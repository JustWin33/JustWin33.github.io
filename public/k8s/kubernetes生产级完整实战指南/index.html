<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Kubernetes生产级完整实战指南 这是一份从零开始构建生产级Kubernetes应用的完整教程，涵盖Pod生命周期、数据持久化、服务暴露、配置管理、健康检查等核心内容。每一步操作都附有详细解释和原理说明。\n"><title>Kubernetes 生产级完整实战指南</title><link rel=canonical href=http://localhost:1313/k8s/kubernetes%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%8C%E6%95%B4%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Kubernetes 生产级完整实战指南"><meta property='og:description' content="Kubernetes生产级完整实战指南 这是一份从零开始构建生产级Kubernetes应用的完整教程，涵盖Pod生命周期、数据持久化、服务暴露、配置管理、健康检查等核心内容。每一步操作都附有详细解释和原理说明。\n"><meta property='og:url' content='http://localhost:1313/k8s/kubernetes%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%8C%E6%95%B4%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/'><meta property='og:site_name' content='JustWin'><meta property='og:type' content='article'><meta property='article:section' content='K8s'><meta property='article:published_time' content='2025-11-19T00:00:00+00:00'><meta property='article:modified_time' content='2025-11-19T00:00:00+00:00'><meta property='og:image' content='http://localhost:1313/'><meta name=twitter:title content="Kubernetes 生产级完整实战指南"><meta name=twitter:description content="Kubernetes生产级完整实战指南 这是一份从零开始构建生产级Kubernetes应用的完整教程，涵盖Pod生命周期、数据持久化、服务暴露、配置管理、健康检查等核心内容。每一步操作都附有详细解释和原理说明。\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='http://localhost:1313/'><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/avatar_hu_89ca753ea8ea85c7.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>✍️</span></figure><div class=site-meta><h1 class=site-name><a href=/>JustWin</a></h1><h2 class=site-description>分享技术与生活</h2></div></header><ol class=menu-social><li><a href=https://github.com/passion-win target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="0 0 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>github [#142]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M94 7399C99.523 7399 104 7403.59 104 7409.253 104 7413.782 101.138 7417.624 97.167 7418.981 96.66 7419.082 96.48 7418.762 96.48 7418.489 96.48 7418.151 96.492 7417.047 96.492 7415.675 96.492 7414.719 96.172 7414.095 95.813 7413.777 98.04 7413.523 100.38 7412.656 100.38 7408.718 100.38 7407.598 99.992 7406.684 99.35 7405.966 99.454 7405.707 99.797 7404.664 99.252 7403.252 99.252 7403.252 98.414 7402.977 96.505 7404.303 95.706 7404.076 94.85 7403.962 94 7403.958 93.15 7403.962 92.295 7404.076 91.497 7404.303 89.586 7402.977 88.746 7403.252 88.746 7403.252 88.203 7404.664 88.546 7405.707 88.649 7405.966 88.01 7406.684 87.619 7407.598 87.619 7408.718 87.619 7412.646 89.954 7413.526 92.175 7413.785 91.889 7414.041 91.63 7414.493 91.54 7415.156 90.97 7415.418 89.522 7415.871 88.63 7414.304 88.63 7414.304 88.101 7413.319 87.097 7413.247 87.097 7413.247 86.122 7413.234 87.029 7413.87 87.029 7413.87 87.684 7414.185 88.139 7415.37 88.139 7415.37 88.726 7417.2 91.508 7416.58 91.513 7417.437 91.522 7418.245 91.522 7418.489 91.522 7418.76 91.338 7419.077 90.839 7418.982 86.865 7417.627 84 7413.783 84 7409.253 84 7403.59 88.478 7399 94 7399" id="github-[#142]"/></g></g></g></svg></a></li><li><a href=https://t.me/+TFjBeZzowwU1YTY1 target=_blank title=telegram rel=me><svg viewBox="0 0 640 640"><path d="M320 72C183 72 72 183 72 320S183 568 320 568 568 457 568 320 457 72 320 72zM435 240.7C431.3 279.9 415.1 375.1 406.9 419c-3.5 18.6-10.3 24.8-16.9 25.4C375.6 445.7 364.7 434.9 350.7 425.7c-21.8-14.3-34.2-23.2-55.3-37.2C270.9 372.4 286.8 363.5 300.7 349 304.4 345.2 367.8 287.5 369 282.3 369.2 281.6 369.3 279.2 367.8 277.9 366.3 276.6 364.2 277.1 362.7 277.4 360.5 277.9 325.6 300.9 258.1 346.5 248.2 353.3 239.2 356.6 231.2 356.4 222.3 356.2 205.3 351.4 192.6 347.3 177.1 342.3 164.7 339.6 165.8 331 166.4 326.5 172.5 322 184.2 317.3 256.5 285.8 304.7 265 328.8 255c68.9-28.6 83.2-33.6 92.5-33.8C423.4 221.2 427.9 221.7 430.9 224.1 432.9 225.8 434.1 228.2 434.4 230.8 434.9 234 435 237.3 434.8 240.6z"/></svg></a></li><li><a href=https://twitter.com/@win1688888888 target=_blank title=twitter rel=me><svg width="800" height="800" viewBox="0 -2 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>twitter [#154]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-60.000000, -7521.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M10.29 7377C17.837 7377 21.965 7370.84365 21.965 7365.50546 21.965 7365.33021 21.965 7365.15595 21.953 7364.98267 22.756 7364.41163 23.449 7363.70276 24 7362.8915 23.252 7363.21837 22.457 7363.433 21.644 7363.52751 22.5 7363.02244 23.141 7362.2289 23.448 7361.2926 22.642 7361.76321 21.761 7362.095 20.842 7362.27321 19.288 7360.64674 16.689 7360.56798 15.036 7362.09796 13.971 7363.08447 13.518 7364.55538 13.849 7365.95835 10.55 7365.79492 7.476 7364.261 5.392 7361.73762 4.303 7363.58363 4.86 7365.94457 6.663 7367.12996 6.01 7367.11125 5.371 7366.93797 4.8 7366.62489V7366.67608C4.801 7368.5989 6.178 7370.2549 8.092 7370.63591 7.488 7370.79836 6.854 7370.82199 6.24 7370.70483 6.777 7372.35099 8.318 7373.47829 10.073 7373.51078 8.62 7374.63513 6.825 7375.24554 4.977 7375.24358 4.651 7375.24259 4.325 7375.22388 4 7375.18549 5.877 7376.37088 8.06 7377 10.29 7376.99705" id="twitter-[#154]"/></g></g></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><span>首页</span></a></li><li><a href=/archives/><span>归档</span></a></li><li><a href=/about/><span>关于</span></a></li><li><a href=/links/><span>网站分享</span></a></li><li><a href=/blockchain/><span>待定</span></a></li><li><a href=/docker/><span>docker</span></a></li><li><a href=/k8s/><span>k8s</span></a></li><li><a href><span></span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=http://localhost:1313/ selected>中文</option><option value=http://localhost:1313/en/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#第一部分pod核心原理与创建流程>第一部分：Pod核心原理与创建流程</a><ol><li><a href=#11-pod创建流程深度解析>1.1 Pod创建流程深度解析</a></li><li><a href=#12-pod-yaml完整配置解析>1.2 Pod YAML完整配置解析</a></li></ol></li><li><a href=#第二部分数据持久化完整方案>第二部分：数据持久化完整方案</a><ol><li><a href=#21-emptydir临时存储>2.1 emptyDir临时存储</a></li><li><a href=#22-hostpath节点存储>2.2 hostPath节点存储</a></li><li><a href=#23-nfs网络存储生产推荐>2.3 NFS网络存储（生产推荐）</a><ol><li><a href=#231-nfs-server配置master节点>2.3.1 NFS Server配置（Master节点）</a></li><li><a href=#232-nfs-client配置所有node节点>2.3.2 NFS Client配置（所有Node节点）</a></li></ol></li><li><a href=#24-pv与pvc存储解耦体系>2.4 PV与PVC存储解耦体系</a><ol><li><a href=#241-persistentvolume集群级存储资源>2.4.1 PersistentVolume（集群级存储资源）</a></li><li><a href=#242-persistentvolumeclaim命名空间级申请>2.4.2 PersistentVolumeClaim（命名空间级申请）</a></li><li><a href=#243-在pod中使用pvc>2.4.3 在Pod中使用PVC</a></li><li><a href=#244-storageclass动态供给进阶>2.4.4 StorageClass动态供给（进阶）</a></li></ol></li></ol></li><li><a href=#第三部分生产级工作负载管理>第三部分：生产级工作负载管理</a><ol><li><a href=#31-deployment完整解析>3.1 Deployment完整解析</a><ol><li><a href=#311-命令行创建与核心概念>3.1.1 命令行创建与核心概念</a></li><li><a href=#312-生产级deployment-yaml>3.1.2 生产级Deployment YAML</a></li></ol></li><li><a href=#32-service服务暴露详解>3.2 Service服务暴露详解</a><ol><li><a href=#321-service类型对比与选择>3.2.1 Service类型对比与选择</a></li><li><a href=#322-service-yaml生产配置>3.2.2 Service YAML生产配置</a></li></ol></li><li><a href=#33-ingress统一入口httphttps>3.3 Ingress统一入口（HTTP/HTTPS）</a><ol><li><a href=#331-ingress-controller部署>3.3.1 Ingress Controller部署</a></li><li><a href=#332-ingress规则配置>3.3.2 Ingress规则配置</a></li></ol></li></ol></li><li><a href=#第四部分配置与安全管理>第四部分：配置与安全管理</a><ol><li><a href=#41-secret敏感信息管理>4.1 Secret敏感信息管理</a><ol><li><a href=#411-通用secret类型>4.1.1 通用Secret类型</a></li><li><a href=#412-docker-registry-secret>4.1.2 Docker Registry Secret</a></li><li><a href=#413-在pod中使用secret>4.1.3 在Pod中使用Secret</a></li></ol></li><li><a href=#42-configmap配置管理补充>4.2 ConfigMap配置管理（补充）</a></li></ol></li><li><a href=#第五部分健康检查与自愈机制>第五部分：健康检查与自愈机制</a><ol><li><a href=#51-三种探针详解>5.1 三种探针详解</a><ol><li><a href=#511-livenessprobe存活探针>5.1.1 LivenessProbe（存活探针）</a></li><li><a href=#512-readinessprobe就绪探针>5.1.2 ReadinessProbe（就绪探针）</a></li><li><a href=#513-startupprobe启动探针116>5.1.3 StartupProbe（启动探针，1.16+）</a></li></ol></li><li><a href=#52-完整探针使用案例>5.2 完整探针使用案例</a></li><li><a href=#53-探针参数总结与生产建议>5.3 探针参数总结与生产建议</a></li></ol></li><li><a href=#第六部分完整生产环境部署案例>第六部分：完整生产环境部署案例</a><ol><li><a href=#61-部署带持久化存储的高可用tomcat应用>6.1 部署带持久化存储的高可用Tomcat应用</a></li></ol></li><li><a href=#第七部分系统化排错与调试>第七部分：系统化排错与调试</a><ol><li><a href=#71-pod无法启动排错流程>7.1 Pod无法启动排错流程</a></li><li><a href=#72-service无法访问排错>7.2 Service无法访问排错</a></li><li><a href=#73-存储问题排错>7.3 存储问题排错</a></li><li><a href=#74-网络问题排错>7.4 网络问题排错</a></li><li><a href=#75-强制删除资源>7.5 强制删除资源</a></li></ol></li><li><a href=#总结与最佳实践>总结与最佳实践</a><ol><li><a href=#kubernetes核心设计思想>Kubernetes核心设计思想</a></li><li><a href=#生产环境-checklist>生产环境 checklist</a></li><li><a href=#推荐学习路径>推荐学习路径</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category></header><div class=article-title-wrapper><h2 class=article-title><a href=/k8s/kubernetes%E7%94%9F%E4%BA%A7%E7%BA%A7%E5%AE%8C%E6%95%B4%E5%AE%9E%E6%88%98%E6%8C%87%E5%8D%97/>Kubernetes 生产级完整实战指南</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-11-19</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 34 分钟</time></div></footer></div></header><section class=article-content><h1 id=kubernetes生产级完整实战指南>Kubernetes生产级完整实战指南</h1><p>这是一份从零开始构建生产级Kubernetes应用的完整教程，涵盖Pod生命周期、数据持久化、服务暴露、配置管理、健康检查等核心内容。每一步操作都附有详细解释和原理说明。</p><hr><h2 id=第一部分pod核心原理与创建流程>第一部分：Pod核心原理与创建流程</h2><h3 id=11-pod创建流程深度解析>1.1 Pod创建流程深度解析</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 示例：创建一个简单的Nginx Pod</span>
</span></span><span class=line><span class=cl>kubectl run mynginx --image<span class=o>=</span>nginx:1.14.2 --restart<span class=o>=</span>Never
</span></span></code></pre></td></tr></table></div></div><p><strong>完整创建流程详解</strong>：</p><div class=table-wrapper><table><thead><tr><th>步骤</th><th>执行组件</th><th>具体操作</th><th>详细解释</th></tr></thead><tbody><tr><td>1</td><td>kubectl客户端</td><td>解析命令参数，生成RESTful API请求</td><td>将<code>run</code>命令转换为JSON格式的Pod定义，包含镜像、名称等元数据</td></tr><tr><td>2</td><td>kube-apiserver</td><td>接收POST请求，认证鉴权</td><td>验证客户端身份和权限，检查请求格式是否符合API规范</td></tr><tr><td>3</td><td>etcd</td><td>存储Pod元数据</td><td>将Pod状态设为"Pending"，记录spec信息但不分配节点</td></tr><tr><td>4</td><td>kube-scheduler</td><td>Watch机制检测到新Pod</td><td>Scheduler持续监听apiserver的未调度Pod，根据资源需求筛选节点</td></tr><tr><td>5</td><td>kube-scheduler</td><td>调度算法选择最优节点</td><td>经过预选（Predicate）和优选（Priority）两个阶段，考虑资源、亲和性、污点半径等因素</td></tr><tr><td>6</td><td>kube-apiserver</td><td>更新Pod的nodeName字段</td><td>将调度结果写回etcd，Pod状态仍为"Pending"</td></tr><tr><td>7</td><td>kubelet（目标节点）</td><td>监听分配到本节点的Pod</td><td>通过apiserver获取本节点需运行的Pod清单</td></tr><tr><td>8</td><td>kubelet</td><td>调用CRI创建容器</td><td>通过Docker/containerd接口拉取镜像、创建容器、配置网络</td></tr><tr><td>9</td><td>CNI插件</td><td>分配Pod IP地址</td><td>从节点CIDR网段中分配IP，配置veth pair和iptables规则</td></tr><tr><td>10</td><td>kubelet</td><td>执行健康检查</td><td>启动后等待initialDelaySeconds，开始执行探针检测</td></tr><tr><td>11</td><td>kubelet</td><td>更新Pod状态为"Running"</td><td>所有容器启动成功后，通过apiserver更新etcd中的状态</td></tr><tr><td>12</td><td>etcd</td><td>持久化最终状态</td><td>整个集群的状态同步完成</td></tr></tbody></table></div><p><strong>关键概念解释</strong>：</p><ul><li><strong>Watch机制</strong>：Kubernetes组件使用长连接监听资源变化，无需轮询，实现毫秒级响应</li><li><strong>CRI（容器运行时接口）</strong>：kubelet与Docker/containerd通信的标准化接口</li><li><strong>CNI（容器网络接口）</strong>：负责Pod网络配置，常见实现有Flannel、Calico、Cilium</li></ul><hr><h3 id=12-pod-yaml完整配置解析>1.2 Pod YAML完整配置解析</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1         </span><span class=w> </span><span class=c># API版本，v1是稳定核心版本</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod              </span><span class=w> </span><span class=c># 资源类型为Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mynginx        </span><span class=w> </span><span class=c># Pod名称，同一命名空间下唯一</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default   </span><span class=w> </span><span class=c># 命名空间，默认为default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>               </span><span class=c># 标签键值对，用于Service选择器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tier</span><span class=p>:</span><span class=w> </span><span class=l>web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>          </span><span class=c># 注释信息，不影响功能，用于记录元数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Production nginx pod&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>monitoring</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx        </span><span class=w> </span><span class=c># 容器名称，Pod内唯一</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.14.2</span><span class=w> </span><span class=c># 镜像地址，支持Docker Hub和私有仓库</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent </span><span class=w> </span><span class=c># 镜像拉取策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># IfNotPresent: 本地不存在才拉取（生产推荐）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Always: 每次都拉取（开发环境）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Never: 仅使用本地镜像</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w> </span><span class=c># 容器暴露的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http       </span><span class=w> </span><span class=c># 端口名称，便于引用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP    </span><span class=w> </span><span class=c># 协议类型</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>                </span><span class=c># 环境变量注入</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NGINX_ENV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;production&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POD_IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>status.podIP </span><span class=w> </span><span class=c># 引用Pod自身信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>          </span><span class=c># 资源限制（生产环境必须设置）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;64Mi&#34;</span><span class=w>  </span><span class=c># 请求内存，调度依据（软限制）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;50m&#34;</span><span class=w>      </span><span class=c># 请求CPU，1核=1000m（50m=0.05核）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;128Mi&#34;</span><span class=w> </span><span class=c># 内存硬限制，超过会触发OOMKill</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;100m&#34;</span><span class=w>     </span><span class=c># CPU硬限制，超过会被限流（不重启）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>       </span><span class=c># 存储卷挂载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/cache </span><span class=w> </span><span class=c># 容器内挂载路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>    </span><span class=c># 是否只读</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>      </span><span class=c># 存活探针（检测容器是否存活）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/healthz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>  </span><span class=c># 启动后延迟10秒开始探测</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>         </span><span class=c># 每5秒探测一次</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>        </span><span class=c># 请求超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>      </span><span class=c># 连续3次失败才重启</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>     </span><span class=c># 就绪探针（检测容器是否准备好接收流量）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>startupProbe</span><span class=p>:</span><span class=w>       </span><span class=c># 启动探针（保护慢启动应用）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>  </span><span class=c># 最多容忍300秒启动时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>              </span><span class=c># 存储卷定义</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w> </span>{}<span class=w>       </span><span class=c># 临时目录，Pod删除时清空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w> </span><span class=c># 重启策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Always: 无论何原因退出都重启（默认）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># OnFailure: 仅错误退出时重启</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Never: 从不重启</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nodeSelector</span><span class=p>:</span><span class=w>         </span><span class=c># 节点选择器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>disktype</span><span class=p>:</span><span class=w> </span><span class=l>ssd      </span><span class=w> </span><span class=c># 只调度到有ssd标签的节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>          </span><span class=c># 污点容忍（允许调度到污点半径节点）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node-role.kubernetes.io/master&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=第二部分数据持久化完整方案>第二部分：数据持久化完整方案</h2><h3 id=21-emptydir临时存储>2.1 emptyDir临时存储</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建工作目录</span>
</span></span><span class=line><span class=cl>mkdir <span class=m>1119</span> <span class=o>&amp;&amp;</span> <span class=nb>cd</span> <span class=m>1119</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建emptyDir配置文件</span>
</span></span><span class=line><span class=cl>vim emptydir.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-empty</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>container-empty</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.19.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/cache     </span><span class=w> </span><span class=c># 容器内挂载路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache-volume   </span><span class=w> </span><span class=c># 引用的卷名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cache-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>emptyDir</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>sizeLimit</span><span class=p>:</span><span class=w> </span><span class=l>500Mi     </span><span class=w> </span><span class=c># 限制最大容量（可选）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># medium: Memory      # 可选：存储在tmpfs（内存）中，速度极快但会消耗内存</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>执行与验证</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建Pod</span>
</span></span><span class=line><span class=cl>kubectl apply -f emptydir.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看Pod调度节点</span>
</span></span><span class=line><span class=cl>kubectl get pods -o wide <span class=p>|</span> grep pod-empty
</span></span><span class=line><span class=cl><span class=c1># 输出示例：pod-empty   1/1   Running   0   2m   10.244.1.5   k8s-node1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看Pod的UID（用于定位节点上的实际路径）</span>
</span></span><span class=line><span class=cl>kubectl get pods pod-empty -o yaml <span class=p>|</span> grep uid
</span></span><span class=line><span class=cl><span class=c1># 输出：uid: 8f9c8d8a-1b2c-3d4e-5f6g-7h8i9j0k1l2m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在对应节点上查看emptyDir实际路径（需要SSH到节点）</span>
</span></span><span class=line><span class=cl><span class=c1># 路径：/var/lib/kubelet/pods/&lt;uid&gt;/volumes/kubernetes.io~empty-dir/&lt;volume-name&gt;</span>
</span></span><span class=line><span class=cl><span class=c1># 例如：/var/lib/kubelet/pods/8f9c8d8a-1b2c-3d4e-5f6g-7h8i9j0k1l2m/volumes/kubernetes.io~empty-dir/cache-volume</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>emptyDir核心特性详解</strong>：</p><ul><li><strong>生命周期</strong>：与Pod完全绑定，Pod删除→卷删除→数据丢失</li><li><strong>适用场景</strong>：<ul><li>应用程序缓存（重启可接受数据丢失）</li><li>同一Pod内容器间文件共享（如sidecar日志收集）</li><li>临时数据处理（排序、转换等）</li></ul></li><li><strong>性能</strong>：<ul><li>默认使用节点磁盘，受磁盘IO限制</li><li><code>medium: Memory</code>时使用tmpfs，内存速度但重启丢失且消耗内存</li></ul></li><li><strong>限制</strong>：通过<code>sizeLimit</code>设置，超过后Pod会被驱逐</li><li><strong>生产建议</strong>：绝不用于持久化数据，仅用于可重建的临时数据</li></ul><hr><h3 id=22-hostpath节点存储>2.2 hostPath节点存储</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 将tomcat镜像分发到节点（因使用IfNotPresent策略）</span>
</span></span><span class=line><span class=cl>ll tomcat.tar.gz
</span></span><span class=line><span class=cl>scp -r tomcat.tar.gz k8s-node1:/root/
</span></span><span class=line><span class=cl>scp -r tomcat.tar.gz k8s-node2:/root/
</span></span><span class=line><span class=cl><span class=c1># 在节点上加载镜像</span>
</span></span><span class=line><span class=cl><span class=c1># ssh k8s-node1 &#34;docker load -i /root/tomcat.tar.gz&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ssh k8s-node2 &#34;docker load -i /root/tomcat.tar.gz&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建hostPath配置文件</span>
</span></span><span class=line><span class=cl>vim hostpath.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-hostpath</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.19.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/test-nginx  </span><span class=w> </span><span class=c># 第一个容器挂载路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>tomcat:latest</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/test-tomcat </span><span class=w> </span><span class=c># 第二个容器挂载路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>test-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/data1            </span><span class=w> </span><span class=c># 节点上的真实目录路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>DirectoryOrCreate </span><span class=w> </span><span class=c># 目录不存在时自动创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 其他type选项：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Directory: 目录必须存在</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># FileOrCreate: 文件不存在时自动创建</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># File: 文件必须存在</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># Socket: UNIX套接字必须存在</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># CharDevice: 字符设备必须存在</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># BlockDevice: 块设备必须存在</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>执行与交互验证</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f hostpath.yaml
</span></span><span class=line><span class=cl>kubectl get pod -owide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入Nginx容器写入数据</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it test-hostpath -c test-nginx -- bash
</span></span><span class=line><span class=cl><span class=c1># 命令解析：</span>
</span></span><span class=line><span class=cl><span class=c1># exec: 在运行容器中执行命令</span>
</span></span><span class=line><span class=cl><span class=c1># -it: 交互式终端</span>
</span></span><span class=line><span class=cl><span class=c1># -c test-nginx: 指定容器名（Pod内有多个容器时必须指定）</span>
</span></span><span class=line><span class=cl><span class=c1># -- bash: 在容器内执行bash shell</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在容器内执行</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;I am test-nginx test data write&#34;</span> &gt; /test-nginx/mslinux-data
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入Tomcat容器读取数据</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it test-hostpath -c test-tomcat -- bash
</span></span><span class=line><span class=cl>cat /test-tomcat/mslinux-data
</span></span><span class=line><span class=cl><span class=c1># 输出：I am test-nginx test data write</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;I am test-tomcat test data write&#34;</span> &gt;&gt; /test-tomcat/mslinux-data
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在节点上验证文件实际位置</span>
</span></span><span class=line><span class=cl><span class=c1># SSH到Pod所在节点</span>
</span></span><span class=line><span class=cl><span class=c1># cat /data1/mslinux-data</span>
</span></span><span class=line><span class=cl><span class=c1># 输出包含两行数据，证明两个容器共享同一主机目录</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>hostPath核心特性详解</strong>：</p><ul><li><strong>生命周期</strong>：独立于Pod，Pod删除后数据保留在节点上</li><li><strong>适用场景</strong>：<ul><li>单节点守护进程日志收集（如fluentd收集/var/log）</li><li>需要访问节点系统文件（如/etc/hosts）</li><li>开发测试环境快速共享数据</li></ul></li><li><strong>风险与限制</strong>：<ul><li><strong>Pod漂移问题</strong>：Pod被调度到其他节点后无法访问原数据</li><li><strong>安全风险</strong>：可访问节点任意路径，需谨慎使用</li><li><strong>权限问题</strong>：容器内root可能映射到节点普通用户（取决于root squash设置）</li></ul></li><li><strong>生产建议</strong>：<ul><li>几乎不用于生产环境，除非使用DaemonSet固定节点</li><li>必须配合nodeSelector或nodeAffinity使用，确保Pod固定节点</li><li>避免使用<code>type: FileOrCreate</code>，防止权限混乱</li></ul></li></ul><hr><h3 id=23-nfs网络存储生产推荐>2.3 NFS网络存储（生产推荐）</h3><h4 id=231-nfs-server配置master节点>2.3.1 NFS Server配置（Master节点）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 步骤1：安装NFS服务组件</span>
</span></span><span class=line><span class=cl>yum install -y nfs-utils rpcbind
</span></span><span class=line><span class=cl><span class=c1># nfs-utils: 提供NFS服务器和客户端工具</span>
</span></span><span class=line><span class=cl><span class=c1># rpcbind: 端口映射服务，NFS依赖的RPC服务</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：创建共享目录并设置权限</span>
</span></span><span class=line><span class=cl>mkdir -p /nfs/data
</span></span><span class=line><span class=cl>chmod -R <span class=m>755</span> /nfs/data
</span></span><span class=line><span class=cl>chown nfsnobody:nfsnobody /nfs/data
</span></span><span class=line><span class=cl><span class=c1># 权限详解：</span>
</span></span><span class=line><span class=cl><span class=c1># 755: 所有者可读写执行，其他用户只读执行</span>
</span></span><span class=line><span class=cl><span class=c1># nfsnobody: NFS服务的匿名用户，容器以root写入时映射为此用户</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：配置exports文件（访问控制列表）</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/exports <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>/nfs/data/ 192.168.200.0/24(insecure,rw,sync,no_root_squash)
</span></span></span><span class=line><span class=cl><span class=s># 参数详解：
</span></span></span><span class=line><span class=cl><span class=s># /nfs/data: 共享目录路径
</span></span></span><span class=line><span class=cl><span class=s># 192.168.200.0/24: 允许访问的网段
</span></span></span><span class=line><span class=cl><span class=s># insecure: 允许客户端使用大于1024的端口（容器常用）
</span></span></span><span class=line><span class=cl><span class=s># rw: 读写权限
</span></span></span><span class=line><span class=cl><span class=s># sync: 同步写入，数据安全但性能较低（async性能高但可能丢数据）
</span></span></span><span class=line><span class=cl><span class=s># no_root_squash: 容器root用户保持root权限（默认root_squash会映射为nobody）
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4：启动服务并设置开机自启</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now rpcbind nfs-server
</span></span><span class=line><span class=cl><span class=c1># enable --now: 相当于 enable + start，设置开机启动并立即启动</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5：验证共享配置</span>
</span></span><span class=line><span class=cl>exportfs -v
</span></span><span class=line><span class=cl><span class=c1># 输出示例：</span>
</span></span><span class=line><span class=cl><span class=c1># /nfs/data 	192.168.200.0/24(sync,wdelay,hide,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_all_squash)</span>
</span></span><span class=line><span class=cl><span class=c1># 每个参数含义：</span>
</span></span><span class=line><span class=cl><span class=c1># sync: 同步模式</span>
</span></span><span class=line><span class=cl><span class=c1># wdelay: 延迟写入，优化性能</span>
</span></span><span class=line><span class=cl><span class=c1># hide: 隐藏下级目录</span>
</span></span><span class=line><span class=cl><span class=c1># no_subtree_check: 禁用子树检查，提升性能</span>
</span></span><span class=line><span class=cl><span class=c1># sec=sys: 使用系统UID/GID认证</span>
</span></span><span class=line><span class=cl><span class=c1># secure: 要求客户端使用安全端口（与insecure互斥，以exports配置为准）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤6：检查NFS共享是否可用</span>
</span></span><span class=line><span class=cl>showmount -e localhost
</span></span><span class=line><span class=cl><span class=c1># 应输出：/nfs/data 192.168.200.0/24</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>常见NFS故障排查</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 故障1：showmount -e 超时</span>
</span></span><span class=line><span class=cl><span class=c1># 解决：检查防火墙 firewall-cmd --add-service=nfs --permanent &amp;&amp; firewall-cmd --reload</span>
</span></span><span class=line><span class=cl><span class=c1># 或 systemctl stop firewalld</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 故障2：容器内Permission denied</span>
</span></span><span class=line><span class=cl><span class=c1># 解决：检查exports权限是否为no_root_squash，检查目录chmod权限</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 故障3：挂载后文件所有者错乱</span>
</span></span><span class=line><span class=cl><span class=c1># 解决：确保chown nfsnobody:nfsnobody已执行，检查/etc/idmapd.conf配置</span>
</span></span></code></pre></td></tr></table></div></div><hr><h4 id=232-nfs-client配置所有node节点>2.3.2 NFS Client配置（所有Node节点）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在k8s-node1和k8s-node2上执行：</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1：验证NFS服务器可用性</span>
</span></span><span class=line><span class=cl>showmount -e 192.168.200.100
</span></span><span class=line><span class=cl><span class=c1># -e: 显示导出列表</span>
</span></span><span class=line><span class=cl><span class=c1># 输出应包含：/nfs/data 192.168.200.0/24</span>
</span></span><span class=line><span class=cl><span class=c1># 如果超时，检查Master节点防火墙和NFS服务状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：创建本地挂载点</span>
</span></span><span class=line><span class=cl>mkdir -p /nfs/data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：手动挂载测试（临时）</span>
</span></span><span class=line><span class=cl>mount -t nfs 192.168.200.100:/nfs/data /nfs/data
</span></span><span class=line><span class=cl><span class=c1># -t nfs: 指定文件系统类型</span>
</span></span><span class=line><span class=cl><span class=c1># 格式：server:remote-dir local-dir</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证挂载是否成功</span>
</span></span><span class=line><span class=cl>df -h <span class=p>|</span> grep nfs
</span></span><span class=line><span class=cl><span class=c1># 输出示例：192.168.200.100:/nfs/data   50G  10G  40G  20% /nfs/data</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4：配置开机自动挂载（生产必备）</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/fstab <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.100:/nfs/data /nfs/data nfs defaults,_netdev 0 0
</span></span></span><span class=line><span class=cl><span class=s># /etc/fstab字段说明：
</span></span></span><span class=line><span class=cl><span class=s># 第1列：远程NFS路径
</span></span></span><span class=line><span class=cl><span class=s># 第2列：本地挂载点
</span></span></span><span class=line><span class=cl><span class=s># 第3列：文件系统类型
</span></span></span><span class=line><span class=cl><span class=s># 第4列：挂载选项
</span></span></span><span class=line><span class=cl><span class=s>#   defaults: 默认选项(rw, suid, dev, exec, auto, nouser, async)
</span></span></span><span class=line><span class=cl><span class=s>#   _netdev: 网络设备，网络就绪后再挂载（避免开机卡死）
</span></span></span><span class=line><span class=cl><span class=s># 第5列：是否备份（0不备份）
</span></span></span><span class=line><span class=cl><span class=s># 第6列：fsck检查顺序（0不检查）
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试fstab配置</span>
</span></span><span class=line><span class=cl>mount -a
</span></span><span class=line><span class=cl><span class=c1># 无输出表示配置正确</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5：测试写入权限</span>
</span></span><span class=line><span class=cl>touch /nfs/data/test.txt
</span></span><span class=line><span class=cl><span class=c1># 在所有节点验证文件是否同步出现</span>
</span></span><span class=line><span class=cl>ls -l /nfs/data/test.txt
</span></span><span class=line><span class=cl><span class=c1># 检查文件大小、时间戳是否一致</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤6：性能优化（可选）</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/fstab <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.100:/nfs/data /nfs/data nfs rw,_netdev,rsize=1048576,wsize=1048576,hard,intr,nolock 0 0
</span></span></span><span class=line><span class=cl><span class=s># 优化参数：
</span></span></span><span class=line><span class=cl><span class=s># rsize/wsize: 读写块大小（字节），增大提升性能
</span></span></span><span class=line><span class=cl><span class=s># hard: 硬挂载，NFS服务器不可用时程序等待（soft会超时）
</span></span></span><span class=line><span class=cl><span class=s># intr: 允许中断等待操作
</span></span></span><span class=line><span class=cl><span class=s># nolock: 禁用文件锁，提升性能但可能不安全
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>生产环境NFS最佳实践</strong>：</p><ul><li><strong>多目录隔离</strong>：为不同应用创建独立NFS目录，避免IO争抢</li><li><strong>容量规划</strong>：使用LVM管理NFS存储，便于后期扩容</li><li><strong>性能监控</strong>：使用<code>nfsstat</code>、<code>iostat</code>监控NFS性能</li><li><strong>高可用</strong>：使用DRBD+Heartbeat实现NFS主备，或使用Ceph/GlusterFS替代NFS</li></ul><hr><h3 id=24-pv与pvc存储解耦体系>2.4 PV与PVC存储解耦体系</h3><h4 id=241-persistentvolume集群级存储资源>2.4.1 PersistentVolume（集群级存储资源）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建PV配置文件</span>
</span></span><span class=line><span class=cl>vi pv-nfs.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pv</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>nfs        </span><span class=w> </span><span class=c># 自定义标签，供PVC选择性绑定</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>environment</span><span class=p>:</span><span class=w> </span><span class=l>prod</span><span class=w> </span><span class=c># 可添加多个标签</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>1Gi     </span><span class=w> </span><span class=c># 存储容量，PVC申请量必须≤此值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeMode</span><span class=p>:</span><span class=w> </span><span class=l>Filesystem </span><span class=w> </span><span class=c># 卷模式：Filesystem（文件系统）或Block（块设备）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteMany  </span><span class=w> </span><span class=c># 访问模式：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ReadWriteOnce (RWO): 单节点读写（如AWS EBS）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ReadOnlyMany (ROX): 多节点只读</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># ReadWriteMany (RWX): 多节点读写（NFS支持）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain </span><span class=w> </span><span class=c># 回收策略：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Retain: PVC删除后PV和数据保留（需手动清理，生产推荐）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Delete: PVC删除后自动删除PV和数据（云盘推荐）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># Recycle: PVC删除后清空数据（已废弃，不推荐使用）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs </span><span class=w> </span><span class=c># 存储类名称，必须与PVC匹配</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mountOptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>hard             </span><span class=w> </span><span class=c># 硬挂载（NFS服务不可用时程序会等待）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>nfsvers=4.1      </span><span class=w> </span><span class=c># 使用NFS v4.1协议（性能更好）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>noatime          </span><span class=w> </span><span class=c># 不更新访问时间，提升性能</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>nfs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/nfs/data     </span><span class=w> </span><span class=c># NFS服务器共享路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=m>192.168.200.100</span><span class=w>  </span><span class=c># NFS服务器IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># readOnly: false   # 是否只读（默认false）</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>创建与状态流转</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f pv-nfs.yaml
</span></span><span class=line><span class=cl>kubectl get pv -w
</span></span><span class=line><span class=cl><span class=c1># 状态流转：</span>
</span></span><span class=line><span class=cl><span class=c1># Available → Bound → Released → Available（手动清理后）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看PV详情</span>
</span></span><span class=line><span class=cl>kubectl describe pv nfs-pv
</span></span><span class=line><span class=cl><span class=c1># 关键信息：</span>
</span></span><span class=line><span class=cl><span class=c1># Source: NFS路径</span>
</span></span><span class=line><span class=cl><span class=c1># Claim: 绑定的PVC</span>
</span></span><span class=line><span class=cl><span class=c1># Status: 当前状态</span>
</span></span><span class=line><span class=cl><span class=c1># Access Modes: 支持的访问模式</span>
</span></span><span class=line><span class=cl><span class=c1># Capacity: 容量</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>PV生命周期详解</strong>：</p><ol><li><strong>Available</strong>：PV创建完成，等待PVC绑定</li><li><strong>Bound</strong>：PVC成功绑定，PV被占用</li><li><strong>Released</strong>：PVC被删除，但PV未回收</li><li><strong>Failed</strong>：回收失败</li><li><strong>Available</strong>：手动清理后重新可用</li></ol><hr><h4 id=242-persistentvolumeclaim命名空间级申请>2.4.2 PersistentVolumeClaim（命名空间级申请）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建PVC配置文件</span>
</span></span><span class=line><span class=cl>vi pvc-nfs.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default </span><span class=w> </span><span class=c># PVC是命名空间资源，不同NS可同名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>500Mi </span><span class=w> </span><span class=c># 申请500Mi存储（PV容量必须≥此值）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 注意：对于NFS，这只是逻辑限制，实际可超过</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteMany  </span><span class=w> </span><span class=c># 必须与PV的accessModes完全匹配</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs </span><span class=w> </span><span class=c># 必须与PV的storageClassName相同</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>           </span><span class=c># 标签选择器（可选，精确匹配PV）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>nfs</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># matchExpressions:  # 复杂匹配规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c>#   - {key: environment, operator: In, values: [prod, staging]}</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>创建与绑定验证</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f pvc-nfs.yaml
</span></span><span class=line><span class=cl>kubectl get pvc -w
</span></span><span class=line><span class=cl><span class=c1># 状态：</span>
</span></span><span class=line><span class=cl><span class=c1># Pending → Bound（成功绑定PV）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看PVC绑定详情</span>
</span></span><span class=line><span class=cl>kubectl get pvc nfs-pvc -o yaml
</span></span><span class=line><span class=cl><span class=c1># 关键字段：</span>
</span></span><span class=line><span class=cl><span class=c1># volumeName: 绑定的PV名称</span>
</span></span><span class=line><span class=cl><span class=c1># capacity.storage: 实际分配的容量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看绑定关系</span>
</span></span><span class=line><span class=cl>kubectl get pvc nfs-pvc -o yaml <span class=p>|</span> grep volumeName
</span></span><span class=line><span class=cl><span class=c1># 输出：  volumeName: nfs-pv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看PV的绑定状态</span>
</span></span><span class=line><span class=cl>kubectl get pv nfs-pv -o yaml <span class=p>|</span> grep claimRef
</span></span><span class=line><span class=cl><span class=c1># 输出包含绑定的PVC的namespace、name等信息</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>PVC绑定PV的匹配规则</strong>：</p><ol><li><strong>storageClassName必须相同</strong>：空字符串也视为相同</li><li><strong>accessModes必须匹配</strong>：PVC的accessModes必须是PV的子集</li><li><strong>PV容量 ≥ PVC申请量</strong>：500Mi的PVC可以绑定1Gi的PV</li><li><strong>selector标签匹配</strong>（可选）：PV必须包含PVC指定的所有标签</li><li><strong>绑定是排他的</strong>：一个PV同一时间只能绑定一个PVC</li></ol><hr><h4 id=243-在pod中使用pvc>2.4.3 在Pod中使用PVC</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建使用PVC的Pod</span>
</span></span><span class=line><span class=cl>vi pod-with-pvc.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-with-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.19.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data </span><span class=w> </span><span class=c># 容器内挂载路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>nginx   </span><span class=w> </span><span class=c># 可选：使用卷中的子目录，避免数据污染</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-pvc </span><span class=w> </span><span class=c># 引用已创建的PVC名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>     </span><span class=c># 是否只读（默认false）</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>创建与验证</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f pod-with-pvc.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证数据持久化</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it app-with-storage -- bash
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;Persistent data test&#34;</span> &gt; /data/test.txt
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除Pod后重建</span>
</span></span><span class=line><span class=cl>kubectl delete pod app-with-storage
</span></span><span class=line><span class=cl>kubectl apply -f pod-with-storage.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证数据是否保留</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it app-with-storage -- cat /data/test.txt
</span></span><span class=line><span class=cl><span class=c1># 输出：Persistent data test （数据持久化成功）</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>PV/PVC体系核心优势</strong>：</p><ul><li><strong>存储与Pod解耦</strong>：Pod删除重建不影响数据</li><li><strong>存储提供者与使用者分离</strong>：管理员管理PV，开发者申请PVC</li><li><strong>跨命名空间共享</strong>：不同NS的PVC可绑定不同PV</li><li><strong>动态供给</strong>：通过StorageClass自动创建PV</li></ul><hr><h4 id=244-storageclass动态供给进阶>2.4.4 StorageClass动态供给（进阶）</h4><p>静态PV需要管理员手动创建，动态供给可自动创建PV。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建StorageClass</span>
</span></span><span class=line><span class=cl>vi storageclass-nfs.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-dynamic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>k8s-sigs.io/nfs-subdir-external-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># provisioner: 指定动态供给驱动，需提前部署</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>archiveOnDelete</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>  </span><span class=c># PVC删除时归档而非真正删除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>pathPattern</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;${.PVC.namespace}/${.PVC.name}&#34;</span><span class=w>  </span><span class=c># 目录命名模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>reclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain     </span><span class=w> </span><span class=c># 回收策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumeBindingMode</span><span class=p>:</span><span class=w> </span><span class=l>Immediate </span><span class=w> </span><span class=c># 绑定模式：Immediate或WaitForFirstConsumer</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>使用动态PVC</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>dynamic-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>nfs-dynamic </span><span class=w> </span><span class=c># 指定StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>ReadWriteMany</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>自动创建PV</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f dynamic-pvc.yaml
</span></span><span class=line><span class=cl>kubectl get pvc dynamic-pvc
</span></span><span class=line><span class=cl><span class=c1># 自动创建PV并绑定，无需手动创建PV</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=第三部分生产级工作负载管理>第三部分：生产级工作负载管理</h2><h3 id=31-deployment完整解析>3.1 Deployment完整解析</h3><h4 id=311-命令行创建与核心概念>3.1.1 命令行创建与核心概念</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 快速创建Deployment（生产不推荐，仅用于测试）</span>
</span></span><span class=line><span class=cl>kubectl create deployment my-tomcat <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --image<span class=o>=</span>tomcat:9.0.55 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --replicas<span class=o>=</span><span class=m>3</span>  <span class=c1># 创建3个副本保证高可用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 与Pod的本质区别：</span>
</span></span><span class=line><span class=cl><span class=c1># - 自愈能力：节点宕机时自动重建</span>
</span></span><span class=line><span class=cl><span class=c1># - 滚动更新：逐个替换Pod，业务不中断</span>
</span></span><span class=line><span class=cl><span class=c1># - 版本管理：记录ReplicaSet历史，支持回滚</span>
</span></span><span class=line><span class=cl><span class=c1># - 扩缩容：手动或自动调整副本数</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Deployment控制层级</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Deployment (my-tomcat)
</span></span><span class=line><span class=cl>  ↓ 管理
</span></span><span class=line><span class=cl>ReplicaSet (my-tomcat-1v1wf)  # 版本控制层，带随机哈希
</span></span><span class=line><span class=cl>  ↓ 管理
</span></span><span class=line><span class=cl>Pods (my-tomcat-1v1wf-xxx)    # 实际运行实例
</span></span></code></pre></td></tr></table></div></div><p><strong>查看控制关系</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看Deployment管理的ReplicaSet</span>
</span></span><span class=line><span class=cl>kubectl get rs -l <span class=nv>app</span><span class=o>=</span>my-tomcat
</span></span><span class=line><span class=cl><span class=c1># 输出：my-tomcat-1v1wf   3   3   3   5m</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看Pod的ownerReferences</span>
</span></span><span class=line><span class=cl>kubectl get pod my-tomcat-1v1wf-xxxx -o yaml <span class=p>|</span> grep -A <span class=m>5</span> ownerReferences
</span></span><span class=line><span class=cl><span class=c1># 输出显示该Pod由哪个ReplicaSet管理</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证自愈能力</span>
</span></span><span class=line><span class=cl>kubectl delete pod my-tomcat-1v1wf-74gp9
</span></span><span class=line><span class=cl>kubectl get pod -l <span class=nv>app</span><span class=o>=</span>my-tomcat -w
</span></span><span class=line><span class=cl><span class=c1># 立即出现新Pod，名称后缀变化</span>
</span></span></code></pre></td></tr></table></div></div><hr><h4 id=312-生产级deployment-yaml>3.1.2 生产级Deployment YAML</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 滚动更新策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate </span><span class=w> </span><span class=c># 或Recreate（全量删除再创建）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>  </span><span class=c># 最大不可用Pod数（绝对值或百分比）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>        </span><span class=c># 最大超出Pod数（可临时多创建1个）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 版本回滚策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>revisionHistoryLimit</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>  </span><span class=c># 保留的历史版本数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 选择器（必须匹配template.labels）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Pod模板</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>version</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>  </span><span class=c># 监控采集注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>prometheus.io/port</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;8080&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 镜像拉取Secret（私有仓库）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>imagePullSecrets</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aliyun-registry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 存储卷定义</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>tomcat-pvc</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>configMap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tomcat-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 初始化容器（在主容器启动前执行）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initContainers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>init-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s1>&#39;sh&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;-c&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;cp /tmp/index.html /data&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 主容器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>tomcat:9.0.55</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 环境变量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>JAVA_OPTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xmx512m -Xms512m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>POD_NAME</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>fieldRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>fieldPath</span><span class=p>:</span><span class=w> </span><span class=l>metadata.name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DB_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 资源限制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;250m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 存储挂载</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/local/tomcat/webapps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>webapps </span><span class=w> </span><span class=c># 使用PV中的子目录</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/usr/local/tomcat/conf/server.xml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>subPath</span><span class=p>:</span><span class=w> </span><span class=l>server.xml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 健康检查</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/healthz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 安全上下文</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>securityContext</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>runAsNonRoot</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>  </span><span class=c># 是否以非root运行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>runAsUser</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w>         </span><span class=c># 运行用户ID</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>privileged</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>    </span><span class=c># 是否特权模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 重启策略</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Always</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 节点亲和性（调度策略）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>disktype</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>values</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ssd&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>podAntiAffinity</span><span class=p>:</span><span class=w>  </span><span class=c># Pod反亲和（避免同一应用调度到同节点）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>podAffinityTerm</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/hostname</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 容忍设置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>  </span><span class=c># 容忍300秒后驱逐</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>滚动更新演示</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看当前版本</span>
</span></span><span class=line><span class=cl>kubectl get deployment my-tomcat -o wide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 更新镜像版本</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>set</span> image deployment/my-tomcat <span class=nv>tomcat</span><span class=o>=</span>tomcat:9.0.56 --record
</span></span><span class=line><span class=cl><span class=c1># 或修改YAML后 apply</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看滚动更新状态</span>
</span></span><span class=line><span class=cl>kubectl rollout status deployment/my-tomcat
</span></span><span class=line><span class=cl><span class=c1># 输出：Waiting for deployment &#34;my-tomcat&#34; rollout to finish: 1 out of 3 new replicas have been updated...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看ReplicaSet历史</span>
</span></span><span class=line><span class=cl>kubectl get rs -l <span class=nv>app</span><span class=o>=</span>my-tomcat
</span></span><span class=line><span class=cl><span class=c1># 输出：my-tomcat-1v1wf   0   0   0   10m  (旧版本)</span>
</span></span><span class=line><span class=cl><span class=c1>#       my-tomcat-2b2cg   3   3   3   5m   (新版本)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 回滚到上一个版本</span>
</span></span><span class=line><span class=cl>kubectl rollout undo deployment/my-tomcat
</span></span><span class=line><span class=cl><span class=c1># 回滚到指定版本</span>
</span></span><span class=line><span class=cl>kubectl rollout undo deployment/my-tomcat --to-revision<span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看历史版本</span>
</span></span><span class=line><span class=cl>kubectl rollout <span class=nb>history</span> deployment/my-tomcat
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=32-service服务暴露详解>3.2 Service服务暴露详解</h3><h4 id=321-service类型对比与选择>3.2.1 Service类型对比与选择</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建Service暴露Deployment</span>
</span></span><span class=line><span class=cl>kubectl expose deployment my-tomcat <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --name<span class=o>=</span>tomcat-svc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --port<span class=o>=</span><span class=m>8080</span> <span class=se>\ </span>       <span class=c1># Service端口（集群内访问）</span>
</span></span><span class=line><span class=cl>  --target-port<span class=o>=</span><span class=m>8080</span> <span class=se>\ </span><span class=c1># Pod端口（容器端口）</span>
</span></span><span class=line><span class=cl>  --type<span class=o>=</span>NodePort      <span class=c1># Service类型</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>四种Service类型深度对比</strong>：</p><div class=table-wrapper><table><thead><tr><th>类型</th><th>使用场景</th><th>外部访问</th><th>性能开销</th><th>适用环境</th></tr></thead><tbody><tr><td><strong>ClusterIP</strong></td><td>集群内部微服务调用</td><td>❌ 不可</td><td>低</td><td>所有环境（默认）</td></tr><tr><td><strong>NodePort</strong></td><td>开发测试环境</td><td>✅ 节点IP+端口</td><td>中</td><td>开发、小规模生产</td></tr><tr><td><strong>LoadBalancer</strong></td><td>公有云生产环境</td><td>✅ 自动分配公网IP</td><td>依赖云厂商</td><td>公有云（AWS ELB、阿里云SLB）</td></tr><tr><td><strong>ExternalName</strong></td><td>指向集群外服务</td><td>CNAME解析</td><td>无</td><td>访问外部数据库、API</td></tr></tbody></table></div><p><strong>NodePort端口范围问题</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 默认范围：30000-32767（共2768个端口）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改端口范围（避免与业务端口冲突）</span>
</span></span><span class=line><span class=cl><span class=c1># 编辑kube-apiserver配置</span>
</span></span><span class=line><span class=cl>vi /etc/kubernetes/manifests/kube-apiserver.yaml
</span></span><span class=line><span class=cl><span class=c1># 在command下添加：</span>
</span></span><span class=line><span class=cl>- --service-node-port-range<span class=o>=</span>30000-39999
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改后apiserver会自动重启</span>
</span></span><span class=line><span class=cl>kubectl get pod -n kube-system kube-apiserver-master -w
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证新范围</span>
</span></span><span class=line><span class=cl>kubectl expose deployment <span class=nb>test</span> --port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort --dry-run<span class=o>=</span>client -o yaml
</span></span><span class=line><span class=cl><span class=c1># 查看nodePort是否在30000-39999范围内</span>
</span></span></code></pre></td></tr></table></div></div><hr><h4 id=322-service-yaml生产配置>3.2.2 Service YAML生产配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>prometheus.io/scrape</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>  </span><span class=c># 监控注解</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>NodePort</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># ClusterIP: None  # 设置为None可创建Headless Service，直接访问Pod IP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 端口定义（可定义多个）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>        </span><span class=c># Service的集群内端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>  </span><span class=c># 转发到Pod的端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30001</span><span class=w>   </span><span class=c># 手动指定节点端口（可选，不指定则随机分配）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP    </span><span class=w> </span><span class=c># 协议：TCP或UDP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>http       </span><span class=w> </span><span class=c># 端口名称，用于识别（多端口时必须命名）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8443</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodePort</span><span class=p>:</span><span class=w> </span><span class=m>30002</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>https</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 会话保持</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sessionAffinity</span><span class=p>:</span><span class=w> </span><span class=l>ClientIP </span><span class=w> </span><span class=c># 或None（默认）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>sessionAffinityConfig</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>clientIP</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10800</span><span class=w>  </span><span class=c># 会话保持超时时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 外部IP（LoadBalancer类型使用）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>externalIPs</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=m>192.168.200.201</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 后端Pod选择器（核心）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat </span><span class=w> </span><span class=c># 匹配Pod的label，Service通过此字段找到后端Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 健康检查（1.21+）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>publishNotReadyAddresses</span><span class=p>:</span><span class=w> </span><span class=kc>false</span><span class=w>  </span><span class=c># 是否将未就绪Pod加入Endpoints</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Service工作原理详解</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Service通过标签选择器动态维护后端Pod列表</span>
</span></span><span class=line><span class=cl>kubectl get endpoints my-tomcat -o yaml
</span></span><span class=line><span class=cl><span class=c1># 输出包含所有就绪Pod的IP和端口</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 集群内DNS访问</span>
</span></span><span class=line><span class=cl><span class=c1># 格式：&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</span>
</span></span><span class=line><span class=cl>curl http://my-tomcat.default.svc.cluster.local:8080
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在不同命名空间访问</span>
</span></span><span class=line><span class=cl>curl http://my-tomcat.prod.svc.cluster.local:8080
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看Service的IPTables规则（NodePort模式）</span>
</span></span><span class=line><span class=cl>iptables-save <span class=p>|</span> grep tomcat
</span></span><span class=line><span class=cl><span class=c1># 显示KUBE-SVC-XXX链和DNAT规则</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=33-ingress统一入口httphttps>3.3 Ingress统一入口（HTTP/HTTPS）</h3><h4 id=331-ingress-controller部署>3.3.1 Ingress Controller部署</h4><p>Ingress Controller是实现Ingress规则的反向代理（通常为Nginx/Traefik）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 步骤1：下载官方部署文件</span>
</span></span><span class=line><span class=cl>wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v0.47.0/deploy/static/provider/baremetal/deploy.yaml
</span></span><span class=line><span class=cl><span class=c1># 文件内容详解：</span>
</span></span><span class=line><span class=cl><span class=c1># - Namespace: ingress-nginx</span>
</span></span><span class=line><span class=cl><span class=c1># - Deployment: ingress-nginx-controller</span>
</span></span><span class=line><span class=cl><span class=c1># - Service: ingress-nginx-controller (LoadBalancer类型)</span>
</span></span><span class=line><span class=cl><span class=c1># - ConfigMap: 存储Nginx配置</span>
</span></span><span class=line><span class=cl><span class=c1># - RBAC: 权限配置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：替换镜像为国内源（避免墙）</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s#k8s.gcr.io/ingress-nginx/controller#registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/ingress-nginx-controller#g&#39;</span> deploy.yaml
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s#k8s.gcr.io/ingress-nginx/kube-webhook-certgen#registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/kube-webhook-certgen#g&#39;</span> deploy.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：修改部署模式为hostNetwork（生产推荐）</span>
</span></span><span class=line><span class=cl>vi deploy.yaml
</span></span><span class=line><span class=cl><span class=c1># 在spec.template.spec下添加：</span>
</span></span><span class=line><span class=cl>hostNetwork: <span class=nb>true</span>          <span class=c1># 使用主机网络，性能更好，端口不冲突</span>
</span></span><span class=line><span class=cl>dnsPolicy: ClusterFirstWithHostNet  <span class=c1># DNS策略</span>
</span></span><span class=line><span class=cl><span class=c1># 优势：</span>
</span></span><span class=line><span class=cl><span class=c1># - 避免NodePort的端口限制</span>
</span></span><span class=line><span class=cl><span class=c1># - 减少一层NAT，性能提升</span>
</span></span><span class=line><span class=cl><span class=c1># - 直接使用节点80/443端口</span>
</span></span><span class=line><span class=cl><span class=c1># 劣势：</span>
</span></span><span class=line><span class=cl><span class=c1># - 每个节点只能运行一个Controller实例</span>
</span></span><span class=line><span class=cl><span class=c1># - 与节点其他服务可能端口冲突</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4：应用并验证</span>
</span></span><span class=line><span class=cl>kubectl apply -f deploy.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5：查看部署状态</span>
</span></span><span class=line><span class=cl>kubectl get pod -n ingress-nginx -w
</span></span><span class=line><span class=cl><span class=c1># 等待Controller Pod进入Running状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤6：查看Service</span>
</span></span><span class=line><span class=cl>kubectl get svc -n ingress-nginx ingress-nginx-controller
</span></span><span class=line><span class=cl><span class=c1># 注意：使用hostNetwork模式时，此Service可能仍为ClusterIP，实际通过节点IP访问</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Ingress Controller工作原理</strong>：</p><ul><li><strong>监听Ingress资源</strong>：通过Watch机制实时获取集群Ingress规则</li><li><strong>生成Nginx配置</strong>：将规则转换为nginx.conf配置</li><li><strong>热加载</strong>：检测到配置变化后执行<code>nginx -s reload</code>无需重启</li><li><strong>负载均衡</strong>：将流量转发到Service的Endpoints（后端Pod）</li></ul><hr><h4 id=332-ingress规则配置>3.3.2 Ingress规则配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>  </span><span class=c># 注解用于配置Nginx行为</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx.ingress.kubernetes.io/rewrite-target</span><span class=p>:</span><span class=w> </span><span class=l>/ </span><span class=w> </span><span class=c># URL重写</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx.ingress.kubernetes.io/ssl-redirect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>  </span><span class=c># 强制HTTP跳转HTTPS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx.ingress.kubernetes.io/rate-limit</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;100&#34;</span><span class=w>  </span><span class=c># 限速100rps</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx.ingress.kubernetes.io/whitelist-source-range</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10.0.0.0/8&#34;</span><span class=w>  </span><span class=c># IP白名单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx.ingress.kubernetes.io/proxy-body-size</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;10m&#34;</span><span class=w>  </span><span class=c># 上传大小限制</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx.ingress.kubernetes.io/cors-allow-origin</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;*&#34;</span><span class=w>  </span><span class=c># CORS配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingressClassName</span><span class=p>:</span><span class=w> </span><span class=l>nginx </span><span class=w> </span><span class=c># 指定使用的Controller（支持多Controller）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># TLS配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>tls-secret </span><span class=w> </span><span class=c># 包含证书密钥的Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>tomcat.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 路由规则</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>tomcat.example.com </span><span class=w> </span><span class=c># 域名路由（基于Host头）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/                </span><span class=w> </span><span class=c># 路径匹配</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix       </span><span class=w> </span><span class=c># 路径类型：Prefix（前缀）、Exact（精确）、ImplementationSpecific（依赖实现）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-tomcat    </span><span class=w> </span><span class=c># 后端Service名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>      </span><span class=c># Service端口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>api.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>api-service-v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>api-service-v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 默认后端（无匹配规则时）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>defaultBackend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-http-backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>创建TLS Secret</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 方式1：使用现有证书</span>
</span></span><span class=line><span class=cl>kubectl create secret tls tls-secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cert<span class=o>=</span>tls.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --key<span class=o>=</span>tls.key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式2：自签名证书（测试）</span>
</span></span><span class=line><span class=cl>openssl req -x509 -nodes -days <span class=m>365</span> -newkey rsa:2048 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -keyout tls.key -out tls.crt -subj <span class=s2>&#34;/CN=tomcat.example.com&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl create secret tls tls-secret --cert<span class=o>=</span>tls.crt --key<span class=o>=</span>tls.key
</span></span></code></pre></td></tr></table></div></div><p><strong>域名解析配置</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 本地hosts文件（开发测试）</span>
</span></span><span class=line><span class=cl><span class=c1># 编辑 /etc/hosts</span>
</span></span><span class=line><span class=cl>192.168.200.101 tomcat.example.com  <span class=c1># 任意Node IP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内网DNS（生产环境）</span>
</span></span><span class=line><span class=cl><span class=c1># 添加A记录：tomcat.example.com → NodeIP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 访问</span>
</span></span><span class=line><span class=cl>curl http://tomcat.example.com  <span class=c1># 自动跳转到HTTPS</span>
</span></span><span class=line><span class=cl>curl -k https://tomcat.example.com  <span class=c1># -k忽略自签名证书警告</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=第四部分配置与安全管理>第四部分：配置与安全管理</h2><h3 id=41-secret敏感信息管理>4.1 Secret敏感信息管理</h3><h4 id=411-通用secret类型>4.1.1 通用Secret类型</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 方式1：命令行创建（少量键值）</span>
</span></span><span class=line><span class=cl>kubectl create secret generic db-secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>username</span><span class=o>=</span>admin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span><span class=s1>&#39;Admin@123!&#39;</span>
</span></span><span class=line><span class=cl><span class=c1># 命令详解：</span>
</span></span><span class=line><span class=cl><span class=c1># generic: 通用类型的Secret</span>
</span></span><span class=line><span class=cl><span class=c1># --from-literal: 从字面量创建，格式key=value</span>
</span></span><span class=line><span class=cl><span class=c1># Secret名称：db-secret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式2：文件创建（证书、大文件）</span>
</span></span><span class=line><span class=cl>kubectl create secret generic ssl-cert <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-file<span class=o>=</span>tls.crt<span class=o>=</span>/path/to/cert.pem <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-file<span class=o>=</span>tls.key<span class=o>=</span>/path/to/key.pem
</span></span><span class=line><span class=cl><span class=c1># --from-file: 从文件创建，文件名作为key，内容作为value</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式3：目录批量创建</span>
</span></span><span class=line><span class=cl>kubectl create secret generic configs <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-file<span class=o>=</span>./config/dir/
</span></span><span class=line><span class=cl><span class=c1># 目录下所有文件都会被加入Secret</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式4：YAML创建（不推荐，需手动base64编码）</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s1>&#39;admin&#39;</span> <span class=p>|</span> base64  <span class=c1># YWRtaW4=</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -n <span class=s1>&#39;Admin@123!&#39;</span> <span class=p>|</span> base64  <span class=c1># QWRtaW5AMTIzIQ==</span>
</span></span><span class=line><span class=cl><span class=c1># 然后创建YAML</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>查看与解码Secret</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看Secret（值会base64编码）</span>
</span></span><span class=line><span class=cl>kubectl get secret db-secret -o yaml
</span></span><span class=line><span class=cl><span class=c1># 输出：</span>
</span></span><span class=line><span class=cl><span class=c1># data:</span>
</span></span><span class=line><span class=cl><span class=c1>#   password: QWRtaW5AMTIzIQ==</span>
</span></span><span class=line><span class=cl><span class=c1>#   username: YWRtaW4=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 解码查看</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;QWRtaW5AMTIzIQ==&#39;</span> <span class=p>|</span> base64 -d
</span></span><span class=line><span class=cl><span class=c1># 输出：Admin@123!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 直接获取某个key</span>
</span></span><span class=line><span class=cl>kubectl get secret db-secret -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.data.password}&#39;</span> <span class=p>|</span> base64 -d
</span></span></code></pre></td></tr></table></div></div><p><strong>Secret类型详解</strong>：</p><ul><li><strong>Opaque</strong>：通用类型（默认），用于密码、密钥等</li><li><strong>kubernetes.io/service-account-token</strong>：服务账户令牌</li><li><strong>kubernetes.io/dockerconfigjson</strong>：镜像仓库凭证</li><li><strong>kubernetes.io/basic-auth</strong>：Basic认证</li><li><strong>kubernetes.io/ssh-auth</strong>：SSH密钥</li><li><strong>kubernetes.io/tls</strong>：TLS证书</li></ul><hr><h4 id=412-docker-registry-secret>4.1.2 Docker Registry Secret</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建阿里云私有仓库凭证</span>
</span></span><span class=line><span class=cl>kubectl create secret docker-registry aliyun-registry <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-server<span class=o>=</span>registry.cn-hangzhou.aliyuncs.com <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-username<span class=o>=</span>fox666 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-password<span class=o>=</span><span class=s1>&#39;AliyunPwd123&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --docker-email<span class=o>=</span>fox@example.com
</span></span><span class=line><span class=cl><span class=c1># 参数详解：</span>
</span></span><span class=line><span class=cl><span class=c1># --docker-server: 仓库地址（域名+端口）</span>
</span></span><span class=line><span class=cl><span class=c1># --docker-username: 登录用户名</span>
</span></span><span class=line><span class=cl><span class=c1># --docker-password: 登录密码或访问令牌</span>
</span></span><span class=line><span class=cl><span class=c1># --docker-email: 邮箱（部分仓库要求）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看凭证结构</span>
</span></span><span class=line><span class=cl>kubectl get secret aliyun-registry --output<span class=o>=</span><span class=s2>&#34;jsonpath={.data.\.dockerconfigjson}&#34;</span> <span class=p>|</span> base64 -d
</span></span><span class=line><span class=cl><span class=c1># 输出JSON格式：</span>
</span></span><span class=line><span class=cl><span class=c1># {</span>
</span></span><span class=line><span class=cl><span class=c1>#   &#34;auths&#34;: {</span>
</span></span><span class=line><span class=cl><span class=c1>#     &#34;registry.cn-hangzhou.aliyuncs.com&#34;: {</span>
</span></span><span class=line><span class=cl><span class=c1>#       &#34;username&#34;: &#34;fox666&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#       &#34;password&#34;: &#34;AliyunPwd123&#34;,</span>
</span></span><span class=line><span class=cl><span class=c1>#       &#34;email&#34;: &#34;fox@example.com&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>#     }</span>
</span></span><span class=line><span class=cl><span class=c1>#   }</span>
</span></span><span class=line><span class=cl><span class=c1># }</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在Pod中使用（两种方式）</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>在Pod中引用镜像拉取Secret</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>private-registry-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>imagePullSecrets</span><span class=p>:</span><span class=w>  </span><span class=c># 在spec级别定义</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>aliyun-registry</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>registry.cn-hangzhou.aliyuncs.com/fox666/app:v1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h4 id=413-在pod中使用secret>4.1.3 在Pod中使用Secret</h4><p><strong>方式1：环境变量注入（简单但不安全）</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-env-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.19.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DB_USER         </span><span class=w> </span><span class=c># 容器内变量名</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret   </span><span class=w> </span><span class=c># Secret名称</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username     </span><span class=w> </span><span class=c># Secret中的key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DB_PASS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>echo &#34;Database: $DB_USER/$DB_PASS &amp;&amp; nginx -g &#39;daemon off;&#39;&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>方式2：文件挂载（推荐，支持热更新）</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.19.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/etc/secrets </span><span class=w> </span><span class=c># 挂载路径</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>          </span><span class=c># 必须为只读</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>defaultMode</span><span class=p>:</span><span class=w> </span><span class=m>0400</span><span class=w>       </span><span class=c># 文件权限（八进制）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>items</span><span class=p>:</span><span class=w>  </span><span class=c># 自定义文件名（可选）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>username</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>db-user.txt    </span><span class=w> </span><span class=c># /etc/secrets/db-user.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=m>0444</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>db-pass.txt    </span><span class=w> </span><span class=c># /etc/secrets/db-pass.txt</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>mode</span><span class=p>:</span><span class=w> </span><span class=m>0400</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Secret热更新演示</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 启动Pod</span>
</span></span><span class=line><span class=cl>kubectl apply -f secret-volume-pod.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 进入Pod查看文件</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it secret-volume-pod -- ls -l /etc/secrets/
</span></span><span class=line><span class=cl><span class=c1># 输出：-r--r--r-- 1 root root 5 Dec 1 10:00 db-user.txt</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 更新Secret</span>
</span></span><span class=line><span class=cl>kubectl create secret generic db-secret <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>username</span><span class=o>=</span>newadmin <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span><span class=s1>&#39;NewPass123!&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --dry-run<span class=o>=</span>client -o yaml <span class=p>|</span> kubectl apply -f -
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 等待约60秒（kubelet同步周期）</span>
</span></span><span class=line><span class=cl><span class=c1># 5. 验证文件内容已更新</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it secret-volume-pod -- cat /etc/secrets/db-user.txt
</span></span><span class=line><span class=cl><span class=c1># 输出：newadmin</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注意：环境变量方式不支持热更新，必须重启Pod</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Secret安全最佳实践</strong>：</p><ol><li><strong>启用RBAC</strong>：限制Secret访问权限</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;secrets&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resourceNames</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;db-secret&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=2><li><strong>使用Vault或SealedSecret</strong>：加密存储etcd中的数据</li><li><strong>定期轮换</strong>：手动或结合Vault Operator自动轮换</li><li><strong>避免环境变量</strong>：环境变量可通过<code>docker inspect</code>和<code>/proc</code>查看，安全性低</li><li><strong>网络加密</strong>：启用TLS加密kubelet与apiserver通信</li></ol><hr><h3 id=42-configmap配置管理补充>4.2 ConfigMap配置管理（补充）</h3><p>ConfigMap用于存储非敏感配置信息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建ConfigMap</span>
</span></span><span class=line><span class=cl>kubectl create configmap tomcat-config <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-file<span class=o>=</span>server.xml<span class=o>=</span>./server.xml <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>env</span><span class=o>=</span>prod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用ConfigMap（与Secret类似）</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=第五部分健康检查与自愈机制>第五部分：健康检查与自愈机制</h2><h3 id=51-三种探针详解>5.1 三种探针详解</h3><h4 id=511-livenessprobe存活探针>5.1.1 LivenessProbe（存活探针）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness-http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.19.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 探测方式：httpGet、exec、tcpSocket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/healthz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP     </span><span class=w> </span><span class=c># 或HTTPS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>httpHeaders</span><span class=p>:</span><span class=w>      </span><span class=c># 自定义请求头</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>X-Custom-Header</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>Awesome</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 探测时机参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>  </span><span class=c># 容器启动后等待30秒开始探测</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>        </span><span class=c># 每10秒探测一次</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>        </span><span class=c># 请求超时5秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>      </span><span class=c># 连续1次成功认为健康</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>      </span><span class=c># 连续3次失败重启容器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 总失败容忍时间 = initialDelaySeconds + (periodSeconds * failureThreshold)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># 本例：30 + (10*3) = 60秒</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>作用</strong>：检测容器是否存活，失败则重启容器。<strong>适用于恢复死锁、内存泄漏等问题</strong>。</p><hr><h4 id=512-readinessprobe就绪探针>5.1.2 ReadinessProbe（就绪探针）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>  </span><span class=c># 连续2次失败从Service移除</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>作用</strong>：检测容器是否准备好接收流量，失败则从Service的Endpoints移除，不重启容器。<strong>适用于应用启动慢、依赖外部服务场景</strong>。</p><hr><h4 id=513-startupprobe启动探针116>5.1.3 StartupProbe（启动探针，1.16+）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>startupProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>  </span><span class=c># 最多容忍300秒启动时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 成功一次后，不再执行startupProbe，转由liveness/readiness接管</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>作用</strong>：保护慢启动应用，避免被过早重启。<strong>适用于启动时间超过liveness容忍期的应用</strong>。</p><hr><h3 id=52-完整探针使用案例>5.2 完整探针使用案例</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建测试目录</span>
</span></span><span class=line><span class=cl>mkdir -pv <span class=m>1117</span> <span class=o>&amp;&amp;</span> <span class=nb>cd</span> <span class=m>1117</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. Exec探针（检测文件存在）</span>
</span></span><span class=line><span class=cl>vi liveness-exec.yaml
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness-exec</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>busybox:1.35</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 容器启动流程：</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 1. 创建健康标志文件</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 2. 等待30秒（模拟正常运行）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 3. 删除文件（模拟故障）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c># 4. 等待600秒（保持容器运行）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>exec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>cat</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=l>/tmp/healthy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>  </span><span class=c># 立即重启</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>执行与观察</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 分发镜像到节点（因使用IfNotPresent策略）</span>
</span></span><span class=line><span class=cl><span class=c1># scp busybox.tar k8s-node1:/root/</span>
</span></span><span class=line><span class=cl><span class=c1># scp busybox.tar k8s-node2:/root/</span>
</span></span><span class=line><span class=cl><span class=c1># ssh k8s-node1 &#34;docker load -i /root/busybox.tar&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># ssh k8s-node2 &#34;docker load -i /root/busybox.tar&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kubectl apply -f liveness-exec.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实时监控Pod状态</span>
</span></span><span class=line><span class=cl>kubectl get pod liveness-exec -w
</span></span><span class=line><span class=cl><span class=c1># 30秒后开始重启：</span>
</span></span><span class=line><span class=cl><span class=c1># NAME            READY   STATUS    RESTARTS   AGE</span>
</span></span><span class=line><span class=cl><span class=c1># liveness-exec   1/1     Running   0          25s</span>
</span></span><span class=line><span class=cl><span class=c1># liveness-exec   1/1     Running   1          40s  # 第一次重启</span>
</span></span><span class=line><span class=cl><span class=c1># liveness-exec   1/1     Running   2          55s  # 第二次重启</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看重启原因</span>
</span></span><span class=line><span class=cl>kubectl describe pod liveness-exec
</span></span><span class=line><span class=cl><span class=c1># Events中显示：Liveness probe failed: cat: can&#39;t open &#39;/tmp/healthy&#39;: No such file or directory</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 清理</span>
</span></span><span class=line><span class=cl>kubectl delete -f liveness-exec.yaml
</span></span></code></pre></td></tr></table></div></div><hr><p><strong>2. HTTPGet探针（检测Web接口）</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness-http</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mydlqclub/springboot-helloworld:0.0.1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/actuator/health </span><span class=w> </span><span class=c># Spring Boot健康检查端点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>              </span><span class=c># 实际端口，文档中8081可能是笔误</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>scheme</span><span class=p>:</span><span class=w> </span><span class=l>HTTP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>   </span><span class=c># 应用启动时间通常较长</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>        </span><span class=c># 请求超时10秒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>       </span><span class=c># 允许3次失败（共15秒）</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>验证健康端点</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 启动Pod</span>
</span></span><span class=line><span class=cl>kubectl apply -f liveness-http.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 等待Pod Running</span>
</span></span><span class=line><span class=cl>kubectl get pod liveness-http -owide
</span></span><span class=line><span class=cl><span class=c1># 获取Pod IP</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 手动测试健康接口</span>
</span></span><span class=line><span class=cl>curl http://10.244.1.5:8080/actuator/health
</span></span><span class=line><span class=cl><span class=c1># 应返回：{&#34;status&#34;:&#34;UP&#34;}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实时查看日志</span>
</span></span><span class=line><span class=cl>kubectl logs -f liveness-http --tail <span class=m>100</span>
</span></span><span class=line><span class=cl><span class=c1># 观察日志确认接口正常响应</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看探针事件</span>
</span></span><span class=line><span class=cl>kubectl describe pod liveness-http <span class=p>|</span> grep -A <span class=m>10</span> Liveness
</span></span></code></pre></td></tr></table></div></div><hr><p><strong>3. TCPSocket探针（端口检测）</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness-tcp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>liveness</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.19.5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>imagePullPolicy</span><span class=p>:</span><span class=w> </span><span class=l>IfNotPresent</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>tcpSocket</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>        </span><span class=c># 只需端口可连接即认为健康</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>20</span><span class=w>   </span><span class=c># 较长间隔，减少资源消耗</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>适用场景</strong>：</p><ul><li>Redis、MySQL等TCP服务</li><li>gRPC服务（无HTTP接口）</li><li>自定义TCP协议服务</li></ul><hr><h3 id=53-探针参数总结与生产建议>5.3 探针参数总结与生产建议</h3><div class=table-wrapper><table><thead><tr><th>参数</th><th>含义</th><th>推荐值</th><th>说明</th></tr></thead><tbody><tr><td><code>initialDelaySeconds</code></td><td>首次探测延迟</td><td>30-120秒</td><td>需大于应用平均启动时间</td></tr><tr><td><code>periodSeconds</code></td><td>探测间隔</td><td>10-30秒</td><td>太频繁增加负载，太稀疏延迟发现问题</td></tr><tr><td><code>timeoutSeconds</code></td><td>超时时间</td><td>3-10秒</td><td>应小于探测间隔</td></tr><tr><td><code>successThreshold</code></td><td>成功阈值</td><td>1</td><td>通常保持1</td></tr><tr><td><code>failureThreshold</code></td><td>失败阈值</td><td>3-5</td><td>避免偶发网络波动导致重启</td></tr><tr><td><code>terminationGracePeriodSeconds</code></td><td>终止宽限期</td><td>30-60秒</td><td>在探针中可覆盖Pod级别的设置</td></tr></tbody></table></div><p><strong>生产环境探针配置最佳实践</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 完整生产配置示例</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/healthz</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>60</span><span class=w>  </span><span class=c># 根据启动时间调整</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>      </span><span class=c># 容忍5次失败（共75秒）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>successThreshold</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>      </span><span class=c># 3次失败后从Service移除</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>startupProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/startup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>failureThreshold</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>     </span><span class=c># 最长容忍300秒启动时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>timeoutSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>常见探针错误排查</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 错误1：Pod不断重启</span>
</span></span><span class=line><span class=cl>kubectl describe pod &lt;pod-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 查看Liveness probe failed事件，检查路径、端口是否正确</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 错误2：Service无法访问</span>
</span></span><span class=line><span class=cl>kubectl get endpoints &lt;svc-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 检查Pod是否通过Readiness probe，未通过不会加入Endpoints</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 错误3：启动慢导致被误杀</span>
</span></span><span class=line><span class=cl><span class=c1># 增加initialDelaySeconds或添加startupProbe</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=第六部分完整生产环境部署案例>第六部分：完整生产环境部署案例</h2><h3 id=61-部署带持久化存储的高可用tomcat应用>6.1 部署带持久化存储的高可用Tomcat应用</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span><span class=lnt>184
</span><span class=lnt>185
</span><span class=lnt>186
</span><span class=lnt>187
</span><span class=lnt>188
</span><span class=lnt>189
</span><span class=lnt>190
</span><span class=lnt>191
</span><span class=lnt>192
</span><span class=lnt>193
</span><span class=lnt>194
</span><span class=lnt>195
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>set</span> -e  <span class=c1># 遇到错误立即退出</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤1：创建命名空间 ===&#34;</span>
</span></span><span class=line><span class=cl>kubectl create ns mall
</span></span><span class=line><span class=cl><span class=c1># 命名空间作用：资源隔离、权限控制、资源配额</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤2：创建PVC ===&#34;</span>
</span></span><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: PersistentVolumeClaim
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: tomcat-data
</span></span></span><span class=line><span class=cl><span class=s>  namespace: mall
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: mall-tomcat
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  accessModes: [&#34;ReadWriteMany&#34;]
</span></span></span><span class=line><span class=cl><span class=s>  storageClassName: nfs
</span></span></span><span class=line><span class=cl><span class=s>  resources:
</span></span></span><span class=line><span class=cl><span class=s>    requests:
</span></span></span><span class=line><span class=cl><span class=s>      storage: 2Gi  # 申请2Gi存储
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=c1># 检查PVC状态</span>
</span></span><span class=line><span class=cl>kubectl get pvc tomcat-data -n mall -w
</span></span><span class=line><span class=cl><span class=c1># 等待状态变为Bound</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤3：创建Secret（数据库密码）===&#34;</span>
</span></span><span class=line><span class=cl>kubectl create secret generic db-pass <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>password</span><span class=o>=</span><span class=s1>&#39;ComplexPass123!ComplexPass123!&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>username</span><span class=o>=</span><span class=s1>&#39;mall_admin&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n mall
</span></span><span class=line><span class=cl><span class=c1># 使用强密码，16位以上，包含大小写、数字、特殊字符</span>
</span></span><span class=line><span class=cl><span class=c1># 检查Secret是否创建</span>
</span></span><span class=line><span class=cl>kubectl get secret db-pass -n mall -o yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤4：创建ConfigMap（应用配置）===&#34;</span>
</span></span><span class=line><span class=cl>kubectl create configmap tomcat-config <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>JAVA_OPTS</span><span class=o>=</span><span class=s1>&#39;-Xmx1024m -Xms1024m -XX:+UseG1GC&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --from-literal<span class=o>=</span><span class=nv>SPRING_PROFILES_ACTIVE</span><span class=o>=</span><span class=s1>&#39;prod&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n mall
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤5：创建Deployment（2副本高可用）===&#34;</span>
</span></span><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: mall-tomcat
</span></span></span><span class=line><span class=cl><span class=s>  namespace: mall
</span></span></span><span class=line><span class=cl><span class=s>  labels:
</span></span></span><span class=line><span class=cl><span class=s>    app: mall-tomcat
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  replicas: 2  # 2副本保证高可用
</span></span></span><span class=line><span class=cl><span class=s>  strategy:
</span></span></span><span class=line><span class=cl><span class=s>    type: RollingUpdate
</span></span></span><span class=line><span class=cl><span class=s>    rollingUpdate:
</span></span></span><span class=line><span class=cl><span class=s>      maxUnavailable: 1
</span></span></span><span class=line><span class=cl><span class=s>      maxSurge: 1
</span></span></span><span class=line><span class=cl><span class=s>  selector:
</span></span></span><span class=line><span class=cl><span class=s>    matchLabels:
</span></span></span><span class=line><span class=cl><span class=s>      app: mall-tomcat
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    metadata:
</span></span></span><span class=line><span class=cl><span class=s>      labels:
</span></span></span><span class=line><span class=cl><span class=s>        app: mall-tomcat
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      imagePullSecrets:
</span></span></span><span class=line><span class=cl><span class=s>      - name: aliyun-registry
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: tomcat
</span></span></span><span class=line><span class=cl><span class=s>        image: registry.cn-hangzhou.aliyuncs.com/fox666/tulingmall-product:0.0.5
</span></span></span><span class=line><span class=cl><span class=s>        imagePullPolicy: IfNotPresent
</span></span></span><span class=line><span class=cl><span class=s>        resources:
</span></span></span><span class=line><span class=cl><span class=s>          requests:
</span></span></span><span class=line><span class=cl><span class=s>            memory: &#34;1Gi&#34;
</span></span></span><span class=line><span class=cl><span class=s>            cpu: &#34;500m&#34;
</span></span></span><span class=line><span class=cl><span class=s>          limits:
</span></span></span><span class=line><span class=cl><span class=s>            memory: &#34;2Gi&#34;
</span></span></span><span class=line><span class=cl><span class=s>            cpu: &#34;1000m&#34;
</span></span></span><span class=line><span class=cl><span class=s>        env:
</span></span></span><span class=line><span class=cl><span class=s>        - name: DB_PASSWORD
</span></span></span><span class=line><span class=cl><span class=s>          valueFrom:
</span></span></span><span class=line><span class=cl><span class=s>            secretKeyRef:
</span></span></span><span class=line><span class=cl><span class=s>              name: db-pass
</span></span></span><span class=line><span class=cl><span class=s>              key: password
</span></span></span><span class=line><span class=cl><span class=s>        - name: DB_USERNAME
</span></span></span><span class=line><span class=cl><span class=s>          valueFrom:
</span></span></span><span class=line><span class=cl><span class=s>            secretKeyRef:
</span></span></span><span class=line><span class=cl><span class=s>              name: db-pass
</span></span></span><span class=line><span class=cl><span class=s>              key: username
</span></span></span><span class=line><span class=cl><span class=s>        - name: JAVA_OPTS
</span></span></span><span class=line><span class=cl><span class=s>          valueFrom:
</span></span></span><span class=line><span class=cl><span class=s>            configMapKeyRef:
</span></span></span><span class=line><span class=cl><span class=s>              name: tomcat-config
</span></span></span><span class=line><span class=cl><span class=s>              key: JAVA_OPTS
</span></span></span><span class=line><span class=cl><span class=s>        ports:
</span></span></span><span class=line><span class=cl><span class=s>        - containerPort: 8080
</span></span></span><span class=line><span class=cl><span class=s>          name: http
</span></span></span><span class=line><span class=cl><span class=s>        volumeMounts:
</span></span></span><span class=line><span class=cl><span class=s>        - name: data
</span></span></span><span class=line><span class=cl><span class=s>          mountPath: /usr/local/tomcat/webapps
</span></span></span><span class=line><span class=cl><span class=s>          subPath: webapps
</span></span></span><span class=line><span class=cl><span class=s>        livenessProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /actuator/health
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 60
</span></span></span><span class=line><span class=cl><span class=s>          periodSeconds: 15
</span></span></span><span class=line><span class=cl><span class=s>          failureThreshold: 5
</span></span></span><span class=line><span class=cl><span class=s>        readinessProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /actuator/ready
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 30
</span></span></span><span class=line><span class=cl><span class=s>          periodSeconds: 5
</span></span></span><span class=line><span class=cl><span class=s>          failureThreshold: 3
</span></span></span><span class=line><span class=cl><span class=s>        startupProbe:
</span></span></span><span class=line><span class=cl><span class=s>          httpGet:
</span></span></span><span class=line><span class=cl><span class=s>            path: /actuator/health
</span></span></span><span class=line><span class=cl><span class=s>            port: 8080
</span></span></span><span class=line><span class=cl><span class=s>          initialDelaySeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>          periodSeconds: 10
</span></span></span><span class=line><span class=cl><span class=s>          failureThreshold: 30
</span></span></span><span class=line><span class=cl><span class=s>      volumes:
</span></span></span><span class=line><span class=cl><span class=s>      - name: data
</span></span></span><span class=line><span class=cl><span class=s>        persistentVolumeClaim:
</span></span></span><span class=line><span class=cl><span class=s>          claimName: tomcat-data
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl><span class=c1># 等待Pod就绪</span>
</span></span><span class=line><span class=cl>kubectl get pod -n mall -w
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤6：创建Service（NodePort暴露）===&#34;</span>
</span></span><span class=line><span class=cl>kubectl expose deployment mall-tomcat <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --name<span class=o>=</span>mall-tomcat-svc <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --port<span class=o>=</span><span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --target-port<span class=o>=</span><span class=m>8080</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --type<span class=o>=</span>NodePort <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  -n mall
</span></span><span class=line><span class=cl><span class=c1># 获取NodePort</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_PORT</span><span class=o>=</span><span class=k>$(</span>kubectl get svc mall-tomcat-svc -n mall -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.ports[0].nodePort}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤7：创建Ingress（域名访问）===&#34;</span>
</span></span><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: networking.k8s.io/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Ingress
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: mall-ingress
</span></span></span><span class=line><span class=cl><span class=s>  namespace: mall
</span></span></span><span class=line><span class=cl><span class=s>  annotations:
</span></span></span><span class=line><span class=cl><span class=s>    nginx.ingress.kubernetes.io/ssl-redirect: &#34;true&#34;
</span></span></span><span class=line><span class=cl><span class=s>    nginx.ingress.kubernetes.io/rate-limit: &#34;100&#34;
</span></span></span><span class=line><span class=cl><span class=s>    cert-manager.io/cluster-issuer: &#34;letsencrypt-prod&#34;  # 自动证书管理
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  ingressClassName: nginx
</span></span></span><span class=line><span class=cl><span class=s>  tls:
</span></span></span><span class=line><span class=cl><span class=s>  - hosts:
</span></span></span><span class=line><span class=cl><span class=s>    - mall.example.com
</span></span></span><span class=line><span class=cl><span class=s>    secretName: mall-tls
</span></span></span><span class=line><span class=cl><span class=s>  rules:
</span></span></span><span class=line><span class=cl><span class=s>  - host: mall.example.com
</span></span></span><span class=line><span class=cl><span class=s>    http:
</span></span></span><span class=line><span class=cl><span class=s>      paths:
</span></span></span><span class=line><span class=cl><span class=s>      - path: /
</span></span></span><span class=line><span class=cl><span class=s>        pathType: Prefix
</span></span></span><span class=line><span class=cl><span class=s>        backend:
</span></span></span><span class=line><span class=cl><span class=s>          service:
</span></span></span><span class=line><span class=cl><span class=s>            name: mall-tomcat-svc
</span></span></span><span class=line><span class=cl><span class=s>            port:
</span></span></span><span class=line><span class=cl><span class=s>              number: 8080
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤8：获取访问地址 ===&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>NODE_IP</span><span class=o>=</span><span class=k>$(</span>kubectl get node -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.items[0].status.addresses[0].address}&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;HTTP访问: http://</span><span class=si>${</span><span class=nv>NODE_IP</span><span class=si>}</span><span class=s2>:</span><span class=si>${</span><span class=nv>NODE_PORT</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;HTTPS访问: https://mall.example.com (需配置DNS和证书)&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 步骤9：配置资源限制 ===&#34;</span>
</span></span><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: v1
</span></span></span><span class=line><span class=cl><span class=s>kind: LimitRange
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: mall-limits
</span></span></span><span class=line><span class=cl><span class=s>  namespace: mall
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  limits:
</span></span></span><span class=line><span class=cl><span class=s>  - default:  # 默认limit
</span></span></span><span class=line><span class=cl><span class=s>      memory: 1Gi
</span></span></span><span class=line><span class=cl><span class=s>      cpu: 500m
</span></span></span><span class=line><span class=cl><span class=s>    defaultRequest:  # 默认request
</span></span></span><span class=line><span class=cl><span class=s>      memory: 512Mi
</span></span></span><span class=line><span class=cl><span class=s>      cpu: 250m
</span></span></span><span class=line><span class=cl><span class=s>    type: Container
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;=== 部署完成 ===&#34;</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=第七部分系统化排错与调试>第七部分：系统化排错与调试</h2><h3 id=71-pod无法启动排错流程>7.1 Pod无法启动排错流程</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 排错三步曲：描述→日志→执行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤1：查看Pod事件（定位问题阶段）</span>
</span></span><span class=line><span class=cl>kubectl describe pod &lt;pod-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 关键事件：</span>
</span></span><span class=line><span class=cl><span class=c1># - FailedScheduling: 调度失败（资源不足、节点亲和性）</span>
</span></span><span class=line><span class=cl><span class=c1># - FailedMount: 挂载失败（PV/PVC问题、NFS不可达）</span>
</span></span><span class=line><span class=cl><span class=c1># - ImagePullBackOff: 镜像拉取失败（认证、网络）</span>
</span></span><span class=line><span class=cl><span class=c1># - CrashLoopBackOff: 容器启动后崩溃（应用错误）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：查看容器日志（定位应用错误）</span>
</span></span><span class=line><span class=cl>kubectl logs &lt;pod-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 查看之前崩溃的日志</span>
</span></span><span class=line><span class=cl>kubectl logs &lt;pod-name&gt; --previous
</span></span><span class=line><span class=cl><span class=c1># 实时跟踪日志</span>
</span></span><span class=line><span class=cl>kubectl logs -f &lt;pod-name&gt; --tail <span class=m>100</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：进入容器内部排查</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod-name&gt; -- /bin/sh
</span></span><span class=line><span class=cl><span class=c1># 在容器内执行：</span>
</span></span><span class=line><span class=cl><span class=c1># - 检查文件权限：ls -l /data</span>
</span></span><span class=line><span class=cl><span class=c1># - 测试网络：curl http://my-tomcat:8080</span>
</span></span><span class=line><span class=cl><span class=c1># - 检查进程：ps aux</span>
</span></span><span class=line><span class=cl><span class=c1># - 查看资源：df -h, free -m</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>常见Pod状态分析</strong>：</p><ul><li><strong>Pending</strong>：调度失败，检查describe events和StorageClass</li><li><strong>ContainerCreating</strong>：镜像拉取或存储挂载中，等待或检查网络</li><li><strong>CrashLoopBackOff</strong>：容器崩溃重启，查看logs &ndash;previous</li><li><strong>ImagePullBackOff</strong>：镜像问题，检查镜像名、Secret、网络</li><li><strong>Terminating</strong>：删除中，可能卡在finalizer，需强制删除</li></ul><hr><h3 id=72-service无法访问排错>7.2 Service无法访问排错</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 步骤1：检查Service是否存在且类型正确</span>
</span></span><span class=line><span class=cl>kubectl get svc &lt;svc-name&gt; -o wide
</span></span><span class=line><span class=cl><span class=c1># 检查CLUSTER-IP、PORT(S)、TYPE</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：检查Endpoints是否包含Pod IP</span>
</span></span><span class=line><span class=cl>kubectl get endpoints &lt;svc-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 输出应包含后端Pod IP和端口</span>
</span></span><span class=line><span class=cl><span class=c1># 如果为空，检查：</span>
</span></span><span class=line><span class=cl><span class=c1># - Pod的label是否与Service的selector匹配</span>
</span></span><span class=line><span class=cl><span class=c1># - Pod是否通过ReadinessProbe（未通过不会加入Endpoints）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：从集群内测试Service连通性</span>
</span></span><span class=line><span class=cl>kubectl run debug-tool --rm -it --image<span class=o>=</span>busybox --restart<span class=o>=</span>Never -- wget -O- &lt;svc-name&gt;:&lt;port&gt;
</span></span><span class=line><span class=cl><span class=c1># 或使用curl镜像</span>
</span></span><span class=line><span class=cl>kubectl run curl-test --rm -it --image<span class=o>=</span>curlimages/curl --restart<span class=o>=</span>Never -- curl &lt;svc-name&gt;:&lt;port&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4：检查kube-proxy和iptables</span>
</span></span><span class=line><span class=cl><span class=c1># 在节点上执行</span>
</span></span><span class=line><span class=cl>iptables-save <span class=p>|</span> grep &lt;svc-ip&gt;  <span class=c1># Service IP</span>
</span></span><span class=line><span class=cl><span class=c1># 查看KUBE-SERVICES链和DNAT规则</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5：检查CNI网络</span>
</span></span><span class=line><span class=cl>kubectl get pod -o wide  <span class=c1># 确认Pod IP分配正常</span>
</span></span><span class=line><span class=cl><span class=c1># 在节点上ping Pod IP</span>
</span></span><span class=line><span class=cl>ping &lt;pod-ip&gt;
</span></span><span class=line><span class=cl><span class=c1># 使用tcpdump抓包</span>
</span></span><span class=line><span class=cl>tcpdump -i any port &lt;port&gt; -nn
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=73-存储问题排错>7.3 存储问题排错</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 步骤1：查看PV/PVC绑定状态</span>
</span></span><span class=line><span class=cl>kubectl get pv,pvc -A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：检查PVC绑定详情</span>
</span></span><span class=line><span class=cl>kubectl describe pvc &lt;pvc-name&gt; -n &lt;namespace&gt;
</span></span><span class=line><span class=cl><span class=c1># 关键信息：</span>
</span></span><span class=line><span class=cl><span class=c1># - Capacity: 容量</span>
</span></span><span class=line><span class=cl><span class=c1># - Access Modes: 访问模式</span>
</span></span><span class=line><span class=cl><span class=c1># - Volume: 绑定的PV名称</span>
</span></span><span class=line><span class=cl><span class=c1># - Events: 绑定失败原因</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：检查PV状态</span>
</span></span><span class=line><span class=cl>kubectl describe pv &lt;pv-name&gt;
</span></span><span class=line><span class=cl><span class=c1># 检查：</span>
</span></span><span class=line><span class=cl><span class=c1># - Status: 是否为Available或Bound</span>
</span></span><span class=line><span class=cl><span class=c1># - Claim: 绑定的PVC</span>
</span></span><span class=line><span class=cl><span class=c1># - Capacity: 容量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4：在节点检查NFS挂载</span>
</span></span><span class=line><span class=cl>df -h <span class=p>|</span> grep nfs
</span></span><span class=line><span class=cl><span class=c1># 检查挂载是否成功</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5：测试NFS写入权限</span>
</span></span><span class=line><span class=cl>touch /nfs/data/test.txt
</span></span><span class=line><span class=cl><span class=c1># 检查权限和所有者</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤6：查看Pod挂载详情</span>
</span></span><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -o yaml <span class=p>|</span> grep volumeMounts -A <span class=m>5</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>常见存储问题</strong>：</p><ul><li><strong>PVC Pending</strong>：无可用PV，检查storageClassName、accessModes、容量</li><li><strong>FailedMount</strong>：挂载失败，检查NFS服务、路径、权限</li><li><strong>Permission denied</strong>：NFS权限问题，检查exports和目录chmod</li></ul><hr><h3 id=74-网络问题排错>7.4 网络问题排错</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 步骤1：检查Pod IP分配</span>
</span></span><span class=line><span class=cl>kubectl get pod -o wide
</span></span><span class=line><span class=cl><span class=c1># 确认IP在集群CIDR范围内</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤2：检查Service IP</span>
</span></span><span class=line><span class=cl>kubectl get svc -o wide
</span></span><span class=line><span class=cl><span class=c1># 确认CLUSTER-IP在service-cluster-ip-range范围内</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤3：测试Pod间通信</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it pod-a -- ping &lt;pod-b-ip&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤4：检查CoreDNS</span>
</span></span><span class=line><span class=cl>kubectl get pod -n kube-system -l k8s-app<span class=o>=</span>kube-dns
</span></span><span class=line><span class=cl><span class=c1># 测试DNS解析</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it pod-a -- nslookup my-tomcat.default.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤5：抓包分析</span>
</span></span><span class=line><span class=cl><span class=c1># 在源Pod所在节点</span>
</span></span><span class=line><span class=cl>tcpdump -i cni0 host &lt;src-pod-ip&gt; and host &lt;dst-pod-ip&gt; -nn
</span></span><span class=line><span class=cl><span class=c1># cni0: CNI网桥接口</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 步骤6：检查路由</span>
</span></span><span class=line><span class=cl>ip route show
</span></span><span class=line><span class=cl><span class=c1># 检查Pod网段路由是否正确</span>
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=75-强制删除资源>7.5 强制删除资源</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Pod卡在Terminating状态</span>
</span></span><span class=line><span class=cl>kubectl delete pod &lt;pod-name&gt; --grace-period<span class=o>=</span><span class=m>0</span> --force
</span></span><span class=line><span class=cl><span class=c1># --grace-period=0: 立即删除，不等待优雅退出</span>
</span></span><span class=line><span class=cl><span class=c1># --force: 强制删除，绕过apiserver直接操作etcd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除namespace卡在Terminating</span>
</span></span><span class=line><span class=cl>kubectl get ns &lt;ns-name&gt; -o json <span class=p>|</span> jq <span class=s1>&#39;.spec.finalizers = []&#39;</span> <span class=p>|</span> kubectl replace --raw /api/v1/namespaces/&lt;ns-name&gt;/finalize -f -
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除PV卡在Released状态</span>
</span></span><span class=line><span class=cl>kubectl patch pv &lt;pv-name&gt; -p <span class=s1>&#39;{&#34;spec&#34;:{&#34;claimRef&#34;: null}}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>⚠️ 强制删除风险</strong>：可能导致数据不一致、资源泄漏，生产环境慎用，优先解决根本原因。</p><hr><h2 id=总结与最佳实践>总结与最佳实践</h2><h3 id=kubernetes核心设计思想>Kubernetes核心设计思想</h3><ul><li><strong>分层解耦</strong>：Pod（应用）、Deployment（运维）、Service（访问）、PV/PVC（存储）、Secret（配置）、Ingress（入口）各层独立</li><li><strong>声明式API</strong>：描述期望状态，系统自动调和实际状态</li><li><strong>自愈能力</strong>：通过探针、控制器实现自动恢复</li><li><strong>弹性伸缩</strong>：手动或自动扩缩容应对负载变化</li></ul><h3 id=生产环境-checklist>生产环境 checklist</h3><ul><li>✅ 所有Pod设置resources limits</li><li>✅ 使用PV/PVC持久化数据，避免emptyDir/empty</li><li>✅ 配置liveness/readiness/startup探针</li><li>✅ 使用Secret管理敏感信息，避免明文</li><li>✅ 镜像使用固定tag，避免latest</li><li>✅ 启用RBAC限制权限</li><li>✅ 配置PodDisruptionBudget保障可用性</li><li>✅ 使用Namespace隔离环境</li><li>✅ 配置资源配额（ResourceQuota）</li><li>✅ 使用NetworkPolicy限制网络访问</li><li>✅ 启用审计日志（Audit Log）</li><li>✅ 配置监控告警（Prometheus+Grafana）</li><li>✅ 定期备份etcd数据</li></ul><h3 id=推荐学习路径>推荐学习路径</h3><ol><li>掌握Pod基础与生命周期</li><li>理解PV/PVC存储体系</li><li>熟练使用Deployment/StatefulSet</li><li>配置Service和Ingress</li><li>实现健康检查与自愈</li><li>配置RBAC和安全策略</li><li>部署监控日志系统</li><li>实践CI/CD流水线</li></ol><hr><p><strong>文档结束语</strong>：Kubernetes是一个复杂的分布式系统，掌握其核心概念和最佳实践需要持续学习和实践。建议从简单的Pod开始，逐步深入到控制器、存储、网络、安全等各个层面，结合实际项目不断积累经验。</p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>本文采用 CC BY-NC-SA 4.0 许可协议</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/posts/kali/><div class=article-details><h2 class=article-title>Kali</h2></div></a></article><article><a href=/k8s/kubernetes-k8s-/><div class=article-details><h2 class=article-title>Kubernetes</h2></div></a></article><article><a href=/k8s/pod%E6%8E%92%E6%9F%A5%E6%89%8B%E5%86%8C/><div class=article-details><h2 class=article-title>Kubernetes Pod</h2></div></a></article><article><a href=/posts/linux%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90/><div class=article-details><h2 class=article-title>linux日志分析</h2></div></a></article><article><a href=/posts/gitgithub/><div class=article-details><h2 class=article-title>Git&amp;Github</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo data-repo-id data-category data-category-id data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2025 © 2025 win. 保留所有权利.</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>