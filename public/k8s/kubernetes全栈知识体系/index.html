<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Kubernetes全栈知识体系\n第一部分：核心架构与原理 1.1 Kubernetes 定义与架构 Kubernetes 是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。\n集群架构（Control Plane - Node Model）：\n"><title>Kubernetes全栈知识体系</title><link rel=canonical href=http://localhost:1313/k8s/kubernetes%E5%85%A8%E6%A0%88%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Kubernetes全栈知识体系"><meta property='og:description' content="Kubernetes全栈知识体系\n第一部分：核心架构与原理 1.1 Kubernetes 定义与架构 Kubernetes 是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。\n集群架构（Control Plane - Node Model）：\n"><meta property='og:url' content='http://localhost:1313/k8s/kubernetes%E5%85%A8%E6%A0%88%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/'><meta property='og:site_name' content='JustWin'><meta property='og:type' content='article'><meta property='article:section' content='K8s'><meta property='article:published_time' content='2025-12-07T00:00:00+00:00'><meta property='article:modified_time' content='2025-12-07T00:00:00+00:00'><meta property='og:image' content='http://localhost:1313/'><meta name=twitter:title content="Kubernetes全栈知识体系"><meta name=twitter:description content="Kubernetes全栈知识体系\n第一部分：核心架构与原理 1.1 Kubernetes 定义与架构 Kubernetes 是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。\n集群架构（Control Plane - Node Model）：\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='http://localhost:1313/'><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/avatar_hu_89ca753ea8ea85c7.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>✍️</span></figure><div class=site-meta><h1 class=site-name><a href=/>JustWin</a></h1><h2 class=site-description>分享技术与生活</h2></div></header><ol class=menu-social><li><a href=https://github.com/passion-win target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="0 0 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>github [#142]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M94 7399C99.523 7399 104 7403.59 104 7409.253 104 7413.782 101.138 7417.624 97.167 7418.981 96.66 7419.082 96.48 7418.762 96.48 7418.489 96.48 7418.151 96.492 7417.047 96.492 7415.675 96.492 7414.719 96.172 7414.095 95.813 7413.777 98.04 7413.523 100.38 7412.656 100.38 7408.718 100.38 7407.598 99.992 7406.684 99.35 7405.966 99.454 7405.707 99.797 7404.664 99.252 7403.252 99.252 7403.252 98.414 7402.977 96.505 7404.303 95.706 7404.076 94.85 7403.962 94 7403.958 93.15 7403.962 92.295 7404.076 91.497 7404.303 89.586 7402.977 88.746 7403.252 88.746 7403.252 88.203 7404.664 88.546 7405.707 88.649 7405.966 88.01 7406.684 87.619 7407.598 87.619 7408.718 87.619 7412.646 89.954 7413.526 92.175 7413.785 91.889 7414.041 91.63 7414.493 91.54 7415.156 90.97 7415.418 89.522 7415.871 88.63 7414.304 88.63 7414.304 88.101 7413.319 87.097 7413.247 87.097 7413.247 86.122 7413.234 87.029 7413.87 87.029 7413.87 87.684 7414.185 88.139 7415.37 88.139 7415.37 88.726 7417.2 91.508 7416.58 91.513 7417.437 91.522 7418.245 91.522 7418.489 91.522 7418.76 91.338 7419.077 90.839 7418.982 86.865 7417.627 84 7413.783 84 7409.253 84 7403.59 88.478 7399 94 7399" id="github-[#142]"/></g></g></g></svg></a></li><li><a href=https://t.me/+TFjBeZzowwU1YTY1 target=_blank title=telegram rel=me><svg viewBox="0 0 640 640"><path d="M320 72C183 72 72 183 72 320S183 568 320 568 568 457 568 320 457 72 320 72zM435 240.7C431.3 279.9 415.1 375.1 406.9 419c-3.5 18.6-10.3 24.8-16.9 25.4C375.6 445.7 364.7 434.9 350.7 425.7c-21.8-14.3-34.2-23.2-55.3-37.2C270.9 372.4 286.8 363.5 300.7 349 304.4 345.2 367.8 287.5 369 282.3 369.2 281.6 369.3 279.2 367.8 277.9 366.3 276.6 364.2 277.1 362.7 277.4 360.5 277.9 325.6 300.9 258.1 346.5 248.2 353.3 239.2 356.6 231.2 356.4 222.3 356.2 205.3 351.4 192.6 347.3 177.1 342.3 164.7 339.6 165.8 331 166.4 326.5 172.5 322 184.2 317.3 256.5 285.8 304.7 265 328.8 255c68.9-28.6 83.2-33.6 92.5-33.8C423.4 221.2 427.9 221.7 430.9 224.1 432.9 225.8 434.1 228.2 434.4 230.8 434.9 234 435 237.3 434.8 240.6z"/></svg></a></li><li><a href=https://twitter.com/@win1688888888 target=_blank title=twitter rel=me><svg width="800" height="800" viewBox="0 -2 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>twitter [#154]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-60.000000, -7521.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M10.29 7377C17.837 7377 21.965 7370.84365 21.965 7365.50546 21.965 7365.33021 21.965 7365.15595 21.953 7364.98267 22.756 7364.41163 23.449 7363.70276 24 7362.8915 23.252 7363.21837 22.457 7363.433 21.644 7363.52751 22.5 7363.02244 23.141 7362.2289 23.448 7361.2926 22.642 7361.76321 21.761 7362.095 20.842 7362.27321 19.288 7360.64674 16.689 7360.56798 15.036 7362.09796 13.971 7363.08447 13.518 7364.55538 13.849 7365.95835 10.55 7365.79492 7.476 7364.261 5.392 7361.73762 4.303 7363.58363 4.86 7365.94457 6.663 7367.12996 6.01 7367.11125 5.371 7366.93797 4.8 7366.62489V7366.67608C4.801 7368.5989 6.178 7370.2549 8.092 7370.63591 7.488 7370.79836 6.854 7370.82199 6.24 7370.70483 6.777 7372.35099 8.318 7373.47829 10.073 7373.51078 8.62 7374.63513 6.825 7375.24554 4.977 7375.24358 4.651 7375.24259 4.325 7375.22388 4 7375.18549 5.877 7376.37088 8.06 7377 10.29 7376.99705" id="twitter-[#154]"/></g></g></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><span>首页</span></a></li><li><a href=/links/><span>网站</span></a></li><li><a href=/linux/><span>Linux</span></a></li><li><a href=/docker/><span>docker</span></a></li><li><a href=/k8s/><span>k8s</span></a></li><li><a href=/mysql/><span>mysql</span></a></li><li><a href=/project/><span>项目</span></a></li><li><a href=/about/><span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=http://localhost:1313/ selected>中文</option><option value=http://localhost:1313/en/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#第一部分核心架构与原理>第一部分：核心架构与原理</a><ol><li><a href=#11-kubernetes-定义与架构>1.1 Kubernetes 定义与架构</a></li><li><a href=#12-pod-核心原理与创建全流程>1.2 Pod 核心原理与创建全流程</a></li></ol></li><li><a href=#第二部分生产级集群部署>第二部分：生产级集群部署</a><ol><li><a href=#21-部署方式选择>2.1 部署方式选择</a></li><li><a href=#22-kubeadm-部署关键步骤centosubuntu>2.2 Kubeadm 部署关键步骤（CentOS/Ubuntu）</a></li></ol></li><li><a href=#第三部分工作负载与调度管理>第三部分：工作负载与调度管理</a><ol><li><a href=#31-deployment无状态应用管理>3.1 Deployment：无状态应用管理</a></li><li><a href=#32-健康检查probes>3.2 健康检查（Probes）</a></li><li><a href=#33-其他工作负载>3.3 其他工作负载</a></li></ol></li><li><a href=#第四部分存储体系>第四部分：存储体系</a><ol><li><a href=#41-存储分层概念>4.1 存储分层概念</a></li><li><a href=#42-常用存储类型实战>4.2 常用存储类型实战</a></li></ol></li><li><a href=#第五部分网络与服务暴露>第五部分：网络与服务暴露</a><ol><li><a href=#51-service-类型对比>5.1 Service 类型对比</a></li><li><a href=#52-ingress统一入口>5.2 Ingress（统一入口）</a></li></ol></li><li><a href=#第六部分配置管理与安全>第六部分：配置管理与安全</a><ol><li><a href=#61-configmap-与-secret>6.1 ConfigMap 与 Secret</a></li><li><a href=#62-rbac-权限控制>6.2 RBAC 权限控制</a></li></ol></li><li><a href=#第七部分系统化排错与诊断>第七部分：系统化排错与诊断</a><ol><li><a href=#71-核心排错命令三剑客>7.1 核心排错命令三剑客</a></li><li><a href=#72-常见状态故障排查>7.2 常见状态故障排查</a></li><li><a href=#73-网络与-service-排错>7.3 网络与 Service 排错</a></li></ol></li><li><a href=#第八部分生产环境最佳实践清单>第八部分：生产环境最佳实践清单</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category></header><div class=article-title-wrapper><h2 class=article-title><a href=/k8s/kubernetes%E5%85%A8%E6%A0%88%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/>Kubernetes全栈知识体系</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-12-07</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 6 分钟</time></div></footer></div></header><section class=article-content><p>Kubernetes全栈知识体系</p><h2 id=第一部分核心架构与原理>第一部分：核心架构与原理</h2><h3 id=11-kubernetes-定义与架构>1.1 Kubernetes 定义与架构</h3><p>Kubernetes 是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。</p><p><strong>集群架构（Control Plane - Node Model）</strong>：</p><ul><li><strong>Master 节点（控制平面）</strong>：<ul><li><strong>kube-apiserver</strong>：集群统一入口，处理 REST API 请求，负责认证鉴权。</li><li><strong>kube-controller-manager</strong>：运行核心控制器（如 Node、Replication 控制器），维持集群期望状态。</li><li><strong>kube-scheduler</strong>：负责 Pod 调度，根据资源、亲和性等策略选择最优节点。</li><li><strong>etcd</strong>：分布式键值存储，保存集群所有状态数据，是集群的“大脑”。</li></ul></li><li><strong>Node 节点（工作节点）</strong>：<ul><li><strong>kubelet</strong>：节点代理，管理 Pod 生命周期，执行健康检查。</li><li><strong>kube-proxy</strong>：维护网络规则（iptables/IPVS），实现 Service 负载均衡。</li><li><strong>容器运行时</strong>：如 containerd 或 Docker，负责运行容器。</li></ul></li></ul><h3 id=12-pod-核心原理与创建全流程>1.2 Pod 核心原理与创建全流程</h3><p>Pod 是 K8s 的最小调度单元。一个 Pod 创建的完整流程如下：</p><ol><li><strong>客户端提交</strong>：kubectl 向 apiserver 发送 REST API 请求。</li><li><strong>验证存储</strong>：apiserver 认证鉴权后将 metadata 存入 etcd（状态 Pending）。</li><li><strong>调度决策</strong>：scheduler 监听到新 Pod，执行**预选（Predicate）<strong>和</strong>优选（Priority）**算法选择节点。</li><li><strong>绑定节点</strong>：apiserver 更新 Pod 的 <code>nodeName</code> 字段并写入 etcd。</li><li><strong>节点执行</strong>：目标节点的 kubelet 监听到绑定事件。</li><li><strong>容器启动</strong>：kubelet 调用 CRI（容器运行时接口）拉取镜像、启动容器；调用 CNI（网络接口）分配 IP。</li><li><strong>状态上报</strong>：kubelet 执行健康检查，更新状态为 Running。</li></ol><hr><h2 id=第二部分生产级集群部署>第二部分：生产级集群部署</h2><h3 id=21-部署方式选择>2.1 部署方式选择</h3><ul><li><strong>Minikube</strong>：单节点，适合本地学习。</li><li><strong>Kubeadm</strong>：官方推荐，支持高可用，适合生产和测试。</li><li><strong>二进制部署</strong>：手动配置所有组件，极度灵活但维护成本高。</li></ul><h3 id=22-kubeadm-部署关键步骤centosubuntu>2.2 Kubeadm 部署关键步骤（CentOS/Ubuntu）</h3><ol><li><p><strong>环境准备</strong>：关闭 Swap、SELinux、防火墙；配置内核参数（开启 IP 转发和 bridge-nf）。</p></li><li><p><strong>安装运行时</strong>：推荐使用 <strong>containerd</strong>，需配置 <code>SystemdCgroup = true</code>。</p></li><li><p><strong>初始化 Master</strong>：</p><p>Bash</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kubeadm init --apiserver-advertise-address=&lt;MasterIP&gt; --pod-network-cidr=10.244.0.0/16 --image-repository=registry.aliyuncs.com/google_containers
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>安装网络插件</strong>：常用 Calico（适合大规模、支持策略）或 Flannel（简单 overlay）。</p></li><li><p><strong>节点加入</strong>：在 Worker 节点执行 <code>kubeadm join</code> 命令。</p></li></ol><hr><h2 id=第三部分工作负载与调度管理>第三部分：工作负载与调度管理</h2><h3 id=31-deployment无状态应用管理>3.1 Deployment：无状态应用管理</h3><p>Deployment 提供副本控制、滚动更新和回滚能力。</p><p><strong>生产级配置示例</strong>：</p><p>YAML</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>apiVersion: apps/v1
</span></span><span class=line><span class=cl>kind: Deployment
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  replicas: 3
</span></span><span class=line><span class=cl>  strategy:
</span></span><span class=line><span class=cl>    type: RollingUpdate
</span></span><span class=line><span class=cl>    rollingUpdate:
</span></span><span class=line><span class=cl>      maxUnavailable: 1  # 更新时最大不可用数
</span></span><span class=line><span class=cl>      maxSurge: 1        # 更新时最大激增数
</span></span><span class=line><span class=cl>  template:
</span></span><span class=line><span class=cl>    spec:
</span></span><span class=line><span class=cl>      affinity:          # 亲和性调度
</span></span><span class=line><span class=cl>        podAntiAffinity: # Pod反亲和（避免单点故障）
</span></span><span class=line><span class=cl>          preferredDuringSchedulingIgnoredDuringExecution:
</span></span><span class=line><span class=cl>          - weight: 100
</span></span><span class=line><span class=cl>            podAffinityTerm:
</span></span><span class=line><span class=cl>              labelSelector:
</span></span><span class=line><span class=cl>                matchLabels:
</span></span><span class=line><span class=cl>                  app: my-app
</span></span><span class=line><span class=cl>              topologyKey: kubernetes.io/hostname
</span></span><span class=line><span class=cl>      containers:
</span></span><span class=line><span class=cl>      - name: app
</span></span><span class=line><span class=cl>        resources:       # 必须配置资源限制
</span></span><span class=line><span class=cl>          requests: {memory: &#34;512Mi&#34;, cpu: &#34;250m&#34;}
</span></span><span class=line><span class=cl>          limits:   {memory: &#34;1Gi&#34;, cpu: &#34;500m&#34;}
</span></span></code></pre></td></tr></table></div></div><h3 id=32-健康检查probes>3.2 健康检查（Probes）</h3><p>K8s 提供三种探针，生产环境建议全部配置：</p><ol><li><strong>LivenessProbe（存活探针）</strong>：检测容器是否死锁。失败则<strong>重启容器</strong>。</li><li><strong>ReadinessProbe（就绪探针）</strong>：检测服务是否可用。失败则<strong>从 Service Endpoints 移除</strong>，不接收流量。</li><li><strong>StartupProbe（启动探针）</strong>：保护启动慢的应用。成功前抑制其他探针，避免启动中被误杀。</li></ol><h3 id=33-其他工作负载>3.3 其他工作负载</h3><ul><li><strong>StatefulSet</strong>：管理有状态应用（如 MySQL），提供稳定网络标识（web-0, web-1）和有序部署。</li><li><strong>DaemonSet</strong>：在每个节点运行一个副本（如日志采集 Fluentd、监控 NodeExporter）。</li></ul><hr><h2 id=第四部分存储体系>第四部分：存储体系</h2><h3 id=41-存储分层概念>4.1 存储分层概念</h3><ul><li><strong>Volume</strong>：Pod 内部存储，随 Pod 生命周期消亡。</li><li><strong>PV (PersistentVolume)</strong>：集群级资源，由管理员创建。</li><li><strong>PVC (PersistentVolumeClaim)</strong>：用户对存储的申请请求。</li><li><strong>StorageClass</strong>：定义存储类型，实现动态自动创建 PV。</li></ul><h3 id=42-常用存储类型实战>4.2 常用存储类型实战</h3><ol><li><p><strong>emptyDir</strong>：</p><ul><li><strong>特点</strong>：临时存储，Pod 删除数据即丢失。</li><li><strong>场景</strong>：缓存、日志收集 sidecar 共享数据。</li></ul></li><li><p><strong>hostPath</strong>：</p><ul><li><strong>特点</strong>：挂载节点本地文件系统。</li><li><strong>风险</strong>：Pod 漂移后数据丢失，存在安全风险。</li><li><strong>场景</strong>：监控、日志采集类 DaemonSet。</li></ul></li><li><p><strong>NFS（网络存储）</strong>：</p><ul><li><strong>实战</strong>：需在 Master 部署 NFS Server，Node 安装 <code>nfs-utils</code>。</li><li><strong>PV 配置</strong>：</li></ul><p>YAML</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>apiVersion: v1
</span></span><span class=line><span class=cl>kind: PersistentVolume
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  capacity: {storage: 1Gi}
</span></span><span class=line><span class=cl>  accessModes: [ReadWriteMany] # 支持多节点读写
</span></span><span class=line><span class=cl>  nfs:
</span></span><span class=line><span class=cl>    path: /nfs/data
</span></span><span class=line><span class=cl>    server: 192.168.200.100
</span></span></code></pre></td></tr></table></div></div></li></ol><hr><h2 id=第五部分网络与服务暴露>第五部分：网络与服务暴露</h2><h3 id=51-service-类型对比>5.1 Service 类型对比</h3><div class=table-wrapper><table><thead><tr><th><strong>类型</strong></th><th><strong>描述</strong></th><th><strong>适用场景</strong></th></tr></thead><tbody><tr><td><strong>ClusterIP</strong></td><td>默认，仅集群内访问</td><td>内部微服务调用</td></tr><tr><td><strong>NodePort</strong></td><td>开放节点静态端口 (30000-32767)</td><td>开发测试，非 HTTP 业务</td></tr><tr><td><strong>LoadBalancer</strong></td><td>需云厂商支持，分配公网 IP</td><td>公有云生产环境</td></tr><tr><td><strong>ExternalName</strong></td><td>映射到外部 DNS</td><td>访问集群外服务</td></tr></tbody></table></div><h3 id=52-ingress统一入口>5.2 Ingress（统一入口）</h3><p>Ingress 是 HTTP/HTTPS 的路由规则，需配合 Ingress Controller（如 Nginx）使用。</p><p><strong>生产级 Nginx Ingress 部署</strong>：</p><ul><li><p><strong>模式</strong>：建议使用 <code>hostNetwork: true</code>，直接监听节点 80/443 端口，减少 NAT 性能损耗。</p></li><li><p><strong>功能</strong>：支持 URL 重写、SSL 卸载、限流、黑白名单。</p></li><li><p><strong>YAML 示例</strong>：</p><p>YAML</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>apiVersion: networking.k8s.io/v1
</span></span><span class=line><span class=cl>kind: Ingress
</span></span><span class=line><span class=cl>metadata:
</span></span><span class=line><span class=cl>  annotations:
</span></span><span class=line><span class=cl>    nginx.ingress.kubernetes.io/ssl-redirect: &#34;true&#34;
</span></span><span class=line><span class=cl>spec:
</span></span><span class=line><span class=cl>  rules:
</span></span><span class=line><span class=cl>  - host: app.example.com
</span></span><span class=line><span class=cl>    http:
</span></span><span class=line><span class=cl>      paths:
</span></span><span class=line><span class=cl>      - path: /
</span></span><span class=line><span class=cl>        pathType: Prefix
</span></span><span class=line><span class=cl>        backend:
</span></span><span class=line><span class=cl>          service: {name: my-svc, port: {number: 80}}
</span></span></code></pre></td></tr></table></div></div></li></ul><hr><h2 id=第六部分配置管理与安全>第六部分：配置管理与安全</h2><h3 id=61-configmap-与-secret>6.1 ConfigMap 与 Secret</h3><ul><li><strong>ConfigMap</strong>：明文存储非敏感配置（如配置文件、环境变量）。</li><li><strong>Secret</strong>：Base64 编码存储敏感信息（密码、证书）。<ul><li><strong>最佳实践</strong>：推荐使用 <strong>Volume 挂载</strong>方式使用 Secret，支持<strong>热更新</strong>（kubelet 周期性同步），而环境变量方式必须重启 Pod。</li></ul></li></ul><h3 id=62-rbac-权限控制>6.2 RBAC 权限控制</h3><ul><li><strong>Role/ClusterRole</strong>：定义权限集合（Rules）。</li><li><strong>RoleBinding/ClusterBinding</strong>：将角色绑定到用户或 ServiceAccount。</li></ul><hr><h2 id=第七部分系统化排错与诊断>第七部分：系统化排错与诊断</h2><h3 id=71-核心排错命令三剑客>7.1 核心排错命令三剑客</h3><ol><li><strong><code>kubectl get pods</code></strong>：查看状态（Pending/CrashLoopBackOff）。</li><li><strong><code>kubectl describe pod </code></strong>：<strong>最关键一步</strong>，查看 Events 事件（调度失败、镜像拉取失败、挂载失败）。</li><li><strong><code>kubectl logs </code></strong>：查看应用内部日志。<ul><li>若容器频繁重启，使用 <code>kubectl logs -p </code>查看<strong>上一次</strong>崩溃的日志。</li></ul></li></ol><h3 id=72-常见状态故障排查>7.2 常见状态故障排查</h3><div class=table-wrapper><table><thead><tr><th><strong>状态</strong></th><th><strong>常见原因</strong></th><th><strong>排查与解决</strong></th></tr></thead><tbody><tr><td><strong>Pending</strong></td><td>资源不足、污点限制、PVC未绑定</td><td>检查 <code>describe</code> 中的 Events；检查节点资源；检查 StorageClass。</td></tr><tr><td><strong>ImagePullBackOff</strong></td><td>镜像名错误、认证失败、网络问题</td><td>检查镜像名称；检查 Secret 是否配置正确；手动在节点 docker pull 测试。</td></tr><tr><td><strong>CrashLoopBackOff</strong></td><td>应用启动报错、配置错误、探针失败</td><td>查看 <code>logs</code> 和 <code>logs --previous</code>；检查 ConfigMap 挂载；调整探针阈值。</td></tr><tr><td><strong>NotReady</strong></td><td>就绪探针失败</td><td>检查应用端口是否监听；检查 ReadinessProbe 路径是否正确。</td></tr><tr><td><strong>Terminating</strong></td><td>finalizer 卡住、挂载无法卸载</td><td>检查存储连接；强制删除：<code>kubectl delete pod --force --grace-period=0</code>。</td></tr></tbody></table></div><h3 id=73-网络与-service-排错>7.3 网络与 Service 排错</h3><ol><li><strong>检查 Endpoints</strong>：<code>kubectl get endpoints </code>，若为空，说明 Pod 标签未匹配或 Pod 未就绪。</li><li><strong>测试连通性</strong>：使用 <code>busybox</code> 容器在集群内 <code>curl :</code>。</li><li><strong>检查 DNS</strong>：<code>nslookup </code>，检查 CoreDNS 状态。</li></ol><hr><h2 id=第八部分生产环境最佳实践清单>第八部分：生产环境最佳实践清单</h2><ol><li><strong>资源管理</strong>：所有 Pod 必须设置 request（调度保障）和 limits（防止 OOM）。</li><li><strong>高可用</strong>：<ul><li>Master 节点至少 3 个。</li><li>关键应用多副本 + <code>podAntiAffinity</code> 强制反亲和。</li></ul></li><li><strong>安全性</strong>：<ul><li>镜像不使用 <code>:latest</code> 标签。</li><li>启用 RBAC，遵循最小权限原则。</li><li>敏感信息必须使用 Secret，甚至结合 Vault。</li></ul></li><li><strong>监控运维</strong>：<ul><li>部署 Prometheus + Grafana 监控集群和应用指标。</li><li>部署 EFK（Elasticsearch, Fluentd, Kibana）统一收集日志。</li><li>定期备份 etcd 数据。</li></ul></li></ol></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>本文采用 CC BY-NC-SA 4.0 许可协议</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/linux/vmware-ubuntu/><div class=article-details><h2 class=article-title>Ubuntu</h2></div></a></article><article><a href=/project/%E9%A1%B9%E7%9B%AE04centos%E9%83%A8%E7%BD%B2mha/><div class=article-details><h2 class=article-title>centos部署MHA</h2></div></a></article><article><a href=/docker/docker%E6%BA%90/><div class=article-details><h2 class=article-title>docker源</h2></div></a></article><article><a href=/linux/%E4%BF%AE%E6%94%B9%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE/><div class=article-details><h2 class=article-title>修改网络配置</h2></div></a></article><article><a href=/posts/%E6%8A%80%E6%9C%AF%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B/><div class=article-details><h2 class=article-title>技术文件类型</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo data-repo-id data-category data-category-id data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2025 © 2025 win. 保留所有权利.</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>