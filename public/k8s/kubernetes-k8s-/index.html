<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Kubernetes (K8s) 完整指南 本文档基于 Kubernetes 2024 年版本整理，涵盖从基础概念到生产实践的完整知识体系。\n1. Kubernetes 概述 1.1 什么是 Kubernetes Kubernetes（K8s）是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。它提供了：\n"><title>Kubernetes</title><link rel=canonical href=http://localhost:1313/k8s/kubernetes-k8s-/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Kubernetes"><meta property='og:description' content="Kubernetes (K8s) 完整指南 本文档基于 Kubernetes 2024 年版本整理，涵盖从基础概念到生产实践的完整知识体系。\n1. Kubernetes 概述 1.1 什么是 Kubernetes Kubernetes（K8s）是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。它提供了：\n"><meta property='og:url' content='http://localhost:1313/k8s/kubernetes-k8s-/'><meta property='og:site_name' content='JustWin'><meta property='og:type' content='article'><meta property='article:section' content='K8s'><meta property='article:published_time' content='2025-11-19T00:00:00+00:00'><meta property='article:modified_time' content='2025-11-19T00:00:00+00:00'><meta property='og:image' content='http://localhost:1313/'><meta name=twitter:title content="Kubernetes"><meta name=twitter:description content="Kubernetes (K8s) 完整指南 本文档基于 Kubernetes 2024 年版本整理，涵盖从基础概念到生产实践的完整知识体系。\n1. Kubernetes 概述 1.1 什么是 Kubernetes Kubernetes（K8s）是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。它提供了：\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='http://localhost:1313/'><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/avatar_hu_89ca753ea8ea85c7.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>✍️</span></figure><div class=site-meta><h1 class=site-name><a href=/>JustWin</a></h1><h2 class=site-description>分享技术与生活</h2></div></header><ol class=menu-social><li><a href=https://github.com/passion-win target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="0 0 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>github [#142]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M94 7399C99.523 7399 104 7403.59 104 7409.253 104 7413.782 101.138 7417.624 97.167 7418.981 96.66 7419.082 96.48 7418.762 96.48 7418.489 96.48 7418.151 96.492 7417.047 96.492 7415.675 96.492 7414.719 96.172 7414.095 95.813 7413.777 98.04 7413.523 100.38 7412.656 100.38 7408.718 100.38 7407.598 99.992 7406.684 99.35 7405.966 99.454 7405.707 99.797 7404.664 99.252 7403.252 99.252 7403.252 98.414 7402.977 96.505 7404.303 95.706 7404.076 94.85 7403.962 94 7403.958 93.15 7403.962 92.295 7404.076 91.497 7404.303 89.586 7402.977 88.746 7403.252 88.746 7403.252 88.203 7404.664 88.546 7405.707 88.649 7405.966 88.01 7406.684 87.619 7407.598 87.619 7408.718 87.619 7412.646 89.954 7413.526 92.175 7413.785 91.889 7414.041 91.63 7414.493 91.54 7415.156 90.97 7415.418 89.522 7415.871 88.63 7414.304 88.63 7414.304 88.101 7413.319 87.097 7413.247 87.097 7413.247 86.122 7413.234 87.029 7413.87 87.029 7413.87 87.684 7414.185 88.139 7415.37 88.139 7415.37 88.726 7417.2 91.508 7416.58 91.513 7417.437 91.522 7418.245 91.522 7418.489 91.522 7418.76 91.338 7419.077 90.839 7418.982 86.865 7417.627 84 7413.783 84 7409.253 84 7403.59 88.478 7399 94 7399" id="github-[#142]"/></g></g></g></svg></a></li><li><a href=https://t.me/+TFjBeZzowwU1YTY1 target=_blank title=telegram rel=me><svg viewBox="0 0 640 640"><path d="M320 72C183 72 72 183 72 320S183 568 320 568 568 457 568 320 457 72 320 72zM435 240.7C431.3 279.9 415.1 375.1 406.9 419c-3.5 18.6-10.3 24.8-16.9 25.4C375.6 445.7 364.7 434.9 350.7 425.7c-21.8-14.3-34.2-23.2-55.3-37.2C270.9 372.4 286.8 363.5 300.7 349 304.4 345.2 367.8 287.5 369 282.3 369.2 281.6 369.3 279.2 367.8 277.9 366.3 276.6 364.2 277.1 362.7 277.4 360.5 277.9 325.6 300.9 258.1 346.5 248.2 353.3 239.2 356.6 231.2 356.4 222.3 356.2 205.3 351.4 192.6 347.3 177.1 342.3 164.7 339.6 165.8 331 166.4 326.5 172.5 322 184.2 317.3 256.5 285.8 304.7 265 328.8 255c68.9-28.6 83.2-33.6 92.5-33.8C423.4 221.2 427.9 221.7 430.9 224.1 432.9 225.8 434.1 228.2 434.4 230.8 434.9 234 435 237.3 434.8 240.6z"/></svg></a></li><li><a href=https://twitter.com/@win1688888888 target=_blank title=twitter rel=me><svg width="800" height="800" viewBox="0 -2 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>twitter [#154]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-60.000000, -7521.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M10.29 7377C17.837 7377 21.965 7370.84365 21.965 7365.50546 21.965 7365.33021 21.965 7365.15595 21.953 7364.98267 22.756 7364.41163 23.449 7363.70276 24 7362.8915 23.252 7363.21837 22.457 7363.433 21.644 7363.52751 22.5 7363.02244 23.141 7362.2289 23.448 7361.2926 22.642 7361.76321 21.761 7362.095 20.842 7362.27321 19.288 7360.64674 16.689 7360.56798 15.036 7362.09796 13.971 7363.08447 13.518 7364.55538 13.849 7365.95835 10.55 7365.79492 7.476 7364.261 5.392 7361.73762 4.303 7363.58363 4.86 7365.94457 6.663 7367.12996 6.01 7367.11125 5.371 7366.93797 4.8 7366.62489V7366.67608C4.801 7368.5989 6.178 7370.2549 8.092 7370.63591 7.488 7370.79836 6.854 7370.82199 6.24 7370.70483 6.777 7372.35099 8.318 7373.47829 10.073 7373.51078 8.62 7374.63513 6.825 7375.24554 4.977 7375.24358 4.651 7375.24259 4.325 7375.22388 4 7375.18549 5.877 7376.37088 8.06 7377 10.29 7376.99705" id="twitter-[#154]"/></g></g></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><span>首页</span></a></li><li><a href=/links/><span>网站</span></a></li><li><a href=/linux/><span>Linux</span></a></li><li><a href=/docker/><span>docker</span></a></li><li><a href=/k8s/><span>k8s</span></a></li><li><a href=/mysql/><span>mysql</span></a></li><li><a href=/project/><span>项目</span></a></li><li><a href=/kali/><span>kali</span></a></li><li><a href=/ubuntu/><span>ubuntu</span></a></li><li><a href=/utility/><span>Utility</span></a></li><li><a href=/about/><span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=http://localhost:1313/ selected>中文</option><option value=http://localhost:1313/en/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#1-kubernetes-概述>1. Kubernetes 概述</a><ol><li><a href=#11-什么是-kubernetes>1.1 什么是 Kubernetes</a></li><li><a href=#12-核心概念>1.2 核心概念</a></li><li><a href=#13-架构原理>1.3 架构原理</a></li></ol></li><li><a href=#2-部署方式详解>2. 部署方式详解</a><ol><li><a href=#21-minikube本地开发>2.1 minikube（本地开发）</a></li><li><a href=#22-kubeadm官方推荐>2.2 kubeadm（官方推荐）</a></li><li><a href=#23-二进制包部署>2.3 二进制包部署</a></li><li><a href=#24-其他部署方式>2.4 其他部署方式</a></li></ol></li><li><a href=#3-集群组件深度解析>3. 集群组件深度解析</a><ol><li><a href=#31-master-节点组件>3.1 Master 节点组件</a><ol><li><a href=#311-kube-apiserver>3.1.1 kube-apiserver</a></li><li><a href=#312-kube-controller-manager>3.1.2 kube-controller-manager</a></li><li><a href=#313-kube-scheduler>3.1.3 kube-scheduler</a></li><li><a href=#314-cloud-controller-manager可选>3.1.4 cloud-controller-manager（可选）</a></li></ol></li><li><a href=#32-node-节点组件>3.2 Node 节点组件</a><ol><li><a href=#321-kubelet>3.2.1 kubelet</a></li><li><a href=#322-kube-proxy>3.2.2 kube-proxy</a></li><li><a href=#323-容器运行时>3.2.3 容器运行时</a></li></ol></li><li><a href=#33-etcd-集群>3.3 ETCD 集群</a><ol><li><a href=#331-核心特性>3.3.1 核心特性</a></li><li><a href=#332-数据存储结构>3.3.2 数据存储结构</a></li><li><a href=#333-部署建议>3.3.3 部署建议</a></li></ol></li><li><a href=#34-核心-addons>3.4 核心 Addons</a><ol><li><a href=#341-coredns>3.4.1 CoreDNS</a></li><li><a href=#342-kube-dns已废弃>3.4.2 kube-dns（已废弃）</a></li><li><a href=#343-metrics-server>3.4.3 Metrics Server</a></li><li><a href=#344-dashboard>3.4.4 Dashboard</a></li></ol></li></ol></li><li><a href=#4-核心资源对象详解>4. 核心资源对象详解</a><ol><li><a href=#41-pod最小程序单元>4.1 Pod（最小程序单元）</a></li><li><a href=#42-service服务发现>4.2 Service（服务发现）</a></li><li><a href=#43-deployment无状态应用>4.3 Deployment（无状态应用）</a></li><li><a href=#44-statefulset有状态应用>4.4 StatefulSet（有状态应用）</a></li><li><a href=#45-daemonset守护进程集>4.5 DaemonSet（守护进程集）</a></li><li><a href=#46-jobcronjob批处理任务>4.6 Job/CronJob（批处理任务）</a></li><li><a href=#47-configmap-与-secret>4.7 ConfigMap 与 Secret</a></li></ol></li><li><a href=#5-网络模型>5. 网络模型</a><ol><li><a href=#51-网络基础>5.1 网络基础</a></li><li><a href=#52-cni-插件对比>5.2 CNI 插件对比</a><ol><li><a href=#521-calico-配置示例>5.2.1 Calico 配置示例</a></li><li><a href=#522-flannel-配置示例>5.2.2 Flannel 配置示例</a></li></ol></li><li><a href=#53-service-网络>5.3 Service 网络</a></li><li><a href=#54-ingresshttphttps-路由>5.4 Ingress（HTTP/HTTPS 路由）</a></li></ol></li><li><a href=#6-存储系统>6. 存储系统</a><ol><li><a href=#61-存储概念>6.1 存储概念</a></li><li><a href=#62-pvpvc-详解>6.2 PV/PVC 详解</a></li><li><a href=#63-storageclass动态供给>6.3 StorageClass（动态供给）</a></li><li><a href=#64-常用存储方案对比>6.4 常用存储方案对比</a></li></ol></li><li><a href=#7-安全机制>7. 安全机制</a><ol><li><a href=#71-rbac基于角色的访问控制>7.1 RBAC（基于角色的访问控制）</a></li><li><a href=#72-networkpolicy网络策略>7.2 NetworkPolicy（网络策略）</a></li><li><a href=#73-podsecuritypolicypsp>7.3 PodSecurityPolicy（PSP）</a></li><li><a href=#74-密钥管理最佳实践>7.4 密钥管理最佳实践</a></li></ol></li><li><a href=#8-调度机制>8. 调度机制</a><ol><li><a href=#81-调度原理>8.1 调度原理</a></li><li><a href=#82-亲和性与反亲和性>8.2 亲和性与反亲和性</a></li><li><a href=#83-污点与容忍>8.3 污点与容忍</a></li><li><a href=#84-资源限制与服务质量>8.4 资源限制与服务质量</a></li></ol></li><li><a href=#9-基于-kubeadm-的集群部署实践>9. 基于 kubeadm 的集群部署实践</a><ol><li><a href=#91-环境准备>9.1 环境准备</a><ol><li><a href=#911-主机规划>9.1.1 主机规划</a></li><li><a href=#912-系统要求>9.1.2 系统要求</a></li></ol></li><li><a href=#92-基础环境配置所有节点>9.2 基础环境配置（所有节点）</a><ol><li><a href=#921-修改主机名>9.2.1 修改主机名</a></li><li><a href=#922-配置-hosts-文件>9.2.2 配置 hosts 文件</a></li><li><a href=#923-配置-ssh-免密登录master-节点>9.2.3 配置 SSH 免密登录（Master 节点）</a></li><li><a href=#924-系统优化配置>9.2.4 系统优化配置</a></li></ol></li><li><a href=#93-安装容器运行时>9.3 安装容器运行时</a></li><li><a href=#94-安装-kubeadmkubeletkubectl>9.4 安装 kubeadm/kubelet/kubectl</a></li><li><a href=#95-初始化-master-节点>9.5 初始化 Master 节点</a></li><li><a href=#96-部署网络插件>9.6 部署网络插件</a></li><li><a href=#97-加入-node-节点>9.7 加入 Node 节点</a></li><li><a href=#98-验证集群状态>9.8 验证集群状态</a></li><li><a href=#99-高可用集群部署>9.9 高可用集群部署</a></li></ol></li><li><a href=#10-kubectl-命令大全>10. kubectl 命令大全</a><ol><li><a href=#101-基础命令速查>10.1 基础命令速查</a><ol><li><a href=#1011-集群信息>10.1.1 集群信息</a></li><li><a href=#1012-资源查看>10.1.2 资源查看</a></li><li><a href=#1013-资源创建与删除>10.1.3 资源创建与删除</a></li><li><a href=#1014-pod-操作>10.1.4 Pod 操作</a></li></ol></li><li><a href=#102-deployment-操作>10.2 Deployment 操作</a></li><li><a href=#103-service-操作>10.3 Service 操作</a></li><li><a href=#104-配置与上下文管理>10.4 配置与上下文管理</a></li><li><a href=#105-调试与故障排查>10.5 调试与故障排查</a></li><li><a href=#106-高级技巧>10.6 高级技巧</a><ol><li><a href=#1061-合并多个-kubeconfig>10.6.1 合并多个 kubeconfig</a></li><li><a href=#1062-生成-yaml-模板>10.6.2 生成 YAML 模板</a></li><li><a href=#1063-标签与注解操作>10.6.3 标签与注解操作</a></li><li><a href=#1064-jsonpath-提取>10.6.4 JSONPath 提取</a></li><li><a href=#1065-批量操作>10.6.5 批量操作</a></li></ol></li></ol></li><li><a href=#11-监控与日志>11. 监控与日志</a><ol><li><a href=#111-metrics-server>11.1 Metrics Server</a></li><li><a href=#112-prometheus--grafana-监控方案>11.2 Prometheus + Grafana 监控方案</a></li><li><a href=#113-efk-日志栈>11.3 EFK 日志栈</a></li><li><a href=#114-监控最佳实践>11.4 监控最佳实践</a></li></ol></li><li><a href=#12-故障排查>12. 故障排查</a><ol><li><a href=#121-pod-问题排查流程>12.1 Pod 问题排查流程</a><ol><li><a href=#1211-pod-一直处于-pending>12.1.1 Pod 一直处于 Pending</a></li><li><a href=#1212-pod-一直处于-crashloopbackoff>12.1.2 Pod 一直处于 CrashLoopBackOff</a></li><li><a href=#1213-pod-网络不通>12.1.3 Pod 网络不通</a></li></ol></li><li><a href=#122-节点问题排查>12.2 节点问题排查</a><ol><li><a href=#1221-node-状态为-notready>12.2.1 Node 状态为 NotReady</a></li><li><a href=#1222-磁盘压力导致-pod-驱逐>12.2.2 磁盘压力导致 Pod 驱逐</a></li></ol></li><li><a href=#123-调度问题排查>12.3 调度问题排查</a><ol><li><a href=#1231-调度器无法调度>12.3.1 调度器无法调度</a></li><li><a href=#1232-亲和性配置错误>12.3.2 亲和性配置错误</a></li></ol></li><li><a href=#124-etcd-问题排查>12.4 ETCD 问题排查</a><ol><li><a href=#1241-etcd-集群健康检查>12.4.1 ETCD 集群健康检查</a></li><li><a href=#1242-etcd-空间不足>12.4.2 ETCD 空间不足</a></li></ol></li><li><a href=#125-性能问题排查>12.5 性能问题排查</a><ol><li><a href=#1251-api-server-响应慢>12.5.1 API Server 响应慢</a></li><li><a href=#1252-网络延迟高>12.5.2 网络延迟高</a></li></ol></li></ol></li><li><a href=#13-性能优化>13. 性能优化</a><ol><li><a href=#131-集群优化>13.1 集群优化</a><ol><li><a href=#1311-api-server-优化>13.1.1 API Server 优化</a></li><li><a href=#1312-调度器优化>13.1.2 调度器优化</a></li><li><a href=#1313-etcd-优化>13.1.3 ETCD 优化</a></li></ol></li><li><a href=#132-应用优化>13.2 应用优化</a><ol><li><a href=#1321-资源请求设置最佳实践>13.2.1 资源请求设置最佳实践</a></li><li><a href=#1322-jvm-应用优化>13.2.2 JVM 应用优化</a></li><li><a href=#1323-镜像优化>13.2.3 镜像优化</a></li></ol></li><li><a href=#133-资源管理优化>13.3 资源管理优化</a><ol><li><a href=#1331-资源配额resourcequota>13.3.1 资源配额（ResourceQuota）</a></li><li><a href=#1332-limitrange>13.3.2 LimitRange</a></li><li><a href=#1333-节点维护cordondrain>13.3.3 节点维护（Cordon/Drain）</a></li></ol></li></ol></li><li><a href=#14-最佳实践>14. 最佳实践</a><ol><li><a href=#141-生产环境建议>14.1 生产环境建议</a><ol><li><a href=#1411-高可用架构>14.1.1 高可用架构</a></li><li><a href=#1412-备份与恢复>14.1.2 备份与恢复</a></li><li><a href=#1413-升级策略>14.1.3 升级策略</a></li></ol></li><li><a href=#142-安全建议>14.2 安全建议</a><ol><li><a href=#1421-集群安全加固>14.2.1 集群安全加固</a></li><li><a href=#1422-网络安全>14.2.2 网络安全</a></li><li><a href=#1423-密钥管理>14.2.3 密钥管理</a></li></ol></li><li><a href=#143-运维建议>14.3 运维建议</a><ol><li><a href=#1431-命令别名配置>14.3.1 命令别名配置</a></li><li><a href=#1432-命名空间规划>14.3.2 命名空间规划</a></li><li><a href=#1433-gitops-工作流>14.3.3 GitOps 工作流</a></li></ol></li></ol></li><li><a href=#15-附录>15. 附录</a><ol><li><a href=#151-常用资源清单模板>15.1 常用资源清单模板</a><ol><li><a href=#1511-完整应用栈模板>15.1.1 完整应用栈模板</a></li></ol></li><li><a href=#152-快速参考命令>15.2 快速参考命令</a><ol><li><a href=#1521-常用命令列表>15.2.1 常用命令列表</a></li><li><a href=#1522-检查清单>15.2.2 检查清单</a></li></ol></li><li><a href=#153-参考资料与工具>15.3 参考资料与工具</a><ol><li><a href=#1531-官方资源>15.3.1 官方资源</a></li><li><a href=#1532-推荐工具>15.3.2 推荐工具</a></li><li><a href=#1533-学习资源>15.3.3 学习资源</a></li></ol></li></ol></li><li><a href=#文档说明>文档说明</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category></header><div class=article-title-wrapper><h2 class=article-title><a href=/k8s/kubernetes-k8s-/>Kubernetes</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-11-19</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 27 分钟</time></div></footer></div></header><section class=article-content><h1 id=kubernetes-k8s-完整指南>Kubernetes (K8s) 完整指南</h1><p>本文档基于 Kubernetes 2024 年版本整理，涵盖从基础概念到生产实践的完整知识体系。</p><hr><h2 id=1-kubernetes-概述>1. Kubernetes 概述</h2><h3 id=11-什么是-kubernetes>1.1 什么是 Kubernetes</h3><p>Kubernetes（K8s）是一个开源的容器编排平台，用于自动化部署、扩展和管理容器化应用。它提供了：</p><ul><li><strong>服务发现与负载均衡</strong>：自动暴露容器，实现流量分发</li><li><strong>存储编排</strong>：自动挂载存储系统</li><li><strong>自动部署与回滚</strong>：声明式配置，自动更新应用</li><li><strong>自动装箱</strong>：根据资源需求智能调度容器</li><li><strong>自我修复</strong>：自动重启、替换失败的容器</li><li><strong>密钥与配置管理</strong>：安全地管理敏感信息</li></ul><h3 id=12-核心概念>1.2 核心概念</h3><div class=table-wrapper><table><thead><tr><th>概念</th><th>说明</th><th>使用场景</th></tr></thead><tbody><tr><td><strong>Pod</strong></td><td>最小部署单元，一个或多个紧密耦合的容器</td><td>运行应用实例</td></tr><tr><td><strong>Service</strong></td><td>定义一组 Pod 的访问策略，提供稳定访问端点</td><td>服务发现、负载均衡</td></tr><tr><td><strong>Deployment</strong></td><td>管理 Pod 的声明式更新，提供副本控制</td><td>无状态应用部署</td></tr><tr><td><strong>StatefulSet</strong></td><td>管理有状态应用，提供稳定标识和存储</td><td>数据库、中间件</td></tr><tr><td><strong>DaemonSet</strong></td><td>确保每个节点运行一个 Pod 副本</td><td>日志采集、监控代理</td></tr><tr><td><strong>ConfigMap</strong></td><td>存储非敏感的配置信息</td><td>应用配置管理</td></tr><tr><td><strong>Secret</strong></td><td>存储敏感信息（Base64 编码）</td><td>密码、Token、证书</td></tr></tbody></table></div><h3 id=13-架构原理>1.3 架构原理</h3><p>Kubernetes 采用<strong>控制平面-工作节点</strong>架构：</p><ul><li><strong>控制平面（Master）</strong>：管理集群状态，做出全局决策</li><li><strong>工作节点（Node）</strong>：运行应用容器，执行控制平面指令</li><li><strong>ETCD</strong>：分布式键值存储，保存集群所有状态数据</li></ul><hr><h2 id=2-部署方式详解>2. 部署方式详解</h2><h3 id=21-minikube本地开发>2.1 minikube（本地开发）</h3><p><strong>适用场景</strong>：个人开发、学习、功能测试</p><p><strong>特点</strong>：</p><ul><li>单节点伪集群，Master 和 Node 角色合一</li><li>一键启动：<code>minikube start</code></li><li>支持多种虚拟化驱动（VirtualBox、Docker、Hyper-V）</li><li>内置插件系统（Dashboard、Ingress、Metrics-Server）</li></ul><p><strong>快速开始</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 安装后启动</span>
</span></span><span class=line><span class=cl>minikube start --driver<span class=o>=</span>docker
</span></span><span class=line><span class=cl><span class=c1># 启用插件</span>
</span></span><span class=line><span class=cl>minikube addons <span class=nb>enable</span> dashboard
</span></span><span class=line><span class=cl>minikube addons <span class=nb>enable</span> ingress
</span></span><span class=line><span class=cl><span class=c1># 访问 Dashboard</span>
</span></span><span class=line><span class=cl>minikube dashboard
</span></span></code></pre></td></tr></table></div></div><p><strong>局限性</strong>：</p><ul><li>无法模拟多节点网络策略</li><li>资源受限，不支持生产负载</li><li>部分高级功能（如多可用区）不可用</li></ul><h3 id=22-kubeadm官方推荐>2.2 kubeadm（官方推荐）</h3><p><strong>适用场景</strong>：测试环境、生产环境、高可用集群部署</p><p><strong>特点</strong>：</p><ul><li>自动化部署官方认可的标准集群</li><li>支持多 Master 节点高可用</li><li>一键初始化：<code>kubeadm init</code></li><li>一键加入：<code>kubeadm join</code></li><li>平滑升级：<code>kubeadm upgrade</code></li></ul><p><strong>优势</strong>：</p><ul><li>组件版本一致性保障</li><li>暴露配置细节，便于学习理解</li><li>社区支持完善，文档丰富</li><li>适合构建生产级集群</li></ul><p><strong>部署要求</strong>：</p><ul><li>至少 2 核 CPU，2GB 内存</li><li>操作系统：Ubuntu 16.04+、CentOS 7+</li><li>网络互通，无 NAT 阻断</li></ul><h3 id=23-二进制包部署>2.3 二进制包部署</h3><p><strong>适用场景</strong>：高度定制化的企业生产环境、离线环境、深度研究</p><p><strong>特点</strong>：</p><ul><li>完全手动部署所有组件</li><li>可深度定制配置参数</li><li>完全掌控证书体系和组件版本</li><li>无自动化工具依赖</li></ul><p><strong>优点</strong>：</p><ul><li>极致灵活性，满足特殊需求</li><li>深入理解 Kubernetes 内部机制</li><li>适用于网络隔离环境</li></ul><p><strong>缺点</strong>：</p><ul><li>部署复杂，易出错</li><li>维护成本高，升级困难</li><li>需要高水平运维团队</li></ul><p><strong>核心组件列表</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>kube-apiserver
</span></span><span class=line><span class=cl>kube-controller-manager
</span></span><span class=line><span class=cl>kube-scheduler
</span></span><span class=line><span class=cl>kubelet
</span></span><span class=line><span class=cl>kube-proxy
</span></span><span class=line><span class=cl>etcd
</span></span><span class=line><span class=cl>containerd/docker
</span></span></code></pre></td></tr></table></div></div><h3 id=24-其他部署方式>2.4 其他部署方式</h3><div class=table-wrapper><table><thead><tr><th>工具</th><th>特点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>kops</strong></td><td>云原生集群生命周期管理</td><td>AWS/GCP 生产集群</td></tr><tr><td><strong>kubespray</strong></td><td>Ansible 剧本部署</td><td>大规模多节点集群</td></tr><tr><td><strong>Rancher</strong></td><td>可视化集群管理</td><td>多集群统一管理</td></tr><tr><td><strong>EKS/GKE/AKS</strong></td><td>托管 Kubernetes 服务</td><td>公有云环境，免运维</td></tr></tbody></table></div><hr><h2 id=3-集群组件深度解析>3. 集群组件深度解析</h2><h3 id=31-master-节点组件>3.1 Master 节点组件</h3><p>Master 节点是集群的"大脑"，负责管理全局状态和决策。</p><h4 id=311-kube-apiserver>3.1.1 kube-apiserver</h4><ul><li><strong>作用</strong>：集群统一入口，所有组件通过 REST API 与其通信</li><li><strong>端口</strong>：6443（HTTPS）</li><li><strong>特性</strong>：<ul><li>认证授权（RBAC、Webhook）</li><li>数据验证和准入控制</li><li>提供 watch 机制，支持组件监听资源变化</li><li>水平扩展支持多实例 + 负载均衡</li></ul></li></ul><h4 id=312-kube-controller-manager>3.1.2 kube-controller-manager</h4><ul><li><strong>作用</strong>：运行各种控制器，维持集群期望状态</li><li><strong>核心控制器</strong>：<ul><li><strong>Node Controller</strong>：节点宕机检测，5分钟无响应标记为 NotReady</li><li><strong>Replication Controller</strong>：保证 Pod 副本数与 Deployment 定义一致</li><li><strong>Endpoint Controller</strong>：维护 Service 的后端 Endpoint 列表</li><li><strong>Service Account Controller</strong>：为 Namespace 创建默认 ServiceAccount</li></ul></li></ul><h4 id=313-kube-scheduler>3.1.3 kube-scheduler</h4><ul><li><strong>作用</strong>：负责 Pod 调度决策，为未分配的 Pod 选择最优节点</li><li><strong>调度流程</strong>：<ol><li><strong>过滤（Predicates）</strong>：筛选满足条件的节点（资源足够、端口不冲突、容忍污点）</li><li><strong>打分（Priorities）</strong>：对候选节点打分（资源平衡、亲和性、镜像本地性）</li></ol></li><li><strong>自定义调度</strong>：支持多调度器，可通过调度扩展器自定义逻辑</li></ul><h4 id=314-cloud-controller-manager可选>3.1.4 cloud-controller-manager（可选）</h4><ul><li><strong>作用</strong>：对接云厂商 API，管理节点、负载均衡、存储卷</li><li><strong>场景</strong>：在云环境（AWS/GCP/阿里云）中部署时使用</li></ul><h3 id=32-node-节点组件>3.2 Node 节点组件</h3><p>Node 节点是工作负载承载者，负责运行容器。</p><h4 id=321-kubelet>3.2.1 kubelet</h4><ul><li><strong>作用</strong>：节点代理，与 Master 通信并管理 Pod 生命周期</li><li><strong>核心功能</strong>：<ul><li>接收 PodSpec，确保容器健康运行</li><li>定期向 API Server 注册节点和上报资源使用</li><li>执行健康检查（Liveness/Readiness Probe）</li><li>管理容器存储卷和网络附加</li></ul></li></ul><h4 id=322-kube-proxy>3.2.2 kube-proxy</h4><ul><li><strong>作用</strong>：实现 Service 网络代理和负载均衡</li><li><strong>工作模式</strong>：<ul><li><strong>iptables</strong>（默认）：通过 iptables 规则实现流量转发，性能稳定</li><li><strong>ipvs</strong>：内核级负载均衡，性能更高，支持更多调度算法</li><li><strong>userspace</strong>：早期模式，已废弃</li></ul></li></ul><h4 id=323-容器运行时>3.2.3 容器运行时</h4><p>负责运行容器的底层软件：</p><ul><li><strong>containerd</strong>：轻量级，CNCF 毕业项目，推荐</li><li><strong>Docker</strong>：早期主流，现已逐步淘汰</li><li><strong>CRI-O</strong>：Kubernetes 专用，轻量安全</li></ul><h3 id=33-etcd-集群>3.3 ETCD 集群</h3><p>ETCD 是 Kubernetes 的数据存储大脑，保存所有集群状态。</p><h4 id=331-核心特性>3.3.1 核心特性</h4><ul><li><strong>强一致性</strong>：基于 Raft 算法，保证数据一致性</li><li><strong>高可用</strong>：奇数节点部署（3/5/7），容忍 (N-1)/2 个节点故障</li><li><strong>性能</strong>：写入性能影响集群整体响应速度</li><li><strong>备份</strong>：定期备份至关重要，建议每小时备份一次</li></ul><h4 id=332-数据存储结构>3.3.2 数据存储结构</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>/registry/pods/default/nginx-pod
</span></span><span class=line><span class=cl>/registry/services/default/nginx-service
</span></span><span class=line><span class=cl>/registry/deployments/default/nginx-deployment
</span></span><span class=line><span class=cl>/registry/secrets/default/db-password
</span></span></code></pre></td></tr></table></div></div><h4 id=333-部署建议>3.3.3 部署建议</h4><ul><li><strong>独立集群</strong>：生产环境建议 ETCD 与 Master 分离部署</li><li><strong>SSD 存储</strong>：使用 SSD 磁盘提升写入性能</li><li><strong>监控</strong>：监控 ETCD 延迟、存储空间、Leader 变化</li><li><strong>备份脚本</strong>：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl snapshot save /backup/etcd-snapshot-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>.db <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --endpoints<span class=o>=</span>https://127.0.0.1:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cacert<span class=o>=</span>/etc/kubernetes/pki/etcd/ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cert<span class=o>=</span>/etc/kubernetes/pki/etcd/server.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --key<span class=o>=</span>/etc/kubernetes/pki/etcd/server.key
</span></span></code></pre></td></tr></table></div></div><h3 id=34-核心-addons>3.4 核心 Addons</h3><h4 id=341-coredns>3.4.1 CoreDNS</h4><ul><li><strong>作用</strong>：集群内部 DNS 服务器，为 Service 提供域名解析</li><li><strong>解析规则</strong>：<code>service.namespace.svc.cluster.local</code></li><li><strong>配置</strong>：可通过 ConfigMap 自定义 DNS 转发规则</li></ul><h4 id=342-kube-dns已废弃>3.4.2 kube-dns（已废弃）</h4><p>早期 DNS 方案，现被 CoreDNS 替代</p><h4 id=343-metrics-server>3.4.3 Metrics Server</h4><ul><li><strong>作用</strong>：提供资源使用指标，支持 <code>kubectl top</code> 和 HPA</li><li><strong>部署</strong>：必须安装才能使用自动扩缩容</li><li><code>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</code></li></ul><h4 id=344-dashboard>3.4.4 Dashboard</h4><ul><li><strong>作用</strong>：官方 Web UI，可视化集群管理</li><li><strong>访问</strong>：<code>kubectl proxy</code> 后访问 <code>http://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy/</code></li></ul><hr><h2 id=4-核心资源对象详解>4. 核心资源对象详解</h2><h3 id=41-pod最小程序单元>4.1 Pod（最小程序单元）</h3><p><strong>概念</strong>：Pod 是 Kubernetes 的最小可部署和可调度单元，一个 Pod 可以包含一个或多个紧密耦合的容器。</p><p><strong>关键特性</strong>：</p><ul><li><strong>共享网络</strong>：Pod 内所有容器共享同一个网络命名空间（IP 和端口）</li><li><strong>共享存储</strong>：通过 Volume 共享存储卷</li><li><strong>生命周期</strong>：Pod 是临时实体，崩溃后不会被修复，由控制器重建</li><li><strong>Sidecar 模式</strong>：主容器 + 辅助容器（日志、代理、监控）</li></ul><p><strong>示例配置</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-pod</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.25</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>NGINX_PORT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;80&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;64Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;250m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;128Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=42-service服务发现>4.2 Service（服务发现）</h3><p><strong>概念</strong>：Service 定义了一组 Pod 的访问策略，提供稳定的网络端点。</p><p><strong>四种类型</strong>：</p><ol><li><p><strong>ClusterIP</strong>（默认）</p><ul><li>集群内部虚拟 IP，仅集群内访问</li><li>示例：<code>kubectl expose deployment/nginx --port=80</code></li></ul></li><li><p><strong>NodePort</strong></p><ul><li>在每个节点开放一个静态端口（30000-32767）</li><li>外部可通过 <code>NodeIP:NodePort</code> 访问</li><li>示例：<code>kubectl expose deployment/nginx --type=NodePort --port=80</code></li></ul></li><li><p><strong>LoadBalancer</strong></p><ul><li>云厂商负载均衡器自动配置</li><li>需要云厂商支持（AWS/GCP/阿里云）</li><li>示例：<code>kubectl expose deployment/nginx --type=LoadBalancer --port=80</code></li></ul></li><li><p><strong>ExternalName</strong></p><ul><li>将 Service 映射到外部 DNS 名称</li><li>示例：访问外部数据库服务</li></ul></li></ol><p><strong>Headless Service</strong>（无头服务）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>clusterIP</span><span class=p>:</span><span class=w> </span><span class=l>None</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ul><li>不分配虚拟 IP，直接返回后端 Pod IP 列表</li><li>适用场景：StatefulSet、需要直接访问 Pod 的场景</li></ul><p><strong>Service 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=43-deployment无状态应用>4.3 Deployment（无状态应用）</h3><p><strong>概念</strong>：Deployment 管理 Pod 的声明式更新，提供副本控制、滚动更新、回滚能力。</p><p><strong>关键功能</strong>：</p><ul><li><strong>副本管理</strong>：确保指定数量的 Pod 始终运行</li><li><strong>滚动更新</strong>：逐步替换旧版本 Pod，零停机更新</li><li><strong>版本回滚</strong>：快速回滚到历史版本</li><li><strong>扩缩容</strong>：手动或自动调整副本数</li></ul><p><strong>Deployment 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx-deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>nginx:1.25</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>strategy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>RollingUpdate</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>rollingUpdate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxUnavailable</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>maxSurge</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>更新策略</strong>：</p><ul><li><strong>RollingUpdate</strong>：滚动更新，逐步替换<ul><li><code>maxUnavailable</code>：更新过程中不可用 Pod 的最大数量（默认 25%）</li><li><code>maxSurge</code>：更新过程中可以超过期望副本数的数量（默认 25%）</li></ul></li><li><strong>Recreate</strong>：先删除所有旧 Pod，再创建新 Pod（会导致短暂停机）</li></ul><h3 id=44-statefulset有状态应用>4.4 StatefulSet（有状态应用）</h3><p><strong>概念</strong>：管理有状态应用，为 Pod 提供稳定标识和持久化存储。</p><p><strong>适用场景</strong>：</p><ul><li>需要稳定网络标识（如 Kafka、Zookeeper）</li><li>需要持久化存储（如 MySQL、MongoDB）</li><li>有序部署和扩展（如主从架构）</li></ul><p><strong>特点</strong>：</p><ul><li><strong>稳定标识</strong>：Pod 名称固定（如 web-0, web-1, web-2）</li><li><strong>有序部署</strong>：按索引顺序创建和删除 Pod</li><li><strong>持久存储</strong>：每个 Pod 绑定独立的 PV</li></ul><p><strong>StatefulSet 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StatefulSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>serviceName</span><span class=p>:</span><span class=w> </span><span class=l>mysql-headless</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mysql:8.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_ROOT_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumeClaimTemplates</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>accessModes</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;ReadWriteOnce&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>fast-ssd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>50Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=45-daemonset守护进程集>4.5 DaemonSet（守护进程集）</h3><p><strong>概念</strong>：确保每个（或特定）节点运行一个 Pod 副本。</p><p><strong>适用场景</strong>：</p><ul><li>日志采集（Fluentd、Filebeat）</li><li>监控代理（Prometheus Node Exporter）</li><li>网络插件（Calico、Flannel）</li><li>安全代理</li></ul><p><strong>DaemonSet 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>DaemonSet</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>fluentd-elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>FLUENT_ELASTICSEARCH_HOST</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;elasticsearch.logging.svc.cluster.local&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=46-jobcronjob批处理任务>4.6 Job/CronJob（批处理任务）</h3><p><strong>Job</strong>：运行一次性任务，确保任务完成。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Job</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi-calculation</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>perl:5.34</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>command</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;perl&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-Mbignum=bpi&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;-wle&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;print bpi(2000)&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Never</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>backoffLimit</span><span class=p>:</span><span class=w> </span><span class=m>4</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>CronJob</strong>：定时执行 Job。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>batch/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>CronJob</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backup-cron</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;0 3 * * *&#34;</span><span class=w>  </span><span class=c># 每天凌晨3点执行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>jobTemplate</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>backup</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>mysql:8.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>/bin/sh</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- -<span class=l>c</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>mysqldump -h mysql.default.svc.cluster.local -u root -p$MYSQL_ROOT_PASSWORD mydb &gt; /backup/mydb-$(date +%Y%m%d).sql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MYSQL_ROOT_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                  </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>restartPolicy</span><span class=p>:</span><span class=w> </span><span class=l>OnFailure</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=47-configmap-与-secret>4.7 ConfigMap 与 Secret</h3><p><strong>ConfigMap</strong>：存储非敏感配置信息。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>database_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;mysql:3306&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>redis_url</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;redis:6379&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>config.yaml</span><span class=p>:</span><span class=w> </span><span class=p>|</span><span class=sd>
</span></span></span><span class=line><span class=cl><span class=sd>    server:
</span></span></span><span class=line><span class=cl><span class=sd>      port: 8080
</span></span></span><span class=line><span class=cl><span class=sd>      timeout: 30s</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Secret</strong>：存储敏感信息（Base64 编码）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>username</span><span class=p>:</span><span class=w> </span><span class=l>YWRtaW4= </span><span class=w> </span><span class=c># base64 编码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>password</span><span class=p>:</span><span class=w> </span><span class=l>MWYyZDFlMmU2N2Rm </span><span class=w> </span><span class=c># base64 编码</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>使用方法</strong>：</p><ol><li><strong>环境变量</strong>：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DB_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>password</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><ol start=2><li><strong>Volume 挂载</strong>：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/secret&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>readOnly</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>secret-volume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>db-secret</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=5-网络模型>5. 网络模型</h2><h3 id=51-网络基础>5.1 网络基础</h3><p><strong>Kubernetes 网络要求</strong>：</p><ul><li><strong>所有 Pod 互通</strong>：无论节点，所有 Pod 可相互通信</li><li><strong>所有节点与 Pod 互通</strong>：节点可访问所有 Pod</li><li><strong>Pod 拥有独立 IP</strong>：每个 Pod 拥有集群范围的唯一 IP</li></ul><p><strong>网络模型实现</strong>：</p><ul><li><strong>CNI（容器网络接口）</strong>：插件化网络方案</li><li><strong>Service 网络</strong>：虚拟 IP 和端口代理</li><li><strong>DNS 服务</strong>：CoreDNS 提供域名解析</li></ul><h3 id=52-cni-插件对比>5.2 CNI 插件对比</h3><div class=table-wrapper><table><thead><tr><th>插件</th><th>特点</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Calico</strong></td><td>BGP 路由，NetworkPolicy 支持</td><td>高</td><td>大规模生产环境</td></tr><tr><td><strong>Flannel</strong></td><td>简单易用，overlay 网络</td><td>中等</td><td>中小型集群</td></tr><tr><td><strong>Cilium</strong></td><td>eBPF 技术，高性能安全</td><td>极高</td><td>对性能和安全性要求高的场景</td></tr><tr><td><strong>Weave</strong></td><td>自动加密，易于部署</td><td>中等</td><td>开发测试、多云环境</td></tr><tr><td><strong>Antrea</strong></td><td>VMware 开源，基于 Open vSwitch</td><td>高</td><td>vSphere 环境</td></tr></tbody></table></div><h4 id=521-calico-配置示例>5.2.1 Calico 配置示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 下载配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>wget https://docs.projectcalico.org/manifests/calico.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 修改配置（如需要）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 编辑 calico.yaml，设置 CALICO_IPV4POOL_CIDR 与集群 pod-network-cidr 一致</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 部署</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl apply -f calico.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 验证</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=l>kubectl get pods -n kube-system -l k8s-app=calico-node</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=522-flannel-配置示例>5.2.2 Flannel 配置示例</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 部署</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置后重启节点</span>
</span></span><span class=line><span class=cl>systemctl restart kubelet
</span></span></code></pre></td></tr></table></div></div><h3 id=53-service-网络>5.3 Service 网络</h3><p><strong>kube-proxy 工作原理</strong>：</p><ol><li><p><strong>iptables 模式</strong>：</p><ul><li>为每个 Service 创建 iptables 规则</li><li>流量通过 DNAT 转发到后端 Pod</li><li>规则数量随服务增多线性增长</li></ul></li><li><p><strong>IPVS 模式</strong>（推荐）：</p><ul><li>内核级负载均衡</li><li>支持多种调度算法（rr, lc, dh, sh, sed, nq）</li><li>性能更好，规则处理更高效</li></ul></li></ol><p><strong>开启 IPVS 模式</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在 kube-proxy ConfigMap 中修改</span>
</span></span><span class=line><span class=cl>kubectl edit configmap kube-proxy -n kube-system
</span></span><span class=line><span class=cl><span class=c1># 设置 mode: &#34;ipvs&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 重启 kube-proxy</span>
</span></span><span class=line><span class=cl>kubectl rollout restart daemonset kube-proxy -n kube-system
</span></span></code></pre></td></tr></table></div></div><h3 id=54-ingresshttphttps-路由>5.4 Ingress（HTTP/HTTPS 路由）</h3><p><strong>概念</strong>：管理外部访问集群服务的 HTTP/HTTPS 路由。</p><p><strong>常用 Ingress Controller</strong>：</p><ul><li><strong>NGINX Ingress Controller</strong>：最流行，功能丰富</li><li><strong>Traefik</strong>：云原生，自动服务发现</li><li><strong>HAProxy</strong>：高性能，成熟稳定</li></ul><p><strong>Ingress 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>my-app-ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nginx.ingress.kubernetes.io/rewrite-target</span><span class=p>:</span><span class=w> </span><span class=l>/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>host</span><span class=p>:</span><span class=w> </span><span class=l>app.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>http</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>paths</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/api</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>api-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/web</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>pathType</span><span class=p>:</span><span class=w> </span><span class=l>Prefix</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>backend</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>service</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>web-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>number</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tls</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>hosts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>app.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>secretName</span><span class=p>:</span><span class=w> </span><span class=l>tls-secret</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=6-存储系统>6. 存储系统</h2><h3 id=61-存储概念>6.1 存储概念</h3><p><strong>存储抽象层次</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>StorageClass → PersistentVolume → PersistentVolumeClaim → Pod
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>StorageClass</strong>：定义存储类型和提供者</li><li><strong>PersistentVolume (PV)</strong>：集群级存储资源，由管理员创建</li><li><strong>PersistentVolumeClaim (PVC)</strong>：命名空间级存储请求，由用户创建</li><li><strong>Pod</strong>：挂载 PVC 使用存储</li></ul><h3 id=62-pvpvc-详解>6.2 PV/PVC 详解</h3><p><strong>PV 示例</strong>（静态供给）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolume</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pv001</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>capacity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>persistentVolumeReclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>fast-ssd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hostPath</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/data/pv001</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>PVC 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PersistentVolumeClaim</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>accessModes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>ReadWriteOnce</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>storageClassName</span><span class=p>:</span><span class=w> </span><span class=l>fast-ssd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>storage</span><span class=p>:</span><span class=w> </span><span class=l>50Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>在 Pod 中使用</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>volumeMounts</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>mountPath</span><span class=p>:</span><span class=w> </span><span class=l>/var/lib/mysql</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>data</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentVolumeClaim</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>claimName</span><span class=p>:</span><span class=w> </span><span class=l>mysql-data</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=63-storageclass动态供给>6.3 StorageClass（动态供给）</h3><p><strong>概念</strong>：自动创建 PV 的模板，支持按需分配存储。</p><p><strong>常用类型</strong>：</p><ul><li><strong>hostPath</strong>：单节点测试</li><li><strong>NFS</strong>：多节点共享存储</li><li><strong>CephFS/RBD</strong>：分布式存储</li><li><strong>云存储</strong>：AWS EBS、GCP PD、阿里云盘</li></ul><p><strong>NFS StorageClass 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 部署 NFS-Subdir-External-Provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>storage.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>StorageClass</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nfs-storage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>provisioner</span><span class=p>:</span><span class=w> </span><span class=l>k8s-sigs.io/nfs-subdir-external-provisioner</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>parameters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>server</span><span class=p>:</span><span class=w> </span><span class=l>nfs-server.example.com</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/exports</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>archiveOnDelete</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>reclaimPolicy</span><span class=p>:</span><span class=w> </span><span class=l>Retain</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>allowVolumeExpansion</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>mountOptions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>hard</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=l>nfsvers=4.1</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=64-常用存储方案对比>6.4 常用存储方案对比</h3><div class=table-wrapper><table><thead><tr><th>方案</th><th>特点</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>hostPath</strong></td><td>单节点，简单易用</td><td>高</td><td>单节点测试</td></tr><tr><td><strong>NFS</strong></td><td>多节点共享，成熟稳定</td><td>中等</td><td>开发测试、共享数据</td></tr><tr><td><strong>Ceph</strong></td><td>分布式，高可用</td><td>高</td><td>大规模生产环境</td></tr><tr><td><strong>GlusterFS</strong></td><td>分布式，弹性扩展</td><td>中等</td><td>文件存储场景</td></tr><tr><td><strong>Longhorn</strong></td><td>Kubernetes 原生，轻量</td><td>中等</td><td>中小规模生产环境</td></tr></tbody></table></div><hr><h2 id=7-安全机制>7. 安全机制</h2><h3 id=71-rbac基于角色的访问控制>7.1 RBAC（基于角色的访问控制）</h3><p><strong>核心概念</strong>：</p><ul><li><strong>Role/ClusterRole</strong>：定义权限集合</li><li><strong>RoleBinding/ClusterRoleBinding</strong>：将 Role 绑定到用户/组/ServiceAccount</li></ul><p><strong>Role 示例</strong>（命名空间级）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;pods&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;watch&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>ClusterRole 示例</strong>（集群级）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ClusterRole</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>node-admin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>rules</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>apiGroups</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;nodes&#34;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>verbs</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&#34;get&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;list&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;update&#34;</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;patch&#34;</span><span class=p>]</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>RoleBinding 示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>RoleBinding</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>read-pods</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>subjects</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>User</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>jane</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ServiceAccount</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>kube-system</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>roleRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Role</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>pod-reader</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>apiGroup</span><span class=p>:</span><span class=w> </span><span class=l>rbac.authorization.k8s.io</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>内置 ClusterRole</strong>：</p><ul><li><code>cluster-admin</code>：超级管理员</li><li><code>admin</code>：命名空间管理员</li><li><code>edit</code>：可修改资源</li><li><code>view</code>：只读权限</li></ul><h3 id=72-networkpolicy网络策略>7.2 NetworkPolicy（网络策略）</h3><p><strong>概念</strong>：定义 Pod 间网络访问规则，实现网络隔离。</p><p><strong>前提</strong>：CNI 插件必须支持 NetworkPolicy（Calico、Cilium 支持）。</p><p><strong>示例：隔离 default 命名空间</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>NetworkPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>default-deny</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyTypes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>Egress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podSelector</span><span class=p>:</span><span class=w> </span>{}<span class=w>  </span><span class=c># 选择所有 Pod</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>示例：允许特定访问</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>networking.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>NetworkPolicy</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>allow-frontend-to-backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>podSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>backend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>policyTypes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=l>Ingress</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ingress</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>from</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>podSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>frontend</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=73-podsecuritypolicypsp>7.3 PodSecurityPolicy（PSP）</h3><p><strong>注意</strong>：PSP 在 Kubernetes v1.25+ 已被移除，改用 PodSecurity Admission。</p><p><strong>替代方案 - PodSecurity 标准</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 为命名空间设置安全等级</span>
</span></span><span class=line><span class=cl>kubectl label namespace default pod-security.kubernetes.io/enforce<span class=o>=</span>baseline
</span></span><span class=line><span class=cl>kubectl label namespace default pod-security.kubernetes.io/warn<span class=o>=</span>restricted
</span></span></code></pre></td></tr></table></div></div><h3 id=74-密钥管理最佳实践>7.4 密钥管理最佳实践</h3><ol><li><strong>使用 Secret 而非 ConfigMap 存储敏感信息</strong></li><li><strong>启用静态加密</strong>：</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在 kube-apiserver 配置中启用</span>
</span></span><span class=line><span class=cl>--encryption-provider-config<span class=o>=</span>/etc/kubernetes/encryption-config.yaml
</span></span></code></pre></td></tr></table></div></div><ol start=3><li><strong>使用外部密钥管理服务</strong>：<ul><li><strong>Vault</strong>：HashiCorp 的密钥管理</li><li><strong>AWS KMS</strong>：云密钥管理服务</li><li><strong>External Secrets Operator</strong>：同步外部密钥到 Kubernetes Secret</li></ul></li></ol><hr><h2 id=8-调度机制>8. 调度机制</h2><h3 id=81-调度原理>8.1 调度原理</h3><p><strong>调度流程</strong>：</p><ol><li><strong>创建 Pod</strong>：Pod 进入 Pending 状态</li><li><strong>调度队列</strong>：调度器监听未分配节点的 Pod</li><li><strong>过滤阶段（Predicates）</strong>：筛选可行节点</li><li><strong>打分阶段（Priorities）</strong>：为可行节点打分</li><li><strong>绑定节点</strong>：选择最高分节点，更新 Pod.spec.nodeName</li></ol><h3 id=82-亲和性与反亲和性>8.2 亲和性与反亲和性</h3><p><strong>节点亲和性（Node Affinity）</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>nodeAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>nodeSelectorTerms</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/e2e-az-name</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>az1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>az2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>preference</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>another-node-label-key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>another-node-label-value</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>Pod 亲和性（Pod Affinity）</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>affinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>podAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requiredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>security</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=l>S1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>topology.kubernetes.io/zone</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>podAntiAffinity</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>preferredDuringSchedulingIgnoredDuringExecution</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>podAffinityTerm</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>labelSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>matchExpressions</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=l>In</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>values</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span>- <span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>topologyKey</span><span class=p>:</span><span class=w> </span><span class=l>kubernetes.io/hostname</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=83-污点与容忍>8.3 污点与容忍</h3><p><strong>污点（Taint）</strong>：节点上的"排斥"标记，阻止 Pod 调度。</p><p><strong>容忍（Toleration）</strong>：Pod 的"接受"标记，允许调度到带污点的节点。</p><p><strong>污点类型</strong>：</p><ul><li><code>NoSchedule</code>：不允许新 Pod 调度</li><li><code>PreferNoSchedule</code>：尽量不调度</li><li><code>NoExecute</code>：不允许调度，已运行的 Pod 会被驱逐</li></ul><p><strong>为节点添加污点</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl taint nodes node1 <span class=nv>key1</span><span class=o>=</span>value1:NoSchedule
</span></span><span class=line><span class=cl>kubectl taint nodes node1 <span class=nv>gpu</span><span class=o>=</span>true:NoSchedule
</span></span></code></pre></td></tr></table></div></div><p><strong>Pod 容忍示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>tolerations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;gpu&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Equal&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;true&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoSchedule&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;node.kubernetes.io/unreachable&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>operator</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;Exists&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>effect</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;NoExecute&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>tolerationSeconds</span><span class=p>:</span><span class=w> </span><span class=m>6000</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>内置污点</strong>：</p><ul><li><code>node.kubernetes.io/not-ready</code>：节点未就绪</li><li><code>node.kubernetes.io/unreachable</code>：节点不可达</li><li><code>node.kubernetes.io/out-of-disk</code>：磁盘不足</li><li><code>node.kubernetes.io/memory-pressure</code>：内存压力</li></ul><h3 id=84-资源限制与服务质量>8.4 资源限制与服务质量</h3><p><strong>资源请求与限制</strong>：</p><ul><li><strong>requests</strong>：调度依据，保证资源</li><li><strong>limits</strong>：运行上限，防止资源抢占</li></ul><p><strong>QoS 类别</strong>（Quality of Service）：</p><ol><li><strong>Guaranteed</strong>：所有容器都设置 requests=limits<ul><li>最高优先级，最后被驱逐</li></ul></li><li><strong>Burstable</strong>：至少一个容器设置 requests&lt;limits<ul><li>中等优先级</li></ul></li><li><strong>BestEffort</strong>：未设置 requests 和 limits<ul><li>最低优先级，最先被驱逐</li></ul></li></ol><p><strong>示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>nginx</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;256Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000m&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p><strong>LimitRange</strong>：限制命名空间内资源默认值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>LimitRange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mem-limit-range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>defaultRequest</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>200m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Container</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><hr><h2 id=9-基于-kubeadm-的集群部署实践>9. 基于 kubeadm 的集群部署实践</h2><h3 id=91-环境准备>9.1 环境准备</h3><h4 id=911-主机规划>9.1.1 主机规划</h4><div class=table-wrapper><table><thead><tr><th>角色</th><th>主机名</th><th>IP地址</th><th>配置要求</th></tr></thead><tbody><tr><td>Master</td><td>k8s-master</td><td>192.168.200.101</td><td>2核4G，50G磁盘</td></tr><tr><td>Node1</td><td>k8s-node1</td><td>192.168.200.102</td><td>2核4G，50G磁盘</td></tr><tr><td>Node2</td><td>k8s-node2</td><td>192.168.200.103</td><td>2核4G，50G磁盘</td></tr></tbody></table></div><h4 id=912-系统要求>9.1.2 系统要求</h4><ul><li><strong>操作系统</strong>：CentOS 7.9 或 Ubuntu 20.04 LTS</li><li><strong>内核版本</strong>：4.18+</li><li><strong>容器运行时</strong>：containerd 1.6+（推荐）</li></ul><h3 id=92-基础环境配置所有节点>9.2 基础环境配置（所有节点）</h3><h4 id=921-修改主机名>9.2.1 修改主机名</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Master 节点</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname k8s-master
</span></span><span class=line><span class=cl>bash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Node1 节点</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname k8s-node1
</span></span><span class=line><span class=cl>bash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Node2 节点</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname k8s-node2
</span></span><span class=line><span class=cl>bash
</span></span></code></pre></td></tr></table></div></div><h4 id=922-配置-hosts-文件>9.2.2 配置 hosts 文件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt;&gt; /etc/hosts <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.101 k8s-master
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.102 k8s-node1
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.103 k8s-node2
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=923-配置-ssh-免密登录master-节点>9.2.3 配置 SSH 免密登录（Master 节点）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 生成密钥</span>
</span></span><span class=line><span class=cl>ssh-keygen -t rsa -b <span class=m>4096</span> -C <span class=s2>&#34;k8s-admin@cluster.local&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 分发公钥</span>
</span></span><span class=line><span class=cl>ssh-copy-id root@k8s-node1
</span></span><span class=line><span class=cl>ssh-copy-id root@k8s-node2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证</span>
</span></span><span class=line><span class=cl>ssh k8s-node1 <span class=s2>&#34;uptime&#34;</span>
</span></span><span class=line><span class=cl>ssh k8s-node2 <span class=s2>&#34;uptime&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=924-系统优化配置>9.2.4 系统优化配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 关闭 SELinux</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/^SELINUX=enforcing/SELINUX=disabled/&#39;</span> /etc/selinux/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 关闭防火墙</span>
</span></span><span class=line><span class=cl>systemctl stop firewalld
</span></span><span class=line><span class=cl>systemctl disable firewalld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 禁用 Swap</span>
</span></span><span class=line><span class=cl>swapoff -a
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;/swap/s/^/#/&#39;</span> /etc/fstab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 配置内核参数</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-ip6tables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.bridge.bridge-nf-call-iptables = 1
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>sysctl --system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 时间同步</span>
</span></span><span class=line><span class=cl>timedatectl set-timezone Asia/Shanghai
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> chronyd
</span></span><span class=line><span class=cl>systemctl start chronyd
</span></span><span class=line><span class=cl>chronyc sources
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 加载内核模块</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; /etc/modules-load.d/k8s.conf
</span></span></span><span class=line><span class=cl><span class=s>overlay
</span></span></span><span class=line><span class=cl><span class=s>br_netfilter
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>modprobe overlay
</span></span><span class=line><span class=cl>modprobe br_netfilter
</span></span></code></pre></td></tr></table></div></div><h3 id=93-安装容器运行时>9.3 安装容器运行时</h3><p><strong>安装 containerd（推荐）</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 所有节点执行</span>
</span></span><span class=line><span class=cl>yum install -y yum-utils device-mapper-persistent-data lvm2
</span></span><span class=line><span class=cl>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span class=line><span class=cl>yum install -y containerd.io
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置 containerd</span>
</span></span><span class=line><span class=cl>mkdir -p /etc/containerd
</span></span><span class=line><span class=cl>containerd config default <span class=p>|</span> tee /etc/containerd/config.toml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改配置，启用 systemd cgroup</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/SystemdCgroup = false/SystemdCgroup = true/&#39;</span> /etc/containerd/config.toml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动服务</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> containerd
</span></span><span class=line><span class=cl>systemctl start containerd
</span></span><span class=line><span class=cl>systemctl status containerd
</span></span></code></pre></td></tr></table></div></div><p><strong>安装 Docker（备选）</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install -y docker-ce docker-ce-cli containerd.io
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> docker
</span></span><span class=line><span class=cl>systemctl start docker
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置 cgroupdriver</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF &gt; /etc/docker/daemon.json
</span></span></span><span class=line><span class=cl><span class=s>{
</span></span></span><span class=line><span class=cl><span class=s>  &#34;exec-opts&#34;: [&#34;native.cgroupdriver=systemd&#34;],
</span></span></span><span class=line><span class=cl><span class=s>  &#34;log-driver&#34;: &#34;json-file&#34;,
</span></span></span><span class=line><span class=cl><span class=s>  &#34;log-opts&#34;: {
</span></span></span><span class=line><span class=cl><span class=s>    &#34;max-size&#34;: &#34;100m&#34;
</span></span></span><span class=line><span class=cl><span class=s>  },
</span></span></span><span class=line><span class=cl><span class=s>  &#34;storage-driver&#34;: &#34;overlay2&#34;
</span></span></span><span class=line><span class=cl><span class=s>}
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>systemctl restart docker
</span></span></code></pre></td></tr></table></div></div><h3 id=94-安装-kubeadmkubeletkubectl>9.4 安装 kubeadm/kubelet/kubectl</h3><p><strong>配置 Kubernetes 源</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class=line><span class=cl><span class=s>[kubernetes]
</span></span></span><span class=line><span class=cl><span class=s>name=Kubernetes
</span></span></span><span class=line><span class=cl><span class=s>baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=1
</span></span></span><span class=line><span class=cl><span class=s>gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>exclude=kubelet kubeadm kubectl
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 国内可使用阿里云镜像</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF | tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span class=line><span class=cl><span class=s>[kubernetes]
</span></span></span><span class=line><span class=cl><span class=s>name=Kubernetes
</span></span></span><span class=line><span class=cl><span class=s>baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span class=line><span class=cl><span class=s>enabled=1
</span></span></span><span class=line><span class=cl><span class=s>gpgcheck=1
</span></span></span><span class=line><span class=cl><span class=s>repo_gpgcheck=1
</span></span></span><span class=line><span class=cl><span class=s>gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span class=line><span class=cl><span class=s>exclude=kubelet kubeadm kubectl
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>安装组件</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>yum install -y kubelet-1.28.0 kubeadm-1.28.0 kubectl-1.28.0 --disableexcludes<span class=o>=</span>kubernetes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置 kubelet cgroupdriver</span>
</span></span><span class=line><span class=cl>sed -i <span class=s1>&#39;s/cgroupDriver: systemd/cgroupDriver: systemd/&#39;</span> /var/lib/kubelet/config.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动 kubelet</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now kubelet
</span></span></code></pre></td></tr></table></div></div><h3 id=95-初始化-master-节点>9.5 初始化 Master 节点</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在 Master 节点执行</span>
</span></span><span class=line><span class=cl>kubeadm init <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --apiserver-advertise-address<span class=o>=</span>192.168.200.101 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --pod-network-cidr<span class=o>=</span>10.244.0.0/16 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --service-cidr<span class=o>=</span>10.96.0.0/12 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --image-repository<span class=o>=</span>registry.aliyuncs.com/google_containers <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --kubernetes-version<span class=o>=</span>v1.28.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置 kubectl</span>
</span></span><span class=line><span class=cl>mkdir -p <span class=nv>$HOME</span>/.kube
</span></span><span class=line><span class=cl>cp -i /etc/kubernetes/admin.conf <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>chown <span class=k>$(</span>id -u<span class=k>)</span>:<span class=k>$(</span>id -g<span class=k>)</span> <span class=nv>$HOME</span>/.kube/config
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看初始化结果</span>
</span></span><span class=line><span class=cl>kubectl get nodes
</span></span><span class=line><span class=cl>kubectl get pods -n kube-system
</span></span></code></pre></td></tr></table></div></div><p><strong>初始化参数说明</strong>：</p><ul><li><code>--apiserver-advertise-address</code>：API Server 广播地址</li><li><code>--pod-network-cidr</code>：Pod 网络 CIDR（需与 CNI 插件匹配）</li><li><code>--service-cidr</code>：Service 网络 CIDR</li><li><code>--image-repository</code>：镜像仓库（国内使用阿里云加速）</li><li><code>--kubernetes-version</code>：Kubernetes 版本</li></ul><p><strong>获取加入命令</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在 Master 节点获取 node 加入命令</span>
</span></span><span class=line><span class=cl>kubeadm token create --print-join-command
</span></span><span class=line><span class=cl><span class=c1># 输出示例：</span>
</span></span><span class=line><span class=cl><span class=c1># kubeadm join 192.168.200.101:6443 --token abcdef.0123456789abcdef \</span>
</span></span><span class=line><span class=cl><span class=c1>#   --discovery-token-ca-cert-hash sha256:xxx</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=96-部署网络插件>9.6 部署网络插件</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Calico</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或 Flannel</span>
</span></span><span class=line><span class=cl>kubectl apply -f https://raw.githubusercontent.com/flannel-io/flannel/master/Documentation/kube-flannel.yml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证部署</span>
</span></span><span class=line><span class=cl>kubectl get pods -n kube-system -w
</span></span></code></pre></td></tr></table></div></div><h3 id=97-加入-node-节点>9.7 加入 Node 节点</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 在每个 Node 节点执行</span>
</span></span><span class=line><span class=cl>kubeadm join 192.168.200.101:6443 --token abcdef.0123456789abcdef <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:xxx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在 Master 节点验证</span>
</span></span><span class=line><span class=cl>kubectl get nodes
</span></span><span class=line><span class=cl><span class=c1># 状态应为 Ready</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=98-验证集群状态>9.8 验证集群状态</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看节点状态</span>
</span></span><span class=line><span class=cl>kubectl get nodes -o wide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看核心组件</span>
</span></span><span class=line><span class=cl>kubectl get pods -n kube-system
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看集群信息</span>
</span></span><span class=line><span class=cl>kubectl cluster-info
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试 DNS</span>
</span></span><span class=line><span class=cl>kubectl run dns-test --rm -it --image<span class=o>=</span>busybox:1.28 -- nslookup kubernetes.default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试部署</span>
</span></span><span class=line><span class=cl>kubectl create deployment nginx --image<span class=o>=</span>nginx:1.25
</span></span><span class=line><span class=cl>kubectl expose deployment/nginx --port<span class=o>=</span><span class=m>80</span> --type<span class=o>=</span>NodePort
</span></span><span class=line><span class=cl>kubectl get svc nginx
</span></span><span class=line><span class=cl><span class=c1># 访问测试</span>
</span></span><span class=line><span class=cl>curl http://&lt;NodeIP&gt;:&lt;NodePort&gt;
</span></span></code></pre></td></tr></table></div></div><h3 id=99-高可用集群部署>9.9 高可用集群部署</h3><p><strong>架构</strong>：3 Master + 多 Node + 外部负载均衡</p><p><strong>步骤</strong>：</p><ol><li><strong>部署 ETCD 集群</strong>（独立或堆叠模式）</li><li><strong>配置外部负载均衡</strong>（HAProxy/NGINX）</li><li><strong>初始化第一个 Master</strong></li><li><strong>其他 Master 加入</strong></li><li><strong>配置负载均衡 VIP</strong></li></ol><p><strong>堆叠式 ETCD 高可用配置</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 第一个 Master 初始化</span>
</span></span><span class=line><span class=cl>kubeadm init --control-plane-endpoint <span class=s2>&#34;k8s-lb.example.com:6443&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --upload-certs --pod-network-cidr<span class=o>=</span>10.244.0.0/16
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 其他 Master 加入</span>
</span></span><span class=line><span class=cl>kubeadm join k8s-lb.example.com:6443 --token &lt;token&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --discovery-token-ca-cert-hash sha256:&lt;hash&gt; <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --control-plane --certificate-key &lt;certificate-key&gt;
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=10-kubectl-命令大全>10. kubectl 命令大全</h2><h3 id=101-基础命令速查>10.1 基础命令速查</h3><h4 id=1011-集群信息>10.1.1 集群信息</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 集群基本信息</span>
</span></span><span class=line><span class=cl>kubectl cluster-info
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 节点列表</span>
</span></span><span class=line><span class=cl>kubectl get nodes
</span></span><span class=line><span class=cl>kubectl get nodes -o wide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组件状态</span>
</span></span><span class=line><span class=cl>kubectl get componentstatuses
</span></span><span class=line><span class=cl>kubectl get cs
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># API 资源类型</span>
</span></span><span class=line><span class=cl>kubectl api-resources
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 集群版本</span>
</span></span><span class=line><span class=cl>kubectl version --short
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看事件（按时间排序）</span>
</span></span><span class=line><span class=cl>kubectl get events --sort-by<span class=o>=</span>.lastTimestamp
</span></span></code></pre></td></tr></table></div></div><h4 id=1012-资源查看>10.1.2 资源查看</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Pod 操作</span>
</span></span><span class=line><span class=cl>kubectl get pods
</span></span><span class=line><span class=cl>kubectl get pods -A
</span></span><span class=line><span class=cl>kubectl get pods -n kube-system
</span></span><span class=line><span class=cl>kubectl get pods -l <span class=nv>app</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>kubectl get pods --show-labels
</span></span><span class=line><span class=cl>kubectl get pods --sort-by<span class=o>=</span>.status.startTime
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看详情</span>
</span></span><span class=line><span class=cl>kubectl describe pod &lt;pod-name&gt;
</span></span><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -o yaml
</span></span><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -o json
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实时监控</span>
</span></span><span class=line><span class=cl>kubectl get pods -w
</span></span><span class=line><span class=cl>kubectl top pods
</span></span><span class=line><span class=cl>kubectl top pods --containers
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多资源查看</span>
</span></span><span class=line><span class=cl>kubectl get pods,svc,deploy
</span></span><span class=line><span class=cl>kubectl get all
</span></span></code></pre></td></tr></table></div></div><h4 id=1013-资源创建与删除>10.1.3 资源创建与删除</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建资源</span>
</span></span><span class=line><span class=cl>kubectl apply -f deployment.yaml  <span class=c1># 推荐，幂等</span>
</span></span><span class=line><span class=cl>kubectl create -f service.yaml    <span class=c1># 仅创建</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除资源</span>
</span></span><span class=line><span class=cl>kubectl delete -f deployment.yaml
</span></span><span class=line><span class=cl>kubectl delete pod &lt;pod-name&gt;
</span></span><span class=line><span class=cl>kubectl delete pods -l <span class=nv>app</span><span class=o>=</span>nginx
</span></span><span class=line><span class=cl>kubectl delete pods --all
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 强制删除</span>
</span></span><span class=line><span class=cl>kubectl delete pod &lt;pod-name&gt; --grace-period<span class=o>=</span><span class=m>0</span> --force
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 清空命名空间</span>
</span></span><span class=line><span class=cl>kubectl delete all --all -n &lt;namespace&gt;
</span></span><span class=line><span class=cl>kubectl delete namespace &lt;namespace-name&gt;
</span></span></code></pre></td></tr></table></div></div><h4 id=1014-pod-操作>10.1.4 Pod 操作</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看日志</span>
</span></span><span class=line><span class=cl>kubectl logs &lt;pod-name&gt;
</span></span><span class=line><span class=cl>kubectl logs -f &lt;pod-name&gt;
</span></span><span class=line><span class=cl>kubectl logs --tail<span class=o>=</span><span class=m>20</span> &lt;pod-name&gt;
</span></span><span class=line><span class=cl>kubectl logs --since<span class=o>=</span>1h &lt;pod-name&gt;
</span></span><span class=line><span class=cl>kubectl logs &lt;pod-name&gt; -c &lt;container-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进入容器</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod-name&gt; -- /bin/bash
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod-name&gt; -c &lt;container-name&gt; -- sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行命令</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> &lt;pod-name&gt; -- ls /
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 文件复制</span>
</span></span><span class=line><span class=cl>kubectl cp &lt;pod-name&gt;:/path/to/file /local/path
</span></span><span class=line><span class=cl>kubectl cp /local/file &lt;pod-name&gt;:/path/to/file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 端口转发</span>
</span></span><span class=line><span class=cl>kubectl port-forward &lt;pod-name&gt; 8080:80
</span></span><span class=line><span class=cl>kubectl port-forward svc/&lt;service-name&gt; 3000:80
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 临时调试 Pod</span>
</span></span><span class=line><span class=cl>kubectl run debug-pod --rm -i --tty --image<span class=o>=</span>busybox -- sh
</span></span><span class=line><span class=cl>kubectl run curl-test --rm -i --image<span class=o>=</span>curlimages/curl -- curl http://nginx-service
</span></span></code></pre></td></tr></table></div></div><h3 id=102-deployment-操作>10.2 Deployment 操作</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看 Deployment</span>
</span></span><span class=line><span class=cl>kubectl get deployments
</span></span><span class=line><span class=cl>kubectl get deploy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 滚动更新</span>
</span></span><span class=line><span class=cl>kubectl <span class=nb>set</span> image deployment/nginx <span class=nv>nginx</span><span class=o>=</span>nginx:1.20
</span></span><span class=line><span class=cl>kubectl rollout status deployment/nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 扩缩容</span>
</span></span><span class=line><span class=cl>kubectl scale deployment/nginx --replicas<span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 回滚</span>
</span></span><span class=line><span class=cl>kubectl rollout undo deployment/nginx
</span></span><span class=line><span class=cl>kubectl rollout undo deployment/nginx --to-revision<span class=o>=</span><span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看历史</span>
</span></span><span class=line><span class=cl>kubectl rollout <span class=nb>history</span> deployment/nginx
</span></span><span class=line><span class=cl>kubectl rollout <span class=nb>history</span> deployment/nginx --revision<span class=o>=</span><span class=m>3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 暂停/恢复</span>
</span></span><span class=line><span class=cl>kubectl rollout pause deployment/nginx
</span></span><span class=line><span class=cl>kubectl rollout resume deployment/nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编辑配置</span>
</span></span><span class=line><span class=cl>kubectl edit deployment/nginx
</span></span></code></pre></td></tr></table></div></div><h3 id=103-service-操作>10.3 Service 操作</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看 Service</span>
</span></span><span class=line><span class=cl>kubectl get services
</span></span><span class=line><span class=cl>kubectl get svc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 暴露 Deployment</span>
</span></span><span class=line><span class=cl>kubectl expose deployment/nginx --type<span class=o>=</span>NodePort --port<span class=o>=</span><span class=m>80</span>
</span></span><span class=line><span class=cl>kubectl expose deployment/nginx --type<span class=o>=</span>LoadBalancer --port<span class=o>=</span><span class=m>80</span> --target-port<span class=o>=</span><span class=m>8080</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 Endpoint</span>
</span></span><span class=line><span class=cl>kubectl get endpoints &lt;service-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看详情</span>
</span></span><span class=line><span class=cl>kubectl describe svc &lt;service-name&gt;
</span></span></code></pre></td></tr></table></div></div><h3 id=104-配置与上下文管理>10.4 配置与上下文管理</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看配置</span>
</span></span><span class=line><span class=cl>kubectl config view
</span></span><span class=line><span class=cl>kubectl config view --raw
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看当前上下文</span>
</span></span><span class=line><span class=cl>kubectl config current-context
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 列出所有上下文</span>
</span></span><span class=line><span class=cl>kubectl config get-contexts
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 切换上下文</span>
</span></span><span class=line><span class=cl>kubectl config use-context &lt;context-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加集群配置</span>
</span></span><span class=line><span class=cl>kubectl config set-cluster &lt;cluster-name&gt; --server<span class=o>=</span>https://192.168.200.101:6443
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加用户凭证</span>
</span></span><span class=line><span class=cl>kubectl config set-credentials &lt;user-name&gt; --token<span class=o>=</span>&lt;token&gt;
</span></span><span class=line><span class=cl>kubectl config set-credentials &lt;user-name&gt; --client-certificate<span class=o>=</span>/path/to/cert --client-key<span class=o>=</span>/path/to/key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置上下文</span>
</span></span><span class=line><span class=cl>kubectl config set-context &lt;context-name&gt; --cluster<span class=o>=</span>&lt;cluster-name&gt; --user<span class=o>=</span>&lt;user-name&gt; --namespace<span class=o>=</span>default
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除上下文</span>
</span></span><span class=line><span class=cl>kubectl config delete-context &lt;context-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置默认命名空间</span>
</span></span><span class=line><span class=cl>kubectl config set-context --current --namespace<span class=o>=</span>&lt;namespace-name&gt;
</span></span></code></pre></td></tr></table></div></div><h3 id=105-调试与故障排查>10.5 调试与故障排查</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 权限检查</span>
</span></span><span class=line><span class=cl>kubectl auth can-i create pods
</span></span><span class=line><span class=cl>kubectl auth can-i <span class=s2>&#34;*&#34;</span> <span class=s2>&#34;*&#34;</span> --all-namespaces
</span></span><span class=line><span class=cl>kubectl auth can-i list secrets --as<span class=o>=</span>system:serviceaccount:default:test-sa
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看 API 请求日志</span>
</span></span><span class=line><span class=cl>kubectl get pods -v<span class=o>=</span><span class=m>6</span>  <span class=c1># 级别 0-9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启动临时调试容器</span>
</span></span><span class=line><span class=cl>kubectl run debug-pod --rm -i --tty --image<span class=o>=</span>nicolaka/netshoot -- sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看资源配额</span>
</span></span><span class=line><span class=cl>kubectl get resourcequota -n &lt;namespace&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看网络策略</span>
</span></span><span class=line><span class=cl>kubectl get networkpolicies
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看所有 API 资源</span>
</span></span><span class=line><span class=cl>kubectl api-resources --verbs<span class=o>=</span>list --namespaced -o name <span class=p>|</span> xargs -n <span class=m>1</span> kubectl get --show-kind --ignore-not-found -n &lt;namespace&gt;
</span></span></code></pre></td></tr></table></div></div><h3 id=106-高级技巧>10.6 高级技巧</h3><h4 id=1061-合并多个-kubeconfig>10.6.1 合并多个 kubeconfig</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nv>KUBECONFIG</span><span class=o>=</span>file1:file2:file3 kubectl config view --merge --flatten &gt; ~/.kube/config
</span></span></code></pre></td></tr></table></div></div><h4 id=1062-生成-yaml-模板>10.6.2 生成 YAML 模板</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 生成 Pod 模板（不创建）</span>
</span></span><span class=line><span class=cl>kubectl run nginx --image<span class=o>=</span>nginx --dry-run<span class=o>=</span>client -o yaml &gt; pod.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成 Deployment 模板</span>
</span></span><span class=line><span class=cl>kubectl create deploy nginx --image<span class=o>=</span>nginx --replicas<span class=o>=</span><span class=m>3</span> --dry-run<span class=o>=</span>client -o yaml &gt; deploy.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 生成 Service 模板</span>
</span></span><span class=line><span class=cl>kubectl expose deploy/nginx --port<span class=o>=</span><span class=m>80</span> --dry-run<span class=o>=</span>client -o yaml &gt; service.yaml
</span></span></code></pre></td></tr></table></div></div><h4 id=1063-标签与注解操作>10.6.3 标签与注解操作</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加标签</span>
</span></span><span class=line><span class=cl>kubectl label pods &lt;pod-name&gt; <span class=nv>env</span><span class=o>=</span>prod
</span></span><span class=line><span class=cl>kubectl label nodes node1 <span class=nv>disk</span><span class=o>=</span>ssd <span class=nv>gpu</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除标签</span>
</span></span><span class=line><span class=cl>kubectl label pods &lt;pod-name&gt; env-
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加注解</span>
</span></span><span class=line><span class=cl>kubectl annotate pods &lt;pod-name&gt; <span class=nv>description</span><span class=o>=</span><span class=s2>&#34;Production nginx pod&#34;</span> commit-hash<span class=o>=</span><span class=s2>&#34;a1b2c3d&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看标签和注解</span>
</span></span><span class=line><span class=cl>kubectl get pods --show-labels
</span></span><span class=line><span class=cl>kubectl describe pod &lt;pod-name&gt;
</span></span></code></pre></td></tr></table></div></div><h4 id=1064-jsonpath-提取>10.6.4 JSONPath 提取</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 提取特定字段</span>
</span></span><span class=line><span class=cl>kubectl get pods &lt;pod-name&gt; -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.status.podIP}&#39;</span>
</span></span><span class=line><span class=cl>kubectl get pods &lt;pod-name&gt; -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{.spec.containers[*].name}&#39;</span>
</span></span><span class=line><span class=cl>kubectl get pods &lt;pod-name&gt; -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s1>&#39;{range .spec.containers[*]}{.name}{&#34;\t&#34;}{.image}{&#34;\n&#34;}{end}&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 提取 Secret 并解码</span>
</span></span><span class=line><span class=cl>kubectl get secret &lt;secret-name&gt; -o <span class=nv>jsonpath</span><span class=o>=</span><span class=s2>&#34;{.data.password}&#34;</span> <span class=p>|</span> base64 -d
</span></span></code></pre></td></tr></table></div></div><h4 id=1065-批量操作>10.6.5 批量操作</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 批量删除 Evicted Pod</span>
</span></span><span class=line><span class=cl>kubectl get pods <span class=p>|</span> grep Evicted <span class=p>|</span> awk <span class=s1>&#39;{print $1}&#39;</span> <span class=p>|</span> xargs kubectl delete pod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批量重启 Deployment</span>
</span></span><span class=line><span class=cl>kubectl get deploy -n default -o name <span class=p>|</span> xargs -I <span class=o>{}</span> kubectl rollout restart <span class=o>{}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 导出所有 ConfigMap</span>
</span></span><span class=line><span class=cl>kubectl get configmap -n default -o yaml &gt; configmaps.yaml
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=11-监控与日志>11. 监控与日志</h2><h3 id=111-metrics-server>11.1 Metrics Server</h3><p><strong>部署</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或修改配置以允许不安全 TLS</span>
</span></span><span class=line><span class=cl>kubectl apply -f - <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>apiVersion: apps/v1
</span></span></span><span class=line><span class=cl><span class=s>kind: Deployment
</span></span></span><span class=line><span class=cl><span class=s>metadata:
</span></span></span><span class=line><span class=cl><span class=s>  name: metrics-server
</span></span></span><span class=line><span class=cl><span class=s>  namespace: kube-system
</span></span></span><span class=line><span class=cl><span class=s>spec:
</span></span></span><span class=line><span class=cl><span class=s>  template:
</span></span></span><span class=line><span class=cl><span class=s>    spec:
</span></span></span><span class=line><span class=cl><span class=s>      containers:
</span></span></span><span class=line><span class=cl><span class=s>      - name: metrics-server
</span></span></span><span class=line><span class=cl><span class=s>        args:
</span></span></span><span class=line><span class=cl><span class=s>        - --kubelet-insecure-tls
</span></span></span><span class=line><span class=cl><span class=s>        - --kubelet-preferred-address-types=InternalIP
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>使用</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectl top nodes
</span></span><span class=line><span class=cl>kubectl top pods
</span></span><span class=line><span class=cl>kubectl top pods --containers
</span></span></code></pre></td></tr></table></div></div><h3 id=112-prometheus--grafana-监控方案>11.2 Prometheus + Grafana 监控方案</h3><p><strong>架构</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Prometheus ← ServiceMonitor ← Prometheus Operator
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Prometheus Adapter ← HPA
</span></span><span class=line><span class=cl>    ↓
</span></span><span class=line><span class=cl>Grafana (可视化)
</span></span></code></pre></td></tr></table></div></div><p><strong>部署步骤</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加 Helm 仓库</span>
</span></span><span class=line><span class=cl>helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
</span></span><span class=line><span class=cl>helm repo update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 kube-prometheus-stack</span>
</span></span><span class=line><span class=cl>helm install monitoring prometheus-community/kube-prometheus-stack <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace monitoring --create-namespace <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set grafana.adminPassword<span class=o>=</span>admin123
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看访问地址</span>
</span></span><span class=line><span class=cl>kubectl get svc -n monitoring
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 端口转发访问 Grafana</span>
</span></span><span class=line><span class=cl>kubectl port-forward -n monitoring svc/monitoring-grafana 3000:80
</span></span><span class=line><span class=cl><span class=c1># 访问 http://localhost:3000，用户名 admin，密码 admin123</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>常用监控指标</strong>：</p><ul><li><strong>集群层面</strong>：节点 CPU/内存/磁盘使用率</li><li><strong>Pod 层面</strong>：CPU/内存使用量、重启次数</li><li><strong>应用层面</strong>：HTTP 请求量、错误率、延迟</li></ul><h3 id=113-efk-日志栈>11.3 EFK 日志栈</h3><p><strong>组件</strong>：</p><ul><li><strong>Elasticsearch</strong>：日志存储与检索</li><li><strong>Fluentd/Fluentbit</strong>：日志采集与转发</li><li><strong>Kibana</strong>：日志可视化</li></ul><p><strong>部署示例</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加 Helm 仓库</span>
</span></span><span class=line><span class=cl>helm repo add elastic https://helm.elastic.co
</span></span><span class=line><span class=cl>helm repo update
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 Elasticsearch</span>
</span></span><span class=line><span class=cl>helm install elasticsearch elastic/elasticsearch <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace logging --create-namespace <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set <span class=nv>replicas</span><span class=o>=</span><span class=m>3</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set volumeClaimTemplate.storageClassName<span class=o>=</span>fast-ssd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 Fluentd</span>
</span></span><span class=line><span class=cl>helm install fluentd stable/fluentd <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace logging <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set elasticsearch.host<span class=o>=</span>elasticsearch-master.logging.svc.cluster.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 安装 Kibana</span>
</span></span><span class=line><span class=cl>helm install kibana elastic/kibana <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --namespace logging <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --set <span class=nv>elasticsearchHosts</span><span class=o>=</span>http://elasticsearch-master:9200
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 端口转发访问 Kibana</span>
</span></span><span class=line><span class=cl>kubectl port-forward -n logging svc/kibana-kibana 5601:5601
</span></span></code></pre></td></tr></table></div></div><h3 id=114-监控最佳实践>11.4 监控最佳实践</h3><ol><li><p><strong>监控分层</strong>：</p><ul><li>基础设施监控（节点、网络、存储）</li><li>Kubernetes 组件监控（API Server、ETCD、调度器）</li><li>应用性能监控（APM）</li><li>业务指标监控</li></ul></li><li><p><strong>告警策略</strong>：</p><ul><li>Pod 重启次数 > 5 次/小时</li><li>节点磁盘使用率 > 85%</li><li>API Server 延迟 > 1s</li><li>ETCD 集群 Leader 变更</li></ul></li><li><p><strong>日志规范</strong>：</p><ul><li>使用 JSON 格式输出日志</li><li>包含时间戳、日志级别、请求 ID</li><li>避免日志过大，设置合理的日志轮转</li></ul></li></ol><hr><h2 id=12-故障排查>12. 故障排查</h2><h3 id=121-pod-问题排查流程>12.1 Pod 问题排查流程</h3><h4 id=1211-pod-一直处于-pending>12.1.1 Pod 一直处于 Pending</h4><p><strong>排查步骤</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查看 Pod 详情</span>
</span></span><span class=line><span class=cl>kubectl describe pod &lt;pod-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 常见原因</span>
</span></span><span class=line><span class=cl>- 资源不足：检查节点资源 kubectl describe nodes
</span></span><span class=line><span class=cl>- 调度约束：检查 nodeSelector/affinity/tolerations
</span></span><span class=line><span class=cl>- 镜像拉取失败：检查镜像地址和 Secret
</span></span><span class=line><span class=cl>- PV 绑定失败：检查 StorageClass 和 PVC
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 查看调度事件</span>
</span></span><span class=line><span class=cl>kubectl get events --sort-by<span class=o>=</span>.lastTimestamp <span class=p>|</span> grep &lt;pod-name&gt;
</span></span></code></pre></td></tr></table></div></div><h4 id=1212-pod-一直处于-crashloopbackoff>12.1.2 Pod 一直处于 CrashLoopBackOff</h4><p><strong>排查步骤</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查看日志</span>
</span></span><span class=line><span class=cl>kubectl logs &lt;pod-name&gt; --previous  <span class=c1># 查看前一次日志</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 进入容器调试</span>
</span></span><span class=line><span class=cl>kubectl run debug --rm -it --image<span class=o>=</span>busybox -- sh
</span></span><span class=line><span class=cl><span class=c1># 在容器内测试网络、DNS、依赖服务</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查健康检查配置</span>
</span></span><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -o yaml <span class=p>|</span> grep -A <span class=m>10</span> liveness
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 常见问题</span>
</span></span><span class=line><span class=cl>- 应用启动失败：检查镜像、配置、依赖
</span></span><span class=line><span class=cl>- 端口冲突：检查容器端口配置
</span></span><span class=line><span class=cl>- 权限不足：检查 SecurityContext 和 RBAC
</span></span></code></pre></td></tr></table></div></div><h4 id=1213-pod-网络不通>12.1.3 Pod 网络不通</h4><p><strong>排查步骤</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 检查 Pod IP</span>
</span></span><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -o wide
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 检查 Service Endpoint</span>
</span></span><span class=line><span class=cl>kubectl get endpoints &lt;service-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 在节点上测试</span>
</span></span><span class=line><span class=cl><span class=c1># 进入节点网络命名空间</span>
</span></span><span class=line><span class=cl>docker run --rm -it --net<span class=o>=</span>host nicolaka/netshoot -- ping &lt;pod-ip&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 检查网络插件</span>
</span></span><span class=line><span class=cl>kubectl get pods -n kube-system -l k8s-app<span class=o>=</span>calico-node
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 检查 NetworkPolicy</span>
</span></span><span class=line><span class=cl>kubectl get networkpolicy -A
</span></span></code></pre></td></tr></table></div></div><h3 id=122-节点问题排查>12.2 节点问题排查</h3><h4 id=1221-node-状态为-notready>12.2.1 Node 状态为 NotReady</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查看节点详情</span>
</span></span><span class=line><span class=cl>kubectl describe node &lt;node-name&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 在节点上检查 kubelet 状态</span>
</span></span><span class=line><span class=cl>systemctl status kubelet
</span></span><span class=line><span class=cl>journalctl -u kubelet -f
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查容器运行时</span>
</span></span><span class=line><span class=cl>crictl ps
</span></span><span class=line><span class=cl>crictl logs &lt;container-id&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 常见原因</span>
</span></span><span class=line><span class=cl>- kubelet 无法连接 API Server
</span></span><span class=line><span class=cl>- 容器运行时故障
</span></span><span class=line><span class=cl>- 磁盘空间不足（/var/lib/kubelet）
</span></span><span class=line><span class=cl>- 网络插件异常
</span></span></code></pre></td></tr></table></div></div><h4 id=1222-磁盘压力导致-pod-驱逐>12.2.2 磁盘压力导致 Pod 驱逐</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查看节点资源</span>
</span></span><span class=line><span class=cl>kubectl describe node &lt;node-name&gt; <span class=p>|</span> grep -A <span class=m>5</span> Capacity
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 查看被驱逐 Pod</span>
</span></span><span class=line><span class=cl>kubectl get pods --all-namespaces <span class=p>|</span> grep Evicted
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 清理 Docker 镜像</span>
</span></span><span class=line><span class=cl>docker image prune -a
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 清理无用卷</span>
</span></span><span class=line><span class=cl>docker volume prune
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 调整磁盘预留</span>
</span></span><span class=line><span class=cl>vim /var/lib/kubelet/config.yaml
</span></span><span class=line><span class=cl>evictionHard:
</span></span><span class=line><span class=cl>  imagefs.available: 15%
</span></span><span class=line><span class=cl>  memory.available: 100Mi
</span></span><span class=line><span class=cl>  nodefs.available: 10%
</span></span><span class=line><span class=cl>  nodefs.inodesFree: 5%
</span></span></code></pre></td></tr></table></div></div><h3 id=123-调度问题排查>12.3 调度问题排查</h3><h4 id=1231-调度器无法调度>12.3.1 调度器无法调度</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查看调度器日志</span>
</span></span><span class=line><span class=cl>kubectl logs -n kube-system kube-scheduler-&lt;master-node&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 检查调度器扩展器</span>
</span></span><span class=line><span class=cl>kubectl get configmap scheduler-config -n kube-system -o yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 模拟调度</span>
</span></span><span class=line><span class=cl>kubectl create deployment <span class=nb>test</span> --image<span class=o>=</span>nginx --dry-run<span class=o>=</span>client -o yaml <span class=p>|</span> kubectl apply -f-
</span></span><span class=line><span class=cl>kubectl describe pod &lt;test-pod&gt;
</span></span></code></pre></td></tr></table></div></div><h4 id=1232-亲和性配置错误>12.3.2 亲和性配置错误</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 检查 Pod 亲和性配置</span>
</span></span><span class=line><span class=cl>kubectl get pod &lt;pod-name&gt; -o yaml <span class=p>|</span> grep -A <span class=m>20</span> affinity
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 检查节点标签</span>
</span></span><span class=line><span class=cl>kubectl get nodes --show-labels
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 验证调度器配置</span>
</span></span><span class=line><span class=cl>kubectl get configmap scheduler-config -n kube-system -o yaml
</span></span></code></pre></td></tr></table></div></div><h3 id=124-etcd-问题排查>12.4 ETCD 问题排查</h3><h4 id=1241-etcd-集群健康检查>12.4.1 ETCD 集群健康检查</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 检查 ETCD 集群健康</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl endpoint health <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --endpoints<span class=o>=</span>https://127.0.0.1:2379,https://127.0.0.2:2379,https://127.0.0.3:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cacert<span class=o>=</span>/etc/kubernetes/pki/etcd/ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cert<span class=o>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --key<span class=o>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查 Leader</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl endpoint status <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --endpoints<span class=o>=</span>https://127.0.0.1:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cacert<span class=o>=</span>/etc/kubernetes/pki/etcd/ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cert<span class=o>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --key<span class=o>=</span>/etc/kubernetes/pki/etcd/healthcheck-client.key <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --write-out<span class=o>=</span>table
</span></span></code></pre></td></tr></table></div></div><h4 id=1242-etcd-空间不足>12.4.2 ETCD 空间不足</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 检查 ETCD 存储</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl --write-out<span class=o>=</span>table endpoint status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 清理缓存</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl compact &lt;revision&gt;
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl defrag
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 调整 ETCD 配额</span>
</span></span><span class=line><span class=cl><span class=c1># 编辑 /etc/kubernetes/manifests/etcd.yaml</span>
</span></span><span class=line><span class=cl><span class=c1># 添加 --quota-backend-bytes=8589934592 (8GB)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=125-性能问题排查>12.5 性能问题排查</h3><h4 id=1251-api-server-响应慢>12.5.1 API Server 响应慢</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 检查 API Server 请求量</span>
</span></span><span class=line><span class=cl>kubectl top pods -n kube-system -l <span class=nv>component</span><span class=o>=</span>kube-apiserver
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 查看审计日志</span>
</span></span><span class=line><span class=cl><span class=c1># 启用审计日志</span>
</span></span><span class=line><span class=cl><span class=c1># /etc/kubernetes/manifests/kube-apiserver.yaml</span>
</span></span><span class=line><span class=cl>--audit-policy-file<span class=o>=</span>/etc/kubernetes/audit-policy.yaml
</span></span><span class=line><span class=cl>--audit-log-path<span class=o>=</span>/var/log/kubernetes/audit.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查 etcd 延迟</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl check perf
</span></span></code></pre></td></tr></table></div></div><h4 id=1252-网络延迟高>12.5.2 网络延迟高</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 测试 Pod 间网络</span>
</span></span><span class=line><span class=cl>kubectl run netshoot --rm -it --image<span class=o>=</span>nicolaka/netshoot -- sh
</span></span><span class=line><span class=cl><span class=c1># 在容器中</span>
</span></span><span class=line><span class=cl>iperf3 -c &lt;target-pod-ip&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 检查 CNI 插件日志</span>
</span></span><span class=line><span class=cl>kubectl logs -n kube-system -l k8s-app<span class=o>=</span>calico-node
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查节点网络</span>
</span></span><span class=line><span class=cl>ethtool -S eth0 <span class=p>|</span> grep drop
</span></span><span class=line><span class=cl>netstat -i
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=13-性能优化>13. 性能优化</h2><h3 id=131-集群优化>13.1 集群优化</h3><h4 id=1311-api-server-优化>13.1.1 API Server 优化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># /etc/kubernetes/manifests/kube-apiserver.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>kube-apiserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>kube-apiserver</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>max-requests-inflight=400 </span><span class=w> </span><span class=c># 限制并发请求数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>max-mutating-requests-inflight=200</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>enable-aggregator-routing=true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>audit-log-maxsize=100</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>audit-log-maxbackup=10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>audit-log-maxage=30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>2000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>2Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1312-调度器优化>13.1.2 调度器优化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 自定义调度配置</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>kubescheduler.config.k8s.io/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>KubeSchedulerConfiguration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>profiles</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span>- <span class=nt>schedulerName</span><span class=p>:</span><span class=w> </span><span class=l>default-scheduler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>score</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>disabled</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ImageLocality</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>enabled</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>MyCustomPlugin</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>weight</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1313-etcd-优化>13.1.3 ETCD 优化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># ETCD 配置优化</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>etcd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>command</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=l>etcd</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>quota-backend-bytes=8589934592 </span><span class=w> </span><span class=c># 8GB</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>auto-compaction-mode=periodic</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>auto-compaction-retention=8h</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- --<span class=l>snapshot-count=50000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>500m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>2000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>4Gi</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=132-应用优化>13.2 应用优化</h3><h4 id=1321-资源请求设置最佳实践>13.2.1 资源请求设置最佳实践</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 根据实际使用情况设置 request 和 limit</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 初始设置为 limit 的 70%</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;700Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;700m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c># 通过监控确定峰值</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000m&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1322-jvm-应用优化>13.2.2 JVM 应用优化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># Java 应用需调整 JVM 参数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>java-app</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>my-java-app:1.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>JAVA_OPTS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;-Xms512m -Xmx1024m -XX:+UseG1GC -XX:MaxRAMPercentage=75.0&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;800Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1500Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1000m&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1323-镜像优化>13.2.3 镜像优化</h4><ul><li><strong>使用多阶段构建</strong>：</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-dockerfile data-lang=dockerfile><span class=line><span class=cl><span class=c># 构建阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>golang:1.20</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=s>builder</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=w> </span><span class=s>/go/src/app</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> . .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> go build -o main<span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># 运行阶段</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>FROM</span><span class=w> </span><span class=s>alpine:3.18</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>RUN</span> apk --no-cache add ca-certificates<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>WORKDIR</span><span class=w> </span><span class=s>/root</span>/<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>COPY</span> --from<span class=o>=</span>builder /go/src/app/main .<span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=k>CMD</span> <span class=p>[</span><span class=s2>&#34;./main&#34;</span><span class=p>]</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div><ul><li><strong>使用 distroless 镜像</strong>：减少攻击面</li><li><strong>设置镜像拉取策略</strong>：<code>imagePullPolicy: IfNotPresent</code></li></ul><h3 id=133-资源管理优化>13.3 资源管理优化</h3><h4 id=1331-资源配额resourcequota>13.3.1 资源配额（ResourceQuota）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ResourceQuota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>compute-quota</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>hard</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests.cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>requests.memory</span><span class=p>:</span><span class=w> </span><span class=l>100Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limits.cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;40&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>limits.memory</span><span class=p>:</span><span class=w> </span><span class=l>200Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>pods</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;50&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>services</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;20&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>persistentvolumeclaims</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;30&#34;</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1332-limitrange>13.3.2 LimitRange</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>LimitRange</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>mem-limit-range</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>default</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>default</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>1Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>1000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>defaultRequest</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>256Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>250m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>min</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>128Mi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>100m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>max</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=l>4000m</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Container</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=1333-节点维护cordondrain>13.3.3 节点维护（Cordon/Drain）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 标记节点不可调度</span>
</span></span><span class=line><span class=cl>kubectl cordon node1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 驱逐节点上 Pod</span>
</span></span><span class=line><span class=cl>kubectl drain node1 --ignore-daemonsets --delete-emptydir-data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 恢复节点</span>
</span></span><span class=line><span class=cl>kubectl uncordon node1
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=14-最佳实践>14. 最佳实践</h2><h3 id=141-生产环境建议>14.1 生产环境建议</h3><h4 id=1411-高可用架构>14.1.1 高可用架构</h4><ul><li><strong>Master 节点</strong>：至少 3 节点，跨可用区部署</li><li><strong>ETCD</strong>：独立集群，SSD 存储，定期备份</li><li><strong>负载均衡</strong>：硬件或软件 LB（HAProxy/NGINX）</li><li><strong>多可用区</strong>：节点分布在多个可用区</li></ul><h4 id=1412-备份与恢复>14.1.2 备份与恢复</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 备份 ETCD</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl snapshot save /backup/etcd-snapshot.db <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --endpoints<span class=o>=</span>https://127.0.0.1:2379 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cacert<span class=o>=</span>/etc/kubernetes/pki/etcd/ca.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --cert<span class=o>=</span>/etc/kubernetes/pki/etcd/server.crt <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --key<span class=o>=</span>/etc/kubernetes/pki/etcd/server.key
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份集群配置</span>
</span></span><span class=line><span class=cl>tar -czvf k8s-backup-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>.tar.gz /etc/kubernetes/ /var/lib/etcd/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 恢复 ETCD</span>
</span></span><span class=line><span class=cl><span class=nv>ETCDCTL_API</span><span class=o>=</span><span class=m>3</span> etcdctl snapshot restore /backup/etcd-snapshot.db <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>  --data-dir<span class=o>=</span>/var/lib/etcd-from-backup
</span></span></code></pre></td></tr></table></div></div><h4 id=1413-升级策略>14.1.3 升级策略</h4><ol><li><strong>小版本升级</strong>：1.27 → 1.28（跳过不超过 2 个版本）</li><li><strong>先升级 Master</strong>，再升级 Node</li><li><strong>逐个节点升级</strong>，避免集群中断</li><li><strong>测试环境验证</strong>，再升级生产环境</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Master 节点升级</span>
</span></span><span class=line><span class=cl>kubeadm upgrade plan
</span></span><span class=line><span class=cl>kubeadm upgrade apply v1.28.0
</span></span><span class=line><span class=cl>apt-mark unhold kubelet kubeadm kubectl
</span></span><span class=line><span class=cl>apt-get upgrade <span class=nv>kubelet</span><span class=o>=</span>1.28.0-00 <span class=nv>kubeadm</span><span class=o>=</span>1.28.0-00 <span class=nv>kubectl</span><span class=o>=</span>1.28.0-00
</span></span><span class=line><span class=cl>systemctl restart kubelet
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Node 节点升级</span>
</span></span><span class=line><span class=cl>kubeadm upgrade node
</span></span><span class=line><span class=cl>apt-get upgrade <span class=nv>kubelet</span><span class=o>=</span>1.28.0-00
</span></span><span class=line><span class=cl>systemctl restart kubelet
</span></span></code></pre></td></tr></table></div></div><h3 id=142-安全建议>14.2 安全建议</h3><h4 id=1421-集群安全加固>14.2.1 集群安全加固</h4><ol><li><strong>启用 RBAC</strong>：禁用 ABAC 和 Webhook</li><li><strong>使用 NetworkPolicy</strong>：默认拒绝所有流量</li><li><strong>启用 PSA</strong>：PodSecurity Admission</li><li><strong>定期轮换证书</strong>：kubeadm certs renew</li><li><strong>审计日志</strong>：记录所有 API 请求</li><li><strong>镜像安全</strong>：使用可信镜像仓库，扫描漏洞</li></ol><h4 id=1422-网络安全>14.2.2 网络安全</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 启用 API Server 加密</span>
</span></span><span class=line><span class=cl>--encryption-provider-config<span class=o>=</span>/etc/kubernetes/encryption-config.yaml
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置 TLS 1.2+</span>
</span></span><span class=line><span class=cl>--tls-min-version<span class=o>=</span>VersionTLS12
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 禁用不安全端口</span>
</span></span><span class=line><span class=cl>--insecure-port<span class=o>=</span><span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=1423-密钥管理>14.2.3 密钥管理</h4><ul><li>使用 Sealed Secrets 加密 Git 中的 Secret</li><li>使用 External Secrets Operator 集成云 KMS</li><li>定期轮换数据库密码和证书</li></ul><h3 id=143-运维建议>14.3 运维建议</h3><h4 id=1431-命令别名配置>14.3.1 命令别名配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加到 ~/.bashrc 或 ~/.zshrc</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>k</span><span class=o>=</span><span class=s1>&#39;kubectl&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kg</span><span class=o>=</span><span class=s1>&#39;kubectl get&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kgp</span><span class=o>=</span><span class=s1>&#39;kubectl get pods&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kgpa</span><span class=o>=</span><span class=s1>&#39;kubectl get pods -A&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kgs</span><span class=o>=</span><span class=s1>&#39;kubectl get svc&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kgd</span><span class=o>=</span><span class=s1>&#39;kubectl get deploy&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>ke</span><span class=o>=</span><span class=s1>&#39;kubectl exec -it&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kl</span><span class=o>=</span><span class=s1>&#39;kubectl logs&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>klf</span><span class=o>=</span><span class=s1>&#39;kubectl logs -f&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kdp</span><span class=o>=</span><span class=s1>&#39;kubectl describe pod&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kds</span><span class=o>=</span><span class=s1>&#39;kubectl describe svc&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kdd</span><span class=o>=</span><span class=s1>&#39;kubectl describe deploy&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kaf</span><span class=o>=</span><span class=s1>&#39;kubectl apply -f&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kdf</span><span class=o>=</span><span class=s1>&#39;kubectl delete -f&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kgpw</span><span class=o>=</span><span class=s1>&#39;kubectl get pods -w&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kgpn</span><span class=o>=</span><span class=s1>&#39;kubectl get pods --sort-by=.status.startTime&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>ksys</span><span class=o>=</span><span class=s1>&#39;kubectl -n kube-system&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>kdp</span><span class=o>=</span><span class=s1>&#39;kubectl describe pod&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>ksysg</span><span class=o>=</span><span class=s1>&#39;kubectl get pods -n kube-system&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 自动补全</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> &lt;<span class=o>(</span>kubectl completion bash<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nb>complete</span> -o default -F __start_kubectl k
</span></span></code></pre></td></tr></table></div></div><h4 id=1432-命名空间规划>14.3.2 命名空间规划</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 按环境划分</span>
</span></span><span class=line><span class=cl>kubectl create namespace dev
</span></span><span class=line><span class=cl>kubectl create namespace <span class=nb>test</span>
</span></span><span class=line><span class=cl>kubectl create namespace staging
</span></span><span class=line><span class=cl>kubectl create namespace prod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按团队/项目划分</span>
</span></span><span class=line><span class=cl>kubectl create namespace team-a
</span></span><span class=line><span class=cl>kubectl create namespace team-b
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置资源配额</span>
</span></span><span class=line><span class=cl>kubectl apply -f resourcequota.yaml -n prod
</span></span></code></pre></td></tr></table></div></div><h4 id=1433-gitops-工作流>14.3.3 GitOps 工作流</h4><ul><li><strong>ArgoCD</strong>：声明式持续部署</li><li><strong>Flux</strong>：GitOps 工具</li><li><strong>最佳实践</strong>：<ul><li>所有配置存储在 Git</li><li>使用 PR 进行变更审核</li><li>自动化测试和部署</li></ul></li></ul><hr><h2 id=15-附录>15. 附录</h2><h3 id=151-常用资源清单模板>15.1 常用资源清单模板</h3><h4 id=1511-完整应用栈模板>15.1.1 完整应用栈模板</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># namespace.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Namespace</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># configmap.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ConfigMap</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-config</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>APP_ENV</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>LOG_LEVEL</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># secret.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Opaque</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>data</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>DB_PASSWORD</span><span class=p>:</span><span class=w> </span><span class=l>cGFzc3dvcmQxMjM= </span><span class=w> </span><span class=c># base64 编码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># deployment.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>replicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>template</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>containers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>myapp:1.0</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>containerPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>env</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>DB_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>valueFrom</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>secretKeyRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-secret</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>              </span><span class=nt>key</span><span class=p>:</span><span class=w> </span><span class=l>DB_PASSWORD</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>APP_ENV</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>value</span><span class=p>:</span><span class=w> </span><span class=l>production</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;256Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;250m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;512Mi&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>livenessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/health</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>30</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>readinessProbe</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>httpGet</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/ready</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>initialDelaySeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>periodSeconds</span><span class=p>:</span><span class=w> </span><span class=m>5</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># service.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>LoadBalancer</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>targetPort</span><span class=p>:</span><span class=w> </span><span class=m>8080</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>protocol</span><span class=p>:</span><span class=w> </span><span class=l>TCP</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>app</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nn>---</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># hpa.yaml</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>autoscaling/v2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>HorizontalPodAutoscaler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp-hpa</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>scaleTargetRef</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>apps/v1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Deployment</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>myapp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>minReplicas</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>maxReplicas</span><span class=p>:</span><span class=w> </span><span class=m>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>metrics</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cpu</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>70</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Resource</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>resource</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>memory</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>target</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>Utilization</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>averageUtilization</span><span class=p>:</span><span class=w> </span><span class=m>80</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h3 id=152-快速参考命令>15.2 快速参考命令</h3><h4 id=1521-常用命令列表>15.2.1 常用命令列表</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 集群状态</span>
</span></span><span class=line><span class=cl>kubectl cluster-info
</span></span><span class=line><span class=cl>kubectl get nodes
</span></span><span class=line><span class=cl>kubectl top nodes
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 资源查看</span>
</span></span><span class=line><span class=cl>kubectl get pods -A -o wide
</span></span><span class=line><span class=cl>kubectl get svc -A
</span></span><span class=line><span class=cl>kubectl get ingress -A
</span></span><span class=line><span class=cl>kubectl get pv,pvc -A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 日志和调试</span>
</span></span><span class=line><span class=cl>kubectl logs -f &lt;pod&gt; -c &lt;container&gt;
</span></span><span class=line><span class=cl>kubectl <span class=nb>exec</span> -it &lt;pod&gt; -- sh
</span></span><span class=line><span class=cl>kubectl debug node/&lt;node-name&gt; -it --image<span class=o>=</span>busybox
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 资源清理</span>
</span></span><span class=line><span class=cl>kubectl delete pod --field-selector<span class=o>=</span>status.phase<span class=o>=</span>Failed -A
</span></span><span class=line><span class=cl>kubectl delete pod --field-selector<span class=o>=</span>status.phase<span class=o>=</span>Succeeded -A
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 强制删除 Terminating 资源</span>
</span></span><span class=line><span class=cl>kubectl patch pod &lt;pod-name&gt; -p <span class=s1>&#39;{&#34;metadata&#34;:{&#34;finalizers&#34;:null}}&#39;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=1522-检查清单>15.2.2 检查清单</h4><ul><li><input disabled type=checkbox> 节点状态是否 Ready</li><li><input disabled type=checkbox> 核心 Pod 是否 Running</li><li><input disabled type=checkbox> 存储是否充足</li><li><input disabled type=checkbox> 网络是否通畅</li><li><input disabled type=checkbox> 证书是否过期</li><li><input disabled type=checkbox> 日志是否正常</li><li><input disabled type=checkbox> 监控是否告警</li></ul><h3 id=153-参考资料与工具>15.3 参考资料与工具</h3><h4 id=1531-官方资源>15.3.1 官方资源</h4><ul><li><strong>Kubernetes 官方文档</strong>：https://kubernetes.io/docs/</li><li><strong>kubectl 备忘单</strong>：https://kubernetes.io/docs/reference/kubectl/cheatsheet/</li><li><strong>API 参考</strong>：https://kubernetes.io/docs/reference/kubernetes-api/</li></ul><h4 id=1532-推荐工具>15.3.2 推荐工具</h4><ul><li><strong>k9s</strong>：终端 UI 工具<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>k9s
</span></span></code></pre></td></tr></table></div></div></li><li><strong>Lens</strong>：桌面 UI 工具<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>https://k8slens.dev/
</span></span></code></pre></td></tr></table></div></div></li><li><strong>kubectx/kubens</strong>：快速切换上下文和命名空间<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>kubectx context-name
</span></span><span class=line><span class=cl>kubens namespace-name
</span></span></code></pre></td></tr></table></div></div></li><li><strong>kube-ps1</strong>：命令行提示符增强<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>source</span> /usr/local/opt/kube-ps1/share/kube-ps1.sh
</span></span><span class=line><span class=cl><span class=nv>PS1</span><span class=o>=</span><span class=s1>&#39;$(kube_ps1)&#39;</span><span class=nv>$PS1</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=1533-学习资源>15.3.3 学习资源</h4><ul><li><strong>Kubernetes The Hard Way</strong>：手动部署 Kubernetes</li><li><strong>CKA/CKAD 认证</strong>：官方认证考试</li><li><strong>Katacoda 交互式教程</strong>：在线实践环境</li><li><strong>Kubernetes Patterns</strong>：设计模式指南</li></ul><hr><h2 id=文档说明>文档说明</h2><p>本指南整合了 Kubernetes 部署、架构、命令、监控、故障排查等完整知识体系。建议结合实际集群环境进行实践操作。对于生产环境部署，请务必：</p><ol><li>在测试环境充分验证</li><li>实施高可用架构</li><li>建立完善的监控告警</li><li>定期备份 ETCD 数据</li><li>遵循安全最佳实践</li></ol><p>文档将持续更新，欢迎关注最新版本变化。</p></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>本文采用 CC BY-NC-SA 4.0 许可协议</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/utility/wireshar/><div class=article-details><h2 class=article-title>Wireshar</h2></div></a></article><article><a href=/utility/tcpdump/><div class=article-details><h2 class=article-title>Tcpdump</h2></div></a></article><article><a href=/utility/ansible/><div class=article-details><h2 class=article-title>Ansible</h2></div></a></article><article><a href=/utility/jenkins/><div class=article-details><h2 class=article-title>Jenkins</h2></div></a></article><article><a href=/utility/nfs/><div class=article-details><h2 class=article-title>NFS</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo data-repo-id data-category data-category-id data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2025 © 2025 win. 保留所有权利.</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>