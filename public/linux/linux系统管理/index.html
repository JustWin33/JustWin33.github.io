<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Linux系统管理 一、存储管理基础 1.1 RAID磁盘阵列技术 1.1.1 RAID级别对比与选择 级别 核心特点 磁盘利用率 最少磁盘数 容错能力 适用场景 RAID 0 条带化，性能翻倍，无冗余 100% 2 0 临时数据、性能测试 RAID 1 完全镜像，100%冗余 50% 2 1 系统盘、关键数据 RAID 5 分布式校验，读快写慢 (N-1)/N 3 1 文件服务器、常规应用 RAID 6 双校验，更高安全 (N-2)/N 4 2 归档存储、高可靠性需求 RAID 10 RAID1+0，镜像+条带 50% 4 每组1个 数据库、高性能需求 RAID 01 RAID0+1，条带+镜像 50% 4 每组1个 不推荐，安全性低于RAID10 关键区别：\n"><title>Linux系统管理</title><link rel=canonical href=http://localhost:1313/linux/linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Linux系统管理"><meta property='og:description' content="Linux系统管理 一、存储管理基础 1.1 RAID磁盘阵列技术 1.1.1 RAID级别对比与选择 级别 核心特点 磁盘利用率 最少磁盘数 容错能力 适用场景 RAID 0 条带化，性能翻倍，无冗余 100% 2 0 临时数据、性能测试 RAID 1 完全镜像，100%冗余 50% 2 1 系统盘、关键数据 RAID 5 分布式校验，读快写慢 (N-1)/N 3 1 文件服务器、常规应用 RAID 6 双校验，更高安全 (N-2)/N 4 2 归档存储、高可靠性需求 RAID 10 RAID1+0，镜像+条带 50% 4 每组1个 数据库、高性能需求 RAID 01 RAID0+1，条带+镜像 50% 4 每组1个 不推荐，安全性低于RAID10 关键区别：\n"><meta property='og:url' content='http://localhost:1313/linux/linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/'><meta property='og:site_name' content='JustWin'><meta property='og:type' content='article'><meta property='article:section' content='Linux'><meta property='article:published_time' content='2025-11-10T00:00:00+00:00'><meta property='article:modified_time' content='2025-11-10T00:00:00+00:00'><meta property='og:image' content='http://localhost:1313/'><meta name=twitter:title content="Linux系统管理"><meta name=twitter:description content="Linux系统管理 一、存储管理基础 1.1 RAID磁盘阵列技术 1.1.1 RAID级别对比与选择 级别 核心特点 磁盘利用率 最少磁盘数 容错能力 适用场景 RAID 0 条带化，性能翻倍，无冗余 100% 2 0 临时数据、性能测试 RAID 1 完全镜像，100%冗余 50% 2 1 系统盘、关键数据 RAID 5 分布式校验，读快写慢 (N-1)/N 3 1 文件服务器、常规应用 RAID 6 双校验，更高安全 (N-2)/N 4 2 归档存储、高可靠性需求 RAID 10 RAID1+0，镜像+条带 50% 4 每组1个 数据库、高性能需求 RAID 01 RAID0+1，条带+镜像 50% 4 每组1个 不推荐，安全性低于RAID10 关键区别：\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='http://localhost:1313/'><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/avatar_hu_89ca753ea8ea85c7.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>✍️</span></figure><div class=site-meta><h1 class=site-name><a href=/>JustWin</a></h1><h2 class=site-description>分享技术与生活</h2></div></header><ol class=menu-social><li><a href=https://github.com/passion-win target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="0 0 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>github [#142]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M94 7399C99.523 7399 104 7403.59 104 7409.253 104 7413.782 101.138 7417.624 97.167 7418.981 96.66 7419.082 96.48 7418.762 96.48 7418.489 96.48 7418.151 96.492 7417.047 96.492 7415.675 96.492 7414.719 96.172 7414.095 95.813 7413.777 98.04 7413.523 100.38 7412.656 100.38 7408.718 100.38 7407.598 99.992 7406.684 99.35 7405.966 99.454 7405.707 99.797 7404.664 99.252 7403.252 99.252 7403.252 98.414 7402.977 96.505 7404.303 95.706 7404.076 94.85 7403.962 94 7403.958 93.15 7403.962 92.295 7404.076 91.497 7404.303 89.586 7402.977 88.746 7403.252 88.746 7403.252 88.203 7404.664 88.546 7405.707 88.649 7405.966 88.01 7406.684 87.619 7407.598 87.619 7408.718 87.619 7412.646 89.954 7413.526 92.175 7413.785 91.889 7414.041 91.63 7414.493 91.54 7415.156 90.97 7415.418 89.522 7415.871 88.63 7414.304 88.63 7414.304 88.101 7413.319 87.097 7413.247 87.097 7413.247 86.122 7413.234 87.029 7413.87 87.029 7413.87 87.684 7414.185 88.139 7415.37 88.139 7415.37 88.726 7417.2 91.508 7416.58 91.513 7417.437 91.522 7418.245 91.522 7418.489 91.522 7418.76 91.338 7419.077 90.839 7418.982 86.865 7417.627 84 7413.783 84 7409.253 84 7403.59 88.478 7399 94 7399" id="github-[#142]"/></g></g></g></svg></a></li><li><a href=https://t.me/+TFjBeZzowwU1YTY1 target=_blank title=telegram rel=me><svg viewBox="0 0 640 640"><path d="M320 72C183 72 72 183 72 320S183 568 320 568 568 457 568 320 457 72 320 72zM435 240.7C431.3 279.9 415.1 375.1 406.9 419c-3.5 18.6-10.3 24.8-16.9 25.4C375.6 445.7 364.7 434.9 350.7 425.7c-21.8-14.3-34.2-23.2-55.3-37.2C270.9 372.4 286.8 363.5 300.7 349 304.4 345.2 367.8 287.5 369 282.3 369.2 281.6 369.3 279.2 367.8 277.9 366.3 276.6 364.2 277.1 362.7 277.4 360.5 277.9 325.6 300.9 258.1 346.5 248.2 353.3 239.2 356.6 231.2 356.4 222.3 356.2 205.3 351.4 192.6 347.3 177.1 342.3 164.7 339.6 165.8 331 166.4 326.5 172.5 322 184.2 317.3 256.5 285.8 304.7 265 328.8 255c68.9-28.6 83.2-33.6 92.5-33.8C423.4 221.2 427.9 221.7 430.9 224.1 432.9 225.8 434.1 228.2 434.4 230.8 434.9 234 435 237.3 434.8 240.6z"/></svg></a></li><li><a href=https://twitter.com/@win1688888888 target=_blank title=twitter rel=me><svg width="800" height="800" viewBox="0 -2 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>twitter [#154]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-60.000000, -7521.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M10.29 7377C17.837 7377 21.965 7370.84365 21.965 7365.50546 21.965 7365.33021 21.965 7365.15595 21.953 7364.98267 22.756 7364.41163 23.449 7363.70276 24 7362.8915 23.252 7363.21837 22.457 7363.433 21.644 7363.52751 22.5 7363.02244 23.141 7362.2289 23.448 7361.2926 22.642 7361.76321 21.761 7362.095 20.842 7362.27321 19.288 7360.64674 16.689 7360.56798 15.036 7362.09796 13.971 7363.08447 13.518 7364.55538 13.849 7365.95835 10.55 7365.79492 7.476 7364.261 5.392 7361.73762 4.303 7363.58363 4.86 7365.94457 6.663 7367.12996 6.01 7367.11125 5.371 7366.93797 4.8 7366.62489V7366.67608C4.801 7368.5989 6.178 7370.2549 8.092 7370.63591 7.488 7370.79836 6.854 7370.82199 6.24 7370.70483 6.777 7372.35099 8.318 7373.47829 10.073 7373.51078 8.62 7374.63513 6.825 7375.24554 4.977 7375.24358 4.651 7375.24259 4.325 7375.22388 4 7375.18549 5.877 7376.37088 8.06 7377 10.29 7376.99705" id="twitter-[#154]"/></g></g></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><span>首页</span></a></li><li><a href=/links/><span>网站</span></a></li><li><a href=/linux/><span>Linux</span></a></li><li><a href=/docker/><span>docker</span></a></li><li><a href=/k8s/><span>k8s</span></a></li><li><a href=/mysql/><span>mysql</span></a></li><li><a href=/project/><span>项目</span></a></li><li><a href=/kali/><span>kali</span></a></li><li><a href=/ubuntu/><span>ubuntu</span></a></li><li><a href=/utility/><span>Utility</span></a></li><li><a href=/about/><span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=http://localhost:1313/ selected>中文</option><option value=http://localhost:1313/en/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#一存储管理基础>一、存储管理基础</a><ol><li><a href=#11-raid磁盘阵列技术>1.1 RAID磁盘阵列技术</a><ol><li><a href=#111-raid级别对比与选择>1.1.1 RAID级别对比与选择</a></li><li><a href=#112-软raid搭建与维护mdadm>1.1.2 软RAID搭建与维护（mdadm）</a></li><li><a href=#113-硬raid配置要点>1.1.3 硬RAID配置要点</a></li></ol></li><li><a href=#12-lvm逻辑卷管理>1.2 LVM逻辑卷管理</a><ol><li><a href=#121-lvm三层架构>1.2.1 LVM三层架构</a></li><li><a href=#122-完整操作步骤>1.2.2 完整操作步骤</a></li><li><a href=#123-重要注意事项>1.2.3 重要注意事项</a></li></ol></li></ol></li><li><a href=#二linux系统引导与启动管理>二、Linux系统引导与启动管理</a><ol><li><a href=#21-完整引导流程详解>2.1 完整引导流程详解</a></li><li><a href=#22-grub2修复与配置>2.2 GRUB2修复与配置</a><ol><li><a href=#221-grubcfg丢失修复>2.2.1 grub.cfg丢失修复</a></li><li><a href=#222-mbr引导程序损坏修复>2.2.2 MBR引导程序损坏修复</a></li><li><a href=#223-grub2密码保护>2.2.3 GRUB2密码保护</a></li></ol></li><li><a href=#23-root密码破解>2.3 root密码破解</a><ol><li><a href=#231-rdbreak方法推荐>2.3.1 rd.break方法（推荐）</a></li><li><a href=#232-initbinsh方法>2.3.2 init=/bin/sh方法</a></li><li><a href=#233-单用户模式传统方法>2.3.3 单用户模式（传统方法）</a></li></ol></li><li><a href=#24-系统服务管理systemd>2.4 系统服务管理（systemd）</a></li></ol></li><li><a href=#三进程与任务管理>三、进程与任务管理</a><ol><li><a href=#31-进程查看命令详解>3.1 进程查看命令详解</a></li><li><a href=#32-进程控制信号>3.2 进程控制信号</a></li><li><a href=#33-后台任务管理>3.3 后台任务管理</a></li><li><a href=#34-at一次性计划任务>3.4 at一次性计划任务</a></li><li><a href=#35-crontab周期性计划任务>3.5 crontab周期性计划任务</a></li></ol></li><li><a href=#四网络基础与配置>四、网络基础与配置</a><ol><li><a href=#41-tcpip协议栈详解>4.1 TCP/IP协议栈详解</a><ol><li><a href=#411-osi与tcpip模型对比>4.1.1 OSI与TCP/IP模型对比</a></li><li><a href=#412-tcp三次握手与四次挥手>4.1.2 TCP三次握手与四次挥手</a></li><li><a href=#413-tcp状态机11种状态>4.1.3 TCP状态机11种状态</a></li></ol></li><li><a href=#42-网络配置命令>4.2 网络配置命令</a><ol><li><a href=#421-ifconfig传统命令>4.2.1 ifconfig（传统命令）</a></li><li><a href=#422-ip命令推荐iproute2工具集>4.2.2 ip命令（推荐，iproute2工具集）</a></li><li><a href=#423-其他网络工具>4.2.3 其他网络工具</a></li><li><a href=#424-配置文件管理>4.2.4 配置文件管理</a></li><li><a href=#425-路由配置>4.2.5 路由配置</a></li><li><a href=#426-ip转发路由功能>4.2.6 IP转发（路由功能）</a></li></ol></li><li><a href=#43-dns与主机名配置>4.3 DNS与主机名配置</a><ol><li><a href=#431-dns解析流程完整版>4.3.1 DNS解析流程（完整版）</a></li><li><a href=#432-etchosts文件>4.3.2 /etc/hosts文件</a></li><li><a href=#433-主机名配置>4.3.3 主机名配置</a></li></ol></li></ol></li><li><a href=#五用户与权限管理>五、用户与权限管理</a><ol><li><a href=#51-用户账号体系>5.1 用户账号体系</a><ol><li><a href=#511-账号文件结构>5.1.1 账号文件结构</a></li><li><a href=#512-用户管理命令>5.1.2 用户管理命令</a></li><li><a href=#513-组管理命令>5.1.3 组管理命令</a></li></ol></li><li><a href=#52-权限管理模型>5.2 权限管理模型</a><ol><li><a href=#521-文件权限表示>5.2.1 文件权限表示</a></li><li><a href=#522-权限修改命令>5.2.2 权限修改命令</a></li><li><a href=#523-特殊权限详解>5.2.3 特殊权限详解</a></li><li><a href=#524-umask掩码>5.2.4 umask掩码</a></li></ol></li><li><a href=#53-acl访问控制列表补充>5.3 ACL访问控制列表（补充）</a></li></ol></li><li><a href=#六系统安全加固>六、系统安全加固</a><ol><li><a href=#61-sudo提权管理>6.1 sudo提权管理</a><ol><li><a href=#611-sudo配置详解>6.1.1 sudo配置详解</a></li><li><a href=#612-sudo命令使用>6.1.2 sudo命令使用</a></li></ol></li><li><a href=#62-账户清理与锁定>6.2 账户清理与锁定</a></li><li><a href=#63-密码策略强化>6.3 密码策略强化</a></li><li><a href=#64-历史命令管理>6.4 历史命令管理</a></li><li><a href=#65-自动注销与终端安全>6.5 自动注销与终端安全</a></li><li><a href=#66-ssh服务加固>6.6 SSH服务加固</a></li><li><a href=#67-文件系统安全>6.7 文件系统安全</a></li></ol></li><li><a href=#七服务管理nginxmysqlredisdns>七、服务管理（NGINX/MySQL/Redis/DNS）</a><ol><li><a href=#71-nginx服务配置与管理>7.1 NGINX服务配置与管理</a><ol><li><a href=#711-nginx核心优势>7.1.1 NGINX核心优势</a></li><li><a href=#712-源码安装步骤生产环境推荐>7.1.2 源码安装步骤（生产环境推荐）</a></li><li><a href=#713-nginx配置结构>7.1.3 NGINX配置结构</a></li><li><a href=#714-location匹配规则重要>7.1.4 location匹配规则（重要）</a></li><li><a href=#715-nginx性能优化>7.1.5 NGINX性能优化</a></li><li><a href=#716-日志管理与切割>7.1.6 日志管理与切割</a></li></ol></li><li><a href=#72-mysql数据库管理>7.2 MySQL数据库管理</a><ol><li><a href=#721-mysql-sql语句分类>7.2.1 MySQL SQL语句分类</a></li><li><a href=#722-索引管理>7.2.2 索引管理</a></li><li><a href=#723-事务管理>7.2.3 事务管理</a></li><li><a href=#724-备份与恢复>7.2.4 备份与恢复</a></li></ol></li><li><a href=#73-redis缓存系统>7.3 Redis缓存系统</a><ol><li><a href=#731-redis核心优势>7.3.1 Redis核心优势</a></li><li><a href=#732-redis安装部署>7.3.2 Redis安装部署</a></li><li><a href=#733-redis主从复制>7.3.3 Redis主从复制</a></li><li><a href=#734-redis哨兵集群>7.3.4 Redis哨兵集群</a></li><li><a href=#735-redis缓存问题与解决方案>7.3.5 Redis缓存问题与解决方案</a></li><li><a href=#736-redis淘汰策略>7.3.6 Redis淘汰策略</a></li><li><a href=#737-redis持久化机制>7.3.7 Redis持久化机制</a></li></ol></li><li><a href=#74-dns服务配置bind>7.4 DNS服务配置（BIND）</a><ol><li><a href=#741-主域名服务器配置>7.4.1 主域名服务器配置</a></li><li><a href=#742-从域名服务器配置>7.4.2 从域名服务器配置</a></li><li><a href=#743-dns工具使用>7.4.3 DNS工具使用</a></li></ol></li></ol></li><li><a href=#八系统监控与故障排查>八、系统监控与故障排查</a><ol><li><a href=#81-系统性能监控>8.1 系统性能监控</a></li><li><a href=#82-日志管理>8.2 日志管理</a><ol><li><a href=#821-日志文件说明>8.2.1 日志文件说明</a></li><li><a href=#822-syslog与rsyslog>8.2.2 syslog与rsyslog</a></li><li><a href=#823-journalctlsystemd日志>8.2.3 journalctl（systemd日志）</a></li></ol></li><li><a href=#83-故障排查方法论>8.3 故障排查方法论</a><ol><li><a href=#831-故障排查步骤>8.3.1 故障排查步骤</a></li><li><a href=#832-常见问题排查>8.3.2 常见问题排查</a></li></ol></li><li><a href=#84-核心转储分析>8.4 核心转储分析</a></li></ol></li><li><a href=#九shell脚本编程>九、Shell脚本编程</a><ol><li><a href=#91-脚本基础与执行方式>9.1 脚本基础与执行方式</a></li><li><a href=#92-重定向与管道>9.2 重定向与管道</a></li><li><a href=#93-变量与数据类型>9.3 变量与数据类型</a></li><li><a href=#94-流程控制>9.4 流程控制</a><ol><li><a href=#941-条件判断>9.4.1 条件判断</a></li><li><a href=#942-循环语句>9.4.2 循环语句</a></li><li><a href=#943-case分支>9.4.3 case分支</a></li></ol></li><li><a href=#95-函数定义>9.5 函数定义</a></li><li><a href=#96-数组操作>9.6 数组操作</a></li><li><a href=#97-正则表达式>9.7 正则表达式</a></li><li><a href=#98-错误处理与调试>9.8 错误处理与调试</a></li></ol></li><li><a href=#十系统服务脚本编写>十、系统服务脚本编写</a><ol><li><a href=#101-systemd服务单元>10.1 Systemd服务单元</a></li><li><a href=#102-传统sysvinit脚本兼容>10.2 传统SysVinit脚本（兼容）</a></li></ol></li><li><a href=#十一系统备份与灾难恢复>十一、系统备份与灾难恢复</a><ol><li><a href=#111-备份策略制定>11.1 备份策略制定</a></li><li><a href=#112-rsync备份方案>11.2 rsync备份方案</a></li><li><a href=#113-mysql数据备份>11.3 MySQL数据备份</a></li><li><a href=#第一部分勘误与优化建议-audit-report>第一部分：勘误与优化建议 (Audit Report)</a><ol><li><a href=#1-存储管理-raid--lvm>1. 存储管理 (RAID & LVM)</a></li><li><a href=#2-网络配置-modern-linux>2. 网络配置 (Modern Linux)</a></li><li><a href=#3-安全加固>3. 安全加固</a></li><li><a href=#4-脚本编程>4. 脚本编程</a></li><li><a href=#十二时间同步服务-chrony>十二、时间同步服务 (Chrony)</a></li><li><a href=#十三现代防火墙管理-firewalld-rich-rules>十三、现代防火墙管理 (Firewalld Rich Rules)</a></li><li><a href=#十四selinux-实用操作指南>十四、SELinux 实用操作指南</a></li><li><a href=#十五docker-容器基础-补充模块>十五、Docker 容器基础 (补充模块)</a></li></ol></li><li><a href=#第三部分现代网络配置替换方案-nmcli>第三部分：现代网络配置替换方案 (nmcli)</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category></header><div class=article-title-wrapper><h2 class=article-title><a href=/linux/linux%E7%B3%BB%E7%BB%9F%E7%AE%A1%E7%90%86/>Linux系统管理</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-11-10</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 54 分钟</time></div></footer></div></header><section class=article-content><h1 id=linux系统管理>Linux系统管理</h1><h2 id=一存储管理基础>一、存储管理基础</h2><h3 id=11-raid磁盘阵列技术>1.1 RAID磁盘阵列技术</h3><h4 id=111-raid级别对比与选择>1.1.1 RAID级别对比与选择</h4><div class=table-wrapper><table><thead><tr><th>级别</th><th>核心特点</th><th>磁盘利用率</th><th>最少磁盘数</th><th>容错能力</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>RAID 0</strong></td><td>条带化，性能翻倍，无冗余</td><td>100%</td><td>2</td><td>0</td><td>临时数据、性能测试</td></tr><tr><td><strong>RAID 1</strong></td><td>完全镜像，100%冗余</td><td>50%</td><td>2</td><td>1</td><td>系统盘、关键数据</td></tr><tr><td><strong>RAID 5</strong></td><td>分布式校验，读快写慢</td><td>(N-1)/N</td><td>3</td><td>1</td><td>文件服务器、常规应用</td></tr><tr><td><strong>RAID 6</strong></td><td>双校验，更高安全</td><td>(N-2)/N</td><td>4</td><td>2</td><td>归档存储、高可靠性需求</td></tr><tr><td><strong>RAID 10</strong></td><td>RAID1+0，镜像+条带</td><td>50%</td><td>4</td><td>每组1个</td><td>数据库、高性能需求</td></tr><tr><td><strong>RAID 01</strong></td><td>RAID0+1，条带+镜像</td><td>50%</td><td>4</td><td>每组1个</td><td>不推荐，安全性低于RAID10</td></tr></tbody></table></div><p><strong>关键区别</strong>：</p><ul><li>RAID10先镜像后条带，安全性更高，允许不同镜像组各坏1块盘</li><li>RAID01先条带后镜像，安全性低，一旦某个RAID0组坏1块盘，整个阵列失效</li></ul><h4 id=112-软raid搭建与维护mdadm>1.1.2 软RAID搭建与维护（mdadm）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 准备磁盘分区（类型fd: Linux raid auto）</span>
</span></span><span class=line><span class=cl>fdisk /dev/sdb
</span></span><span class=line><span class=cl><span class=c1># 依次创建分区：n→p→1→回车→+20G→t→1→fd→w</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>partprobe /dev/sdb  <span class=c1># 重读分区表</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建RAID5阵列（3数据盘+1热备）</span>
</span></span><span class=line><span class=cl>mdadm -C /dev/md5 -l5 -n3 -x1 /dev/sdb1 /dev/sdb2 /dev/sdb3 /dev/sdb4
</span></span><span class=line><span class=cl><span class=c1># 参数说明：</span>
</span></span><span class=line><span class=cl><span class=c1># -C: 创建模式</span>
</span></span><span class=line><span class=cl><span class=c1># -l: RAID级别（level）</span>
</span></span><span class=line><span class=cl><span class=c1># -n: 数据盘数量</span>
</span></span><span class=line><span class=cl><span class=c1># -x: 热备盘数量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 查看RAID状态</span>
</span></span><span class=line><span class=cl>cat /proc/mdstat
</span></span><span class=line><span class=cl>mdadm -D /dev/md5  <span class=c1># 详细信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 创建配置文件（必须操作，否则重启后RAID名称会变化）</span>
</span></span><span class=line><span class=cl>mdadm -D -s &gt; /etc/mdadm.conf
</span></span><span class=line><span class=cl><span class=c1># 编辑确保包含：DEVICE /dev/sdb1 /dev/sdb2 /dev/sdb3 /dev/sdb4</span>
</span></span><span class=line><span class=cl><span class=c1># 和ARRAY信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 格式化与挂载</span>
</span></span><span class=line><span class=cl>mkfs.xfs /dev/md5
</span></span><span class=line><span class=cl>mkdir /raid5
</span></span><span class=line><span class=cl>mount /dev/md5 /raid5
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/dev/md5 /raid5 xfs defaults 0 0&#34;</span> &gt;&gt; /etc/fstab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 模拟故障与恢复</span>
</span></span><span class=line><span class=cl>mdadm /dev/md5 --fail /dev/sdb2  <span class=c1># 模拟sdb2故障</span>
</span></span><span class=line><span class=cl>cat /proc/mdstat  <span class=c1># 观察热备盘自动重建</span>
</span></span><span class=line><span class=cl>mdadm /dev/md5 --remove /dev/sdb2  <span class=c1># 移除故障盘</span>
</span></span><span class=line><span class=cl>mdadm /dev/md5 --add /dev/sdb5     <span class=c1># 添加新盘（自动成为热备）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 性能测试</span>
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span>/raid5/test.data <span class=nv>bs</span><span class=o>=</span>1M <span class=nv>count</span><span class=o>=</span><span class=m>1024</span>
</span></span><span class=line><span class=cl>hdparm -t /dev/md5
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 停止与删除RAID</span>
</span></span><span class=line><span class=cl>umount /raid5
</span></span><span class=line><span class=cl>mdadm -S /dev/md5              <span class=c1># 停止阵列</span>
</span></span><span class=line><span class=cl>mdadm --zero-superblock /dev/sdb1 /dev/sdb2 /dev/sdb3 /dev/sdb4  <span class=c1># 清除超级块</span>
</span></span><span class=line><span class=cl>rm -rf /etc/mdadm.conf
</span></span></code></pre></td></tr></table></div></div><h4 id=113-硬raid配置要点>1.1.3 硬RAID配置要点</h4><p>硬RAID通过RAID卡BIOS配置：</p><ol><li>开机按Ctrl+R或Ctrl+A进入RAID卡配置界面</li><li>选择Create Virtual Drive</li><li>选择RAID级别，添加物理磁盘</li><li>设置热备盘（Global Hot Spare）</li><li>配置完成后，系统识别为单一/dev/sdX设备</li><li>安装操作系统前需加载RAID卡驱动</li></ol><h3 id=12-lvm逻辑卷管理>1.2 LVM逻辑卷管理</h3><h4 id=121-lvm三层架构>1.2.1 LVM三层架构</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>物理卷(PV) → 卷组(VG) → 逻辑卷(LV)
</span></span><span class=line><span class=cl>  ↓              ↓              ↓
</span></span><span class=line><span class=cl>物理磁盘      存储池        可用分区
</span></span><span class=line><span class=cl>(PE=4MB)   (PE集合)     (LE映射)
</span></span></code></pre></td></tr></table></div></div><p><strong>关键术语</strong>：</p><ul><li><strong>PE</strong>（Physical Extent）：物理卷的基本单元，默认4MB</li><li><strong>LE</strong>（Logical Extent）：逻辑卷的基本单元，与PE一一对应</li><li><strong>UUID</strong>：每个PV、VG、LV的唯一标识符</li><li><strong>元数据区域</strong>：存储LVM配置信息，默认在每个PV头部</li></ul><h4 id=122-完整操作步骤>1.2.2 完整操作步骤</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 准备物理卷（以/dev/sdc为例）</span>
</span></span><span class=line><span class=cl>pvcreate /dev/sdc1 /dev/sdc2 /dev/sdc3
</span></span><span class=line><span class=cl><span class=c1># 批量创建：pvcreate /dev/sdc{1,2,3}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看PV信息</span>
</span></span><span class=line><span class=cl>pvscan                    <span class=c1># 扫描所有PV</span>
</span></span><span class=line><span class=cl>pvs                       <span class=c1># 简要信息（推荐）</span>
</span></span><span class=line><span class=cl>pvdisplay /dev/sdc1       <span class=c1># 详细信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建卷组myvg</span>
</span></span><span class=line><span class=cl>vgcreate myvg /dev/sdc1 /dev/sdc2
</span></span><span class=line><span class=cl><span class=c1># 指定PE大小：vgcreate -s 16M myvg /dev/sdc1 /dev/sdc2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看VG信息</span>
</span></span><span class=line><span class=cl>vgscan
</span></span><span class=line><span class=cl>vgs
</span></span><span class=line><span class=cl>vgdisplay myvg            <span class=c1># 查看PE总数、空闲数</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 创建逻辑卷</span>
</span></span><span class=line><span class=cl>lvcreate -L 8G -n mylv myvg        <span class=c1># 指定大小</span>
</span></span><span class=line><span class=cl>lvcreate -l <span class=m>2048</span> -n mylv myvg      <span class=c1># 指定PE数（2048*4MB=8G）</span>
</span></span><span class=line><span class=cl>lvcreate -l +100%FREE -n mylv myvg <span class=c1># 使用全部剩余空间</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看LV信息</span>
</span></span><span class=line><span class=cl>lvscan
</span></span><span class=line><span class=cl>lvs
</span></span><span class=line><span class=cl>lvdisplay /dev/myvg/mylv
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 格式化与挂载</span>
</span></span><span class=line><span class=cl>mkfs.xfs /dev/myvg/mylv
</span></span><span class=line><span class=cl><span class=c1># 或mkfs.ext4 /dev/myvg/mylv</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>mkdir /media/s1
</span></span><span class=line><span class=cl>mount /dev/myvg/mylv /media/s1
</span></span><span class=line><span class=cl>df -hT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置开机挂载</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/dev/myvg/mylv /media/s1 xfs defaults 0 0&#34;</span> &gt;&gt; /etc/fstab
</span></span><span class=line><span class=cl><span class=c1># 或使用UUID（推荐）</span>
</span></span><span class=line><span class=cl>blkid /dev/myvg/mylv &gt;&gt; /etc/fstab  <span class=c1># 然后编辑替换</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 在线扩展（LVM最大优势）</span>
</span></span><span class=line><span class=cl>lvextend -L +1G /dev/myvg/mylv       <span class=c1># 增加1G</span>
</span></span><span class=line><span class=cl><span class=c1># 或lvextend -L 9G /dev/myvg/mylv    # 扩展到9G</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># XFS文件系统调整（必须在线执行）</span>
</span></span><span class=line><span class=cl>xfs_growfs /dev/myvg/mylv           <span class=c1># 自动扩展至LV大小</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ext4文件系统调整（可离线或在线）</span>
</span></span><span class=line><span class=cl>resize2fs /dev/myvg/mylv            <span class=c1># 扩展到LV大小</span>
</span></span><span class=line><span class=cl><span class=c1># resize2fs /dev/myvg/mylv 5G       # 收缩到5G（需先卸载）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看扩展结果</span>
</span></span><span class=line><span class=cl>df -hT
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 卷组扩容</span>
</span></span><span class=line><span class=cl>vgextend myvg /dev/sdc3             <span class=c1># 添加新PV到VG</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 迁移数据（pvmove）</span>
</span></span><span class=line><span class=cl><span class=c1># 将sdc1上的数据迁移到sdc3</span>
</span></span><span class=line><span class=cl>pvmove /dev/sdc1 /dev/sdc3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 删除LVM（顺序：LV→VG→PV）</span>
</span></span><span class=line><span class=cl>umount /media/s1
</span></span><span class=line><span class=cl>lvremove /dev/myvg/mylv             <span class=c1># 确认删除</span>
</span></span><span class=line><span class=cl>vgremove myvg
</span></span><span class=line><span class=cl>pvremove /dev/sdc1 /dev/sdc2 /dev/sdc3
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 9. 创建快照（重要功能）</span>
</span></span><span class=line><span class=cl>lvcreate -L 1G -s -n mylv_snap /dev/myvg/mylv
</span></span><span class=line><span class=cl><span class=c1># 参数：-s创建快照，-n快照名称</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 恢复快照</span>
</span></span><span class=line><span class=cl>umount /media/s1
</span></span><span class=line><span class=cl>lvconvert --merge /dev/myvg/mylv_snap  <span class=c1># 合并快照到原LV</span>
</span></span><span class=line><span class=cl>mount /dev/myvg/mylv /media/s1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除快照</span>
</span></span><span class=line><span class=cl>lvremove /dev/myvg/mylv_snap
</span></span></code></pre></td></tr></table></div></div><h4 id=123-重要注意事项>1.2.3 重要注意事项</h4><ol><li><p><strong>/boot分区不能放在LVM上</strong></p><ul><li>原因：GRUB无法识别LVM，系统启动流程为BIOS→MBR→GRUB→内核→init，GRUB阶段无法读取LVM中的文件</li><li>解决方案：/boot必须是普通分区或独立RAID1</li></ul></li><li><p><strong>扩容后df看不到新空间</strong></p><ul><li>现象：lvextend成功，但df显示大小不变</li><li>原因：逻辑卷扩容后，文件系统未同步更新</li><li>解决：执行<code>xfs_growsfs</code>（XFS）或<code>resize2fs</code>（ext4）</li></ul></li><li><p><strong>根分区在线扩容</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 添加新硬盘→创建PV→扩展VG→扩展LV→扩展文件系统</span>
</span></span><span class=line><span class=cl>pvcreate /dev/sdd1
</span></span><span class=line><span class=cl>vgextend centos /dev/sdd1    <span class=c1># 假设VG名为centos</span>
</span></span><span class=line><span class=cl>lvextend -l +100%FREE /dev/centos/root
</span></span><span class=line><span class=cl>xfs_growfs /
</span></span></code></pre></td></tr></table></div></div></li><li><p><strong>PE大小选择</strong></p><ul><li>默认4MB适合大多数场景</li><li>大数据存储可考虑16MB或更大，减少元数据开销</li><li>PE大小在VG创建后不可更改</li></ul></li></ol><h2 id=二linux系统引导与启动管理>二、Linux系统引导与启动管理</h2><h3 id=21-完整引导流程详解>2.1 完整引导流程详解</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>1. 开机自检(POST, Power-On Self-Test)
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   BIOS/UEFI初始化硬件，加载CMOS设置
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   按启动顺序查找可引导设备（硬盘、U盘、PXE）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>2. MBR引导（传统BIOS模式）
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   读取磁盘第一个扇区（512字节）的MBR
</span></span><span class=line><span class=cl>   - 446字节：引导加载程序（GRUB stage1）
</span></span><span class=line><span class=cl>   - 64字节：分区表（4个主分区，各16字节）
</span></span><span class=line><span class=cl>   - 2字节：55AA签名（有效性标志）
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   GRUB stage1加载/boot/grub2/i386-pc/boot.img
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>3. GRUB2菜单阶段
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   加载/boot/grub2/grub.cfg（由grub2-mkconfig生成）
</span></span><span class=line><span class=cl>   加载字体、背景、菜单项
</span></span><span class=line><span class=cl>   加载内核vmlinuz和initramfs到内存
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   按Shift或Esc可进入GRUB编辑模式
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>4. 内核加载阶段
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   解压vmlinuz到内存
</span></span><span class=line><span class=cl>   初始化硬件、挂载驱动
</span></span><span class=line><span class=cl>   加载initramfs（临时根文件系统）
</span></span><span class=line><span class=cl>   - 包含必要的驱动模块（ext4/xfs、RAID、LVM）
</span></span><span class=line><span class=cl>   - 包含udev、systemd等早期启动程序
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>5. systemd初始化（CentOS 7+）
</span></span><span class=line><span class=cl>   ↓
</span></span><span class=line><span class=cl>   systemd成为PID 1，取代传统SysVinit
</span></span><span class=line><span class=cl>   读取/etc/systemd/system/default.target（指向multi-user.target或graphical.target）
</span></span><span class=line><span class=cl>   并行启动系统服务（由systemctl管理）
</span></span><span class=line><span class=cl>   执行/etc/rc.local（兼容性）
</span></span><span class=line><span class=cl>   启动getty/login提示用户登录
</span></span></code></pre></td></tr></table></div></div><h3 id=22-grub2修复与配置>2.2 GRUB2修复与配置</h3><h4 id=221-grubcfg丢失修复>2.2.1 grub.cfg丢失修复</h4><p><strong>现象</strong>：开机直接进入grub rescue模式</p><p><strong>修复步骤</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查找boot分区</span>
</span></span><span class=line><span class=cl>grub rescue&gt; ls
</span></span><span class=line><span class=cl><span class=o>(</span>hd0<span class=o>)</span> <span class=o>(</span>hd0,msdos1<span class=o>)</span> <span class=o>(</span>hd0,msdos2<span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 尝试查看分区内容</span>
</span></span><span class=line><span class=cl>grub rescue&gt; ls <span class=o>(</span>hd0,msdos1<span class=o>)</span>/
</span></span><span class=line><span class=cl><span class=c1># 如果能看到vmlinuz和initramfs，说明这是boot分区</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 设置根和prefix</span>
</span></span><span class=line><span class=cl>grub rescue&gt; <span class=nb>set</span> <span class=nv>root</span><span class=o>=(</span>hd0,msdos1<span class=o>)</span>
</span></span><span class=line><span class=cl>grub rescue&gt; <span class=nb>set</span> <span class=nv>prefix</span><span class=o>=(</span>hd0,msdos1<span class=o>)</span>/boot/grub2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 加载必要模块</span>
</span></span><span class=line><span class=cl>grub rescue&gt; insmod linux
</span></span><span class=line><span class=cl>grub rescue&gt; insmod xfs   <span class=c1># 根据文件系统类型</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 手动引导（关键步骤）</span>
</span></span><span class=line><span class=cl>grub rescue&gt; linux16 /vmlinuz-3.10.0-1160.el7.x86_64 <span class=nv>root</span><span class=o>=</span>/dev/mapper/centos-root ro
</span></span><span class=line><span class=cl>grub rescue&gt; initrd16 /initramfs-3.10.0-1160.el7.x86_64.img
</span></span><span class=line><span class=cl>grub rescue&gt; boot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 进入系统后重建配置</span>
</span></span><span class=line><span class=cl>grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span></code></pre></td></tr></table></div></div><h4 id=222-mbr引导程序损坏修复>2.2.2 MBR引导程序损坏修复</h4><p><strong>现象</strong>：启动黑屏，无GRUB菜单</p><p><strong>修复方法</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 方法一：使用系统安装盘进入救援模式</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 选择Troubleshooting → Rescue a CentOS system</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 选择1) Continue，挂载原系统到/mnt/sysimage</span>
</span></span><span class=line><span class=cl>chroot /mnt/sysimage
</span></span><span class=line><span class=cl>grub2-install /dev/sda
</span></span><span class=line><span class=cl>grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl>reboot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法二：如果系统仍在运行</span>
</span></span><span class=line><span class=cl>grub2-install /dev/sda
</span></span><span class=line><span class=cl>grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span></code></pre></td></tr></table></div></div><h4 id=223-grub2密码保护>2.2.3 GRUB2密码保护</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 生成密码哈希</span>
</span></span><span class=line><span class=cl>grub2-mkpasswd-pbkdf2
</span></span><span class=line><span class=cl><span class=c1># 输入密码后得到：grub.pbkdf2.sha512.10000.xxx</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 编辑/etc/grub.d/00_header</span>
</span></span><span class=line><span class=cl>cat <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>set superusers=&#39;admin&#39;
</span></span></span><span class=line><span class=cl><span class=s>password_pbkdf2 admin grub.pbkdf2.sha512.10000.xxx
</span></span></span><span class=line><span class=cl><span class=s>export superusers
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 更新GRUB配置</span>
</span></span><span class=line><span class=cl>grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 效果：重启后按e编辑需输入用户名admin和密码</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=23-root密码破解>2.3 root密码破解</h3><h4 id=231-rdbreak方法推荐>2.3.1 rd.break方法（推荐）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 重启系统，在GRUB菜单按e编辑</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 找到linux16行，在行尾添加 rd.break</span>
</span></span><span class=line><span class=cl>linux16 ... ro rd.break
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. Ctrl+x启动</span>
</span></span><span class=line><span class=cl>switch_root:/# mount -o remount,rw /sysroot
</span></span><span class=line><span class=cl>switch_root:/# chroot /sysroot
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 修改密码</span>
</span></span><span class=line><span class=cl>sh-4.2# passwd
</span></span><span class=line><span class=cl>New password: 
</span></span><span class=line><span class=cl>Retype new password: 
</span></span><span class=line><span class=cl>sh-4.2# touch /.autorelabel  <span class=c1># 关键！重置SELinux标签</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 退出重启</span>
</span></span><span class=line><span class=cl>sh-4.2# <span class=nb>exit</span>
</span></span><span class=line><span class=cl>switch_root:/# <span class=nb>exit</span>
</span></span><span class=line><span class=cl><span class=c1># 系统会自动重启</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>注意</strong>：CentOS 7.2+可能需要：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>mount -o remount,rw /sysroot
</span></span><span class=line><span class=cl>chroot /sysroot
</span></span><span class=line><span class=cl>passwd
</span></span><span class=line><span class=cl>touch /.autorelabel
</span></span></code></pre></td></tr></table></div></div><h4 id=232-initbinsh方法>2.3.2 init=/bin/sh方法</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. GRUB编辑，在linux16行末添加 init=/bin/sh</span>
</span></span><span class=line><span class=cl>linux16 ... ro <span class=nv>init</span><span class=o>=</span>/bin/sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. Ctrl+x启动</span>
</span></span><span class=line><span class=cl>/bin/sh# mount -o remount,rw /
</span></span><span class=line><span class=cl>/bin/sh# passwd
</span></span><span class=line><span class=cl>/bin/sh# <span class=nb>exec</span> /sbin/init  <span class=c1># 或exec /sbin/reboot</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=233-单用户模式传统方法>2.3.3 单用户模式（传统方法）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. GRUB编辑，添加 single 或 1</span>
</span></span><span class=line><span class=cl>linux16 ... ro single
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 进入单用户后直接passwd</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=24-系统服务管理systemd>2.4 系统服务管理（systemd）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 服务状态</span>
</span></span><span class=line><span class=cl>systemctl status nginx    <span class=c1># 查看状态</span>
</span></span><span class=line><span class=cl>systemctl start nginx     <span class=c1># 启动</span>
</span></span><span class=line><span class=cl>systemctl stop nginx      <span class=c1># 停止</span>
</span></span><span class=line><span class=cl>systemctl restart nginx   <span class=c1># 重启</span>
</span></span><span class=line><span class=cl>systemctl reload nginx    <span class=c1># 重载配置</span>
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> nginx    <span class=c1># 开机自启</span>
</span></span><span class=line><span class=cl>systemctl disable nginx   <span class=c1># 禁用自启</span>
</span></span><span class=line><span class=cl>systemctl is-enabled nginx <span class=c1># 查看是否自启</span>
</span></span><span class=line><span class=cl>systemctl is-active nginx  <span class=c1># 查看是否运行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看服务依赖</span>
</span></span><span class=line><span class=cl>systemctl list-dependencies nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看启动耗时</span>
</span></span><span class=line><span class=cl>systemd-analyze blame
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建自定义服务</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/myapp.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=My Application
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=simple
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/bin/myapp
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>User=appuser
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start myapp
</span></span></code></pre></td></tr></table></div></div><h2 id=三进程与任务管理>三、进程与任务管理</h2><h3 id=31-进程查看命令详解>3.1 进程查看命令详解</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ps命令（静态查看）</span>
</span></span><span class=line><span class=cl>ps aux          <span class=c1># 显示所有进程的详细信息</span>
</span></span><span class=line><span class=cl><span class=c1># a: 所有终端  u: 用户信息  x: 无终端进程</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 字段解释：</span>
</span></span><span class=line><span class=cl>USER: 进程所有者
</span></span><span class=line><span class=cl>PID: 进程ID
</span></span><span class=line><span class=cl>%CPU: CPU占用百分比
</span></span><span class=line><span class=cl>%MEM: 内存占用百分比
</span></span><span class=line><span class=cl>VSZ: 虚拟内存大小（KB）
</span></span><span class=line><span class=cl>RSS: 常驻内存大小（KB）
</span></span><span class=line><span class=cl>TTY: 终端设备（?表示无终端）
</span></span><span class=line><span class=cl>STAT: 状态码
</span></span><span class=line><span class=cl>  R: 运行中
</span></span><span class=line><span class=cl>  S: 睡眠（可中断）
</span></span><span class=line><span class=cl>  D: 不可中断睡眠（I/O等待）
</span></span><span class=line><span class=cl>  T: 停止
</span></span><span class=line><span class=cl>  Z: 僵尸进程
</span></span><span class=line><span class=cl>  +: 前台进程
</span></span><span class=line><span class=cl>  l: 多线程
</span></span><span class=line><span class=cl>  s: 会话领导者
</span></span><span class=line><span class=cl>START: 启动时间或日期
</span></span><span class=line><span class=cl>TIME: 累计CPU时间
</span></span><span class=line><span class=cl>COMMAND: 命令名
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ps -elf         <span class=c1># 长格式显示</span>
</span></span><span class=line><span class=cl><span class=c1># -e: 所有进程  -l: 长格式  -f: 全格式</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按条件筛选</span>
</span></span><span class=line><span class=cl>ps -C sshd      <span class=c1># 按命令名精确查找</span>
</span></span><span class=line><span class=cl>ps -u root      <span class=c1># 按用户筛选</span>
</span></span><span class=line><span class=cl>pgrep -l sshd   <span class=c1># 仅显示PID和名称（轻量）</span>
</span></span><span class=line><span class=cl>pstree -p       <span class=c1># 树状结构显示父子关系</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 动态查看</span>
</span></span><span class=line><span class=cl>top             <span class=c1># 交互式实时查看</span>
</span></span><span class=line><span class=cl><span class=c1># 快捷键：</span>
</span></span><span class=line><span class=cl><span class=c1>#   P: 按CPU排序  M: 按内存排序  T: 按时间排序</span>
</span></span><span class=line><span class=cl><span class=c1>#   k: 杀死进程  r: 调整优先级  q: 退出</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>htop            <span class=c1># 增强版top（需安装：yum install htop）</span>
</span></span><span class=line><span class=cl><span class=c1># 支持鼠标操作，彩色显示，功能更强大</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>vmstat <span class=m>1</span>        <span class=c1># 每秒刷新系统资源统计</span>
</span></span><span class=line><span class=cl><span class=c1># procs: r(运行队列) b(阻塞)  </span>
</span></span><span class=line><span class=cl><span class=c1># memory: swpd free buff cache</span>
</span></span><span class=line><span class=cl><span class=c1># swap: si so</span>
</span></span><span class=line><span class=cl><span class=c1># io: bi bo</span>
</span></span><span class=line><span class=cl><span class=c1># cpu: us sy id wa st</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=32-进程控制信号>3.2 进程控制信号</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看所有信号</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> -l
</span></span><span class=line><span class=cl><span class=c1># 常用信号：</span>
</span></span><span class=line><span class=cl><span class=c1># 1  SIGHUP    : 重新加载配置（如nginx -s reload）</span>
</span></span><span class=line><span class=cl><span class=c1># 2  SIGINT    : Ctrl+C中断</span>
</span></span><span class=line><span class=cl><span class=c1># 9  SIGKILL   : 强制终止（不可捕获、阻塞）</span>
</span></span><span class=line><span class=cl><span class=c1># 15 SIGTERM   : 优雅终止（默认信号）</span>
</span></span><span class=line><span class=cl><span class=c1># 18 SIGCONT   : 继续运行（恢复）</span>
</span></span><span class=line><span class=cl><span class=c1># 19 SIGSTOP   : 停止进程（不可捕获）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 终止进程</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> PID                    <span class=c1># 发送SIGTERM</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> -9 PID                 <span class=c1># 强制杀死（谨慎使用）</span>
</span></span><span class=line><span class=cl><span class=nb>kill</span> -KILL PID              <span class=c1># 同-9</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按名称批量终止</span>
</span></span><span class=line><span class=cl>killall httpd               <span class=c1># 杀死所有httpd进程</span>
</span></span><span class=line><span class=cl>killall -9 java             <span class=c1># 强制杀死所有java进程</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按条件终止</span>
</span></span><span class=line><span class=cl>pkill -U user1              <span class=c1># 按用户杀死进程</span>
</span></span><span class=line><span class=cl>pkill -t pts/0              <span class=c1># 按终端杀死进程</span>
</span></span><span class=line><span class=cl>pkill -f <span class=s2>&#34;python manage.py&#34;</span> <span class=c1># 按完整命令名匹配</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看信号详情</span>
</span></span><span class=line><span class=cl>man <span class=m>7</span> signal
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 僵尸进程处理</span>
</span></span><span class=line><span class=cl><span class=c1># 僵尸进程（Z状态）无法kill，需杀死其父进程</span>
</span></span><span class=line><span class=cl>ps -ef <span class=p>|</span> grep defunct       <span class=c1># 查找僵尸进程</span>
</span></span><span class=line><span class=cl><span class=c1># 找到PPID，然后 kill -9 PPID</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=33-后台任务管理>3.3 后台任务管理</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 直接放入后台（仍在当前终端）</span>
</span></span><span class=line><span class=cl><span class=nb>command</span> <span class=p>&amp;</span>                   <span class=c1># 后台运行（当前终端关闭后进程仍退出）</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span> <span class=m>12345</span>                   <span class=c1># 输出：任务号 PID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nohup方式（推荐）nohup command &amp;                    # 忽略SIGHUP信号（终端断开后继续运行）</span>
</span></span><span class=line><span class=cl><span class=c1># 输出重定向到nohup.out</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># screen方式（会话管理）</span>
</span></span><span class=line><span class=cl>yum install screen
</span></span><span class=line><span class=cl>screen -S session_name      <span class=c1># 创建会话</span>
</span></span><span class=line><span class=cl>Ctrl+a d                    <span class=c1># 分离会话</span>
</span></span><span class=line><span class=cl>screen -ls                  <span class=c1># 列出会话</span>
</span></span><span class=line><span class=cl>screen -r session_name      <span class=c1># 恢复会话</span>
</span></span><span class=line><span class=cl>screen -X -S session_name quit <span class=c1># 关闭会话</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># tmux方式（现代选择）</span>
</span></span><span class=line><span class=cl>tmux new -s session_name
</span></span><span class=line><span class=cl>Ctrl+b d                    <span class=c1># 分离</span>
</span></span><span class=line><span class=cl>tmux ls                     <span class=c1># 列出</span>
</span></span><span class=line><span class=cl>tmux attach -t session_name <span class=c1># 恢复</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 任务控制</span>
</span></span><span class=line><span class=cl>Ctrl+Z                      <span class=c1># 暂停前台任务</span>
</span></span><span class=line><span class=cl><span class=nb>jobs</span>                        <span class=c1># 查看后台任务列表</span>
</span></span><span class=line><span class=cl><span class=o>[</span>1<span class=o>]</span>+  Stopped                 vim file1
</span></span><span class=line><span class=cl><span class=o>[</span>2<span class=o>]</span>-  Running                 python server.py <span class=p>&amp;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>fg</span> %1                       <span class=c1># 将任务1恢复到前台</span>
</span></span><span class=line><span class=cl><span class=nb>bg</span> %2                       <span class=c1># 让任务2在后台继续运行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 任务调度优先级</span>
</span></span><span class=line><span class=cl>nice -n <span class=m>10</span> <span class=nb>command</span>          <span class=c1># 以nice值10启动（范围-20~19，默认0）</span>
</span></span><span class=line><span class=cl>renice -n <span class=m>5</span> -p <span class=m>12345</span>        <span class=c1># 调整正在运行的进程nice值</span>
</span></span><span class=line><span class=cl><span class=c1># nice值越高，CPU优先级越低</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=34-at一次性计划任务>3.4 at一次性计划任务</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 启动服务</span>
</span></span><span class=line><span class=cl>systemctl start atd
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> atd
</span></span><span class=line><span class=cl>systemctl status atd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 设置任务</span>
</span></span><span class=line><span class=cl>at 14:30                    <span class=c1># 今天14:30执行</span>
</span></span><span class=line><span class=cl>at&gt; /root/backup.sh
</span></span><span class=line><span class=cl>at&gt; <span class=nb>echo</span> <span class=s2>&#34;backup completed&#34;</span> <span class=p>|</span> mail -s <span class=s2>&#34;Backup&#34;</span> admin@company.com
</span></span><span class=line><span class=cl>at&gt; &lt;Ctrl+D&gt;                <span class=c1># 提交任务</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 时间格式支持</span>
</span></span><span class=line><span class=cl>at 2pm + <span class=m>3</span> days            <span class=c1># 3天后下午2点</span>
</span></span><span class=line><span class=cl>at now + <span class=m>5</span> minutes         <span class=c1># 5分钟后</span>
</span></span><span class=line><span class=cl>at 23:00 2024-01-01        <span class=c1># 指定日期时间</span>
</span></span><span class=line><span class=cl>at teatime                 <span class=c1># 下午4点</span>
</span></span><span class=line><span class=cl>at noon                    <span class=c1># 中午12点</span>
</span></span><span class=line><span class=cl>at midnight                <span class=c1># 午夜</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 查看待执行任务</span>
</span></span><span class=line><span class=cl>atq
</span></span><span class=line><span class=cl><span class=c1># 输出：2   Mon Jan 15 14:30:00 2024 a root</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 查看任务详情</span>
</span></span><span class=line><span class=cl>at -c <span class=m>2</span>                    <span class=c1># 显示任务2的完整内容（包括环境变量）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 删除任务</span>
</span></span><span class=line><span class=cl>atrm <span class=m>2</span>                     <span class=c1># 删除任务2</span>
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>at -d <span class=m>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 限制at使用</span>
</span></span><span class=line><span class=cl>/etc/at.deny               <span class=c1># 黑名单（默认存在）</span>
</span></span><span class=line><span class=cl>/etc/at.allow              <span class=c1># 白名单（优先级更高）</span>
</span></span><span class=line><span class=cl><span class=c1># 如果at.allow存在，只有其中用户能使用at</span>
</span></span><span class=line><span class=cl><span class=c1># 如果都不存在，仅root能使用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 查看at日志</span>
</span></span><span class=line><span class=cl>grep CROND /var/log/cron   <span class=c1># at由cron服务管理</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=35-crontab周期性计划任务>3.5 crontab周期性计划任务</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 时间格式</span>
</span></span><span class=line><span class=cl><span class=c1># *    *    *    *    *    command</span>
</span></span><span class=line><span class=cl><span class=c1># 分   时   日   月   周   命令</span>
</span></span><span class=line><span class=cl><span class=c1># 范围：分(0-59) 时(0-23) 日(1-31) 月(1-12) 周(0-7,0和7都是周日)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 特殊符号</span>
</span></span><span class=line><span class=cl>*     <span class=c1># 任意值（每）</span>
</span></span><span class=line><span class=cl>,     <span class=c1># 分隔列表：1,3,5</span>
</span></span><span class=line><span class=cl>-     <span class=c1># 范围：1-5</span>
</span></span><span class=line><span class=cl>*/n   <span class=c1># 每隔n单位：*/5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 系统级任务</span>
</span></span><span class=line><span class=cl>/etc/crontab               <span class=c1># 系统主配置文件</span>
</span></span><span class=line><span class=cl>/etc/cron.d/               <span class=c1># 服务专用的cron文件</span>
</span></span><span class=line><span class=cl>/etc/cron.hourly/          <span class=c1># 每小时执行</span>
</span></span><span class=line><span class=cl>/etc/cron.daily/           <span class=c1># 每天执行</span>
</span></span><span class=line><span class=cl>/etc/cron.weekly/          <span class=c1># 每周执行</span>
</span></span><span class=line><span class=cl>/etc/cron.monthly/         <span class=c1># 每月执行</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 用户级任务</span>
</span></span><span class=line><span class=cl>/var/spool/cron/username     <span class=c1># 用户crontab文件</span>
</span></span><span class=line><span class=cl>crontab -e                  <span class=c1># 编辑当前用户任务</span>
</span></span><span class=line><span class=cl>crontab -l                  <span class=c1># 列出任务</span>
</span></span><span class=line><span class=cl>crontab -r                  <span class=c1># 删除所有任务</span>
</span></span><span class=line><span class=cl>crontab -i                  <span class=c1># 删除前确认</span>
</span></span><span class=line><span class=cl>crontab -u user -e          <span class=c1># root编辑其他用户任务</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实用示例</span>
</span></span><span class=line><span class=cl><span class=c1># 每天3点备份</span>
</span></span><span class=line><span class=cl><span class=m>0</span> <span class=m>3</span> * * * /usr/local/bin/backup.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 每周一三五10点</span>
</span></span><span class=line><span class=cl><span class=m>0</span> <span class=m>10</span> * * 1,3,5 /usr/bin/sync
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 每10分钟</span>
</span></span><span class=line><span class=cl>*/10 * * * * /usr/bin/date &gt;&gt; /tmp/log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 每小时第30分</span>
</span></span><span class=line><span class=cl><span class=m>30</span> * * * * /path/to/script
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 每天8-18点，每2小时</span>
</span></span><span class=line><span class=cl><span class=m>0</span> 8-18/2 * * * /path/to/script
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 每月1号、15号的2:30</span>
</span></span><span class=line><span class=cl><span class=m>30</span> <span class=m>2</span> 1,15 * * /path/to/script
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 每30秒执行（cron最小粒度为分钟，需配合sleep）</span>
</span></span><span class=line><span class=cl>* * * * * /path/to/script
</span></span><span class=line><span class=cl>* * * * * sleep 30<span class=p>;</span> /path/to/script
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># crontab环境变量</span>
</span></span><span class=line><span class=cl><span class=c1># cron执行环境PATH有限，建议脚本中写绝对路径</span>
</span></span><span class=line><span class=cl><span class=c1># 或在crontab顶部设置</span>
</span></span><span class=line><span class=cl><span class=nv>SHELL</span><span class=o>=</span>/bin/bash
</span></span><span class=line><span class=cl><span class=nv>PATH</span><span class=o>=</span>/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
</span></span><span class=line><span class=cl><span class=nv>MAILTO</span><span class=o>=</span>admin@company.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看cron日志</span>
</span></span><span class=line><span class=cl>grep CRON /var/log/cron
</span></span><span class=line><span class=cl>tail -f /var/log/cron
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 权限问题</span>
</span></span><span class=line><span class=cl>/etc/cron.deny            <span class=c1># 拒绝列表</span>
</span></span><span class=line><span class=cl>/etc/cron.allow           <span class=c1># 允许列表（优先级更高）</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=四网络基础与配置>四、网络基础与配置</h2><h3 id=41-tcpip协议栈详解>4.1 TCP/IP协议栈详解</h3><h4 id=411-osi与tcpip模型对比>4.1.1 OSI与TCP/IP模型对比</h4><div class=table-wrapper><table><thead><tr><th>OSI七层模型</th><th>TCP/IP四层模型</th><th>协议</th><th>数据单元</th><th>设备</th></tr></thead><tbody><tr><td>7. 应用层</td><td>应用层</td><td>HTTP/FTP/DNS/SMTP</td><td>数据</td><td>网关</td></tr><tr><td>6. 表示层</td><td></td><td>TLS/SSL</td><td>数据</td><td></td></tr><tr><td>5. 会话层</td><td></td><td>SSH/Socket</td><td>数据</td><td></td></tr><tr><td>4. 传输层</td><td>传输层</td><td>TCP/UDP</td><td>段(Segment)</td><td>防火墙</td></tr><tr><td>3. 网络层</td><td>网络层</td><td>IP/ICMP/ARP</td><td>包(Packet)</td><td>路由器</td></tr><tr><td>2. 数据链路层</td><td>网络接口层</td><td>Ethernet/PPP</td><td>帧(Frame)</td><td>交换机/网桥</td></tr><tr><td>1. 物理层</td><td></td><td>IEEE 802.3</td><td>比特(Bit)</td><td>集线器/中继器</td></tr></tbody></table></div><p><strong>关键概念</strong>：</p><ul><li><strong>端到端</strong>（传输层以上）：端口到端口，由操作系统处理</li><li><strong>点到点</strong>（网络层以下）：节点到节点，由硬件处理</li><li><strong>封装与解封装</strong>：数据每经过一层增加头部信息，接收方反向剥离</li></ul><h4 id=412-tcp三次握手与四次挥手>4.1.2 TCP三次握手与四次挥手</h4><p><strong>三次握手（建立连接）</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Client → SYN=1, Seq=x → Server
</span></span><span class=line><span class=cl>Client ← SYN=1, ACK=1, Seq=y, Ack=x+1 ← Server
</span></span><span class=line><span class=cl>Client → ACK=1, Seq=x+1, Ack=y+1 → Server
</span></span></code></pre></td></tr></table></div></div><p><strong>状态变迁</strong>：</p><ul><li>LISTEN → SYN_SENT → SYN_RECEIVED → ESTABLISHED</li></ul><p><strong>为什么不能两次握手？</strong>：
防止已失效的连接请求突然到达服务器，造成资源浪费。三次握手可以确保双方的发送和接收能力都正常。</p><p><strong>四次挥手（断开连接）</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Client → FIN=1, ACK=1 → Server    # Client主动关闭
</span></span><span class=line><span class=cl>Client ← ACK=1 ← Server           # Server确认
</span></span><span class=line><span class=cl>Client ← FIN=1, ACK=1 ← Server    # Server也准备关闭
</span></span><span class=line><span class=cl>Client → ACK=1 → Server           # Client最后确认
</span></span></code></pre></td></tr></table></div></div><p><strong>状态变迁</strong>：</p><ul><li>ESTABLISHED → FIN_WAIT1 → FIN_WAIT2 → TIME_WAIT → CLOSED</li><li>ESTABLISHED → CLOSE_WAIT → LAST_ACK → CLOSED</li></ul><p><strong>TIME_WAIT状态（2MSL）</strong>：</p><ul><li><strong>MSL</strong>（Maximum Segment Lifetime）：报文最大生存时间，通常为30秒到2分钟</li><li><strong>2MSL等待目的</strong>：确保最后一个ACK能到达；让网络中延迟的旧报文消失</li><li><strong>端口耗尽问题</strong>：高并发服务器可能出现大量TIME_WAIT，需通过<code>net.ipv4.tcp_tw_reuse=1</code>优化</li></ul><h4 id=413-tcp状态机11种状态>4.1.3 TCP状态机11种状态</h4><div class=table-wrapper><table><thead><tr><th>状态</th><th>端类型</th><th>描述</th></tr></thead><tbody><tr><td><strong>LISTEN</strong></td><td>Server</td><td>监听连接请求</td></tr><tr><td><strong>SYN_SENT</strong></td><td>Client</td><td>已发送SYN，等待确认</td></tr><tr><td><strong>SYN_RECEIVED</strong></td><td>Server</td><td>收到SYN，发送SYN+ACK</td></tr><tr><td><strong>ESTABLISHED</strong></td><td>Both</td><td>连接已建立，数据传输</td></tr><tr><td><strong>FIN_WAIT_1</strong></td><td>Client</td><td>发送FIN，等待ACK</td></tr><tr><td><strong>FIN_WAIT_2</strong></td><td>Client</td><td>收到ACK，等待对方FIN</td></tr><tr><td><strong>CLOSE_WAIT</strong></td><td>Server</td><td>收到FIN，等待应用关闭</td></tr><tr><td><strong>CLOSING</strong></td><td>Both</td><td>同时发送FIN</td></tr><tr><td><strong>LAST_ACK</strong></td><td>Server</td><td>发送FIN，等待最后ACK</td></tr><tr><td><strong>TIME_WAIT</strong></td><td>Client</td><td>等待2MSL</td></tr><tr><td><strong>CLOSED</strong></td><td>Both</td><td>连接完全关闭</td></tr></tbody></table></div><p><strong>客户端特有状态</strong>：SYN_SENT, FIN_WAIT_1, FIN_WAIT_2, CLOSING, TIME_WAIT
<strong>服务器特有状态</strong>：LISTEN, SYN_RECEIVED, CLOSE_WAIT, LAST_ACK</p><h3 id=42-网络配置命令>4.2 网络配置命令</h3><h4 id=421-ifconfig传统命令>4.2.1 ifconfig（传统命令）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看所有活动接口</span>
</span></span><span class=line><span class=cl>ifconfig
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看指定接口（即使down）</span>
</span></span><span class=line><span class=cl>ifconfig ens33
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ifconfig输出解读</span>
</span></span><span class=line><span class=cl>ens33: <span class=nv>flags</span><span class=o>=</span>4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class=m>1500</span>
</span></span><span class=line><span class=cl>        inet 192.168.200.100  netmask 255.255.255.0  broadcast 192.168.200.255
</span></span><span class=line><span class=cl>        inet6 fe80::20c:29ff:feb3:4c4a  prefixlen <span class=m>64</span>  scopeid 0x20&lt;link&gt;
</span></span><span class=line><span class=cl>        ether 00:0c:29:b3:4c:4a  txqueuelen <span class=m>1000</span>  <span class=o>(</span>Ethernet<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX packets <span class=m>12345</span>  bytes <span class=m>1234567</span> <span class=o>(</span>1.1 MiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        RX errors <span class=m>0</span>  dropped <span class=m>0</span>  overruns <span class=m>0</span>  frame <span class=m>0</span>
</span></span><span class=line><span class=cl>        TX packets <span class=m>6789</span>  bytes <span class=m>6789012</span> <span class=o>(</span>6.4 MiB<span class=o>)</span>
</span></span><span class=line><span class=cl>        TX errors <span class=m>0</span>  dropped <span class=m>0</span> overruns <span class=m>0</span>  carrier <span class=m>0</span>  collisions <span class=m>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 字段说明：</span>
</span></span><span class=line><span class=cl>UP: 接口已启用
</span></span><span class=line><span class=cl>BROADCAST: 支持广播
</span></span><span class=line><span class=cl>RUNNING: 正在运行
</span></span><span class=line><span class=cl>MULTICAST: 支持组播
</span></span><span class=line><span class=cl>mtu: 最大传输单元（1500字节）
</span></span><span class=line><span class=cl>inet: IPv4地址
</span></span><span class=line><span class=cl>netmask: 子网掩码
</span></span><span class=line><span class=cl>broadcast: 广播地址
</span></span><span class=line><span class=cl>ether: MAC地址
</span></span><span class=line><span class=cl>RX/TX: 接收/发送统计
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 临时配置IP</span>
</span></span><span class=line><span class=cl>ifconfig ens33 192.168.200.100 netmask 255.255.255.0
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>ifconfig ens33 192.168.200.100/24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用/禁用接口</span>
</span></span><span class=line><span class=cl>ifconfig ens33 up
</span></span><span class=line><span class=cl>ifconfig ens33 down
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加虚拟接口</span>
</span></span><span class=line><span class=cl>ifconfig ens33:0 192.168.200.200 netmask 255.255.255.0
</span></span></code></pre></td></tr></table></div></div><h4 id=422-ip命令推荐iproute2工具集>4.2.2 ip命令（推荐，iproute2工具集）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看网络接口（数据链路层）</span>
</span></span><span class=line><span class=cl>ip link
</span></span><span class=line><span class=cl>ip link show ens33
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看IP地址（网络层）</span>
</span></span><span class=line><span class=cl>ip addr
</span></span><span class=line><span class=cl>ip addr show ens33
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 临时配置IP</span>
</span></span><span class=line><span class=cl>ip addr add 192.168.200.100/24 dev ens33
</span></span><span class=line><span class=cl>ip addr del 192.168.200.100/24 dev ens33
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 启用/禁用接口</span>
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ens33 up
</span></span><span class=line><span class=cl>ip link <span class=nb>set</span> ens33 down
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看路由</span>
</span></span><span class=line><span class=cl>ip route
</span></span><span class=line><span class=cl>ip route show
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加/删除路由</span>
</span></span><span class=line><span class=cl>ip route add 10.0.0.0/8 via 192.168.200.1
</span></span><span class=line><span class=cl>ip route del 10.0.0.0/8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看ARP缓存</span>
</span></span><span class=line><span class=cl>ip neigh
</span></span><span class=line><span class=cl>ip neigh show
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看统计信息</span>
</span></span><span class=line><span class=cl>ip -s link
</span></span></code></pre></td></tr></table></div></div><h4 id=423-其他网络工具>4.2.3 其他网络工具</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># ethtool - 查看网卡详细信息（需root）</span>
</span></span><span class=line><span class=cl>ethtool ens33
</span></span><span class=line><span class=cl><span class=c1># 输出：</span>
</span></span><span class=line><span class=cl>Settings <span class=k>for</span> ens33:
</span></span><span class=line><span class=cl>        Supported ports: <span class=o>[</span> TP <span class=o>]</span>
</span></span><span class=line><span class=cl>        Supported link modes:   10baseT/Half 10baseT/Full
</span></span><span class=line><span class=cl>                                100baseT/Half 100baseT/Full
</span></span><span class=line><span class=cl>                                1000baseT/Full
</span></span><span class=line><span class=cl>        Supported pause frame use: No
</span></span><span class=line><span class=cl>        Supports auto-negotiation: Yes
</span></span><span class=line><span class=cl>        Advertised link modes:  10baseT/Half 10baseT/Full
</span></span><span class=line><span class=cl>                                100baseT/Half 100baseT/Full
</span></span><span class=line><span class=cl>                                1000baseT/Full
</span></span><span class=line><span class=cl>        Advertised pause frame use: No
</span></span><span class=line><span class=cl>        Advertised auto-negotiation: Yes
</span></span><span class=line><span class=cl>        Speed: 1000Mb/s          <span class=c1># 当前速率</span>
</span></span><span class=line><span class=cl>        Duplex: Full             <span class=c1># 全双工</span>
</span></span><span class=line><span class=cl>        Port: Twisted Pair
</span></span><span class=line><span class=cl>        PHYAD: <span class=m>0</span>
</span></span><span class=line><span class=cl>        Transceiver: internal
</span></span><span class=line><span class=cl>        Auto-negotiation: on
</span></span><span class=line><span class=cl>        MDI-X: off <span class=o>(</span>auto<span class=o>)</span>
</span></span><span class=line><span class=cl>        Supports Wake-on: d
</span></span><span class=line><span class=cl>        Wake-on: d
</span></span><span class=line><span class=cl>        Current message level: 0x00000007 <span class=o>(</span>7<span class=o>)</span>
</span></span><span class=line><span class=cl>        Link detected: yes       <span class=c1># 链路状态</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># mii-tool - 简洁查看</span>
</span></span><span class=line><span class=cl>mii-tool ens33
</span></span><span class=line><span class=cl>ens33: negotiated 1000baseT-FD flow-control, link ok
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ss - 现代netstat替代品（性能更好）</span>
</span></span><span class=line><span class=cl>ss -tuln                  <span class=c1># 查看监听端口</span>
</span></span><span class=line><span class=cl>ss -tun                   <span class=c1># 查看所有连接</span>
</span></span><span class=line><span class=cl>ss -tun <span class=p>|</span> grep :80        <span class=c1># 过滤80端口</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># lsof - 查看端口占用</span>
</span></span><span class=line><span class=cl>lsof -i :22               <span class=c1># 查看22端口</span>
</span></span><span class=line><span class=cl>lsof -i TCP:80            <span class=c1># 查看TCP 80端口</span>
</span></span><span class=line><span class=cl>lsof -p <span class=m>1234</span>              <span class=c1># 查看进程打开的文件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ping - 连通性测试</span>
</span></span><span class=line><span class=cl>ping -c <span class=m>4</span> baidu.com       <span class=c1># 发送4个包</span>
</span></span><span class=line><span class=cl>ping -i <span class=m>2</span> baidu.com       <span class=c1># 间隔2秒</span>
</span></span><span class=line><span class=cl>ping -w <span class=m>10</span> baidu.com      <span class=c1># 10秒超时</span>
</span></span><span class=line><span class=cl>ping -s <span class=m>1024</span> baidu.com    <span class=c1># 指定包大小1024字节</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># traceroute - 路由跟踪</span>
</span></span><span class=line><span class=cl>traceroute baidu.com      <span class=c1># 跟踪路径</span>
</span></span><span class=line><span class=cl>traceroute -n baidu.com   <span class=c1># 不解析主机名</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=424-配置文件管理>4.2.4 配置文件管理</h4><p><strong>网络配置文件位置</strong>：</p><ul><li>RHEL/CentOS 7: <code>/etc/sysconfig/network-scripts/ifcfg-ens33</code></li><li>RHEL/CentOS 8+: <code>/etc/NetworkManager/system-connections/</code>（推荐nmcli）</li></ul><p><strong>典型配置</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cat &gt; /etc/sysconfig/network-scripts/ifcfg-ens33 <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>TYPE=Ethernet
</span></span></span><span class=line><span class=cl><span class=s>PROXY_METHOD=none
</span></span></span><span class=line><span class=cl><span class=s>BROWSER_ONLY=no
</span></span></span><span class=line><span class=cl><span class=s>BOOTPROTO=static          # static|dhcp|none
</span></span></span><span class=line><span class=cl><span class=s>DEFROUTE=yes
</span></span></span><span class=line><span class=cl><span class=s>IPV4_FAILURE_FATAL=no
</span></span></span><span class=line><span class=cl><span class=s>IPV6INIT=yes
</span></span></span><span class=line><span class=cl><span class=s>IPV6_AUTOCONF=yes
</span></span></span><span class=line><span class=cl><span class=s>IPV6_DEFROUTE=yes
</span></span></span><span class=line><span class=cl><span class=s>IPV6_FAILURE_FATAL=no
</span></span></span><span class=line><span class=cl><span class=s>NAME=ens33
</span></span></span><span class=line><span class=cl><span class=s>UUID=5e2cfdc2-1234-4567-890a-bcdef1234567  # 唯一标识
</span></span></span><span class=line><span class=cl><span class=s>DEVICE=ens33
</span></span></span><span class=line><span class=cl><span class=s>ONBOOT=yes                # 开机启用
</span></span></span><span class=line><span class=cl><span class=s>IPADDR=192.168.200.100
</span></span></span><span class=line><span class=cl><span class=s>PREFIX=24                 # 或NETMASK=255.255.255.0
</span></span></span><span class=line><span class=cl><span class=s>GATEWAY=192.168.200.2
</span></span></span><span class=line><span class=cl><span class=s>DNS1=8.8.8.8
</span></span></span><span class=line><span class=cl><span class=s>DNS2=114.114.114.114
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重启网络</span>
</span></span><span class=line><span class=cl>systemctl restart network
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>nmcli con reload<span class=p>;</span> nmcli con up ens33
</span></span></code></pre></td></tr></table></div></div><p><strong>UUID生成</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>uuidgen ens33              <span class=c1># 生成新UUID</span>
</span></span><span class=line><span class=cl><span class=c1># 将生成的UUID写入ifcfg文件</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=425-路由配置>4.2.5 路由配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 临时添加路由</span>
</span></span><span class=line><span class=cl>route add -net 10.0.0.0/8 gw 192.168.200.1
</span></span><span class=line><span class=cl>route add -net 10.0.0.0 netmask 255.0.0.0 gw 192.168.200.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除路由</span>
</span></span><span class=line><span class=cl>route del -net 10.0.0.0/8
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加默认网关</span>
</span></span><span class=line><span class=cl>route add default gw 192.168.200.1
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>ip route add default via 192.168.200.1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看路由表</span>
</span></span><span class=line><span class=cl>route -n                   <span class=c1># 数字格式</span>
</span></span><span class=line><span class=cl>ip route show
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 永久路由配置</span>
</span></span><span class=line><span class=cl><span class=c1># 方法1：/etc/rc.local</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;route add -net 10.0.0.0/8 gw 192.168.200.1&#34;</span> &gt;&gt; /etc/rc.local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法2：/etc/sysconfig/static-routes（不存在则创建）</span>
</span></span><span class=line><span class=cl><span class=c1># 格式：any net 10.0.0.0/8 gw 192.168.200.1</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/sysconfig/static-routes <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>any net 10.0.0.0 netmask 255.0.0.0 gw 192.168.200.1
</span></span></span><span class=line><span class=cl><span class=s>any host 192.168.100.100 gw 192.168.200.1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法3：/etc/sysconfig/network-scripts/route-ens33</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/sysconfig/network-scripts/route-ens33 <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>10.0.0.0/8 via 192.168.200.1
</span></span></span><span class=line><span class=cl><span class=s>192.168.100.0/24 via 192.168.200.1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=426-ip转发路由功能>4.2.6 IP转发（路由功能）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 临时开启</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;1&#34;</span> &gt; /proc/sys/net/ipv4/ip_forward
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 永久开启</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/sysctl.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_forward = 1
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>sysctl -p                  <span class=c1># 立即生效</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 验证</span>
</span></span><span class=line><span class=cl>sysctl net.ipv4.ip_forward
</span></span><span class=line><span class=cl><span class=c1># 输出：net.ipv4.ip_forward = 1</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=43-dns与主机名配置>4.3 DNS与主机名配置</h3><h4 id=431-dns解析流程完整版>4.3.1 DNS解析流程（完整版）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>用户输入www.baidu.com
</span></span><span class=line><span class=cl>  ↓
</span></span><span class=line><span class=cl>浏览器缓存检查（TTL过期时间）
</span></span><span class=line><span class=cl>  ↓
</span></span><span class=line><span class=cl>操作系统缓存检查（/etc/hosts, nscd缓存）
</span></span><span class=line><span class=cl>  ↓
</span></span><span class=line><span class=cl>本地DNS服务器（LDNS）查询
</span></span><span class=line><span class=cl>  ├→ 递归查询（客户端等待结果）
</span></span><span class=line><span class=cl>  └→ 迭代查询（LDNS逐级查询）
</span></span><span class=line><span class=cl>      ↓
</span></span><span class=line><span class=cl>      根域名服务器（.）→ 返回.com服务器地址
</span></span><span class=line><span class=cl>      ↓
</span></span><span class=line><span class=cl>      顶级域服务器（.com）→ 返回baidu.com授权服务器
</span></span><span class=line><span class=cl>      ↓
</span></span><span class=line><span class=cl>      权威域名服务器（baidu.com）→ 返回www.baidu.com的A记录
</span></span><span class=line><span class=cl>      ↓
</span></span><span class=line><span class=cl>LDNS缓存结果 → 返回给客户端
</span></span><span class=line><span class=cl>  ↓
</span></span><span class=line><span class=cl>浏览器获得IP → 发起TCP连接
</span></span></code></pre></td></tr></table></div></div><p><strong>关键概念</strong>：</p><ul><li><strong>递归查询</strong>：DNS服务器为客户机完全解析域名，客户端只需等待最终结果</li><li><strong>迭代查询</strong>：DNS服务器返回下一个查询服务器地址，由客户端继续查询</li><li><strong>TTL</strong>：缓存生存时间，单位为秒</li><li><strong>权威服务器</strong>：拥有域名最终解析权的服务器</li></ul><h4 id=432-etchosts文件>4.3.2 /etc/hosts文件</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 格式：IP 主机名 别名</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/hosts <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
</span></span></span><span class=line><span class=cl><span class=s>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.100    www.linux.com   www
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.100    ns1.linux.com   ns1
</span></span></span><span class=line><span class=cl><span class=s>192.168.200.193    ns2.linux.com   ns2
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 优先级：/etc/hosts &gt; DNS查询</span>
</span></span><span class=line><span class=cl><span class=c1># nsswitch.conf控制顺序</span>
</span></span><span class=line><span class=cl>grep hosts /etc/nsswitch.conf
</span></span><span class=line><span class=cl><span class=c1># 输出：hosts:      files dns myhostname</span>
</span></span><span class=line><span class=cl><span class=c1># files代表/etc/hosts，dns代表DNS服务器</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=433-主机名配置>4.3.3 主机名配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 临时修改（立即生效，重启失效）</span>
</span></span><span class=line><span class=cl>hostname new-hostname
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname new-hostname
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 永久修改（RHEL 7+推荐）</span>
</span></span><span class=line><span class=cl>hostnamectl set-hostname new-hostname --static
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看主机名</span>
</span></span><span class=line><span class=cl>hostname
</span></span><span class=line><span class=cl>hostnamectl status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 传统方式（编辑配置文件）</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/hostname <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>new-hostname
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 同时修改/etc/hosts中的127.0.0.1对应的主机名</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=五用户与权限管理>五、用户与权限管理</h2><h3 id=51-用户账号体系>5.1 用户账号体系</h3><h4 id=511-账号文件结构>5.1.1 账号文件结构</h4><p><strong>/etc/passwd</strong>（7个冒号分隔字段）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root:x:0:0:root:/root:/bin/bash
</span></span><span class=line><span class=cl>用户名:密码占位符:UID:GID:注释:家目录:Shell
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 字段说明：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 用户名：登录名，不超过32字符</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 密码：x表示密码在/etc/shadow中，空表示无密码</span>
</span></span><span class=line><span class=cl><span class=c1># 3. UID：0=root，1-999=系统用户，1000+=普通用户</span>
</span></span><span class=line><span class=cl><span class=c1># 4. GID：主组ID，对应/etc/group</span>
</span></span><span class=line><span class=cl><span class=c1># 5. 注释：用户全名或描述</span>
</span></span><span class=line><span class=cl><span class=c1># 6. 家目录：登录后默认目录</span>
</span></span><span class=line><span class=cl><span class=c1># 7. Shell：/bin/bash可登录，/sbin/nologin不可登录</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>/etc/shadow</strong>（9个冒号分隔字段）：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>root:<span class=nv>$6$rounds</span><span class=o>=</span>5000<span class=nv>$salt$hash</span>:18000:0:99999:7:::
</span></span><span class=line><span class=cl>用户名:加密密码:最后修改天数:最小天数:最大天数:警告天数:过期宽限:失效日期:保留
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 字段说明：</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 用户名：与passwd对应</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 加密密码：$id$salt$hash</span>
</span></span><span class=line><span class=cl><span class=c1>#    - $1$ MD5</span>
</span></span><span class=line><span class=cl><span class=c1>#    - $2a$ Blowfish</span>
</span></span><span class=line><span class=cl><span class=c1>#    - $5$ SHA-256</span>
</span></span><span class=line><span class=cl><span class=c1>#    - $6$ SHA-512（CentOS 7+默认）</span>
</span></span><span class=line><span class=cl><span class=c1>#    - !! 或 * 表示账户锁定</span>
</span></span><span class=line><span class=cl><span class=c1># 3. 最后修改：从1970-01-01算起的天数</span>
</span></span><span class=line><span class=cl><span class=c1># 4. 最小天数：密码修改最小间隔</span>
</span></span><span class=line><span class=cl><span class=c1># 5. 最大天数：密码有效最大天数</span>
</span></span><span class=line><span class=cl><span class=c1># 6. 警告天数：到期前警告天数</span>
</span></span><span class=line><span class=cl><span class=c1># 7. 过期宽限：密码过期后可用天数</span>
</span></span><span class=line><span class=cl><span class=c1># 8. 失效日期：账户失效日期（天数）</span>
</span></span><span class=line><span class=cl><span class=c1># 9. 保留：未使用</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=512-用户管理命令>5.1.2 用户管理命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建用户</span>
</span></span><span class=line><span class=cl>useradd -u <span class=m>1001</span> -g wheel -G admin,dev -c <span class=s2>&#34;Admin User&#34;</span> -s /bin/bash -d /home/admin admin
</span></span><span class=line><span class=cl><span class=c1># -u: UID</span>
</span></span><span class=line><span class=cl><span class=c1># -g: 主组（必须已存在）</span>
</span></span><span class=line><span class=cl><span class=c1># -G: 附加组（逗号分隔）</span>
</span></span><span class=line><span class=cl><span class=c1># -c: 注释</span>
</span></span><span class=line><span class=cl><span class=c1># -s: Shell</span>
</span></span><span class=line><span class=cl><span class=c1># -d: 家目录</span>
</span></span><span class=line><span class=cl><span class=c1># -m: 自动创建家目录（默认）</span>
</span></span><span class=line><span class=cl><span class=c1># -M: 不创建家目录</span>
</span></span><span class=line><span class=cl><span class=c1># -e: 过期日期（YYYY-MM-DD）</span>
</span></span><span class=line><span class=cl><span class=c1># -f: 密码过期后宽限天数</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 创建系统用户（无登录Shell，无家目录）</span>
</span></span><span class=line><span class=cl>useradd -r -s /sbin/nologin nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 批量创建用户</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=o>{</span>1..10<span class=o>}</span><span class=p>;</span> <span class=k>do</span> useradd user<span class=nv>$i</span><span class=p>;</span> <span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改用户属性</span>
</span></span><span class=line><span class=cl>usermod -l newname oldname          <span class=c1># 重命名用户</span>
</span></span><span class=line><span class=cl>usermod -u <span class=m>2000</span> admin               <span class=c1># 修改UID</span>
</span></span><span class=line><span class=cl>usermod -g users admin              <span class=c1># 修改主组</span>
</span></span><span class=line><span class=cl>usermod -aG docker admin            <span class=c1># 追加附加组（-a关键）</span>
</span></span><span class=line><span class=cl>usermod -s /bin/zsh admin           <span class=c1># 修改Shell</span>
</span></span><span class=line><span class=cl>usermod -d /newhome -m admin        <span class=c1># 修改家目录并移动文件</span>
</span></span><span class=line><span class=cl>usermod -e 2024-12-31 admin         <span class=c1># 设置账户过期</span>
</span></span><span class=line><span class=cl>usermod -L admin                    <span class=c1># 锁定账户（密码前加!）</span>
</span></span><span class=line><span class=cl>usermod -U admin                    <span class=c1># 解锁账户（需执行两次）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除用户</span>
</span></span><span class=line><span class=cl>userdel admin                       <span class=c1># 仅删除用户</span>
</span></span><span class=line><span class=cl>userdel -r admin                    <span class=c1># 删除用户及家目录、邮件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 密码管理</span>
</span></span><span class=line><span class=cl>passwd admin                        <span class=c1># 交互式设置密码</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;password&#34;</span> <span class=p>|</span> passwd --stdin admin  <span class=c1># 非交互式（需root）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 密码策略</span>
</span></span><span class=line><span class=cl>passwd -n <span class=m>7</span> admin                   <span class=c1># 最小间隔7天</span>
</span></span><span class=line><span class=cl>passwd -x <span class=m>90</span> admin                  <span class=c1># 最大有效期90天</span>
</span></span><span class=line><span class=cl>passwd -w <span class=m>7</span> admin                   <span class=c1># 提前7天警告</span>
</span></span><span class=line><span class=cl>passwd -i <span class=m>7</span> admin                   <span class=c1># 过期后宽限7天</span>
</span></span><span class=line><span class=cl>passwd -S admin                     <span class=c1># 查看密码状态</span>
</span></span><span class=line><span class=cl>passwd -l admin                     <span class=c1># 锁定（密码前加!!）</span>
</span></span><span class=line><span class=cl>passwd -u admin                     <span class=c1># 解锁</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=513-组管理命令>5.1.3 组管理命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 创建组</span>
</span></span><span class=line><span class=cl>groupadd -g <span class=m>1000</span> admin
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看组信息</span>
</span></span><span class=line><span class=cl>cat /etc/group
</span></span><span class=line><span class=cl><span class=c1># 格式：组名:密码占位符:GID:成员列表（逗号分隔）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改组</span>
</span></span><span class=line><span class=cl>groupmod -n newadmin admin          <span class=c1># 重命名</span>
</span></span><span class=line><span class=cl>groupmod -g <span class=m>2000</span> admin              <span class=c1># 修改GID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除组</span>
</span></span><span class=line><span class=cl>groupdel admin                      <span class=c1># 组内不能有用户为主组</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组成员管理</span>
</span></span><span class=line><span class=cl>gpasswd -a user1 admin              <span class=c1># 添加成员</span>
</span></span><span class=line><span class=cl>gpasswd -M user1,user2,user3 admin  <span class=c1># 批量设置成员（覆盖）</span>
</span></span><span class=line><span class=cl>gpasswd -d user1 admin              <span class=c1># 删除成员</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置组管理员</span>
</span></span><span class=line><span class=cl>gpasswd -A user1 admin              <span class=c1># user1可管理admin组成员</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组密码（极少使用）</span>
</span></span><span class=line><span class=cl>gpasswd admin                       <span class=c1># 设置组密码</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=52-权限管理模型>5.2 权限管理模型</h3><h4 id=521-文件权限表示>5.2.1 文件权限表示</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>-rwxr-xr-x  1 root root  12345 Jan 10 10:00 script.sh
</span></span><span class=line><span class=cl>\_________/  \__/ \____/  \___/ \______________\____/
</span></span><span class=line><span class=cl>  权限      链接  属主 属组   大小      日期      文件名
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>权限段：- rwx r-x r-x
</span></span><span class=line><span class=cl>类型  所有者  组    其他
</span></span><span class=line><span class=cl>-: 普通文件
</span></span><span class=line><span class=cl>d: 目录
</span></span><span class=line><span class=cl>l: 软链接
</span></span><span class=line><span class=cl>b: 块设备
</span></span><span class=line><span class=cl>c: 字符设备
</span></span><span class=line><span class=cl>s: 套接字
</span></span><span class=line><span class=cl>p: 管道
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>权限位：
</span></span><span class=line><span class=cl>r = 4 (read)
</span></span><span class=line><span class=cl>w = 2 (write)
</span></span><span class=line><span class=cl>x = 1 (execute)
</span></span><span class=line><span class=cl>- = 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>组合示例：
</span></span><span class=line><span class=cl>rwx = 7 (4+2+1)
</span></span><span class=line><span class=cl>rw- = 6 (4+2+0)
</span></span><span class=line><span class=cl>r-x = 5 (4+0+1)
</span></span><span class=line><span class=cl>r-- = 4
</span></span></code></pre></td></tr></table></div></div><h4 id=522-权限修改命令>5.2.2 权限修改命令</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># chmod命令</span>
</span></span><span class=line><span class=cl>chmod u+x,g-w,o<span class=o>=</span>r file              <span class=c1># 符号模式</span>
</span></span><span class=line><span class=cl><span class=c1># u: user(owner), g: group, o: other, a: all</span>
</span></span><span class=line><span class=cl><span class=c1># +: 添加, -: 移除, =: 设置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> file                      <span class=c1># 数字模式</span>
</span></span><span class=line><span class=cl>chmod <span class=m>644</span> file.txt                  <span class=c1># 普通文件</span>
</span></span><span class=line><span class=cl>chmod <span class=m>755</span> script.sh                 <span class=c1># 可执行脚本</span>
</span></span><span class=line><span class=cl>chmod <span class=m>700</span> /home/user                <span class=c1># 家目录</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod -R <span class=m>755</span> /path                  <span class=c1># 递归修改（慎用！）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 特殊权限</span>
</span></span><span class=line><span class=cl>chmod u+s /usr/bin/myapp            <span class=c1># SUID (4)</span>
</span></span><span class=line><span class=cl>chmod g+s /path/to/dir              <span class=c1># SGID (2)</span>
</span></span><span class=line><span class=cl>chmod o+t /path/to/dir              <span class=c1># Sticky Bit (1)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数字表示特殊权限</span>
</span></span><span class=line><span class=cl>chmod <span class=m>4755</span> file                     <span class=c1># SUID rwsr-xr-x</span>
</span></span><span class=line><span class=cl>chmod <span class=m>2755</span> dir                      <span class=c1># SGID rwxr-sr-x</span>
</span></span><span class=line><span class=cl>chmod <span class=m>1755</span> dir                      <span class=c1># Sticky rwxr-xr-t</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># chown命令</span>
</span></span><span class=line><span class=cl>chown user file                     <span class=c1># 修改属主</span>
</span></span><span class=line><span class=cl>chown :group file                   <span class=c1># 修改属组</span>
</span></span><span class=line><span class=cl>chown user:group file               <span class=c1># 同时修改</span>
</span></span><span class=line><span class=cl>chown -R user:group /path           <span class=c1># 递归修改</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># chgrp命令（较少使用）</span>
</span></span><span class=line><span class=cl>chgrp admin file                    <span class=c1># 修改属组</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=523-特殊权限详解>5.2.3 特殊权限详解</h4><p><strong>SUID (Set UID, 4)</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod u+s /usr/bin/myapp
</span></span><span class=line><span class=cl><span class=c1># 权限显示：-rwsr-xr-x</span>
</span></span><span class=line><span class=cl><span class=c1># 效果：普通用户执行时，以文件所有者的身份运行</span>
</span></span><span class=line><span class=cl><span class=c1># 典型应用：/usr/bin/passwd (suid root)</span>
</span></span><span class=line><span class=cl><span class=c1># 风险：安全漏洞可能导致权限提升</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>SGID (Set GID, 2)</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 对文件：以文件所属组身份运行</span>
</span></span><span class=line><span class=cl>chmod g+s /usr/bin/myapp
</span></span><span class=line><span class=cl><span class=c1># 权限显示：-rwxr-sr-x</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 对目录：新建文件自动继承目录的属组</span>
</span></span><span class=line><span class=cl>mkdir /shared
</span></span><span class=line><span class=cl>chgrp devgroup /shared
</span></span><span class=line><span class=cl>chmod <span class=m>2775</span> /shared
</span></span><span class=line><span class=cl><span class=c1># 所有用户在此目录创建的文件属组都是devgroup</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>Sticky Bit (1)</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chmod o+t /tmp
</span></span><span class=line><span class=cl><span class=c1># 权限显示：drwxrwxrwt</span>
</span></span><span class=line><span class=cl><span class=c1># 效果：只有文件所有者、目录所有者、root能删除/重命名文件</span>
</span></span><span class=line><span class=cl><span class=c1># 典型应用：/tmp目录</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=524-umask掩码>5.2.4 umask掩码</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看当前umask</span>
</span></span><span class=line><span class=cl><span class=nb>umask</span>
</span></span><span class=line><span class=cl><span class=c1># 输出：0022</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 临时修改</span>
</span></span><span class=line><span class=cl><span class=nb>umask</span> <span class=m>027</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 永久修改</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;umask 027&#34;</span> &gt;&gt; /etc/profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># umask计算</span>
</span></span><span class=line><span class=cl><span class=c1># 目录默认权限：777 - umask</span>
</span></span><span class=line><span class=cl><span class=c1># 文件默认权限：666 - umask（文件默认无执行位）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例：umask=022</span>
</span></span><span class=line><span class=cl><span class=c1># 目录：777 - 022 = 755 (rwxr-xr-x)</span>
</span></span><span class=line><span class=cl><span class=c1># 文件：666 - 022 = 644 (rw-r--r--)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># umask=027</span>
</span></span><span class=line><span class=cl><span class=c1># 目录：777 - 027 = 750 (rwxr-x---)</span>
</span></span><span class=line><span class=cl><span class=c1># 文件：666 - 027 = 640 (rw-r-----)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># umask=002</span>
</span></span><span class=line><span class=cl><span class=c1># 目录：777 - 002 = 775 (rwxrwxr-x)</span>
</span></span><span class=line><span class=cl><span class=c1># 文件：666 - 002 = 664 (rw-rw-r--)</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=53-acl访问控制列表补充>5.3 ACL访问控制列表（补充）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看是否支持ACL</span>
</span></span><span class=line><span class=cl>tune2fs -l /dev/sda1 <span class=p>|</span> grep <span class=s2>&#34;Default mount options&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 输出应包含：acl</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 挂载时启用ACL（ext4默认启用）</span>
</span></span><span class=line><span class=cl>mount -o remount,acl /
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看ACL</span>
</span></span><span class=line><span class=cl>getfacl /path/to/file
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置ACL</span>
</span></span><span class=line><span class=cl>setfacl -m u:user1:rw file          <span class=c1># 给用户user1添加rw权限</span>
</span></span><span class=line><span class=cl>setfacl -m g:group1:r file          <span class=c1># 给组group1添加r权限</span>
</span></span><span class=line><span class=cl>setfacl -m o::r file                <span class=c1># 设置其他用户权限</span>
</span></span><span class=line><span class=cl>setfacl -m m::rwx file              <span class=c1># 设置有效权限掩码</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 递归设置</span>
</span></span><span class=line><span class=cl>setfacl -R -m u:user1:rw /path
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除ACL</span>
</span></span><span class=line><span class=cl>setfacl -x u:user1 file             <span class=c1># 删除指定用户</span>
</span></span><span class=line><span class=cl>setfacl -b file                     <span class=c1># 删除所有ACL</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 默认ACL（对目录有效，影响新建文件）</span>
</span></span><span class=line><span class=cl>setfacl -m d:u:user1:rw /path       <span class=c1># 设置默认ACL</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=六系统安全加固>六、系统安全加固</h2><h3 id=61-sudo提权管理>6.1 sudo提权管理</h3><h4 id=611-sudo配置详解>6.1.1 sudo配置详解</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 编辑sudo配置（必须使用visudo，会检查语法）</span>
</span></span><span class=line><span class=cl>visudo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 基本格式：用户 主机=(运行身份) 命令</span>
</span></span><span class=line><span class=cl>root    <span class=nv>ALL</span><span class=o>=(</span>ALL<span class=o>)</span>       ALL
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 用户别名</span>
</span></span><span class=line><span class=cl>User_Alias <span class=nv>ADMIN</span> <span class=o>=</span> admin,fang,jialiang
</span></span><span class=line><span class=cl>User_Alias <span class=nv>DEV</span> <span class=o>=</span> dev1,dev2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 主机别名</span>
</span></span><span class=line><span class=cl>Host_Alias <span class=nv>WEBSERVERS</span> <span class=o>=</span> www1,www2
</span></span><span class=line><span class=cl>Host_Alias <span class=nv>DBSERVERS</span> <span class=o>=</span> db1,db2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 命令别名</span>
</span></span><span class=line><span class=cl>Cmnd_Alias <span class=nv>SOFTWARE</span> <span class=o>=</span> /bin/rpm,/usr/bin/yum
</span></span><span class=line><span class=cl>Cmnd_Alias <span class=nv>SERVICES</span> <span class=o>=</span> /usr/bin/systemctl start *, /usr/bin/systemctl stop *
</span></span><span class=line><span class=cl>Cmnd_Alias <span class=nv>DELEGATING</span> <span class=o>=</span> /usr/sbin/visudo, /bin/chown, /bin/chmod
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 授权规则</span>
</span></span><span class=line><span class=cl>ADMIN <span class=nv>ALL</span><span class=o>=(</span>ALL<span class=o>)</span> ALL                      <span class=c1># ADMIN组可执行所有命令</span>
</span></span><span class=line><span class=cl>DEV <span class=nv>WEBSERVERS</span><span class=o>=(</span>root<span class=o>)</span> SOFTWARE           <span class=c1># DEV组可在WEBSERVERS上安装软件</span>
</span></span><span class=line><span class=cl>%wheel <span class=nv>ALL</span><span class=o>=(</span>ALL<span class=o>)</span> NOPASSWD:ALL            <span class=c1># wheel组无需密码</span>
</span></span><span class=line><span class=cl>admin <span class=nv>ALL</span><span class=o>=(</span>ALL<span class=o>)</span> NOPASSWD:SERVICES        <span class=c1># admin可免密管理服务</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 限制只能执行特定命令</span>
</span></span><span class=line><span class=cl>user1 <span class=nv>ALL</span><span class=o>=(</span>root<span class=o>)</span> /usr/bin/cat /var/log/messages
</span></span><span class=line><span class=cl><span class=c1># user1只能cat这个文件，不能cat其他文件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 日志记录</span>
</span></span><span class=line><span class=cl>Defaults <span class=nv>logfile</span><span class=o>=</span>/var/log/sudo.log
</span></span><span class=line><span class=cl>Defaults <span class=nv>loglinelen</span><span class=o>=</span><span class=m>0</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=612-sudo命令使用>6.1.2 sudo命令使用</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看当前用户权限</span>
</span></span><span class=line><span class=cl>sudo -l
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以root身份执行</span>
</span></span><span class=line><span class=cl>sudo <span class=nb>command</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 切换到root（需配置）</span>
</span></span><span class=line><span class=cl>sudo -i
</span></span><span class=line><span class=cl>sudo -s
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 以其他用户身份执行</span>
</span></span><span class=line><span class=cl>sudo -u nginx /usr/sbin/nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 编辑文件</span>
</span></span><span class=line><span class=cl>sudo visudo
</span></span><span class=line><span class=cl>sudo vim /etc/shadow
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看sudo日志</span>
</span></span><span class=line><span class=cl>grep sudo /var/log/secure
</span></span><span class=line><span class=cl>cat /var/log/sudo.log
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 权限不足时的错误</span>
</span></span><span class=line><span class=cl><span class=c1># user1 is not in the sudoers file.  This incident will be reported.</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 免密码时限</span>
</span></span><span class=line><span class=cl><span class=c1># Defaults timestamp_timeout=15  # 15分钟内免密</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=62-账户清理与锁定>6.2 账户清理与锁定</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 删除无用系统账户（根据实际需求）</span>
</span></span><span class=line><span class=cl>userdel adm
</span></span><span class=line><span class=cl>userdel lp
</span></span><span class=line><span class=cl>userdel sync
</span></span><span class=line><span class=cl>userdel shutdown
</span></span><span class=line><span class=cl>userdel halt
</span></span><span class=line><span class=cl><span class=c1># 注意：不要删除系统关键用户如bin,daemon等</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 锁定配置文件（防篡改）</span>
</span></span><span class=line><span class=cl>chattr +i /etc/passwd /etc/shadow /etc/group /etc/gshadow
</span></span><span class=line><span class=cl>lsattr /etc/passwd         <span class=c1># 查看是否加锁</span>
</span></span><span class=line><span class=cl><span class=c1># 解锁：chattr -i /etc/passwd</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 设置账户过期</span>
</span></span><span class=line><span class=cl>usermod -e 2024-12-31 tempuser
</span></span><span class=line><span class=cl>chage -E 2024-12-31 tempuser
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看账户过期信息</span>
</span></span><span class=line><span class=cl>chage -l username
</span></span></code></pre></td></tr></table></div></div><h3 id=63-密码策略强化>6.3 密码策略强化</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 修改/etc/login.defs</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/login.defs <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s># 密码过期配置
</span></span></span><span class=line><span class=cl><span class=s>PASS_MAX_DAYS   90      # 密码最长使用90天
</span></span></span><span class=line><span class=cl><span class=s>PASS_MIN_DAYS   7       # 密码修改最小间隔7天
</span></span></span><span class=line><span class=cl><span class=s>PASS_MIN_LEN    12      # 密码最小长度12位
</span></span></span><span class=line><span class=cl><span class=s>PASS_WARN_AGE   14      # 提前14天警告
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 强制密码复杂度（安装libpwquality）</span>
</span></span><span class=line><span class=cl>yum install libpwquality
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修改/etc/security/pwquality.conf</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/security/pwquality.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>minlen = 12                # 最小长度
</span></span></span><span class=line><span class=cl><span class=s>dcredit = -1               # 至少1个数字
</span></span></span><span class=line><span class=cl><span class=s>ucredit = -1               # 至少1个大写字母
</span></span></span><span class=line><span class=cl><span class=s>lcredit = -1               # 至少1个小写字母
</span></span></span><span class=line><span class=cl><span class=s>ocredit = -1               # 至少1个特殊字符
</span></span></span><span class=line><span class=cl><span class=s>minclass = 3               # 至少3种字符类型
</span></span></span><span class=line><span class=cl><span class=s>maxrepeat = 2              # 最多2个相同字符连续
</span></span></span><span class=line><span class=cl><span class=s>difok = 3                  # 新密码与旧密码至少3字符不同
</span></span></span><span class=line><span class=cl><span class=s>remember = 5               # 记住最近5个密码
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 历史密码记录</span>
</span></span><span class=line><span class=cl><span class=c1># 修改/etc/pam.d/system-auth</span>
</span></span><span class=line><span class=cl>password    sufficient    pam_unix.so sha512 shadow nullok try_first_pass use_authtok <span class=nv>remember</span><span class=o>=</span><span class=m>5</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 密码加密算法</span>
</span></span><span class=line><span class=cl>authconfig --passalgo<span class=o>=</span>sha512 --update
</span></span></code></pre></td></tr></table></div></div><h3 id=64-历史命令管理>6.4 历史命令管理</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># /etc/profile环境配置</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/profile <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s># 历史命令控制
</span></span></span><span class=line><span class=cl><span class=s>export HISTSIZE=1000              # 内存中保留历史命令数
</span></span></span><span class=line><span class=cl><span class=s>export HISTFILESIZE=1000          # ~/.bash_history文件中保留数
</span></span></span><span class=line><span class=cl><span class=s>export HISTTIMEFORMAT=&#34;%F %T &#34;    # 显示时间戳
</span></span></span><span class=line><span class=cl><span class=s>export HISTCONTROL=ignoredups     # 忽略连续重复命令
</span></span></span><span class=line><span class=cl><span class=s># 其他选项：
</span></span></span><span class=line><span class=cl><span class=s># ignorespace: 忽略以空格开头的命令
</span></span></span><span class=line><span class=cl><span class=s># ignoreboth: 同时忽略重复和空格开头
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 历史命令文件位置
</span></span></span><span class=line><span class=cl><span class=s>export HISTFILE=/var/log/.hist/$(whoami)_$(date +%Y%m%d).log
</span></span></span><span class=line><span class=cl><span class=s># 按用户和日期分离存储
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 安全加固：命令执行后立即写入文件，不等待退出
</span></span></span><span class=line><span class=cl><span class=s>export PROMPT_COMMAND=&#34;history -a&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 禁止某些危险命令记录
</span></span></span><span class=line><span class=cl><span class=s>export HISTIGNORE=&#34;ls:ll:pwd:exit&#34;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 立即生效</span>
</span></span><span class=line><span class=cl><span class=nb>source</span> /etc/profile
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 清理当前会话历史</span>
</span></span><span class=line><span class=cl><span class=nb>history</span> -c                  <span class=c1># 清空内存历史</span>
</span></span><span class=line><span class=cl>&gt; ~/.bash_history           <span class=c1># 清空历史文件</span>
</span></span><span class=line><span class=cl><span class=nb>history</span> -r                  <span class=c1># 重新读取历史文件</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看历史命令</span>
</span></span><span class=line><span class=cl><span class=nb>history</span>
</span></span><span class=line><span class=cl><span class=nb>history</span> <span class=p>|</span> grep <span class=s2>&#34;rm&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 执行历史命令</span>
</span></span><span class=line><span class=cl>!123                        <span class=c1># 执行第123条命令</span>
</span></span><span class=line><span class=cl>!!                          <span class=c1># 执行上一条命令</span>
</span></span><span class=line><span class=cl>!vim                        <span class=c1># 执行最近一条以vim开头的命令</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=65-自动注销与终端安全>6.5 自动注销与终端安全</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># /etc/profile配置</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/profile <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s># 10分钟无操作自动注销
</span></span></span><span class=line><span class=cl><span class=s>TMOUT=600
</span></span></span><span class=line><span class=cl><span class=s>readonly TMOUT
</span></span></span><span class=line><span class=cl><span class=s>export TMOUT
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 限制su切换
</span></span></span><span class=line><span class=cl><span class=s># 只有wheel组用户可su到root
</span></span></span><span class=line><span class=cl><span class=s># /etc/pam.d/su
</span></span></span><span class=line><span class=cl><span class=s>auth required pam_wheel.so use_uid
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 添加用户到wheel组
</span></span></span><span class=line><span class=cl><span class=s>usermod -aG wheel admin
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 限制root登录终端</span>
</span></span><span class=line><span class=cl><span class=c1># 编辑/etc/securetty</span>
</span></span><span class=line><span class=cl><span class=c1># 只保留需要的终端，如：</span>
</span></span><span class=line><span class=cl>tty1
</span></span><span class=line><span class=cl><span class=c1># tty2-tty6注释掉</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 禁用Ctrl+Alt+Del重启</span>
</span></span><span class=line><span class=cl>systemctl mask ctrl-alt-del.target
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用StrongSWAN或OpenSSH保护远程访问</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=66-ssh服务加固>6.6 SSH服务加固</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 修改/etc/ssh/sshd_config</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/ssh/sshd_config <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s># 监听配置
</span></span></span><span class=line><span class=cl><span class=s>Port 2222                   # 修改默认端口
</span></span></span><span class=line><span class=cl><span class=s>ListenAddress 192.168.200.100  # 只监听内网
</span></span></span><span class=line><span class=cl><span class=s>Protocol 2                  # 仅使用SSH v2
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 登录控制
</span></span></span><span class=line><span class=cl><span class=s>PermitRootLogin no          # 禁止root登录
</span></span></span><span class=line><span class=cl><span class=s>PermitEmptyPasswords no     # 禁止空密码
</span></span></span><span class=line><span class=cl><span class=s>PasswordAuthentication yes  # 允许密码登录（可关闭，仅用密钥）
</span></span></span><span class=line><span class=cl><span class=s>LoginGraceTime 2m           # 登录宽限时间2分钟
</span></span></span><span class=line><span class=cl><span class=s>MaxAuthTries 3              # 最大尝试3次
</span></span></span><span class=line><span class=cl><span class=s>MaxSessions 10              # 最大会话数
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 密钥认证
</span></span></span><span class=line><span class=cl><span class=s>PubkeyAuthentication yes
</span></span></span><span class=line><span class=cl><span class=s>AuthorizedKeysFile      .ssh/authorized_keys
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 安全增强
</span></span></span><span class=line><span class=cl><span class=s>UseDNS no                   # 禁用DNS反向解析，加快连接
</span></span></span><span class=line><span class=cl><span class=s>GSSAPIAuthentication no     # 禁用GSSAPI认证
</span></span></span><span class=line><span class=cl><span class=s>AllowUsers admin user1 user2  # 允许登录的用户列表
</span></span></span><span class=line><span class=cl><span class=s>AllowGroups wheel dev       # 允许登录的组
</span></span></span><span class=line><span class=cl><span class=s>DenyUsers tempuser          # 拒绝登录的用户
</span></span></span><span class=line><span class=cl><span class=s>DenyGroups test             # 拒绝登录的组
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 空闲断开
</span></span></span><span class=line><span class=cl><span class=s>ClientAliveInterval 600     # 每600秒检测一次
</span></span></span><span class=line><span class=cl><span class=s>ClientAliveCountMax 3       # 3次无响应断开
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志
</span></span></span><span class=line><span class=cl><span class=s>SyslogFacility AUTHPRIV
</span></span></span><span class=line><span class=cl><span class=s>LogLevel INFO
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 重启SSH服务</span>
</span></span><span class=line><span class=cl>systemctl restart sshd
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> sshd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 密钥认证配置</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 客户端生成密钥对</span>
</span></span><span class=line><span class=cl>ssh-keygen -t rsa -b <span class=m>4096</span> -C <span class=s2>&#34;admin@company.com&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 复制公钥到服务器</span>
</span></span><span class=line><span class=cl>ssh-copy-id -i ~/.ssh/id_rsa.pub admin@server_ip
</span></span><span class=line><span class=cl><span class=c1># 3. 测试密钥登录</span>
</span></span><span class=line><span class=cl>ssh admin@server_ip
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 禁用密码登录（仅密钥）</span>
</span></span><span class=line><span class=cl><span class=c1># /etc/ssh/sshd_config</span>
</span></span><span class=line><span class=cl>PasswordAuthentication no
</span></span><span class=line><span class=cl><span class=c1># 重启sshd</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=67-文件系统安全>6.7 文件系统安全</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 锁定关键文件</span>
</span></span><span class=line><span class=cl>chattr +i /etc/passwd /etc/shadow /etc/group /etc/gshadow
</span></span><span class=line><span class=cl>chattr +i /etc/fstab /etc/inittab /etc/crontab
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 系统日志保护</span>
</span></span><span class=line><span class=cl>chattr +a /var/log/messages
</span></span><span class=line><span class=cl>chattr +a /var/log/secure
</span></span><span class=line><span class=cl>chattr +a /var/log/maillog
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 检查文件完整性</span>
</span></span><span class=line><span class=cl><span class=c1># 安装AIDE或Tripwire</span>
</span></span><span class=line><span class=cl>yum install aide
</span></span><span class=line><span class=cl>aide --init
</span></span><span class=line><span class=cl>mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
</span></span><span class=line><span class=cl>aide --check
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 使用auditd审计</span>
</span></span><span class=line><span class=cl>systemctl start auditd
</span></span><span class=line><span class=cl>auditctl -w /etc/passwd -p wa -k passwd_changes
</span></span><span class=line><span class=cl>ausearch -k passwd_changes
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=七服务管理nginxmysqlredisdns>七、服务管理（NGINX/MySQL/Redis/DNS）</h2><h3 id=71-nginx服务配置与管理>7.1 NGINX服务配置与管理</h3><h4 id=711-nginx核心优势>7.1.1 NGINX核心优势</h4><ol><li><strong>轻量级高并发</strong>：异步非阻塞架构，C10K问题解决方案</li><li><strong>反向代理</strong>：隐藏后端服务器，实现负载均衡</li><li><strong>静态资源处理</strong>：高效处理静态文件，CDN核心组件</li><li><strong>模块化设计</strong>：核心+插件架构，灵活扩展</li><li><strong>低内存占用</strong>：1万个非活动连接仅消耗2.5MB内存</li></ol><h4 id=712-源码安装步骤生产环境推荐>7.1.2 源码安装步骤（生产环境推荐）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 安装依赖包</span>
</span></span><span class=line><span class=cl>yum install -y gcc gcc-c++ make automake autoconf libtool <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>pcre pcre-devel zlib zlib-devel openssl openssl-devel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建运行用户</span>
</span></span><span class=line><span class=cl>useradd -s /sbin/nologin -M nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 下载源码</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /usr/src
</span></span><span class=line><span class=cl>wget http://nginx.org/download/nginx-1.24.0.tar.gz
</span></span><span class=line><span class=cl>tar zxf nginx-1.24.0.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> nginx-1.24.0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 配置编译参数</span>
</span></span><span class=line><span class=cl>./configure <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--prefix<span class=o>=</span>/usr/local/nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--user<span class=o>=</span>nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--group<span class=o>=</span>nginx <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_ssl_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_v2_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_realip_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_stub_status_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-http_gzip_static_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-pcre <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-stream <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-stream_ssl_module <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>--with-stream_realip_module
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 编译安装</span>
</span></span><span class=line><span class=cl>make -j <span class=k>$(</span>nproc<span class=k>)</span> <span class=o>&amp;&amp;</span> make install
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 创建软链接</span>
</span></span><span class=line><span class=cl>ln -s /usr/local/nginx/sbin/nginx /usr/local/sbin/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 验证安装</span>
</span></span><span class=line><span class=cl>nginx -t
</span></span><span class=line><span class=cl><span class=c1># 输出：</span>
</span></span><span class=line><span class=cl><span class=c1># nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</span>
</span></span><span class=line><span class=cl><span class=c1># nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 创建systemd服务</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/nginx.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=The NGINX HTTP and reverse proxy server
</span></span></span><span class=line><span class=cl><span class=s>After=network.target remote-fs.target nss-lookup.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=forking
</span></span></span><span class=line><span class=cl><span class=s>PIDFile=/usr/local/nginx/logs/nginx.pid
</span></span></span><span class=line><span class=cl><span class=s>ExecStartPre=/usr/local/nginx/sbin/nginx -t
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/nginx/sbin/nginx
</span></span></span><span class=line><span class=cl><span class=s>ExecReload=/bin/kill -s HUP \$MAINPID
</span></span></span><span class=line><span class=cl><span class=s>ExecStop=/bin/kill -s QUIT \$MAINPID
</span></span></span><span class=line><span class=cl><span class=s>PrivateTmp=true
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 9. 启动服务</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start nginx
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> nginx
</span></span><span class=line><span class=cl>systemctl status nginx
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 10. 配置防火墙</span>
</span></span><span class=line><span class=cl>firewall-cmd --permanent --add-port<span class=o>=</span>80/tcp
</span></span><span class=line><span class=cl>firewall-cmd --permanent --add-port<span class=o>=</span>443/tcp
</span></span><span class=line><span class=cl>firewall-cmd --reload
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 11. 浏览器访问测试</span>
</span></span><span class=line><span class=cl>http://server_ip
</span></span><span class=line><span class=cl><span class=c1># 应显示&#34;Welcome to nginx!&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=713-nginx配置结构>7.1.3 NGINX配置结构</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=c1># 全局配置段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>user</span> <span class=s>nginx</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>worker_processes</span> <span class=s>auto</span><span class=p>;</span>  <span class=c1># 根据CPU核心数自动设置
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>worker_cpu_affinity</span> <span class=s>auto</span><span class=p>;</span>  <span class=c1># CPU亲和性
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>error_log</span> <span class=s>/usr/local/nginx/logs/error.log</span> <span class=s>notice</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>pid</span> <span class=s>/usr/local/nginx/logs/nginx.pid</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>worker_rlimit_nofile</span> <span class=mi>65535</span><span class=p>;</span>  <span class=c1># 每个worker最大文件句柄
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># events配置段
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>events</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>use</span> <span class=s>epoll</span><span class=p>;</span>  <span class=c1># Linux高效模型
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>worker_connections</span> <span class=mi>65535</span><span class=p>;</span>  <span class=c1># 每个worker最大连接数
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>multi_accept</span> <span class=no>on</span><span class=p>;</span>  <span class=c1># 批量接受新连接
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># http配置段（核心）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>http</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>include</span> <span class=s>mime.types</span><span class=p>;</span>  <span class=c1># 文件类型映射
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>default_type</span> <span class=s>application/octet-stream</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 日志格式
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>log_format</span> <span class=s>main</span> <span class=s>&#39;</span><span class=nv>$remote_addr</span> <span class=s>-</span> <span class=nv>$remote_user</span> <span class=s>[</span><span class=nv>$time_local]</span> <span class=s>&#34;</span><span class=nv>$request&#34;</span> <span class=s>&#39;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#39;</span><span class=nv>$status</span> <span class=nv>$body_bytes_sent</span> <span class=s>&#34;</span><span class=nv>$http_referer&#34;</span> <span class=s>&#39;</span>
</span></span><span class=line><span class=cl>                    <span class=s>&#39;&#34;</span><span class=nv>$http_user_agent&#34;</span> <span class=s>&#34;</span><span class=nv>$http_x_forwarded_for&#34;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>access_log</span> <span class=s>/usr/local/nginx/logs/access.log</span> <span class=s>main</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 性能优化
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>sendfile</span> <span class=no>on</span><span class=p>;</span>  <span class=c1># 零拷贝传输
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>tcp_nopush</span> <span class=no>on</span><span class=p>;</span>  <span class=c1># 合并数据包
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>tcp_nodelay</span> <span class=no>on</span><span class=p>;</span>  <span class=c1># 禁用Nagle算法
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>keepalive_timeout</span> <span class=mi>65</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>keepalive_requests</span> <span class=mi>100</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>reset_timedout_connection</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 压缩配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>gzip</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_min_length</span> <span class=mi>1k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_comp_level</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>gzip_types</span> <span class=s>text/plain</span> <span class=s>text/css</span> <span class=s>text/xml</span> <span class=s>text/javascript</span> <span class=s>application/json</span> <span class=s>application/javascript</span> <span class=s>application/xml+rss</span> <span class=s>application/rss+xml</span> <span class=s>image/svg+xml</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 虚拟主机配置
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>server_name</span> <span class=s>www.linux.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span> <span class=s>/data/www</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>index</span> <span class=s>index.html</span> <span class=s>index.htm</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 访问日志
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>access_log</span> <span class=s>/usr/local/nginx/logs/www.access.log</span> <span class=s>main</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 错误页面
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>error_page</span> <span class=mi>404</span> <span class=s>/404.html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>error_page</span> <span class=mi>500</span> <span class=mi>502</span> <span class=mi>503</span> <span class=mi>504</span> <span class=s>/50x.html</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>#  location匹配
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>try_files</span> <span class=nv>$uri</span> <span class=nv>$uri/</span> <span class=s>@rewrite</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=kn>location</span> <span class=s>@rewrite</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>rewrite</span> <span class=s>^/(.*)</span>$ <span class=s>/index.php?q=</span><span class=nv>$1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 静态文件缓存
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>location</span> <span class=p>~</span><span class=sr>*</span> <span class=s>\.(jpg|jpeg|png|gif|ico|css|js)</span>$ <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>expires</span> <span class=s>1d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>add_header</span> <span class=s>Cache-Control</span> <span class=s>&#34;public,</span> <span class=s>immutable&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 拒绝访问
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>location</span> <span class=p>~</span> <span class=sr>/\.</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>deny</span> <span class=s>all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 反向代理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>location</span> <span class=s>/api/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>proxy_pass</span> <span class=s>http://backend_server</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>proxy_set_header</span> <span class=s>Host</span> <span class=nv>$host</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>proxy_set_header</span> <span class=s>X-Real-IP</span> <span class=nv>$remote_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>proxy_set_header</span> <span class=s>X-Forwarded-For</span> <span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 目录别名
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>location</span> <span class=s>/doc/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>alias</span> <span class=s>/usr/share/doc/</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>autoindex</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># 访问控制
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kn>location</span> <span class=s>/admin/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kn>auth_basic</span> <span class=s>&#34;Admin</span> <span class=s>Area&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>auth_basic_user_file</span> <span class=s>/usr/local/nginx/conf/htpasswd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>allow</span> <span class=n>192.168.200.0</span><span class=s>/24</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=kn>deny</span> <span class=s>all</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># 多个虚拟主机
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kn>server</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>server_name</span> <span class=s>blog.linux.com</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=kn>root</span> <span class=s>/data/blog</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=c1># ...
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=714-location匹配规则重要>7.1.4 location匹配规则（重要）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=c1># 匹配优先级（从高到低）：
</span></span></span><span class=line><span class=cl><span class=c1># 1. = 精确匹配
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=p>=</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 只匹配&#34;/&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. ^~ 前缀匹配（优先于正则）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=s>^~</span> <span class=s>/images/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 匹配以/images/开头的请求，停止后续正则匹配
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. ~ 区分大小写正则
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=p>~</span> <span class=sr>\.php$</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 匹配以.php结尾的请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. ~* 不区分大小写正则
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=p>~</span><span class=sr>*</span> <span class=s>\.(jpg|png|gif)</span>$ <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 匹配图片文件，不区分大小写
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. / 通用匹配
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 匹配所有请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 匹配示例：
</span></span></span><span class=line><span class=cl><span class=c1># URI: /images/logo.png
</span></span></span><span class=line><span class=cl><span class=c1># 优先匹配 ^~ /images/，不检查正则
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># URI: /index.php
</span></span></span><span class=line><span class=cl><span class=c1># 精确匹配失败，前缀匹配失败，正则匹配 ~ \.php$ 成功
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 实际配置建议：
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=p>=</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 首页
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>location</span> <span class=s>^~</span> <span class=s>/static/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 静态资源
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>location</span> <span class=p>~</span><span class=sr>*</span> <span class=s>\.(jpg|jpeg|png|gif|ico|css|js)</span>$ <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 静态文件缓存
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>location</span> <span class=p>~</span> <span class=sr>\.php$</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># PHP处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>location</span> <span class=s>/</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1># 默认处理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=715-nginx性能优化>7.1.5 NGINX性能优化</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=c1># worker进程数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>worker_processes</span> <span class=s>auto</span><span class=p>;</span>  <span class=c1># 或设置为CPU核心数
</span></span></span><span class=line><span class=cl><span class=c1># worker_cpu_affinity auto;  # CPU亲和性
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 最大连接数计算
</span></span></span><span class=line><span class=cl><span class=c1># 最大连接数 = worker_processes * worker_connections
</span></span></span><span class=line><span class=cl><span class=c1># 如果启用反向代理，需除以2（客户端和后端各一个连接）
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=c1># 文件句柄限制
</span></span></span><span class=line><span class=cl><span class=c1># /etc/security/limits.conf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>nginx</span> <span class=s>soft</span> <span class=s>nofile</span> <span class=mi>65535</span>
</span></span><span class=line><span class=cl><span class=s>nginx</span> <span class=s>hard</span> <span class=s>nofile</span> <span class=mi>65535</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># /etc/systemd/system/nginx.service
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>[Service]</span>
</span></span><span class=line><span class=cl><span class=s>LimitNOFILE=65535</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内核参数优化
</span></span></span><span class=line><span class=cl><span class=c1># /etc/sysctl.conf
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>net.core.somaxconn</span> <span class=p>=</span> <span class=mi>65535</span>
</span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_tw_buckets</span> <span class=p>=</span> <span class=mi>6000</span>
</span></span><span class=line><span class=cl><span class=s>net.ipv4.ip_local_port_range</span> <span class=p>=</span> <span class=mi>1024</span> <span class=mi>65000</span>
</span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_tw_reuse</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_keepalive_time</span> <span class=p>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_fin_timeout</span> <span class=p>=</span> <span class=mi>30</span>
</span></span><span class=line><span class=cl><span class=s>net.ipv4.tcp_max_syn_backlog</span> <span class=p>=</span> <span class=mi>8192</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 零拷贝优化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=s>sendfile</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>sendfile_max_chunk</span> <span class=mi>512k</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># TCP优化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>tcp_nopush</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>tcp_nodelay</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 连接复用
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>keepalive_timeout</span> <span class=mi>65</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>keepalive_requests</span> <span class=mi>100</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Gzip优化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>gzip</span> <span class=no>on</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>gzip_min_length</span> <span class=mi>1k</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>gzip_comp_level</span> <span class=mi>6</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>gzip_types</span> <span class=s>text/plain</span> <span class=s>text/css</span> <span class=s>application/json</span> <span class=s>application/javascript</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 缓存优化
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>open_file_cache</span> <span class=s>max=65535</span> <span class=s>inactive=60s</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>open_file_cache_valid</span> <span class=s>80s</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>open_file_cache_min_uses</span> <span class=mi>1</span><span class=p>;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=716-日志管理与切割>7.1.6 日志管理与切割</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 日志切割脚本（按天）</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/local/nginx/sbin/logrotate.sh <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>LOG_DIR=&#34;/usr/local/nginx/logs&#34;
</span></span></span><span class=line><span class=cl><span class=s>YESTERDAY=$(date -d &#34;yesterday&#34; +%Y%m%d)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 移动日志
</span></span></span><span class=line><span class=cl><span class=s>mv ${LOG_DIR}/access.log ${LOG_DIR}/access.log-${YESTERDAY}
</span></span></span><span class=line><span class=cl><span class=s>mv ${LOG_DIR}/error.log ${LOG_DIR}/error.log-${YESTERDAY}
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 重新打开日志
</span></span></span><span class=line><span class=cl><span class=s>kill -USR1 $(cat ${LOG_DIR}/nginx.pid)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 压缩旧日志（保留30天）
</span></span></span><span class=line><span class=cl><span class=s>find ${LOG_DIR} -name &#34;*.log-20*&#34; -mtime +30 -exec gzip {} \;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x /usr/local/nginx/sbin/logrotate.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 配置crontab</span>
</span></span><span class=line><span class=cl>crontab -e
</span></span><span class=line><span class=cl><span class=m>0</span> <span class=m>0</span> * * * /usr/local/nginx/sbin/logrotate.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 日志分析示例</span>
</span></span><span class=line><span class=cl><span class=c1># 统计IP访问次数</span>
</span></span><span class=line><span class=cl>awk <span class=s1>&#39;{print $1}&#39;</span> /usr/local/nginx/logs/access.log <span class=p>|</span> sort <span class=p>|</span> uniq -c <span class=p>|</span> sort -nr <span class=p>|</span> head -20
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 统计URL访问次数</span>
</span></span><span class=line><span class=cl>awk <span class=s1>&#39;{print $7}&#39;</span> /usr/local/nginx/logs/access.log <span class=p>|</span> sort <span class=p>|</span> uniq -c <span class=p>|</span> sort -nr <span class=p>|</span> head -20
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 统计响应时间超过1秒的请求</span>
</span></span><span class=line><span class=cl>awk <span class=s1>&#39;$NF &gt; 1 {print $0}&#39;</span> /usr/local/nginx/logs/access.log
</span></span></code></pre></td></tr></table></div></div><h3 id=72-mysql数据库管理>7.2 MySQL数据库管理</h3><h4 id=721-mysql-sql语句分类>7.2.1 MySQL SQL语句分类</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 1. DDL (Data Definition Language) - 数据定义语言
</span></span></span><span class=line><span class=cl><span class=c1>-- 创建、修改、删除数据库对象（表、索引、视图）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=w> </span><span class=nb>INT</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>50</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_name</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>users</span><span class=p>(</span><span class=n>name</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=k>VIEW</span><span class=w> </span><span class=n>v_users</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>active</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>COLUMN</span><span class=w> </span><span class=n>email</span><span class=w> </span><span class=nb>VARCHAR</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DROP</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DROP</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_name</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 2. DML (Data Manipulation Language) - 数据操作语言
</span></span></span><span class=line><span class=cl><span class=c1>-- 插入、更新、删除数据
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=p>(</span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;admin&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;root&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>DELETE</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>TRUNCATE</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>users</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 快速清空表
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 3. DQL (Data Query Language) - 数据查询语言
</span></span></span><span class=line><span class=cl><span class=c1>-- 查询数据（最常用）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=n>id</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>users</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 4. DCL (Data Control Language) - 数据控制语言
</span></span></span><span class=line><span class=cl><span class=c1>-- 权限管理
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>GRANT</span><span class=w> </span><span class=k>SELECT</span><span class=p>,</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>db1</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=s1>&#39;user1&#39;</span><span class=o>@</span><span class=s1>&#39;localhost&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>REVOKE</span><span class=w> </span><span class=k>INSERT</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>db1</span><span class=p>.</span><span class=o>*</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=s1>&#39;user1&#39;</span><span class=o>@</span><span class=s1>&#39;localhost&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>FLUSH</span><span class=w> </span><span class=k>PRIVILEGES</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 5. TCL (Transaction Control Language) - 事务控制语言
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>START</span><span class=w> </span><span class=k>TRANSACTION</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 或 BEGIN;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;test&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;temp&#39;</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=mi>2</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 提交
</span></span></span><span class=line><span class=cl><span class=c1>-- 或
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ROLLBACK</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 回滚
</span></span></span></code></pre></td></tr></table></div></div><h4 id=722-索引管理>7.2.2 索引管理</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 创建索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_salary</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>employees</span><span class=p>(</span><span class=n>salary</span><span class=p>);</span><span class=w>          </span><span class=c1>-- 普通索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>UNIQUE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_empid</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>employees</span><span class=p>(</span><span class=n>emp_id</span><span class=p>);</span><span class=w>    </span><span class=c1>-- 唯一索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=n>FULLTEXT</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_content</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>articles</span><span class=p>(</span><span class=n>content</span><span class=p>);</span><span class=c1>-- 全文索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 查看索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SHOW</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>SHOW</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>employees</span><span class=w> </span><span class=err>\</span><span class=k>G</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 垂直显示
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 删除索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>DROP</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_salary</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>employees</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>employees</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_salary</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 删除主键索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>employees</span><span class=w> </span><span class=k>DROP</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 创建主键索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ALTER</span><span class=w> </span><span class=k>TABLE</span><span class=w> </span><span class=n>employees</span><span class=w> </span><span class=k>ADD</span><span class=w> </span><span class=k>PRIMARY</span><span class=w> </span><span class=k>KEY</span><span class=w> </span><span class=p>(</span><span class=n>emp_id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 复合索引
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>CREATE</span><span class=w> </span><span class=k>INDEX</span><span class=w> </span><span class=n>idx_name_age</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>employees</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>age</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 索引使用建议
</span></span></span><span class=line><span class=cl><span class=c1>-- 1.  WHERE、ORDER BY、GROUP BY字段建立索引
</span></span></span><span class=line><span class=cl><span class=c1>-- 2.  区分度低的字段（如性别）不适合建立索引
</span></span></span><span class=line><span class=cl><span class=c1>-- 3.  索引会占用额外空间，降低写入速度
</span></span></span><span class=line><span class=cl><span class=c1>-- 4.  定期使用OPTIMIZE TABLE优化索引
</span></span></span></code></pre></td></tr></table></div></div><h4 id=723-事务管理>7.2.3 事务管理</h4><p><strong>事务ACID特性</strong>：</p><ul><li><strong>原子性（Atomicity）</strong>：事务是不可分割的工作单位，要么全做，要么全不做</li><li><strong>一致性（Consistency）</strong>：事务前后，数据库从一个一致状态变到另一个一致状态</li><li><strong>隔离性（Isolation）</strong>：事务之间互不干扰，隔离级别控制可见性</li><li><strong>持久性（Durability）</strong>：事务提交后，对数据的修改是永久性的</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=c1>-- 查看当前事务隔离级别
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SHOW</span><span class=w> </span><span class=n>VARIABLES</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;transaction_isolation&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 或
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SELECT</span><span class=w> </span><span class=o>@@</span><span class=n>transaction_isolation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- MySQL四种隔离级别
</span></span></span><span class=line><span class=cl><span class=c1>-- READ UNCOMMITTED（读未提交）：最低级别，可能脏读
</span></span></span><span class=line><span class=cl><span class=c1>-- READ COMMITTED（读已提交）：Oracle默认，可能不可重复读
</span></span></span><span class=line><span class=cl><span class=c1>-- REPEATABLE READ（可重复读）：MySQL默认，可能幻读
</span></span></span><span class=line><span class=cl><span class=c1>-- SERIALIZABLE（可串行化）：最高级别，完全隔离
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 事务操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>BEGIN</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 或 START TRANSACTION;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>1000</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 提交
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 回滚示例
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>UPDATE</span><span class=w> </span><span class=n>accounts</span><span class=w> </span><span class=k>SET</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>balance</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=mi>100</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>id</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 发现错误
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>ROLLBACK</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 撤销所有操作
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 保存点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>BEGIN</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;user1&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>SAVEPOINT</span><span class=w> </span><span class=n>sp1</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>users</span><span class=w> </span><span class=k>VALUES</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;user2&#39;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>ROLLBACK</span><span class=w> </span><span class=k>TO</span><span class=w> </span><span class=n>sp1</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 回滚到保存点
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>COMMIT</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- 自动提交控制
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>autocommit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 关闭自动提交
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>SET</span><span class=w> </span><span class=n>autocommit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 开启自动提交（默认）
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>-- MySQL默认引擎对比
</span></span></span><span class=line><span class=cl><span class=c1>-- MyISAM：不支持事务，表级锁，读快写慢，支持全文索引
</span></span></span><span class=line><span class=cl><span class=c1>-- InnoDB：支持事务，行级锁，支持外键，5.6+支持全文索引
</span></span></span></code></pre></td></tr></table></div></div><h4 id=724-备份与恢复>7.2.4 备份与恢复</h4><p><strong>备份策略</strong>：</p><ol><li><strong>完全备份</strong>：备份所有数据，恢复简单，占用空间大</li><li><strong>增量备份</strong>：备份自上次备份后变化的数据，节省空间，恢复复杂</li><li><strong>差异备份</strong>：备份自上次完全备份后变化的数据，折中方案</li></ol><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 物理冷备份（需停库）</span>
</span></span><span class=line><span class=cl>systemctl stop mysqld
</span></span><span class=line><span class=cl>tar zcf /backup/mysql-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>.tar.gz /var/lib/mysql
</span></span><span class=line><span class=cl>systemctl start mysqld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 逻辑备份（mysqldump，推荐）</span>
</span></span><span class=line><span class=cl><span class=c1># 备份单个库</span>
</span></span><span class=line><span class=cl>mysqldump -u root -p<span class=s1>&#39;password&#39;</span> db1 &gt; /backup/db1-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>.sql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份多个库</span>
</span></span><span class=line><span class=cl>mysqldump -u root -p<span class=s1>&#39;password&#39;</span> --databases db1 db2 &gt; /backup/dbs.sql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份所有库</span>
</span></span><span class=line><span class=cl>mysqldump -u root -p<span class=s1>&#39;password&#39;</span> --all-databases &gt; /backup/all-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>.sql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 仅备份表结构</span>
</span></span><span class=line><span class=cl>mysqldump -u root -p<span class=s1>&#39;password&#39;</span> -d db1 &gt; /backup/db1-structure.sql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份并压缩</span>
</span></span><span class=line><span class=cl>mysqldump -u root -p<span class=s1>&#39;password&#39;</span> db1 <span class=p>|</span> gzip &gt; /backup/db1.sql.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 恢复</span>
</span></span><span class=line><span class=cl><span class=c1># 方法1：mysql命令</span>
</span></span><span class=line><span class=cl>mysql -u root -p<span class=s1>&#39;password&#39;</span> db1 &lt; /backup/db1.sql
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方法2：source（在MySQL客户端）</span>
</span></span><span class=line><span class=cl>mysql&gt; USE db1<span class=p>;</span>
</span></span><span class=line><span class=cl>mysql&gt; SOURCE /backup/db1.sql<span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 增量备份（基于binlog）</span>
</span></span><span class=line><span class=cl><span class=c1># 启用binlog</span>
</span></span><span class=line><span class=cl>cat &gt;&gt; /etc/my.cnf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[mysqld]
</span></span></span><span class=line><span class=cl><span class=s>log_bin = /var/log/mysql/mysql-bin
</span></span></span><span class=line><span class=cl><span class=s>binlog_format = MIXED
</span></span></span><span class=line><span class=cl><span class=s>expire_logs_days = 7
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看binlog</span>
</span></span><span class=line><span class=cl>mysqlbinlog /var/log/mysql/mysql-bin.000001 <span class=p>|</span> mysql -u root -p
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 自动化备份脚本</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/local/bin/mysql_backup.sh <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>BACKUP_DIR=&#34;/backup/mysql&#34;
</span></span></span><span class=line><span class=cl><span class=s>DATE=$(date +%Y%m%d_%H%M%S)
</span></span></span><span class=line><span class=cl><span class=s>USER=&#34;root&#34;
</span></span></span><span class=line><span class=cl><span class=s>PASS=&#34;your_password&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 创建目录
</span></span></span><span class=line><span class=cl><span class=s>mkdir -p $BACKUP_DIR
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 备份所有数据库
</span></span></span><span class=line><span class=cl><span class=s>mysqldump -u $USER -p$PASS --all-databases | gzip &gt; $BACKUP_DIR/all-$DATE.sql.gz
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 删除30天前的备份
</span></span></span><span class=line><span class=cl><span class=s>find $BACKUP_DIR -name &#34;*.sql.gz&#34; -mtime +30 -delete
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 记录日志
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;$DATE: Backup completed&#34; &gt;&gt; /var/log/mysql_backup.log
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x /usr/local/bin/mysql_backup.sh
</span></span><span class=line><span class=cl>crontab -e
</span></span><span class=line><span class=cl><span class=m>0</span> <span class=m>2</span> * * * /usr/local/bin/mysql_backup.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=73-redis缓存系统>7.3 Redis缓存系统</h3><h4 id=731-redis核心优势>7.3.1 Redis核心优势</h4><ol><li><strong>极高性能</strong>：纯内存操作，11万/秒读，8万/秒写</li><li><strong>丰富数据结构</strong>：String, Hash, List, Set, Sorted Set</li><li><strong>持久化</strong>：RDB快照+AOF日志，支持数据恢复</li><li><strong>原子性</strong>：所有操作单线程，保证原子性</li><li><strong>高可用</strong>：主从复制+哨兵+集群</li></ol><h4 id=732-redis安装部署>7.3.2 Redis安装部署</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 编译安装</span>
</span></span><span class=line><span class=cl><span class=nb>cd</span> /usr/src
</span></span><span class=line><span class=cl>wget https://download.redis.io/releases/redis-6.2.11.tar.gz
</span></span><span class=line><span class=cl>tar zxf redis-6.2.11.tar.gz
</span></span><span class=line><span class=cl><span class=nb>cd</span> redis-6.2.11
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 编译</span>
</span></span><span class=line><span class=cl>make <span class=nv>MALLOC</span><span class=o>=</span>libc
</span></span><span class=line><span class=cl>make install <span class=nv>PREFIX</span><span class=o>=</span>/usr/local/redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 创建配置目录</span>
</span></span><span class=line><span class=cl>mkdir -p /usr/local/redis/<span class=o>{</span>conf,logs,data,run<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 初始化配置文件</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/local/redis/conf/redis.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s># 绑定地址
</span></span></span><span class=line><span class=cl><span class=s>bind 0.0.0.0
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 端口
</span></span></span><span class=line><span class=cl><span class=s>port 6379
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 守护进程
</span></span></span><span class=line><span class=cl><span class=s>daemonize yes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># PID文件
</span></span></span><span class=line><span class=cl><span class=s>pidfile /usr/local/redis/run/redis_6379.pid
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志文件
</span></span></span><span class=line><span class=cl><span class=s>logfile /usr/local/redis/logs/redis.log
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 数据目录
</span></span></span><span class=line><span class=cl><span class=s>dir /usr/local/redis/data
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 数据文件
</span></span></span><span class=line><span class=cl><span class=s>dbfilename dump.rdb
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># RDB持久化策略
</span></span></span><span class=line><span class=cl><span class=s>save 900 1
</span></span></span><span class=line><span class=cl><span class=s>save 300 10
</span></span></span><span class=line><span class=cl><span class=s>save 60 10000
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># AOF持久化
</span></span></span><span class=line><span class=cl><span class=s>appendonly yes
</span></span></span><span class=line><span class=cl><span class=s>appendfilename &#34;appendonly.aof&#34;
</span></span></span><span class=line><span class=cl><span class=s>appendfsync everysec
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 密码验证
</span></span></span><span class=line><span class=cl><span class=s>requirepass your_strong_password
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 最大内存
</span></span></span><span class=line><span class=cl><span class=s>maxmemory 1gb
</span></span></span><span class=line><span class=cl><span class=s>maxmemory-policy allkeys-lru
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 慢查询日志
</span></span></span><span class=line><span class=cl><span class=s>slowlog-log-slower-than 10000
</span></span></span><span class=line><span class=cl><span class=s>slowlog-max-len 128
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 限制连接数
</span></span></span><span class=line><span class=cl><span class=s>maxclients 10000
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 超时设置
</span></span></span><span class=line><span class=cl><span class=s>timeout 300
</span></span></span><span class=line><span class=cl><span class=s>tcp-keepalive 60
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 创建启动脚本</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/redis.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=Redis In-Memory Data Store
</span></span></span><span class=line><span class=cl><span class=s>After=network.target
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=forking
</span></span></span><span class=line><span class=cl><span class=s>User=redis
</span></span></span><span class=line><span class=cl><span class=s>Group=redis
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/usr/local/redis/bin/redis-server /usr/local/redis/conf/redis.conf
</span></span></span><span class=line><span class=cl><span class=s>ExecStop=/usr/local/redis/bin/redis-cli shutdown
</span></span></span><span class=line><span class=cl><span class=s>Restart=always
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 创建用户并授权</span>
</span></span><span class=line><span class=cl>useradd -s /sbin/nologin -M redis
</span></span><span class=line><span class=cl>chown -R redis:redis /usr/local/redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 启动服务</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start redis
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> redis
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 客户端测试</span>
</span></span><span class=line><span class=cl>/usr/local/redis/bin/redis-cli
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; AUTH your_strong_password
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; SET name <span class=s2>&#34;redis&#34;</span>
</span></span><span class=line><span class=cl>OK
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; GET name
</span></span><span class=line><span class=cl><span class=s2>&#34;redis&#34;</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; INFO
</span></span></code></pre></td></tr></table></div></div><h4 id=733-redis主从复制>7.3.3 Redis主从复制</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 主节点配置（192.168.200.100）</span>
</span></span><span class=line><span class=cl><span class=c1># redis.conf</span>
</span></span><span class=line><span class=cl><span class=nb>bind</span> 0.0.0.0
</span></span><span class=line><span class=cl>port <span class=m>6379</span>
</span></span><span class=line><span class=cl>requirepass MasterPass123
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 从节点1配置（192.168.200.101）</span>
</span></span><span class=line><span class=cl><span class=c1># redis.conf</span>
</span></span><span class=line><span class=cl><span class=nb>bind</span> 0.0.0.0
</span></span><span class=line><span class=cl>port <span class=m>6379</span>
</span></span><span class=line><span class=cl>requirepass SlavePass123
</span></span><span class=line><span class=cl>masterauth MasterPass123
</span></span><span class=line><span class=cl>slaveof 192.168.200.100 <span class=m>6379</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 从节点2配置（192.168.200.102）</span>
</span></span><span class=line><span class=cl><span class=c1># 同上</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 验证主从</span>
</span></span><span class=line><span class=cl><span class=c1># 主节点执行</span>
</span></span><span class=line><span class=cl>redis-cli -a MasterPass123
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; INFO replication
</span></span><span class=line><span class=cl><span class=c1># 输出：</span>
</span></span><span class=line><span class=cl><span class=c1># role:master</span>
</span></span><span class=line><span class=cl><span class=c1># connected_slaves:2</span>
</span></span><span class=line><span class=cl><span class=c1># slave0:ip=192.168.200.101,port=6379,state=online,offset=12345,lag=0</span>
</span></span><span class=line><span class=cl><span class=c1># slave1:ip=192.168.200.102,port=6379,state=online,offset=12345,lag=0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 从节点执行</span>
</span></span><span class=line><span class=cl>127.0.0.1:6379&gt; INFO replication
</span></span><span class=line><span class=cl><span class=c1># 输出：</span>
</span></span><span class=line><span class=cl><span class=c1># role:slave</span>
</span></span><span class=line><span class=cl><span class=c1># master_host:192.168.200.100</span>
</span></span><span class=line><span class=cl><span class=c1># master_port:6379</span>
</span></span><span class=line><span class=cl><span class=c1># master_link_status:up</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=734-redis哨兵集群>7.3.4 Redis哨兵集群</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 创建Sentinel配置</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/local/redis/conf/sentinel.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s># 端口
</span></span></span><span class=line><span class=cl><span class=s>port 26379
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 守护进程
</span></span></span><span class=line><span class=cl><span class=s>daemonize yes
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># PID文件
</span></span></span><span class=line><span class=cl><span class=s>pidfile /usr/local/redis/run/sentinel_26379.pid
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志
</span></span></span><span class=line><span class=cl><span class=s>logfile /usr/local/redis/logs/sentinel.log
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 监控主节点
</span></span></span><span class=line><span class=cl><span class=s>sentinel monitor mymaster 192.168.200.100 6379 2
</span></span></span><span class=line><span class=cl><span class=s># mymaster: 主节点名称
</span></span></span><span class=line><span class=cl><span class=s># 192.168.200.100: 主节点IP
</span></span></span><span class=line><span class=cl><span class=s># 6379: 主节点端口
</span></span></span><span class=line><span class=cl><span class=s># 2: 最少2个sentinel同意才判定故障
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 密码
</span></span></span><span class=line><span class=cl><span class=s>sentinel auth-pass mymaster MasterPass123
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 主观下线时间（毫秒）
</span></span></span><span class=line><span class=cl><span class=s>sentinel down-after-milliseconds mymaster 3000
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 故障转移超时
</span></span></span><span class=line><span class=cl><span class=s>sentinel failover-timeout mymaster 180000
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 故障转移后，从节点并行同步数量
</span></span></span><span class=line><span class=cl><span class=s>sentinel parallel-syncs mymaster 1
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 保护模式
</span></span></span><span class=line><span class=cl><span class=s>protected-mode no
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 启动Sentinel</span>
</span></span><span class=line><span class=cl>/usr/local/redis/bin/redis-sentinel /usr/local/redis/conf/sentinel.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 查看Sentinel状态</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>26379</span>
</span></span><span class=line><span class=cl>127.0.0.1:26379&gt; sentinel masters
</span></span><span class=line><span class=cl>127.0.0.1:26379&gt; sentinel slaves mymaster
</span></span><span class=line><span class=cl>127.0.0.1:26379&gt; sentinel sentinels mymaster
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 故障转移测试</span>
</span></span><span class=line><span class=cl><span class=c1># 在主节点执行</span>
</span></span><span class=line><span class=cl>redis-cli -a MasterPass123 shutdown
</span></span><span class=line><span class=cl><span class=c1># 观察sentinel日志，自动选举新主节点</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 客户端连接</span>
</span></span><span class=line><span class=cl><span class=c1># 使用哨兵获取当前主节点</span>
</span></span><span class=line><span class=cl>redis-cli -p <span class=m>26379</span> sentinel get-master-addr-by-name mymaster
</span></span><span class=line><span class=cl><span class=c1># 输出：1) &#34;192.168.200.101&#34; 2) &#34;6379&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=735-redis缓存问题与解决方案>7.3.5 Redis缓存问题与解决方案</h4><p><strong>缓存击穿</strong>：</p><ul><li><p><strong>原因</strong>：热点key过期瞬间，大量请求打到数据库</p></li><li><p><strong>解决方案</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 互斥锁方案</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>redis</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>threading</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_data</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=c1># 尝试获取锁</span>
</span></span><span class=line><span class=cl>        <span class=n>lock</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>lock_key</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=mi>10</span><span class=p>,</span> <span class=n>nx</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>lock</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 从数据库加载</span>
</span></span><span class=line><span class=cl>            <span class=n>value</span> <span class=o>=</span> <span class=n>load_from_db</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=mi>3600</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=n>delete</span><span class=p>(</span><span class=n>lock_key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=c1># 等待并重试</span>
</span></span><span class=line><span class=cl>            <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mf>0.1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=n>get_data</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>value</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-nginx data-lang=nginx><span class=line><span class=cl><span class=c1># Nginx配置：永不过期
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=k>location</span> <span class=s>/api/hot-data</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_cache_valid</span> <span class=mi>200</span> <span class=s>1d</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kn>proxy_cache_use_stale</span> <span class=s>error</span> <span class=s>timeout</span> <span class=s>updating</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p><strong>缓存雪崩</strong>：</p><ul><li><strong>原因</strong>：大量key同时过期</li><li><strong>解决方案</strong>：<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Redis配置：随机过期时间</span>
</span></span><span class=line><span class=cl><span class=c1># 在设置缓存时添加随机值</span>
</span></span><span class=line><span class=cl>EXPIRE key <span class=k>$((</span><span class=nv>$RANDOM</span> <span class=o>%</span> <span class=m>300</span> <span class=o>+</span> <span class=m>3600</span><span class=k>))</span>  <span class=c1># 3600-3900秒之间</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><p><strong>缓存穿透</strong>：</p><ul><li><strong>原因</strong>：查询不存在的数据，绕过缓存</li><li><strong>解决方案</strong>：<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># 布隆过滤器</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>pybloom_live</span> <span class=kn>import</span> <span class=n>BloomFilter</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>bf</span> <span class=o>=</span> <span class=n>BloomFilter</span><span class=p>(</span><span class=n>capacity</span><span class=o>=</span><span class=mi>1000000</span><span class=p>,</span> <span class=n>error_rate</span><span class=o>=</span><span class=mf>0.001</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># 加载所有有效key到布隆过滤器</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>get_data</span><span class=p>(</span><span class=n>key</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>bf</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=kc>None</span>  <span class=c1># 直接返回，不查询数据库</span>
</span></span><span class=line><span class=cl>    <span class=n>value</span> <span class=o>=</span> <span class=n>r</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>value</span> <span class=o>=</span> <span class=n>load_from_db</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>value</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>r</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s2>&#34;NULL&#34;</span><span class=p>,</span> <span class=n>ex</span><span class=o>=</span><span class=mi>60</span><span class=p>)</span>  <span class=c1># 缓存空结果</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>value</span>
</span></span></code></pre></td></tr></table></div></div></li></ul><h4 id=736-redis淘汰策略>7.3.6 Redis淘汰策略</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看当前策略</span>
</span></span><span class=line><span class=cl>redis-cli config get maxmemory-policy
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 八种淘汰策略</span>
</span></span><span class=line><span class=cl>noeviction          <span class=c1># 不淘汰，内存满后写入报错</span>
</span></span><span class=line><span class=cl>allkeys-lru         <span class=c1># 所有key中淘汰最近最少使用（推荐）</span>
</span></span><span class=line><span class=cl>allkeys-lfu         <span class=c1># 所有key中淘汰最不常用</span>
</span></span><span class=line><span class=cl>allkeys-random      <span class=c1># 随机淘汰</span>
</span></span><span class=line><span class=cl>volatile-lru        <span class=c1># 过期key中淘汰LRU（需要设置TTL）</span>
</span></span><span class=line><span class=cl>volatile-lfu        <span class=c1># 过期key中淘汰LFU</span>
</span></span><span class=line><span class=cl>volatile-random     <span class=c1># 过期key中随机淘汰</span>
</span></span><span class=line><span class=cl>volatile-ttl        <span class=c1># 淘汰即将过期的key</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 配置淘汰策略</span>
</span></span><span class=line><span class=cl>maxmemory-policy allkeys-lru
</span></span><span class=line><span class=cl>maxmemory-samples <span class=m>5</span>  <span class=c1># 采样数量，越大越精确</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 监控内存</span>
</span></span><span class=line><span class=cl>redis-cli info memory
</span></span><span class=line><span class=cl><span class=c1># used_memory_human:1.23G</span>
</span></span><span class=line><span class=cl><span class=c1># used_memory_peak_human:1.50G</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=737-redis持久化机制>7.3.7 Redis持久化机制</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. RDB（Redis Database）</span>
</span></span><span class=line><span class=cl><span class=c1># 优点：紧凑、恢复快</span>
</span></span><span class=line><span class=cl><span class=c1># 缺点：可能丢失数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>save <span class=m>900</span> <span class=m>1</span>        <span class=c1># 900秒内有1次修改就触发</span>
</span></span><span class=line><span class=cl>save <span class=m>300</span> <span class=m>10</span>       <span class=c1># 300秒内有10次修改</span>
</span></span><span class=line><span class=cl>save <span class=m>60</span> <span class=m>10000</span>     <span class=c1># 60秒内有10000次修改</span>
</span></span><span class=line><span class=cl>dbfilename dump.rdb
</span></span><span class=line><span class=cl>dir /usr/local/redis/data
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 手动触发</span>
</span></span><span class=line><span class=cl>SAVE              <span class=c1># 同步保存（阻塞）</span>
</span></span><span class=line><span class=cl>BGSAVE            <span class=c1># 异步保存（fork子进程）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. AOF（Append Only File）</span>
</span></span><span class=line><span class=cl><span class=c1># 优点：数据安全，最多丢失1秒</span>
</span></span><span class=line><span class=cl><span class=c1># 缺点：文件大，恢复慢</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>appendonly yes
</span></span><span class=line><span class=cl>appendfilename <span class=s2>&#34;appendonly.aof&#34;</span>
</span></span><span class=line><span class=cl>appendfsync everysec    <span class=c1># 每秒同步</span>
</span></span><span class=line><span class=cl><span class=c1># appendfsync always    # 每次操作同步（最安全，最慢）</span>
</span></span><span class=line><span class=cl><span class=c1># appendfsync no        # 由操作系统决定（最快，不安全）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># AOF重写</span>
</span></span><span class=line><span class=cl>auto-aof-rewrite-percentage <span class=m>100</span>
</span></span><span class=line><span class=cl>auto-aof-rewrite-min-size 64mb
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 混合持久化（Redis 4.0+）</span>
</span></span><span class=line><span class=cl>aof-use-rdb-preamble yes
</span></span></code></pre></td></tr></table></div></div><h3 id=74-dns服务配置bind>7.4 DNS服务配置（BIND）</h3><h4 id=741-主域名服务器配置>7.4.1 主域名服务器配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 安装BIND</span>
</span></span><span class=line><span class=cl>yum install <span class=nb>bind</span> bind-utils
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 修改主配置</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/named.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>options {
</span></span></span><span class=line><span class=cl><span class=s>    listen-on port 53 { 192.168.200.100; };
</span></span></span><span class=line><span class=cl><span class=s>    listen-on-v6 port 53 { ::1; };
</span></span></span><span class=line><span class=cl><span class=s>    directory   &#34;/var/named&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    dump-file   &#34;/var/named/data/cache_dump.db&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    statistics-file &#34;/var/named/data/named_stats.txt&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    memstatistics-file &#34;/var/named/data/named_mem_stats.txt&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    recursing-file  &#34;/var/named/data/named.recursing&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    secroots-file   &#34;/var/named/data/named.secroots&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    allow-query     { 192.168.200.0/24; localhost; };
</span></span></span><span class=line><span class=cl><span class=s>    recursion yes;
</span></span></span><span class=line><span class=cl><span class=s>    dnssec-enable yes;
</span></span></span><span class=line><span class=cl><span class=s>    dnssec-validation yes;
</span></span></span><span class=line><span class=cl><span class=s>    bindkeys-file &#34;/etc/named.root.key&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    managed-keys-directory &#34;/var/named/dynamic&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    pid-file &#34;/run/named/named.pid&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    session-keyfile &#34;/run/named/session.key&#34;;
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>logging {
</span></span></span><span class=line><span class=cl><span class=s>        channel default_debug {
</span></span></span><span class=line><span class=cl><span class=s>                file &#34;data/named.run&#34;;
</span></span></span><span class=line><span class=cl><span class=s>                severity dynamic;
</span></span></span><span class=line><span class=cl><span class=s>        };
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>zone &#34;.&#34; IN {
</span></span></span><span class=line><span class=cl><span class=s>    type hint;
</span></span></span><span class=line><span class=cl><span class=s>    file &#34;named.ca&#34;;
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>zone &#34;linux.com&#34; IN {
</span></span></span><span class=line><span class=cl><span class=s>    type master;
</span></span></span><span class=line><span class=cl><span class=s>    file &#34;linux.com.zone&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    allow-transfer { 192.168.200.193; };
</span></span></span><span class=line><span class=cl><span class=s>    allow-update { none; };
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>zone &#34;200.168.192.in-addr.arpa&#34; IN {
</span></span></span><span class=line><span class=cl><span class=s>    type master;
</span></span></span><span class=line><span class=cl><span class=s>    file &#34;192.168.200.zone&#34;;
</span></span></span><span class=line><span class=cl><span class=s>    allow-transfer { 192.168.200.193; };
</span></span></span><span class=line><span class=cl><span class=s>    allow-update { none; };
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>include &#34;/etc/named.rfc1912.zones&#34;;
</span></span></span><span class=line><span class=cl><span class=s>include &#34;/etc/named.root.key&#34;;
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 创建正向解析区域文件</span>
</span></span><span class=line><span class=cl>cat &gt; /var/named/linux.com.zone <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>\$TTL 86400
</span></span></span><span class=line><span class=cl><span class=s>@       IN      SOA     ns1.linux.com. admin.linux.com. (
</span></span></span><span class=line><span class=cl><span class=s>                        2024011501      ; serial
</span></span></span><span class=line><span class=cl><span class=s>                        3600            ; refresh (1小时)
</span></span></span><span class=line><span class=cl><span class=s>                        600             ; retry (10分钟)
</span></span></span><span class=line><span class=cl><span class=s>                        86400           ; expire (1天)
</span></span></span><span class=line><span class=cl><span class=s>                        86400 )         ; minimum (1天)
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>        IN      NS      ns1.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>        IN      NS      ns2.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>        IN      MX  10  mail.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>ns1     IN      A       192.168.200.100
</span></span></span><span class=line><span class=cl><span class=s>ns2     IN      A       192.168.200.193
</span></span></span><span class=line><span class=cl><span class=s>www     IN      A       192.168.200.100
</span></span></span><span class=line><span class=cl><span class=s>mail    IN      A       192.168.200.111
</span></span></span><span class=line><span class=cl><span class=s>ftp     IN      CNAME   www
</span></span></span><span class=line><span class=cl><span class=s>*       IN      A       192.168.200.100  ; 泛解析
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 创建反向解析区域文件</span>
</span></span><span class=line><span class=cl>cat &gt; /var/named/192.168.200.zone <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>\$TTL 86400
</span></span></span><span class=line><span class=cl><span class=s>@       IN      SOA     ns1.linux.com. admin.linux.com. (
</span></span></span><span class=line><span class=cl><span class=s>                        2024011501
</span></span></span><span class=line><span class=cl><span class=s>                        3600
</span></span></span><span class=line><span class=cl><span class=s>                        600
</span></span></span><span class=line><span class=cl><span class=s>                        86400
</span></span></span><span class=line><span class=cl><span class=s>                        86400 )
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>        IN      NS      ns1.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>        IN      NS      ns2.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>100     IN      PTR     ns1.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>193     IN      PTR     ns2.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>100     IN      PTR     www.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>111     IN      PTR     mail.linux.com.
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 修改权限</span>
</span></span><span class=line><span class=cl>chown named:named /var/named/linux.com.zone
</span></span><span class=line><span class=cl>chown named:named /var/named/192.168.200.zone
</span></span><span class=line><span class=cl>chmod <span class=m>640</span> /var/named/linux.com.zone
</span></span><span class=line><span class=cl>chmod <span class=m>640</span> /var/named/192.168.200.zone
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 检查配置</span>
</span></span><span class=line><span class=cl>named-checkconf /etc/named.conf
</span></span><span class=line><span class=cl>named-checkzone linux.com /var/named/linux.com.zone
</span></span><span class=line><span class=cl>named-checkzone 200.168.192.in-addr.arpa /var/named/192.168.200.zone
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 启动服务</span>
</span></span><span class=line><span class=cl>systemctl start named
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> named
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 客户端测试</span>
</span></span><span class=line><span class=cl><span class=c1># 修改客户端DNS</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/resolv.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>nameserver 192.168.200.100
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 测试解析</span>
</span></span><span class=line><span class=cl>nslookup www.linux.com
</span></span><span class=line><span class=cl>dig www.linux.com
</span></span><span class=line><span class=cl>host www.linux.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 反向解析测试</span>
</span></span><span class=line><span class=cl>nslookup 192.168.200.100
</span></span><span class=line><span class=cl>dig -x 192.168.200.100
</span></span></code></pre></td></tr></table></div></div><h4 id=742-从域名服务器配置>7.4.2 从域名服务器配置</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 在从服务器上安装BIND</span>
</span></span><span class=line><span class=cl>yum install <span class=nb>bind</span> bind-utils
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 修改named.conf</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/named.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>options {
</span></span></span><span class=line><span class=cl><span class=s>    listen-on port 53 { 192.168.200.193; };
</span></span></span><span class=line><span class=cl><span class=s>    allow-query { 192.168.200.0/24; };
</span></span></span><span class=line><span class=cl><span class=s>    # ... 其他配置同主服务器
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>zone &#34;linux.com&#34; IN {
</span></span></span><span class=line><span class=cl><span class=s>    type slave;
</span></span></span><span class=line><span class=cl><span class=s>    masters { 192.168.200.100; };
</span></span></span><span class=line><span class=cl><span class=s>    file &#34;slaves/linux.com.zone&#34;;
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>zone &#34;200.168.192.in-addr.arpa&#34; IN {
</span></span></span><span class=line><span class=cl><span class=s>    type slave;
</span></span></span><span class=line><span class=cl><span class=s>    masters { 192.168.200.100; };
</span></span></span><span class=line><span class=cl><span class=s>    file &#34;slaves/192.168.200.zone&#34;;
</span></span></span><span class=line><span class=cl><span class=s>};
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 启动从服务器</span>
</span></span><span class=line><span class=cl>systemctl start named
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> named
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 验证</span>
</span></span><span class=line><span class=cl><span class=c1># 在主服务器修改区域文件，更新serial</span>
</span></span><span class=line><span class=cl><span class=c1># 执行 rndc reload 或 systemctl reload named</span>
</span></span><span class=line><span class=cl><span class=c1># 观察从服务器日志</span>
</span></span><span class=line><span class=cl>tail -f /var/log/messages <span class=p>|</span> grep named
</span></span><span class=line><span class=cl><span class=c1># 应显示：transfer of &#39;linux.com/IN&#39; from 192.168.200.100#53: Transfer completed: 1 messages</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 测试从服务器解析</span>
</span></span><span class=line><span class=cl>dig @192.168.200.193 www.linux.com
</span></span></code></pre></td></tr></table></div></div><h4 id=743-dns工具使用>7.4.3 DNS工具使用</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># nslookup（交互式）</span>
</span></span><span class=line><span class=cl>nslookup
</span></span><span class=line><span class=cl>&gt; server 192.168.200.100
</span></span><span class=line><span class=cl>&gt; www.linux.com
</span></span><span class=line><span class=cl>&gt; <span class=nb>set</span> <span class=nv>type</span><span class=o>=</span>mx
</span></span><span class=line><span class=cl>&gt; linux.com
</span></span><span class=line><span class=cl>&gt; <span class=nb>exit</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># dig（详细信息）</span>
</span></span><span class=line><span class=cl>dig www.linux.com
</span></span><span class=line><span class=cl>dig +short www.linux.com          <span class=c1># 简短输出</span>
</span></span><span class=line><span class=cl>dig +trace www.linux.com          <span class=c1># 跟踪解析过程</span>
</span></span><span class=line><span class=cl>dig +nocmd www.linux.com          <span class=c1># 不显示命令</span>
</span></span><span class=line><span class=cl>dig +noall +answer www.linux.com  <span class=c1># 只显示答案</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># host</span>
</span></span><span class=line><span class=cl>host www.linux.com
</span></span><span class=line><span class=cl>host -t mx linux.com              <span class=c1># 查询MX记录</span>
</span></span><span class=line><span class=cl>host -t a www.linux.com           <span class=c1># 查询A记录</span>
</span></span><span class=line><span class=cl>host -t ptr 192.168.200.100       <span class=c1># 反向解析</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># rndc（BIND管理工具）</span>
</span></span><span class=line><span class=cl>rndc status                       <span class=c1># 查看状态</span>
</span></span><span class=line><span class=cl>rndc reload                       <span class=c1># 重载配置</span>
</span></span><span class=line><span class=cl>rndc flush                        <span class=c1># 清空缓存</span>
</span></span><span class=line><span class=cl>rndc sync                         <span class=c1># 同步区域文件</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=八系统监控与故障排查>八、系统监控与故障排查</h2><h3 id=81-系统性能监控>8.1 系统性能监控</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># CPU监控</span>
</span></span><span class=line><span class=cl>top                                  <span class=c1># 实时CPU使用</span>
</span></span><span class=line><span class=cl>htop                                 <span class=c1># 更友好的top</span>
</span></span><span class=line><span class=cl>mpstat <span class=m>1</span>                             <span class=c1># 每个CPU核心统计</span>
</span></span><span class=line><span class=cl>vmstat <span class=m>1</span>                             <span class=c1># CPU、内存、I/O综合</span>
</span></span><span class=line><span class=cl>sar -u <span class=m>1</span> <span class=m>10</span>                          <span class=c1># CPU历史数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 内存监控</span>
</span></span><span class=line><span class=cl>free -h                              <span class=c1># 内存使用</span>
</span></span><span class=line><span class=cl>vmstat -s <span class=p>|</span> grep memory              <span class=c1># 内存统计</span>
</span></span><span class=line><span class=cl>pmap -x &lt;pid&gt;                        <span class=c1># 进程内存映射</span>
</span></span><span class=line><span class=cl>smem                                 <span class=c1># 内存使用分析工具</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 磁盘监控</span>
</span></span><span class=line><span class=cl>df -hT                               <span class=c1># 磁盘空间</span>
</span></span><span class=line><span class=cl>du -sh /*                            <span class=c1># 目录大小</span>
</span></span><span class=line><span class=cl>iostat -x <span class=m>1</span>                          <span class=c1># 磁盘I/O统计</span>
</span></span><span class=line><span class=cl>iotop                                <span class=c1># I/O进程排名</span>
</span></span><span class=line><span class=cl>dstat                                <span class=c1># 综合I/O监控</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 网络监控</span>
</span></span><span class=line><span class=cl>iftop                                <span class=c1># 实时流量</span>
</span></span><span class=line><span class=cl>nethogs                              <span class=c1># 按进程显示流量</span>
</span></span><span class=line><span class=cl>ss -s                                <span class=c1># 套接字统计</span>
</span></span><span class=line><span class=cl>netstat -i                           <span class=c1># 网络接口统计</span>
</span></span><span class=line><span class=cl>cat /proc/net/dev                    <span class=c1># 原始网络数据</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 系统负载</span>
</span></span><span class=line><span class=cl>uptime                               <span class=c1># 1、5、15分钟负载</span>
</span></span><span class=line><span class=cl>cat /proc/loadavg                    <span class=c1># 详细负载信息</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 进程监控</span>
</span></span><span class=line><span class=cl>ps aux --sort<span class=o>=</span>-%cpu                  <span class=c1># 按CPU排序</span>
</span></span><span class=line><span class=cl>ps aux --sort<span class=o>=</span>-%mem                  <span class=c1># 按内存排序</span>
</span></span><span class=line><span class=cl>pidstat <span class=m>1</span>                            <span class=c1># 进程资源使用</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 综合监控工具</span>
</span></span><span class=line><span class=cl>dstat -cdngy <span class=m>1</span>                       <span class=c1># CPU、磁盘、网络、系统、分页</span>
</span></span><span class=line><span class=cl>glances                              <span class=c1># 跨平台监控（需安装）</span>
</span></span><span class=line><span class=cl>nmon                                 <span class=c1># AIX/Linux性能分析</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=82-日志管理>8.2 日志管理</h3><h4 id=821-日志文件说明>8.2.1 日志文件说明</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 核心日志</span>
</span></span><span class=line><span class=cl>/var/log/messages                    <span class=c1># 系统通用日志（内核、服务）</span>
</span></span><span class=line><span class=cl>/var/log/secure                      <span class=c1># 安全相关（SSH、su、sudo）</span>
</span></span><span class=line><span class=cl>/var/log/cron                        <span class=c1># 计划任务日志</span>
</span></span><span class=line><span class=cl>/var/log/dmesg                       <span class=c1># 内核环形缓冲区</span>
</span></span><span class=line><span class=cl>/var/log/boot.log                    <span class=c1># 系统启动日志</span>
</span></span><span class=line><span class=cl>/var/log/audit/audit.log             <span class=c1># SELinux审计日志</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 应用日志</span>
</span></span><span class=line><span class=cl>/var/log/nginx/access.log            <span class=c1># Nginx访问日志</span>
</span></span><span class=line><span class=cl>/var/log/nginx/error.log             <span class=c1># Nginx错误日志</span>
</span></span><span class=line><span class=cl>/var/log/mysql/mysqld.log            <span class=c1># MySQL日志</span>
</span></span><span class=line><span class=cl>/var/log/redis/redis.log             <span class=c1># Redis日志</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 登录日志</span>
</span></span><span class=line><span class=cl>/var/log/wtmp                        <span class=c1># 登录历史（二进制）</span>
</span></span><span class=line><span class=cl>/var/log/btmp                        <span class=c1># 失败登录尝试（二进制）</span>
</span></span><span class=line><span class=cl>/var/log/lastlog                     <span class=c1># 最近登录（二进制）</span>
</span></span><span class=line><span class=cl>/var/log/utmp                        <span class=c1># 当前登录用户（二进制）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看工具</span>
</span></span><span class=line><span class=cl>last                                 <span class=c1># 读取wtmp</span>
</span></span><span class=line><span class=cl>lastb                                <span class=c1># 读取btmp</span>
</span></span><span class=line><span class=cl>lastlog                              <span class=c1># 读取lastlog</span>
</span></span><span class=line><span class=cl>who                                  <span class=c1># 读取utmp</span>
</span></span><span class=line><span class=cl>w                                    <span class=c1># 增强版who</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=822-syslog与rsyslog>8.2.2 syslog与rsyslog</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># rsyslog配置</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/rsyslog.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s># 模块加载
</span></span></span><span class=line><span class=cl><span class=s>$ModLoad imuxsock
</span></span></span><span class=line><span class=cl><span class=s>$ModLoad imjournal
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志级别
</span></span></span><span class=line><span class=cl><span class=s># emerg, alert, crit, err, warning, notice, info, debug
</span></span></span><span class=line><span class=cl><span class=s># 格式：facility.priority   action
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 内核日志
</span></span></span><span class=line><span class=cl><span class=s>kern.*                          /var/log/kern.log
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 邮件日志
</span></span></span><span class=line><span class=cl><span class=s>mail.*                          /var/log/maillog
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 认证日志
</span></span></span><span class=line><span class=cl><span class=s>authpriv.*                      /var/log/secure
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 计划任务
</span></span></span><span class=line><span class=cl><span class=s>cron.*                          /var/log/cron
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 本地应用
</span></span></span><span class=line><span class=cl><span class=s>local0.*                        /var/log/app1.log
</span></span></span><span class=line><span class=cl><span class=s>local1.*                        /var/log/app2.log
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 远程日志服务器
</span></span></span><span class=line><span class=cl><span class=s>*.* @192.168.200.100:514        # UDP
</span></span></span><span class=line><span class=cl><span class=s>*.* @@192.168.200.100:514       # TCP
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 模板
</span></span></span><span class=line><span class=cl><span class=s>$template CustomFormat,&#34;%timestamp% %hostname% %syslogtag%%msg%\n&#34;
</span></span></span><span class=line><span class=cl><span class=s>$ActionFileDefaultTemplate CustomFormat
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>systemctl restart rsyslog
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 日志级别测试</span>
</span></span><span class=line><span class=cl>logger -p local0.info <span class=s2>&#34;This is a test message&#34;</span>
</span></span><span class=line><span class=cl>tail -f /var/log/app1.log
</span></span></code></pre></td></tr></table></div></div><h4 id=823-journalctlsystemd日志>8.2.3 journalctl（systemd日志）</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 查看所有日志</span>
</span></span><span class=line><span class=cl>journalctl
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 实时跟踪</span>
</span></span><span class=line><span class=cl>journalctl -f
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按时间范围</span>
</span></span><span class=line><span class=cl>journalctl --since <span class=s2>&#34;2024-01-10 10:00:00&#34;</span>
</span></span><span class=line><span class=cl>journalctl --since <span class=s2>&#34;1 hour ago&#34;</span>
</span></span><span class=line><span class=cl>journalctl --until <span class=s2>&#34;2024-01-10 12:00:00&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按服务</span>
</span></span><span class=line><span class=cl>journalctl -u nginx.service
</span></span><span class=line><span class=cl>journalctl -u nginx.service --since today
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按优先级</span>
</span></span><span class=line><span class=cl>journalctl -p err               <span class=c1># 错误级别及以上</span>
</span></span><span class=line><span class=cl><span class=c1># 0: emerg, 1: alert, 2: crit, 3: err, 4: warning, 5: notice, 6: info, 7: debug</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按进程ID</span>
</span></span><span class=line><span class=cl>journalctl <span class=nv>_PID</span><span class=o>=</span><span class=m>12345</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 按用户</span>
</span></span><span class=line><span class=cl>journalctl <span class=nv>_UID</span><span class=o>=</span><span class=m>1000</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看占用空间</span>
</span></span><span class=line><span class=cl>journalctl --disk-usage
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 清理旧日志</span>
</span></span><span class=line><span class=cl>journalctl --vacuum-size<span class=o>=</span>100M   <span class=c1># 保留100MB</span>
</span></span><span class=line><span class=cl>journalctl --vacuum-time<span class=o>=</span>7d     <span class=c1># 保留7天</span>
</span></span><span class=line><span class=cl>journalctl --vacuum-files<span class=o>=</span><span class=m>5</span>     <span class=c1># 保留5个文件</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=83-故障排查方法论>8.3 故障排查方法论</h3><h4 id=831-故障排查步骤>8.3.1 故障排查步骤</h4><ol><li><strong>收集信息</strong>：症状、日志、监控数据、最近变更</li><li><strong>定位范围</strong>：网络/系统/应用/数据库</li><li><strong>分析原因</strong>：日志分析、进程跟踪、资源检查</li><li><strong>制定方案</strong>：临时解决+长期优化</li><li><strong>实施验证</strong>：测试验证，监控观察</li><li><strong>文档记录</strong>：记录过程，更新知识库</li></ol><h4 id=832-常见问题排查>8.3.2 常见问题排查</h4><p><strong>场景1：系统无法启动</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 进入救援模式</span>
</span></span><span class=line><span class=cl><span class=c1># 1. 使用安装盘启动，选择Troubleshooting → Rescue</span>
</span></span><span class=line><span class=cl><span class=c1># 2. 检查文件系统</span>
</span></span><span class=line><span class=cl>fsck -y /dev/sda1
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查/etc/fstab</span>
</span></span><span class=line><span class=cl>cat /mnt/sysimage/etc/fstab
</span></span><span class=line><span class=cl><span class=c1># 确认UUID、挂载点正确</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 检查GRUB</span>
</span></span><span class=line><span class=cl>chroot /mnt/sysimage
</span></span><span class=line><span class=cl>grub2-install /dev/sda
</span></span><span class=line><span class=cl>grub2-mkconfig -o /boot/grub2/grub.cfg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 检查SELinux</span>
</span></span><span class=line><span class=cl><span class=c1># 临时禁用</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;SELINUX=disabled&#34;</span> &gt; /mnt/sysimage/etc/selinux/config
</span></span><span class=line><span class=cl>touch /mnt/sysimage/.autorelabel
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 重启</span>
</span></span><span class=line><span class=cl><span class=nb>exit</span>
</span></span><span class=line><span class=cl>reboot
</span></span></code></pre></td></tr></table></div></div><p><strong>场景2：磁盘空间不足</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 检查空间</span>
</span></span><span class=line><span class=cl>df -h
</span></span><span class=line><span class=cl><span class=c1># 发现某分区使用率100%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 查找大文件</span>
</span></span><span class=line><span class=cl>du -sh /* 2&gt;/dev/null <span class=p>|</span> sort -rh <span class=p>|</span> head -10
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>ncdu /  <span class=c1># 交互式分析（需安装）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 清理日志</span>
</span></span><span class=line><span class=cl>journalctl --vacuum-size<span class=o>=</span>100M
</span></span><span class=line><span class=cl>&gt; /var/log/messages
</span></span><span class=line><span class=cl>logrotate -f /etc/logrotate.conf
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 清理临时文件</span>
</span></span><span class=line><span class=cl>find /tmp -type f -atime +7 -delete
</span></span><span class=line><span class=cl>find /var/tmp -type f -atime +30 -delete
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 清理包缓存</span>
</span></span><span class=line><span class=cl>yum clean all
</span></span><span class=line><span class=cl>apt-get clean
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 查找大文件</span>
</span></span><span class=line><span class=cl>find / -type f -size +100M -exec ls -lh <span class=o>{}</span> <span class=se>\;</span>
</span></span><span class=line><span class=cl><span class=c1># 检查是否为日志文件，可考虑压缩或删除</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>场景3：内存不足（OOM）</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查看内存</span>
</span></span><span class=line><span class=cl>free -h
</span></span><span class=line><span class=cl>vmstat <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 查看进程内存</span>
</span></span><span class=line><span class=cl>ps aux --sort<span class=o>=</span>-%mem <span class=p>|</span> head
</span></span><span class=line><span class=cl><span class=c1># 或使用smem</span>
</span></span><span class=line><span class=cl>smem
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查OOM Killer日志</span>
</span></span><span class=line><span class=cl>dmesg <span class=p>|</span> grep -i <span class=s2>&#34;oom-killer&#34;</span>
</span></span><span class=line><span class=cl>journalctl -k <span class=p>|</span> grep -i <span class=s2>&#34;oom&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 调整OOM分数</span>
</span></span><span class=line><span class=cl><span class=c1># OOM优先级：-1000到1000，值越高越容易被杀</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> -500 &gt; /proc/<span class=nv>$PID</span>/oom_score_adj  <span class=c1># 保护关键进程</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 释放内存</span>
</span></span><span class=line><span class=cl>sync
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=m>3</span> &gt; /proc/sys/vm/drop_caches
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 扩展swap（应急）</span>
</span></span><span class=line><span class=cl>dd <span class=k>if</span><span class=o>=</span>/dev/zero <span class=nv>of</span><span class=o>=</span>/swapfile <span class=nv>bs</span><span class=o>=</span>1G <span class=nv>count</span><span class=o>=</span><span class=m>4</span>
</span></span><span class=line><span class=cl>chmod <span class=m>600</span> /swapfile
</span></span><span class=line><span class=cl>mkswap /swapfile
</span></span><span class=line><span class=cl>swapon /swapfile
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/swapfile swap swap defaults 0 0&#34;</span> &gt;&gt; /etc/fstab
</span></span></code></pre></td></tr></table></div></div><p><strong>场景4：网络不通</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 检查物理链路</span>
</span></span><span class=line><span class=cl>ip link show                   <span class=c1># 查看接口状态</span>
</span></span><span class=line><span class=cl>ethtool eth0                   <span class=c1># 查看网卡状态</span>
</span></span><span class=line><span class=cl>mii-tool eth0                  <span class=c1># 快速检查</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 检查IP配置</span>
</span></span><span class=line><span class=cl>ip addr show
</span></span><span class=line><span class=cl>route -n
</span></span><span class=line><span class=cl><span class=c1># 确认IP、网关、子网掩码正确</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查连通性</span>
</span></span><span class=line><span class=cl>ping 127.0.0.1                 <span class=c1># 本地回环</span>
</span></span><span class=line><span class=cl>ping 192.168.200.1             <span class=c1># 网关</span>
</span></span><span class=line><span class=cl>ping 8.8.8.8                   <span class=c1># 外网</span>
</span></span><span class=line><span class=cl>ping www.baidu.com             <span class=c1># DNS</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 检查DNS</span>
</span></span><span class=line><span class=cl>cat /etc/resolv.conf
</span></span><span class=line><span class=cl>nslookup www.baidu.com
</span></span><span class=line><span class=cl>dig www.baidu.com
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 检查防火墙</span>
</span></span><span class=line><span class=cl>iptables -L -n
</span></span><span class=line><span class=cl>firewall-cmd --list-all
</span></span><span class=line><span class=cl><span class=c1># 临时禁用测试</span>
</span></span><span class=line><span class=cl>systemctl stop firewalld
</span></span><span class=line><span class=cl>iptables -F
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 检查路由</span>
</span></span><span class=line><span class=cl>traceroute www.baidu.com
</span></span><span class=line><span class=cl>mtr www.baidu.com              <span class=c1># 更强大的traceroute</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 检查端口监听</span>
</span></span><span class=line><span class=cl>ss -tuln
</span></span><span class=line><span class=cl>netstat -tuln
</span></span><span class=line><span class=cl><span class=c1># 确认服务监听在正确地址</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>场景5：CPU使用率100%</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 查看CPU占用</span>
</span></span><span class=line><span class=cl>top
</span></span><span class=line><span class=cl><span class=c1># 按P按CPU排序</span>
</span></span><span class=line><span class=cl><span class=c1># 按H查看线程</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 查看进程详情</span>
</span></span><span class=line><span class=cl>pidstat <span class=m>1</span> -p &lt;PID&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 生成火焰图（高级）</span>
</span></span><span class=line><span class=cl><span class=c1># 安装perf</span>
</span></span><span class=line><span class=cl>perf record -ag -- sleep <span class=m>30</span>
</span></span><span class=line><span class=cl>perf script <span class=p>|</span> flamegraph.pl &gt; cpu.svg
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 查看系统调用</span>
</span></span><span class=line><span class=cl>strace -p &lt;PID&gt; -c              <span class=c1># 统计系统调用</span>
</span></span><span class=line><span class=cl>strace -p &lt;PID&gt; -o trace.log    <span class=c1># 详细日志</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. GDB调试</span>
</span></span><span class=line><span class=cl>gdb -p &lt;PID&gt;
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> thread apply all bt       <span class=c1># 查看所有线程堆栈</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 查看Java进程</span>
</span></span><span class=line><span class=cl>jstack &lt;PID&gt; &gt; jstack.log
</span></span><span class=line><span class=cl>jvisualvm                       <span class=c1># GUI工具</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=84-核心转储分析>8.4 核心转储分析</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 启用core dump</span>
</span></span><span class=line><span class=cl><span class=nb>ulimit</span> -c unlimited
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;/corefiles/core-%e-%p-%t&#34;</span> &gt; /proc/sys/kernel/core_pattern
</span></span><span class=line><span class=cl>mkdir /corefiles <span class=o>&amp;&amp;</span> chmod <span class=m>777</span> /corefiles
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 程序崩溃后生成core文件</span>
</span></span><span class=line><span class=cl><span class=c1># 使用gdb分析</span>
</span></span><span class=line><span class=cl>gdb /path/to/program /corefiles/core-program-12345-1673423401
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. gdb常用命令</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> bt                      <span class=c1># 查看堆栈</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> info threads            <span class=c1># 查看线程</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> thread <span class=m>2</span>                <span class=c1># 切换到线程2</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> bt                      <span class=c1># 查看该线程堆栈</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> frame <span class=m>3</span>                 <span class=c1># 切换到第3帧</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> list                    <span class=c1># 查看代码</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> print var               <span class=c1># 打印变量</span>
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> info registers          <span class=c1># 查看寄存器</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 分析内存泄漏</span>
</span></span><span class=line><span class=cl>valgrind --leak-check<span class=o>=</span>full ./program
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>valgrind --tool<span class=o>=</span>memcheck --leak-check<span class=o>=</span>yes ./program
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=九shell脚本编程>九、Shell脚本编程</h2><h3 id=91-脚本基础与执行方式>9.1 脚本基础与执行方式</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 标准脚本格式（shebang）</span>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=c1># Description: Backup script</span>
</span></span><span class=line><span class=cl><span class=c1># Author: Admin</span>
</span></span><span class=line><span class=cl><span class=c1># Date: 2024-01-15</span>
</span></span><span class=line><span class=cl><span class=c1># Version: 1.0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 执行方式对比</span>
</span></span><span class=line><span class=cl><span class=c1># 方式1：添加执行权限</span>
</span></span><span class=line><span class=cl>chmod +x script.sh
</span></span><span class=line><span class=cl>./script.sh                <span class=c1># 相对路径</span>
</span></span><span class=line><span class=cl>/path/to/script.sh         <span class=c1># 绝对路径</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式2：解释器执行（无需执行权限）</span>
</span></span><span class=line><span class=cl>bash script.sh
</span></span><span class=line><span class=cl>sh script.sh
</span></span><span class=line><span class=cl><span class=nb>source</span> script.sh           <span class=c1># 在当前shell执行（影响环境变量）</span>
</span></span><span class=line><span class=cl>. script.sh                <span class=c1># 同source</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 区别：</span>
</span></span><span class=line><span class=cl><span class=c1># ./script.sh 或 bash script.sh：子shell执行，不影响当前环境</span>
</span></span><span class=line><span class=cl><span class=c1># source 或 .：当前shell执行，影响当前环境</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 脚本调试</span>
</span></span><span class=line><span class=cl>bash -x script.sh          <span class=c1># 显示执行过程</span>
</span></span><span class=line><span class=cl>bash -n script.sh          <span class=c1># 检查语法错误</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -x                     <span class=c1># 脚本内开启调试</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> +x                     <span class=c1># 关闭调试</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=92-重定向与管道>9.2 重定向与管道</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 重定向</span>
</span></span><span class=line><span class=cl><span class=c1># 标准输出重定向（1为stdout）</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;hello&#34;</span> &gt; file.txt    <span class=c1># 覆盖</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;world&#34;</span> &gt;&gt; file.txt   <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 标准错误重定向（2为stderr）</span>
</span></span><span class=line><span class=cl><span class=nb>command</span> 2&gt; error.log       <span class=c1># 错误重定向</span>
</span></span><span class=line><span class=cl><span class=nb>command</span> &gt; out.log 2&gt;<span class=p>&amp;</span><span class=m>1</span>     <span class=c1># 标准输出和错误都重定向（推荐）</span>
</span></span><span class=line><span class=cl><span class=nb>command</span> <span class=p>&amp;</span>&gt; all.log         <span class=c1># Bash 4+ 简写</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 输入重定向</span>
</span></span><span class=line><span class=cl>mysql -u root -p<span class=s1>&#39;pass&#39;</span> &lt; backup.sql
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl>mysql -u root -p<span class=s1>&#39;pass&#39;</span> -e <span class=s2>&#34;source backup.sql&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 多行输入</span>
</span></span><span class=line><span class=cl>cat &gt; config.conf <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Section]
</span></span></span><span class=line><span class=cl><span class=s>key1=value1
</span></span></span><span class=line><span class=cl><span class=s>key2=value2
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Here Document（忽略变量替换）</span>
</span></span><span class=line><span class=cl>cat &gt; config.conf <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>PATH=$HOME/bin:$PATH
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Here String</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;error&#34;</span> <span class=o>&lt;&lt;&lt;</span> <span class=s2>&#34;This is an error message&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 管道</span>
</span></span><span class=line><span class=cl>ps aux <span class=p>|</span> grep nginx
</span></span><span class=line><span class=cl>cat file.txt <span class=p>|</span> sort <span class=p>|</span> uniq -c <span class=p>|</span> sort -nr
</span></span><span class=line><span class=cl>df -h <span class=p>|</span> awk <span class=s1>&#39;{print $4}&#39;</span> <span class=p>|</span> tail -n +2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 管道与重定向组合</span>
</span></span><span class=line><span class=cl>ps aux <span class=p>|</span> tee processes.txt <span class=p>|</span> grep ssh
</span></span><span class=line><span class=cl><span class=c1># tee：同时输出到屏幕和文件</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=93-变量与数据类型>9.3 变量与数据类型</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 变量定义（无类型）</span>
</span></span><span class=line><span class=cl><span class=nv>name</span><span class=o>=</span><span class=s2>&#34;John&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>age</span><span class=o>=</span><span class=m>25</span>
</span></span><span class=line><span class=cl><span class=nv>pi</span><span class=o>=</span>3.14
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 注意：等号两边不能有空格</span>
</span></span><span class=line><span class=cl><span class=c1># name = &#34;John&#34;  # 错误</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 变量引用</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$name</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>name</span><span class=si>}</span>      <span class=c1># 推荐，避免歧义</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;My name is </span><span class=nv>$name</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;My name is $name&#39;</span>  <span class=c1># 单引号不解析变量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 只读变量</span>
</span></span><span class=line><span class=cl><span class=nb>readonly</span> <span class=nv>PI</span><span class=o>=</span>3.14159
</span></span><span class=line><span class=cl><span class=nv>PI</span><span class=o>=</span>3.1416         <span class=c1># 报错：readonly variable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 删除变量</span>
</span></span><span class=line><span class=cl><span class=nb>unset</span> name
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 特殊变量</span>
</span></span><span class=line><span class=cl><span class=nv>$0</span>                <span class=c1># 脚本名称</span>
</span></span><span class=line><span class=cl><span class=nv>$1</span>-<span class=nv>$9</span>             <span class=c1># 位置参数</span>
</span></span><span class=line><span class=cl><span class=nv>$#</span>                <span class=c1># 参数个数</span>
</span></span><span class=line><span class=cl><span class=nv>$*</span>                <span class=c1># 所有参数（整体）</span>
</span></span><span class=line><span class=cl><span class=nv>$@</span>                <span class=c1># 所有参数（个体）</span>
</span></span><span class=line><span class=cl><span class=nv>$$</span>                <span class=c1># 当前进程PID</span>
</span></span><span class=line><span class=cl><span class=nv>$?</span>                <span class=c1># 上条命令退出状态（0成功）</span>
</span></span><span class=line><span class=cl><span class=nv>$!</span>                <span class=c1># 最后一个后台进程PID</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 6. 环境变量</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>PATH</span><span class=o>=</span><span class=s2>&#34;/usr/local/bin:</span><span class=nv>$PATH</span><span class=s2>&#34;</span>  <span class=c1># 设置环境变量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 7. 内置变量</span>
</span></span><span class=line><span class=cl><span class=nv>$HOME</span>             <span class=c1># 用户家目录</span>
</span></span><span class=line><span class=cl><span class=nv>$PWD</span>              <span class=c1># 当前目录</span>
</span></span><span class=line><span class=cl><span class=nv>$OLDPWD</span>           <span class=c1># 上一个目录</span>
</span></span><span class=line><span class=cl><span class=nv>$UID</span>               <span class=c1># 用户ID</span>
</span></span><span class=line><span class=cl><span class=nv>$SHELL</span>            <span class=c1># 当前Shell</span>
</span></span><span class=line><span class=cl><span class=nv>$RANDOM</span>           <span class=c1># 随机数（0-32767）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 8. 数值运算</span>
</span></span><span class=line><span class=cl><span class=c1># 方式1：expr（旧方式）</span>
</span></span><span class=line><span class=cl><span class=nv>a</span><span class=o>=</span><span class=m>10</span>
</span></span><span class=line><span class=cl><span class=nv>b</span><span class=o>=</span><span class=m>20</span>
</span></span><span class=line><span class=cl><span class=nv>c</span><span class=o>=</span><span class=k>$(</span>expr <span class=nv>$a</span> + <span class=nv>$b</span><span class=k>)</span>  <span class=c1># 注意空格</span>
</span></span><span class=line><span class=cl><span class=c1># 支持：+ - * / %</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式2：$(( ))（推荐）</span>
</span></span><span class=line><span class=cl><span class=nv>c</span><span class=o>=</span><span class=k>$((</span>a <span class=o>+</span> b<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>c</span><span class=o>=</span><span class=k>$((</span>a <span class=o>*</span> b<span class=k>))</span>
</span></span><span class=line><span class=cl><span class=nv>c</span><span class=o>=</span><span class=k>$((</span>a <span class=o>/</span> b<span class=k>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式3：let</span>
</span></span><span class=line><span class=cl><span class=nb>let</span> <span class=nv>c</span><span class=o>=</span>a+b
</span></span><span class=line><span class=cl><span class=nb>let</span> a++           <span class=c1># 自增</span>
</span></span><span class=line><span class=cl><span class=nb>let</span> a--           <span class=c1># 自减</span>
</span></span><span class=line><span class=cl><span class=nb>let</span> <span class=nv>a</span><span class=o>+=</span><span class=m>10</span>         <span class=c1># 复合赋值</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 方式4：bc（浮点运算）</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;scale=2; 10/3&#34;</span> <span class=p>|</span> bc   <span class=c1># 3.33</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=94-流程控制>9.4 流程控制</h3><h4 id=941-条件判断>9.4.1 条件判断</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># if语句格式</span>
</span></span><span class=line><span class=cl><span class=k>if</span> condition<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    commands
</span></span><span class=line><span class=cl><span class=k>elif</span> condition2<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    commands
</span></span><span class=line><span class=cl><span class=k>else</span>
</span></span><span class=line><span class=cl>    commands
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 条件测试（[ ]是test的别名）</span>
</span></span><span class=line><span class=cl><span class=c1># 文件测试</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -f file.txt <span class=o>]</span>      <span class=c1># 文件存在且为普通文件</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -d /path <span class=o>]</span>         <span class=c1># 目录存在</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -e file <span class=o>]</span>          <span class=c1># 文件/目录存在</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -r file <span class=o>]</span>          <span class=c1># 可读</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -w file <span class=o>]</span>          <span class=c1># 可写</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -x file <span class=o>]</span>          <span class=c1># 可执行</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -s file <span class=o>]</span>          <span class=c1># 文件大小大于0</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -L link <span class=o>]</span>          <span class=c1># 是符号链接</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 字符串比较</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -z <span class=s2>&#34;</span><span class=nv>$str</span><span class=s2>&#34;</span> <span class=o>]</span>        <span class=c1># 字符串为空</span>
</span></span><span class=line><span class=cl><span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$str</span><span class=s2>&#34;</span> <span class=o>]</span>        <span class=c1># 字符串非空</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$str1</span><span class=s2>&#34;</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=nv>$str2</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=c1># 相等</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$str1</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;</span><span class=nv>$str2</span><span class=s2>&#34;</span> <span class=o>]</span><span class=c1># 不等</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$str1</span><span class=s2>&#34;</span> &lt; <span class=s2>&#34;</span><span class=nv>$str2</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=c1># 字典序小于（需转义：\&lt;）</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$str1</span><span class=s2>&#34;</span> &gt; <span class=s2>&#34;</span><span class=nv>$str2</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=c1># 字典序大于</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 数值比较</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$a</span> -eq <span class=nv>$b</span> <span class=o>]</span>        <span class=c1># 等于</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$a</span> -ne <span class=nv>$b</span> <span class=o>]</span>        <span class=c1># 不等于</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$a</span> -gt <span class=nv>$b</span> <span class=o>]</span>        <span class=c1># 大于</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$a</span> -ge <span class=nv>$b</span> <span class=o>]</span>        <span class=c1># 大于等于</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$a</span> -lt <span class=nv>$b</span> <span class=o>]</span>        <span class=c1># 小于</span>
</span></span><span class=line><span class=cl><span class=o>[</span> <span class=nv>$a</span> -le <span class=nv>$b</span> <span class=o>]</span>        <span class=c1># 小于等于</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逻辑运算</span>
</span></span><span class=line><span class=cl><span class=o>[</span> condition1 -a condition2 <span class=o>]</span>  <span class=c1># 与（and）</span>
</span></span><span class=line><span class=cl><span class=o>[</span> condition1 -o condition2 <span class=o>]</span>  <span class=c1># 或（or）</span>
</span></span><span class=line><span class=cl>! <span class=o>[</span> condition <span class=o>]</span>               <span class=c1># 非（not）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 复合条件</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> -f file.txt <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=o>[</span> -r file.txt <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;File exists and readable&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例：检查磁盘空间</span>
</span></span><span class=line><span class=cl><span class=nv>DISK_USAGE</span><span class=o>=</span><span class=k>$(</span>df / <span class=p>|</span> tail -1 <span class=p>|</span> awk <span class=s1>&#39;{print $5}&#39;</span> <span class=p>|</span> tr -d <span class=s1>&#39;%&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$DISK_USAGE</span> -gt <span class=m>80</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Warning: Disk usage is </span><span class=si>${</span><span class=nv>DISK_USAGE</span><span class=si>}</span><span class=s2>%&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 发送告警</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=942-循环语句>9.4.2 循环语句</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># for循环（常用）</span>
</span></span><span class=line><span class=cl><span class=c1># 格式1：遍历列表</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span> 5<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 格式2：遍历范围</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=o>{</span>1..10<span class=o>}</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 格式3：C语言风格</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=o>((</span><span class=nv>i</span><span class=o>=</span>1<span class=p>;</span> i&lt;<span class=o>=</span>10<span class=p>;</span> i++<span class=o>))</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 格式4：遍历数组</span>
</span></span><span class=line><span class=cl><span class=nv>arr</span><span class=o>=(</span>apple banana cherry<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> fruit in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>arr</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$fruit</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># while循环</span>
</span></span><span class=line><span class=cl><span class=nv>count</span><span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=o>[</span> <span class=nv>$count</span> -le <span class=m>5</span> <span class=o>]</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$count</span>
</span></span><span class=line><span class=cl>    <span class=o>((</span>count++<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 读取文件</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=nb>read</span> line<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$line</span>
</span></span><span class=line><span class=cl><span class=k>done</span> &lt; file.txt
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># until循环（条件为假时执行）</span>
</span></span><span class=line><span class=cl><span class=k>until</span> <span class=o>[</span> <span class=nv>$count</span> -gt <span class=m>5</span> <span class=o>]</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$count</span>
</span></span><span class=line><span class=cl>    <span class=o>((</span>count++<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># select菜单</span>
</span></span><span class=line><span class=cl><span class=nv>PS3</span><span class=o>=</span><span class=s2>&#34;Please select: &#34;</span>
</span></span><span class=line><span class=cl><span class=k>select</span> opt in <span class=s2>&#34;Option 1&#34;</span> <span class=s2>&#34;Option 2&#34;</span> <span class=s2>&#34;Quit&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=nv>$opt</span> in
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Option 1&#34;</span><span class=o>)</span> <span class=nb>echo</span> <span class=s2>&#34;You selected 1&#34;</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Option 2&#34;</span><span class=o>)</span> <span class=nb>echo</span> <span class=s2>&#34;You selected 2&#34;</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;Quit&#34;</span><span class=o>)</span> <span class=nb>break</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>        *<span class=o>)</span> <span class=nb>echo</span> <span class=s2>&#34;Invalid option&#34;</span> <span class=p>;;</span>
</span></span><span class=line><span class=cl>    <span class=k>esac</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=943-case分支>9.4.3 case分支</h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=k>case</span> <span class=nv>$variable</span> in
</span></span><span class=line><span class=cl>    pattern1<span class=o>)</span>
</span></span><span class=line><span class=cl>        commands <span class=p>;;</span>
</span></span><span class=line><span class=cl>    pattern2<span class=p>|</span>pattern3<span class=o>)</span>
</span></span><span class=line><span class=cl>        commands <span class=p>;;</span>
</span></span><span class=line><span class=cl>    *<span class=o>)</span>
</span></span><span class=line><span class=cl>        default_commands <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例：服务管理脚本</span>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>    start<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Starting service...&#34;</span>
</span></span><span class=line><span class=cl>        /usr/local/bin/service start
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    stop<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Stopping service...&#34;</span>
</span></span><span class=line><span class=cl>        /usr/local/bin/service stop
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    restart<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nv>$0</span> stop
</span></span><span class=line><span class=cl>        sleep <span class=m>2</span>
</span></span><span class=line><span class=cl>        <span class=nv>$0</span> start
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    status<span class=o>)</span>
</span></span><span class=line><span class=cl>        /usr/local/bin/service status
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    *<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> {start|stop|restart|status}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=95-函数定义>9.5 函数定义</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 函数格式</span>
</span></span><span class=line><span class=cl>function_name<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    commands
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl><span class=k>function</span> function_name <span class=o>{</span>
</span></span><span class=line><span class=cl>    commands
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例</span>
</span></span><span class=line><span class=cl>greet<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Hello, </span><span class=nv>$1</span><span class=s2>!&#34;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 调用</span>
</span></span><span class=line><span class=cl>greet <span class=s2>&#34;World&#34;</span>  <span class=c1># 输出：Hello, World!</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 返回值（0-255）</span>
</span></span><span class=line><span class=cl>check_file<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>0</span>  <span class=c1># 成功</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>  <span class=c1># 失败</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>check_file <span class=s2>&#34;/etc/passwd&#34;</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=nv>$?</span> -eq <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;File exists&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 返回字符串（使用echo）</span>
</span></span><span class=line><span class=cl>get_date<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=k>$(</span>date +%Y-%m-%d<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>today</span><span class=o>=</span><span class=k>$(</span>get_date<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$today</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 局部变量</span>
</span></span><span class=line><span class=cl>func<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>local</span> <span class=nv>local_var</span><span class=o>=</span><span class=s2>&#34;only in function&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$local_var</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>func
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=nv>$local_var</span>  <span class=c1># 为空</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=96-数组操作>9.6 数组操作</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 数组定义</span>
</span></span><span class=line><span class=cl><span class=nv>arr1</span><span class=o>=(</span><span class=m>1</span> <span class=m>2</span> <span class=m>3</span> <span class=m>4</span> 5<span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>arr2</span><span class=o>=(</span><span class=s2>&#34;apple&#34;</span> <span class=s2>&#34;banana&#34;</span> <span class=s2>&#34;cherry&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nv>arr3</span><span class=o>=([</span>0<span class=o>]=</span><span class=s2>&#34;first&#34;</span> <span class=o>[</span>2<span class=o>]=</span><span class=s2>&#34;third&#34;</span> <span class=o>[</span>5<span class=o>]=</span><span class=s2>&#34;sixth&#34;</span><span class=o>)</span>  <span class=c1># 稀疏数组</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 访问元素</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>arr1</span><span class=p>[0]</span><span class=si>}</span>        <span class=c1># 第一个元素</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>arr1</span><span class=p>[-1]</span><span class=si>}</span>       <span class=c1># 最后一个元素</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取长度</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${#</span><span class=nv>arr1</span><span class=p>[@]</span><span class=si>}</span>       <span class=c1># 元素个数</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${#</span><span class=nv>arr1</span><span class=p>[*]</span><span class=si>}</span>       <span class=c1># 同上</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 获取所有元素</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>arr1</span><span class=p>[@]</span><span class=si>}</span>        <span class=c1># 每个元素作为独立字符串</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>arr1</span><span class=p>[*]</span><span class=si>}</span>        <span class=c1># 所有元素作为单个字符串</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 遍历数组</span>
</span></span><span class=line><span class=cl><span class=k>for</span> i in <span class=s2>&#34;</span><span class=si>${</span><span class=nv>arr2</span><span class=p>[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$i</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 添加元素</span>
</span></span><span class=line><span class=cl><span class=nv>arr1</span><span class=o>+=(</span><span class=m>6</span> <span class=m>7</span> 8<span class=o>)</span>          <span class=c1># 追加</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 删除元素</span>
</span></span><span class=line><span class=cl><span class=nb>unset</span> arr1<span class=o>[</span>2<span class=o>]</span>          <span class=c1># 删除索引2的元素</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 切片</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>arr1</span><span class=p>[@]:</span><span class=nv>1</span><span class=p>:</span><span class=nv>3</span><span class=si>}</span>    <span class=c1># 从索引1开始，取3个元素</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 关联数组（类似Map，Bash 4+）</span>
</span></span><span class=line><span class=cl><span class=nb>declare</span> -A assoc_arr
</span></span><span class=line><span class=cl>assoc_arr<span class=o>[</span>name<span class=o>]=</span><span class=s2>&#34;John&#34;</span>
</span></span><span class=line><span class=cl>assoc_arr<span class=o>[</span>age<span class=o>]=</span><span class=m>25</span>
</span></span><span class=line><span class=cl>assoc_arr<span class=o>[</span>city<span class=o>]=</span><span class=s2>&#34;Beijing&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>assoc_arr</span><span class=p>[name]</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>for</span> key in <span class=s2>&#34;</span><span class=si>${</span><span class=p>!assoc_arr[@]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$key</span><span class=s2>: </span><span class=si>${</span><span class=nv>assoc_arr</span><span class=p>[</span><span class=nv>$key</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=97-正则表达式>9.7 正则表达式</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 基础正则（BRE）</span>
</span></span><span class=line><span class=cl><span class=c1># . 任意单个字符</span>
</span></span><span class=line><span class=cl><span class=c1># * 前面字符0次或多次</span>
</span></span><span class=line><span class=cl><span class=c1># ^ 行首</span>
</span></span><span class=line><span class=cl><span class=c1># $ 行尾</span>
</span></span><span class=line><span class=cl><span class=c1># [abc] 字符集</span>
</span></span><span class=line><span class=cl><span class=c1># [^abc] 取反</span>
</span></span><span class=line><span class=cl><span class=c1># \{n,m\} 重复n到m次</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 扩展正则（ERE，grep -E或egrep）</span>
</span></span><span class=line><span class=cl><span class=c1># + 前面字符1次或多次</span>
</span></span><span class=line><span class=cl><span class=c1># ? 前面字符0次或1次</span>
</span></span><span class=line><span class=cl><span class=c1># | 或</span>
</span></span><span class=line><span class=cl><span class=c1># () 分组</span>
</span></span><span class=line><span class=cl><span class=c1># {} 重复</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;error&#34;</span> log.txt               <span class=c1># 简单匹配</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;^192.168&#34;</span> access.log         <span class=c1># 匹配行首</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;200</span>$<span class=s2>&#34;</span> access.log             <span class=c1># 匹配行尾</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;ab\{2,4\}&#34;</span> file.txt           <span class=c1># 匹配abbb或abbbb</span>
</span></span><span class=line><span class=cl>egrep <span class=s2>&#34;error|fail&#34;</span> log.txt          <span class=c1># 匹配error或fail</span>
</span></span><span class=line><span class=cl>egrep <span class=s2>&#34;(ab)+&#34;</span> file.txt              <span class=c1># 匹配ab, abab, ababab...</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 在变量中匹配</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=nv>$email</span> <span class=o>=</span>~ ^<span class=o>[</span>a-zA-Z0-9._%+-<span class=o>]</span>+@<span class=o>[</span>a-zA-Z0-9.-<span class=o>]</span>+<span class=se>\.</span><span class=o>[</span>a-zA-Z<span class=o>]{</span>2,4<span class=o>}</span>$ <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Valid email&#34;</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 替换</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>var</span><span class=p>/old/new</span><span class=si>}</span>                     <span class=c1># 替换第一个</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>var</span><span class=p>//old/new</span><span class=si>}</span>                    <span class=c1># 替换全部</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>var</span><span class=p>/#old/new</span><span class=si>}</span>                    <span class=c1># 替换行首</span>
</span></span><span class=line><span class=cl><span class=si>${</span><span class=nv>var</span><span class=p>/%old/new</span><span class=si>}</span>                    <span class=c1># 替换行尾</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 示例</span>
</span></span><span class=line><span class=cl><span class=nv>filename</span><span class=o>=</span><span class=s2>&#34;file.txt.txt&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>filename</span><span class=p>/.txt/.log</span><span class=si>}</span>         <span class=c1># file.log.txt</span>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=si>${</span><span class=nv>filename</span><span class=p>//.txt/.log</span><span class=si>}</span>        <span class=c1># file.log.log</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=98-错误处理与调试>9.8 错误处理与调试</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 错误处理</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -e                           <span class=c1># 遇到错误立即退出</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -u                           <span class=c1># 使用未定义变量时报错</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -o pipefail                  <span class=c1># 管道中任意命令失败则整体失败</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -x                           <span class=c1># 显示执行命令</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 组合使用</span>
</span></span><span class=line><span class=cl><span class=c1>#!/bin/bash</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -euo pipefail
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 自定义错误处理</span>
</span></span><span class=line><span class=cl><span class=nb>trap</span> <span class=s1>&#39;echo &#34;Error at line $LINENO&#34;&#39;</span> ERR
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 检查命令是否存在</span>
</span></span><span class=line><span class=cl><span class=nb>command</span> -v nginx <span class=p>&amp;</span>&gt;/dev/null <span class=o>||</span> <span class=o>{</span> <span class=nb>echo</span> <span class=s2>&#34;nginx not found&#34;</span><span class=p>;</span> <span class=nb>exit</span> 1<span class=p>;</span> <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 日志记录</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> &gt; &gt;<span class=o>(</span>tee -a /var/log/myscript.log<span class=o>)</span>  <span class=c1># 标准输出重定向</span>
</span></span><span class=line><span class=cl><span class=nb>exec</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span>                              <span class=c1># 标准错误重定向到标准输出</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 返回值检查</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! command<span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Command failed&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 或</span>
</span></span><span class=line><span class=cl><span class=nb>command</span> <span class=o>||</span> <span class=o>{</span> <span class=nb>echo</span> <span class=s2>&#34;Failed&#34;</span><span class=p>;</span> <span class=nb>exit</span> 1<span class=p>;</span> <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=十系统服务脚本编写>十、系统服务脚本编写</h2><h3 id=101-systemd服务单元>10.1 Systemd服务单元</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 示例：自定义应用服务</span>
</span></span><span class=line><span class=cl>cat &gt; /etc/systemd/system/myapp.service <span class=s>&lt;&lt;EOF
</span></span></span><span class=line><span class=cl><span class=s>[Unit]
</span></span></span><span class=line><span class=cl><span class=s>Description=My Application Service
</span></span></span><span class=line><span class=cl><span class=s>After=network.target mysql.service redis.service
</span></span></span><span class=line><span class=cl><span class=s>Wants=mysql.service redis.service
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Service]
</span></span></span><span class=line><span class=cl><span class=s>Type=forking
</span></span></span><span class=line><span class=cl><span class=s>User=appuser
</span></span></span><span class=line><span class=cl><span class=s>Group=appgroup
</span></span></span><span class=line><span class=cl><span class=s>WorkingDirectory=/opt/myapp
</span></span></span><span class=line><span class=cl><span class=s>PIDFile=/run/myapp.pid
</span></span></span><span class=line><span class=cl><span class=s>ExecStartPre=/opt/myapp/bin/check_config.sh
</span></span></span><span class=line><span class=cl><span class=s>ExecStart=/opt/myapp/bin/start.sh
</span></span></span><span class=line><span class=cl><span class=s>ExecReload=/bin/kill -s HUP \$MAINPID
</span></span></span><span class=line><span class=cl><span class=s>ExecStop=/bin/kill -s TERM \$MAINPID
</span></span></span><span class=line><span class=cl><span class=s>TimeoutStartSec=30
</span></span></span><span class=line><span class=cl><span class=s>TimeoutStopSec=30
</span></span></span><span class=line><span class=cl><span class=s>Restart=on-failure
</span></span></span><span class=line><span class=cl><span class=s>RestartSec=10
</span></span></span><span class=line><span class=cl><span class=s>LimitNOFILE=65536
</span></span></span><span class=line><span class=cl><span class=s>Environment=&#34;PATH=/usr/local/bin:/usr/bin:/bin&#34;
</span></span></span><span class=line><span class=cl><span class=s>Environment=&#34;APP_ENV=production&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 日志配置
</span></span></span><span class=line><span class=cl><span class=s>StandardOutput=journal
</span></span></span><span class=line><span class=cl><span class=s>StandardError=journal
</span></span></span><span class=line><span class=cl><span class=s>SyslogIdentifier=myapp
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s>[Install]
</span></span></span><span class=line><span class=cl><span class=s>WantedBy=multi-user.target
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 服务管理命令</span>
</span></span><span class=line><span class=cl>systemctl daemon-reload
</span></span><span class=line><span class=cl>systemctl start myapp
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> myapp
</span></span><span class=line><span class=cl>systemctl status myapp
</span></span><span class=line><span class=cl>systemctl stop myapp
</span></span><span class=line><span class=cl>systemctl restart myapp
</span></span><span class=line><span class=cl>systemctl reload myapp
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看服务日志</span>
</span></span><span class=line><span class=cl>journalctl -u myapp -f
</span></span><span class=line><span class=cl>journalctl -u myapp --since <span class=s2>&#34;1 hour ago&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 查看服务依赖</span>
</span></span><span class=line><span class=cl>systemctl list-dependencies myapp
</span></span></code></pre></td></tr></table></div></div><h3 id=102-传统sysvinit脚本兼容>10.2 传统SysVinit脚本（兼容）</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=c1># chkconfig: 2345 85 15</span>
</span></span><span class=line><span class=cl><span class=c1># description: My Application Service</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Source function library</span>
</span></span><span class=line><span class=cl>. /etc/rc.d/init.d/functions
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>APP_NAME</span><span class=o>=</span><span class=s2>&#34;myapp&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>APP_BIN</span><span class=o>=</span><span class=s2>&#34;/opt/myapp/bin/start.sh&#34;</span>
</span></span><span class=line><span class=cl><span class=nv>APP_PID</span><span class=o>=</span><span class=s2>&#34;/run/myapp.pid&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>start<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -n <span class=s2>&#34;Starting </span><span class=nv>$APP_NAME</span><span class=s2>: &#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=nv>$APP_PID</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Already running&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl>    daemon <span class=nv>$APP_BIN</span>
</span></span><span class=line><span class=cl>    <span class=nv>RETVAL</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> <span class=nv>$RETVAL</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> touch /var/lock/subsys/<span class=nv>$APP_NAME</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$RETVAL</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>stop<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> -n <span class=s2>&#34;Stopping </span><span class=nv>$APP_NAME</span><span class=s2>: &#34;</span>
</span></span><span class=line><span class=cl>    killproc <span class=nv>$APP_NAME</span>
</span></span><span class=line><span class=cl>    <span class=nv>RETVAL</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span>
</span></span><span class=line><span class=cl>    <span class=o>[</span> <span class=nv>$RETVAL</span> -eq <span class=m>0</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> rm -f /var/lock/subsys/<span class=nv>$APP_NAME</span> <span class=nv>$APP_PID</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nv>$RETVAL</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>restart<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    stop
</span></span><span class=line><span class=cl>    sleep <span class=m>2</span>
</span></span><span class=line><span class=cl>    start
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=cl>    start<span class=o>)</span>
</span></span><span class=line><span class=cl>        start
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    stop<span class=o>)</span>
</span></span><span class=line><span class=cl>        stop
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    restart<span class=o>)</span>
</span></span><span class=line><span class=cl>        restart
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    status<span class=o>)</span>
</span></span><span class=line><span class=cl>        status <span class=nv>$APP_NAME</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl>    *<span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> {start|stop|restart|status}&#34;</span>
</span></span><span class=line><span class=cl>        <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl>        <span class=p>;;</span>
</span></span><span class=line><span class=cl><span class=k>esac</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>exit</span> <span class=nv>$?</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=十一系统备份与灾难恢复>十一、系统备份与灾难恢复</h2><h3 id=111-备份策略制定>11.1 备份策略制定</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 3-2-1备份原则</span>
</span></span><span class=line><span class=cl><span class=c1># 3份备份：原始 + 2份备份</span>
</span></span><span class=line><span class=cl><span class=c1># 2种介质：磁盘 + 磁带/云</span>
</span></span><span class=line><span class=cl><span class=c1># 1份异地：物理隔离</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份类型</span>
</span></span><span class=line><span class=cl><span class=c1># 全量备份：周日，凌晨2点</span>
</span></span><span class=line><span class=cl><span class=c1># 增量备份：周一至周六，凌晨2点</span>
</span></span><span class=line><span class=cl><span class=c1># 实时备份：对关键数据（binlog、应用日志）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># RTO（恢复时间目标）和RPO（恢复点目标）</span>
</span></span><span class=line><span class=cl><span class=c1># RTO：系统恢复所需时间</span>
</span></span><span class=line><span class=cl><span class=c1># RPO：可接受的数据丢失量</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份工具选择</span>
</span></span><span class=line><span class=cl><span class=c1># 系统级：tar, rsync, dd, dump/restore</span>
</span></span><span class=line><span class=cl><span class=c1># 文件级：rsnapshot, Bacula, Amanda</span>
</span></span><span class=line><span class=cl><span class=c1># 虚拟化：Veeam, vSphere Data Protection</span>
</span></span><span class=line><span class=cl><span class=c1># 云备份：AWS S3, Azure Backup, Google Cloud Storage</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=112-rsync备份方案>11.2 rsync备份方案</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 备份脚本</span>
</span></span><span class=line><span class=cl>cat &gt; /usr/local/bin/backup.sh <span class=s>&lt;&lt;&#39;EOF&#39;
</span></span></span><span class=line><span class=cl><span class=s>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s>SOURCE_DIR=&#34;/data&#34;
</span></span></span><span class=line><span class=cl><span class=s>BACKUP_DIR=&#34;/backup&#34;
</span></span></span><span class=line><span class=cl><span class=s>DATE=$(date +%Y%m%d_%H%M%S)
</span></span></span><span class=line><span class=cl><span class=s>LOG_FILE=&#34;/var/log/backup.log&#34;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 创建备份目录
</span></span></span><span class=line><span class=cl><span class=s>mkdir -p $BACKUP_DIR
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 排除文件
</span></span></span><span class=line><span class=cl><span class=s>EXCLUDE_LIST=&#34;/tmp/backup_exclude.txt&#34;
</span></span></span><span class=line><span class=cl><span class=s>cat &gt; $EXCLUDE_LIST &lt;&lt;EOT
</span></span></span><span class=line><span class=cl><span class=s>*.log
</span></span></span><span class=line><span class=cl><span class=s>*.tmp
</span></span></span><span class=line><span class=cl><span class=s>cache/
</span></span></span><span class=line><span class=cl><span class=s>temp/
</span></span></span><span class=line><span class=cl><span class=s>EOT
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 执行备份
</span></span></span><span class=line><span class=cl><span class=s>rsync -avz --delete --exclude-from=$EXCLUDE_LIST \
</span></span></span><span class=line><span class=cl><span class=s>      $SOURCE_DIR/ $BACKUP_DIR/full-$DATE/
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 检查备份结果
</span></span></span><span class=line><span class=cl><span class=s>if [ $? -eq 0 ]; then
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;[$DATE] Backup successful&#34; &gt;&gt; $LOG_FILE
</span></span></span><span class=line><span class=cl><span class=s>else
</span></span></span><span class=line><span class=cl><span class=s>    echo &#34;[$DATE] Backup failed&#34; &gt;&gt; $LOG_FILE
</span></span></span><span class=line><span class=cl><span class=s>    exit 1
</span></span></span><span class=line><span class=cl><span class=s>fi
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 删除30天前的备份
</span></span></span><span class=line><span class=cl><span class=s>find $BACKUP_DIR -type d -name &#34;full-*&#34; -mtime +30 -exec rm -rf {} \;
</span></span></span><span class=line><span class=cl><span class=s>
</span></span></span><span class=line><span class=cl><span class=s># 发送通知
</span></span></span><span class=line><span class=cl><span class=s>echo &#34;Backup completed&#34; | mail -s &#34;Backup Report&#34; admin@company.com
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>chmod +x /usr/local/bin/backup.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. rsync关键参数</span>
</span></span><span class=line><span class=cl><span class=c1># -a: 归档模式，保留所有属性</span>
</span></span><span class=line><span class=cl><span class=c1># -v: 详细输出</span>
</span></span><span class=line><span class=cl><span class=c1># -z: 压缩传输</span>
</span></span><span class=line><span class=cl><span class=c1># -r: 递归</span>
</span></span><span class=line><span class=cl><span class=c1># -P: 显示进度，支持断点续传</span>
</span></span><span class=line><span class=cl><span class=c1># -n: 试运行（dry run）</span>
</span></span><span class=line><span class=cl><span class=c1># --delete: 删除目标目录多余文件</span>
</span></span><span class=line><span class=cl><span class=c1># --exclude: 排除特定文件/目录</span>
</span></span><span class=line><span class=cl><span class=c1># --link-dest: 硬链接增量备份（rsnapshot原理）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. rsync远程备份</span>
</span></span><span class=line><span class=cl>rsync -avz -e ssh /data/ user@backup-server:/backup/
</span></span><span class=line><span class=cl><span class=c1># 使用SSH密钥认证</span>
</span></span><span class=line><span class=cl>rsync -avz -e <span class=s2>&#34;ssh -i /root/.ssh/backup_key&#34;</span> /data/ user@backup-server:/backup/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 增量备份实现</span>
</span></span><span class=line><span class=cl><span class=c1># 基于时间戳</span>
</span></span><span class=line><span class=cl>rsync -avz --link-dest<span class=o>=</span>/backup/latest /data/ /backup/<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>/
</span></span><span class=line><span class=cl>ln -sf /backup/<span class=k>$(</span>date +%Y%m%d<span class=k>)</span> /backup/latest
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 自动化</span>
</span></span><span class=line><span class=cl>crontab -e
</span></span><span class=line><span class=cl><span class=m>0</span> <span class=m>2</span> * * * /usr/local/bin/backup.sh
</span></span></code></pre></td></tr></table></div></div><h3 id=113-mysql数据备份>11.3 MySQL数据备份</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 物理备份（Percona XtraBackup，热备）</span>
</span></span><span class=line><span class=cl><span class=c1># 安装</span>
</span></span><span class=line><span class=cl>yum install percona-xtrabackup-24
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 全量备份</span>
</span></span><span class=line><span class=cl>xtrabackup --backup --user<span class=o>=</span>root --password<span class=o>=</span><span class=s1>&#39;pass&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --target-dir<span class=o>=</span>/backup/mysql/full-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 准备备份</span>
</span></span><span class=line><span class=cl>xtrabackup --prepare --target-dir<span class=o>=</span>/backup/mysql/full-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 恢复</span>
</span></span><span class=line><span class=cl>systemctl stop mysqld
</span></span><span class=line><span class=cl>rm -rf /var/lib/mysql/*
</span></span><span class=line><span class=cl>xtrabackup --copy-back --target-dir<span class=o>=</span>/backup/mysql/full-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>
</span></span><span class=line><span class=cl>chown -R mysql:mysql /var/lib/mysql
</span></span><span class=line><span class=cl>systemctl start mysqld
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 增量备份</span>
</span></span><span class=line><span class=cl>xtrabackup --backup --user<span class=o>=</span>root --password<span class=o>=</span><span class=s1>&#39;pass&#39;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --target-dir<span class=o>=</span>/backup/mysql/inc-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>           --incremental-basedir<span class=o>=</span>/backup/mysql/full-20240101
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 逻辑备份（mysqldump + binlog）</span>
</span></span><span class=line><span class=cl><span class=c1># 全量备份</span>
</span></span><span class=line><span class=cl>mysqldump --all-databases --single-transaction --master-data<span class=o>=</span><span class=m>2</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>          --quick --lock-tables<span class=o>=</span><span class=nb>false</span> <span class=p>|</span> gzip &gt; /backup/mysql/all-<span class=k>$(</span>date +%Y%m%d<span class=k>)</span>.sql.gz
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 备份binlog</span>
</span></span><span class=line><span class=cl>mysql -e <span class=s2>&#34;SHOW MASTER STATUS;&#34;</span> &gt; /backup/mysql/master-pos.txt
</span></span><span class=line><span class=cl>cp /var/log/mysql/mysql-bin.* /backup/mysql/
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 恢复</span>
</span></span><span class=line><span class=cl>gunzip &lt; all-20240101.sql.gz <span class=p>|</span> mysql
</span></span><span class=line><span class=cl><span class=c1># 然后应用binlog</span>
</span></span><span class=line><span class=cl>mysqlbinlog mysql-bin.000001 mysql-bin.000002 <span class=p>|</span> mysql
</span></span></code></pre></td></tr></table></div></div><p>这份文档是一份非常详尽且结构清晰的 RHEL/CentOS 7 风格的 Linux 系统管理笔记。它涵盖了从存储、引导、网络到服务管理的各个核心领域。</p><p>经过详细审查，你的原文基础非常扎实（约 95% 的内容准确无误）。不过，为了使其成为一份<strong>企业级生产环境标准</strong>的“最终版”手册，我发现了一些需要修正的细节（主要是安全性、命令严谨性）以及针对现代 Linux（CentOS 8/9, Rocky, Ubuntu 20.04+）需要补充的关键模块。</p><p>以下是为你整理的<strong>勘误报告</strong>以及<strong>补充完善后的最终版模块</strong>。</p><hr><h3 id=第一部分勘误与优化建议-audit-report>第一部分：勘误与优化建议 (Audit Report)</h3><p>基于你提供的《Linux系统管理.md》，以下是具体的修改建议：</p><h4 id=1-存储管理-raid--lvm>1. 存储管理 (RAID & LVM)</h4><ul><li><strong>fstab 挂载风险</strong>：<ul><li><em>原文</em>：<code>echo "/dev/md5 /raid5 xfs defaults 0 0" >> /etc/fstab</code>。</li><li><em>修正</em>：<strong>强烈建议使用 UUID</strong>。在云环境或多盘环境中，<code>/dev/md5</code> 或 <code>/dev/sdb</code> 的设备名可能会在重启后发生漂移，导致系统无法启动。</li><li><em>命令</em>：<code>blkid /dev/md5</code> 获取 UUID，然后写入 fstab。</li></ul></li><li><strong>LVM 扩容顺序</strong>：<ul><li><em>原文</em>：先 <code>lvextend</code> 后 <code>xfs_growfs</code>。</li><li><em>补充</em>：这是正确的。但要注意 <code>xfs</code> 只能扩容不能缩容。如果是 <code>ext4</code>，缩容时必须<strong>先卸载、先缩小文件系统、再缩小 LV</strong>，顺序弄反会丢失数据。</li></ul></li></ul><h4 id=2-网络配置-modern-linux>2. 网络配置 (Modern Linux)</h4><ul><li><strong>工具迭代</strong>：<ul><li><em>原文</em>：大量使用了 <code>/etc/sysconfig/network-scripts/ifcfg-ens33</code> 和 <code>route</code> 命令。</li><li><em>现状</em>：在 RHEL 8/9、Ubuntu 20+ 中，<code>network-scripts</code> 已被废弃或默认不安装，<code>net-tools</code> (ifconfig/route) 也被淘汰。</li><li><em>建议</em>：最终版需加入 <strong><code>nmcli</code></strong> (NetworkManager CLI) 的配置方法，这是目前通用的标准。</li></ul></li></ul><h4 id=3-安全加固>3. 安全加固</h4><ul><li><strong>SSH 权限</strong>：<ul><li><em>原文</em>：<code>chmod 644</code> 用于私钥是不安全的。</li><li><em>修正</em>：私钥（<code>id_rsa</code>）必须是 <strong>600</strong>，否则 SSH 客户端会拒绝使用。公钥（<code>id_rsa.pub</code>）可以是 644。</li></ul></li></ul><h4 id=4-脚本编程>4. 脚本编程</h4><ul><li><strong>Shebang</strong>：<ul><li><em>建议</em>：虽然 <code>#!/bin/bash</code> 是标准的，但在某些精简系统（如 Alpine）或非标准环境，推荐使用 <code>#!/usr/bin/env bash</code> 以获得更好的兼容性。</li></ul></li></ul><h4 id=十二时间同步服务-chrony>十二、时间同步服务 (Chrony)</h4><p><em>注：现代 Linux 取代 NTP 的标准服务，对数据库和集群至关重要。</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 安装与启动</span>
</span></span><span class=line><span class=cl>yum install chrony -y
</span></span><span class=line><span class=cl>systemctl start chronyd
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> chronyd
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 配置文件 /etc/chrony.conf</span>
</span></span><span class=line><span class=cl><span class=c1># 修改 server 设定</span>
</span></span><span class=line><span class=cl><span class=c1># server 0.centos.pool.ntp.org iburst</span>
</span></span><span class=line><span class=cl><span class=c1># server 1.centos.pool.ntp.org iburst</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 常用命令</span>
</span></span><span class=line><span class=cl>chronyc sources -v    <span class=c1># 查看同步源状态（*表示正常同步）</span>
</span></span><span class=line><span class=cl>chronyc sourcestats -v
</span></span><span class=line><span class=cl>chronyc -a makestep   <span class=c1># 强制立即同步（跳跃时间）</span>
</span></span><span class=line><span class=cl>timedatectl set-timezone Asia/Shanghai  <span class=c1># 设置时区</span>
</span></span><span class=line><span class=cl>timedatectl status    <span class=c1># 查看完整时间状态</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=十三现代防火墙管理-firewalld-rich-rules>十三、现代防火墙管理 (Firewalld Rich Rules)</h4><p><em>注：原文只提到了简单的端口开放，生产环境需要更精细的控制。</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 基础概念</span>
</span></span><span class=line><span class=cl><span class=c1># Zone（区域）: public(默认), trusted, drop, home 等</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 常用操作</span>
</span></span><span class=line><span class=cl>firewall-cmd --state
</span></span><span class=line><span class=cl>firewall-cmd --get-active-zones
</span></span><span class=line><span class=cl>firewall-cmd --reload   <span class=c1># 重载配置（不中断连接）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 复杂规则（Rich Rules）- 生产环境必备</span>
</span></span><span class=line><span class=cl><span class=c1># 场景：只允许 192.168.1.10 访问 MySQL(3306)，拒绝其他</span>
</span></span><span class=line><span class=cl>firewall-cmd --permanent --remove-service<span class=o>=</span>mysql
</span></span><span class=line><span class=cl>firewall-cmd --permanent --add-rich-rule<span class=o>=</span><span class=s1>&#39;rule family=&#34;ipv4&#34; source address=&#34;192.168.1.10&#34; port port=&#34;3306&#34; protocol=&#34;tcp&#34; accept&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 场景：丢弃来自特定 IP 的所有包</span>
</span></span><span class=line><span class=cl>firewall-cmd --permanent --add-rich-rule<span class=o>=</span><span class=s1>&#39;rule family=&#34;ipv4&#34; source address=&#34;10.0.0.50&#34; drop&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 端口转发（NAT）</span>
</span></span><span class=line><span class=cl><span class=c1># 将本地 8080 转发到 80</span>
</span></span><span class=line><span class=cl>firewall-cmd --permanent --add-forward-port<span class=o>=</span><span class=nv>port</span><span class=o>=</span>8080:proto<span class=o>=</span>tcp:toport<span class=o>=</span><span class=m>80</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=十四selinux-实用操作指南>十四、SELinux 实用操作指南</h4><p><em>注：原文在排查中建议关闭 SELinux，但在高安环境（如银行、政企）必须开启。</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 模式管理</span>
</span></span><span class=line><span class=cl>getenforce          <span class=c1># 查看状态 (Enforcing/Permissive)</span>
</span></span><span class=line><span class=cl>setenforce <span class=m>0</span>        <span class=c1># 临时设置为宽容模式（只报警不拦截）</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 上下文（Context）修复</span>
</span></span><span class=line><span class=cl><span class=c1># 场景：Nginx 修改了网站根目录到 /data/www，导致 403 Forbidden</span>
</span></span><span class=line><span class=cl>ls -Z /data/www     <span class=c1># 查看当前标签</span>
</span></span><span class=line><span class=cl><span class=c1># 修复方法：</span>
</span></span><span class=line><span class=cl>semanage fcontext -a -t httpd_sys_content_t <span class=s2>&#34;/data/www(/.*)?&#34;</span>
</span></span><span class=line><span class=cl>restorecon -Rv /data/www
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 布尔值（Boolean）开关</span>
</span></span><span class=line><span class=cl><span class=c1># 场景：允许 HTTPD 发起网络连接（如 Nginx 反代）</span>
</span></span><span class=line><span class=cl>getsebool -a <span class=p>|</span> grep httpd
</span></span><span class=line><span class=cl>setsebool -P httpd_can_network_connect <span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 故障排查神器</span>
</span></span><span class=line><span class=cl>yum install setroubleshoot-server
</span></span><span class=line><span class=cl><span class=c1># 当被拦截时，查看日志并获取解决方案</span>
</span></span><span class=line><span class=cl>grep <span class=s2>&#34;SELinux is preventing&#34;</span> /var/log/messages
</span></span><span class=line><span class=cl>sealert -l &lt;UUID&gt;   <span class=c1># 系统会给出具体的解决命令</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=十五docker-容器基础-补充模块>十五、Docker 容器基础 (补充模块)</h4><p><em>注：现代运维无法绕过容器技术。</em></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 1. 安装 Docker CE</span>
</span></span><span class=line><span class=cl>yum install -y yum-utils
</span></span><span class=line><span class=cl>yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
</span></span><span class=line><span class=cl>yum install -y docker-ce docker-ce-cli containerd.io
</span></span><span class=line><span class=cl>systemctl <span class=nb>enable</span> --now docker
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 镜像加速（/etc/docker/daemon.json）</span>
</span></span><span class=line><span class=cl><span class=o>{</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;registry-mirrors&#34;</span>: <span class=o>[</span><span class=s2>&#34;https://your-mirror.mirror.aliyuncs.com&#34;</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 常用命令</span>
</span></span><span class=line><span class=cl>docker ps -a                   <span class=c1># 查看所有容器</span>
</span></span><span class=line><span class=cl>docker images                  <span class=c1># 查看镜像</span>
</span></span><span class=line><span class=cl>docker run -d -p 80:80 nginx   <span class=c1># 运行 Nginx</span>
</span></span><span class=line><span class=cl>docker <span class=nb>exec</span> -it &lt;ID&gt; bash      <span class=c1># 进入容器</span>
</span></span><span class=line><span class=cl>docker logs -f &lt;ID&gt;            <span class=c1># 查看日志</span>
</span></span><span class=line><span class=cl>docker prune system -f         <span class=c1># 清理未使用的资源</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. Docker Compose (单机编排)</span>
</span></span><span class=line><span class=cl><span class=c1># docker-compose.yml 示例</span>
</span></span><span class=line><span class=cl>version: <span class=s1>&#39;3&#39;</span>
</span></span><span class=line><span class=cl>services:
</span></span><span class=line><span class=cl>  web:
</span></span><span class=line><span class=cl>    image: nginx
</span></span><span class=line><span class=cl>    ports:
</span></span><span class=line><span class=cl>      - <span class=s2>&#34;80:80&#34;</span>
</span></span><span class=line><span class=cl>    volumes:
</span></span><span class=line><span class=cl>      - ./html:/usr/share/nginx/html
</span></span></code></pre></td></tr></table></div></div><hr><h3 id=第三部分现代网络配置替换方案-nmcli>第三部分：现代网络配置替换方案 (nmcli)</h3><p>建议将原文 <strong>4.2.4 配置文件管理</strong> 中的手动编辑 <code>ifcfg</code> 文件部分，替换或并在以下 <code>nmcli</code> 内容之后，因为 RHEL 8/9 可能会在未来完全移除 <code>network-scripts</code>。</p><p><strong>推荐替换/补充内容：</strong></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># NetworkManager CLI (nmcli) 生产环境配置</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 1. 查看连接</span>
</span></span><span class=line><span class=cl>nmcli connection show
</span></span><span class=line><span class=cl>nmcli device status
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 2. 创建/修改静态 IP 连接 (比手写配置文件更安全，自动纠错)</span>
</span></span><span class=line><span class=cl><span class=c1># 创建名为 &#34;static-ens33&#34; 的连接，绑定到 ens33</span>
</span></span><span class=line><span class=cl>nmcli con add <span class=nb>type</span> ethernet con-name static-ens33 ifname ens33 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      ipv4.method manual <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      ipv4.addresses 192.168.200.100/24 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      ipv4.gateway 192.168.200.1 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>      ipv4.dns <span class=s2>&#34;8.8.8.8 114.114.114.114&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 3. 生效与切换</span>
</span></span><span class=line><span class=cl>nmcli con up static-ens33
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 4. 修改现有配置</span>
</span></span><span class=line><span class=cl>nmcli con mod static-ens33 ipv4.addresses 192.168.200.101/24
</span></span><span class=line><span class=cl>nmcli con up static-ens33   <span class=c1># 重启生效</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 5. 交互式编辑器（图形化字符界面，适合新手）</span>
</span></span><span class=line><span class=cl>nmtui
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>本文采用 CC BY-NC-SA 4.0 许可协议</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/utility/tcpdump/><div class=article-details><h2 class=article-title>Tcpdump</h2></div></a></article><article><a href=/utility/ansible/><div class=article-details><h2 class=article-title>Ansible</h2></div></a></article><article><a href=/utility/jenkins/><div class=article-details><h2 class=article-title>Jenkins</h2></div></a></article><article><a href=/utility/nfs/><div class=article-details><h2 class=article-title>NFS</h2></div></a></article><article><a href=/utility/prometheus-/><div class=article-details><h2 class=article-title>Prometheus</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo data-repo-id data-category data-category-id data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2025 © 2025 win. 保留所有权利.</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>