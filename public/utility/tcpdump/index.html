<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="Tcpdump 指南 前言： 在 Linux 运维中，tcpdump 是上帝视角。它不撒谎，不推卸责任。当开发说“代码没问题”，网络说“交换机没问题”时，Tcpdump 的抓包文件是判定问题的唯一“法律证据”。\n"><title>Tcpdump</title><link rel=canonical href=http://localhost:1313/utility/tcpdump/><link rel=stylesheet href=/scss/style.min.6a692fd055deae459f2a9767f57f3855ba80cafd5041317f24f7360f6ca47cdf.css><meta property='og:title' content="Tcpdump"><meta property='og:description' content="Tcpdump 指南 前言： 在 Linux 运维中，tcpdump 是上帝视角。它不撒谎，不推卸责任。当开发说“代码没问题”，网络说“交换机没问题”时，Tcpdump 的抓包文件是判定问题的唯一“法律证据”。\n"><meta property='og:url' content='http://localhost:1313/utility/tcpdump/'><meta property='og:site_name' content='JustWin'><meta property='og:type' content='article'><meta property='article:section' content='Utility'><meta property='article:published_time' content='2025-12-15T00:00:00+00:00'><meta property='article:modified_time' content='2025-12-15T00:00:00+00:00'><meta property='og:image' content='http://localhost:1313/'><meta name=twitter:title content="Tcpdump"><meta name=twitter:description content="Tcpdump 指南 前言： 在 Linux 运维中，tcpdump 是上帝视角。它不撒谎，不推卸责任。当开发说“代码没问题”，网络说“交换机没问题”时，Tcpdump 的抓包文件是判定问题的唯一“法律证据”。\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='http://localhost:1313/'><link rel=stylesheet href=/css/custom.css><link rel="shortcut icon" href=/favicon.ico></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"light")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/images/avatar_hu_89ca753ea8ea85c7.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>✍️</span></figure><div class=site-meta><h1 class=site-name><a href=/>JustWin</a></h1><h2 class=site-description>分享技术与生活</h2></div></header><ol class=menu-social><li><a href=https://github.com/passion-win target=_blank title=GitHub rel=me><svg width="800" height="800" viewBox="0 0 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>github [#142]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M94 7399C99.523 7399 104 7403.59 104 7409.253 104 7413.782 101.138 7417.624 97.167 7418.981 96.66 7419.082 96.48 7418.762 96.48 7418.489 96.48 7418.151 96.492 7417.047 96.492 7415.675 96.492 7414.719 96.172 7414.095 95.813 7413.777 98.04 7413.523 100.38 7412.656 100.38 7408.718 100.38 7407.598 99.992 7406.684 99.35 7405.966 99.454 7405.707 99.797 7404.664 99.252 7403.252 99.252 7403.252 98.414 7402.977 96.505 7404.303 95.706 7404.076 94.85 7403.962 94 7403.958 93.15 7403.962 92.295 7404.076 91.497 7404.303 89.586 7402.977 88.746 7403.252 88.746 7403.252 88.203 7404.664 88.546 7405.707 88.649 7405.966 88.01 7406.684 87.619 7407.598 87.619 7408.718 87.619 7412.646 89.954 7413.526 92.175 7413.785 91.889 7414.041 91.63 7414.493 91.54 7415.156 90.97 7415.418 89.522 7415.871 88.63 7414.304 88.63 7414.304 88.101 7413.319 87.097 7413.247 87.097 7413.247 86.122 7413.234 87.029 7413.87 87.029 7413.87 87.684 7414.185 88.139 7415.37 88.139 7415.37 88.726 7417.2 91.508 7416.58 91.513 7417.437 91.522 7418.245 91.522 7418.489 91.522 7418.76 91.338 7419.077 90.839 7418.982 86.865 7417.627 84 7413.783 84 7409.253 84 7403.59 88.478 7399 94 7399" id="github-[#142]"/></g></g></g></svg></a></li><li><a href=https://t.me/+TFjBeZzowwU1YTY1 target=_blank title=telegram rel=me><svg viewBox="0 0 640 640"><path d="M320 72C183 72 72 183 72 320S183 568 320 568 568 457 568 320 457 72 320 72zM435 240.7C431.3 279.9 415.1 375.1 406.9 419c-3.5 18.6-10.3 24.8-16.9 25.4C375.6 445.7 364.7 434.9 350.7 425.7c-21.8-14.3-34.2-23.2-55.3-37.2C270.9 372.4 286.8 363.5 300.7 349 304.4 345.2 367.8 287.5 369 282.3 369.2 281.6 369.3 279.2 367.8 277.9 366.3 276.6 364.2 277.1 362.7 277.4 360.5 277.9 325.6 300.9 258.1 346.5 248.2 353.3 239.2 356.6 231.2 356.4 222.3 356.2 205.3 351.4 192.6 347.3 177.1 342.3 164.7 339.6 165.8 331 166.4 326.5 172.5 322 184.2 317.3 256.5 285.8 304.7 265 328.8 255c68.9-28.6 83.2-33.6 92.5-33.8C423.4 221.2 427.9 221.7 430.9 224.1 432.9 225.8 434.1 228.2 434.4 230.8 434.9 234 435 237.3 434.8 240.6z"/></svg></a></li><li><a href=https://twitter.com/@win1688888888 target=_blank title=twitter rel=me><svg width="800" height="800" viewBox="0 -2 20 20" xmlns:xlink="http://www.w3.org/1999/xlink"><title>twitter [#154]</title><desc>Created with Sketch.</desc><defs/><g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g id="Dribbble-Light-Preview" transform="translate(-60.000000, -7521.000000)" fill="#000"><g id="icons" transform="translate(56.000000, 160.000000)"><path d="M10.29 7377C17.837 7377 21.965 7370.84365 21.965 7365.50546 21.965 7365.33021 21.965 7365.15595 21.953 7364.98267 22.756 7364.41163 23.449 7363.70276 24 7362.8915 23.252 7363.21837 22.457 7363.433 21.644 7363.52751 22.5 7363.02244 23.141 7362.2289 23.448 7361.2926 22.642 7361.76321 21.761 7362.095 20.842 7362.27321 19.288 7360.64674 16.689 7360.56798 15.036 7362.09796 13.971 7363.08447 13.518 7364.55538 13.849 7365.95835 10.55 7365.79492 7.476 7364.261 5.392 7361.73762 4.303 7363.58363 4.86 7365.94457 6.663 7367.12996 6.01 7367.11125 5.371 7366.93797 4.8 7366.62489V7366.67608C4.801 7368.5989 6.178 7370.2549 8.092 7370.63591 7.488 7370.79836 6.854 7370.82199 6.24 7370.70483 6.777 7372.35099 8.318 7373.47829 10.073 7373.51078 8.62 7374.63513 6.825 7375.24554 4.977 7375.24358 4.651 7375.24259 4.325 7375.22388 4 7375.18549 5.877 7376.37088 8.06 7377 10.29 7376.99705" id="twitter-[#154]"/></g></g></g></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><span>首页</span></a></li><li><a href=/links/><span>网站</span></a></li><li><a href=/linux/><span>Linux</span></a></li><li><a href=/docker/><span>docker</span></a></li><li><a href=/k8s/><span>k8s</span></a></li><li><a href=/mysql/><span>mysql</span></a></li><li><a href=/project/><span>项目</span></a></li><li><a href=/kali/><span>kali</span></a></li><li><a href=/ubuntu/><span>ubuntu</span></a></li><li><a href=/utility/><span>Utility</span></a></li><li><a href=/about/><span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=http://localhost:1313/ selected>中文</option><option value=http://localhost:1313/en/>English</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#第一章核心原理与环境准备-the-foundation>第一章：核心原理与环境准备 (The Foundation)</a><ol><li><a href=#11-工作原理-kernel-space>1.1 工作原理 (Kernel Space)</a></li><li><a href=#12-安装与权限>1.2 安装与权限</a></li><li><a href=#13-核心参数防止掉坑的必选项>1.3 核心参数：防止“掉坑”的必选项</a></li></ol></li><li><a href=#第二章过滤的艺术-the-art-of-filtering>第二章：过滤的艺术 (The Art of Filtering)</a><ol><li><a href=#21-bpf-基础语法-回顾与补充>2.1 BPF 基础语法 (回顾与补充)</a></li><li><a href=#22-高级位掩码过滤-advanced-bitmasking--专家级技能>2.2 高级位掩码过滤 (Advanced Bitmasking) —— 专家级技能</a></li><li><a href=#23-基于包大小过滤>2.3 基于包大小过滤</a></li></ol></li><li><a href=#第三章现场解读与应用层分析-live-decoding>第三章：现场解读与应用层分析 (Live Decoding)</a><ol><li><a href=#31-增强版输出参数>3.1 增强版输出参数</a></li><li><a href=#32-常见应用层协议实战>3.2 常见应用层协议实战</a><ol><li><a href=#1-抓取-mysql-sql-语句>1. 抓取 MySQL SQL 语句</a></li><li><a href=#2-抓取-http-真实请求-rest-api>2. 抓取 HTTP 真实请求 (REST API)</a></li><li><a href=#3-抓取-dns-解析耗时>3. 抓取 DNS 解析耗时</a></li></ol></li></ol></li><li><a href=#第四章容器与云原生环境-docker--kubernetes>第四章：容器与云原生环境 (Docker & Kubernetes)</a><ol><li><a href=#41-传统-docker-方式>4.1 传统 Docker 方式</a></li><li><a href=#42-终极方案进入容器网络命名空间-namespace>4.2 终极方案：进入容器网络命名空间 (Namespace)</a></li></ol></li><li><a href=#第五章故障排查实战剧本-scenarios-expanded>第五章：故障排查实战剧本 (Scenarios Expanded)</a><ol><li><a href=#场景-d排查-tcp-重传-retransmission--网络质量差>场景 D：排查 TCP 重传 (Retransmission) —— 网络质量差</a></li><li><a href=#场景-e排查-tcp-零窗口-zero-window--接收端处理不过来>场景 E：排查 TCP 零窗口 (Zero Window) —— 接收端处理不过来</a></li><li><a href=#场景-f排查-keepalive-超时>场景 F：排查 Keepalive 超时</a></li></ol></li><li><a href=#第六章高级数据保存与分析流程-workflow>第六章：高级数据保存与分析流程 (Workflow)</a><ol><li><a href=#61-生产环境黑匣子策略-rotating-capture>6.1 生产环境“黑匣子”策略 (Rotating Capture)</a></li><li><a href=#62-结合-wireshark-的解密-https>6.2 结合 Wireshark 的解密 (HTTPS)</a></li></ol></li><li><a href=#第七章运维速查总结卡-the-cheat-sheet>第七章：运维速查总结卡 (The Cheat Sheet)</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category></header><div class=article-title-wrapper><h2 class=article-title><a href=/utility/tcpdump/>Tcpdump</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2025-12-15</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><h1 id=tcpdump-指南>Tcpdump 指南</h1><blockquote><p><strong>前言：</strong>
在 Linux 运维中，<code>tcpdump</code> 是上帝视角。它不撒谎，不推卸责任。当开发说“代码没问题”，网络说“交换机没问题”时，Tcpdump 的抓包文件是判定问题的唯一“法律证据”。</p></blockquote><hr><h2 id=第一章核心原理与环境准备-the-foundation>第一章：核心原理与环境准备 (The Foundation)</h2><h3 id=11-工作原理-kernel-space>1.1 工作原理 (Kernel Space)</h3><p>Tcpdump 工作在<strong>内核空间 (Kernel Space)</strong>。它通过调用 <code>libpcap</code> 库，直接从<strong>数据链路层</strong>（Device Driver 之上）捕获数据。</p><ul><li><strong>关键点</strong>：它在 <code>iptables/netfilter</code> 之前（入站流量）或之后（出站流量）看到数据。这意味着：即使 <code>iptables</code> INPUT 链丢弃了包，<code>tcpdump</code> 通常依然能抓到入站包（证明流量到了网卡）。</li></ul><h3 id=12-安装与权限>1.2 安装与权限</h3><p>大多数发行版默认不带，需手动安装：</p><ul><li><strong>CentOS/RHEL</strong>: <code>yum install -y tcpdump</code></li><li><strong>Ubuntu/Debian</strong>: <code>apt-get install -y tcpdump</code></li><li><strong>权限</strong>: 必须使用 <code>root</code> 用户或 <code>sudo</code>，因为它需要将网卡设置为混杂模式。</li></ul><h3 id=13-核心参数防止掉坑的必选项>1.3 核心参数：防止“掉坑”的必选项</h3><p>除了 <code>-nn</code>，生产环境必须了解以下参数，否则抓出来的包可能无法使用：</p><ul><li><strong><code>-s 0</code> (Snaplen)</strong>: <strong>极其重要</strong>。默认 <code>tcpdump</code> 可能只抓取包头（如前 96 字节）。如果不加 <code>-s 0</code>（表示抓取完整包），你在 Wireshark 里看 HTTP Body 或 SQL 语句时会被截断，显示 &ldquo;Packet size limited during capture&rdquo;。</li><li><strong><code>-c [count]</code></strong>: 抓取指定数量的包后自动停止。防止忘记关命令导致磁盘写满。</li><li><strong><code>-B [size]</code></strong>: 设置内核捕获缓冲区大小（单位 KiB）。流量大时，默认缓冲区容易溢出导致丢包（Tcpdump 显示 <code>dropped by kernel</code>），可设置为 <code>-B 4096</code>。</li></ul><hr><h2 id=第二章过滤的艺术-the-art-of-filtering>第二章：过滤的艺术 (The Art of Filtering)</h2><p><strong>原则：</strong> 过滤不仅是为了看得清，更是为了保护服务器 I/O。</p><h3 id=21-bpf-基础语法-回顾与补充>2.1 BPF 基础语法 (回顾与补充)</h3><div class=table-wrapper><table><thead><tr><th style=text-align:left>维度</th><th style=text-align:left>关键字</th><th style=text-align:left>示例</th><th style=text-align:left>补充说明</th></tr></thead><tbody><tr><td style=text-align:left><strong>Type</strong></td><td style=text-align:left><code>host</code></td><td style=text-align:left><code>host 1.1.1.1</code></td><td style=text-align:left>同时匹配 src 和 dst</td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>net</code></td><td style=text-align:left><code>net 192.168.0.0/16</code></td><td style=text-align:left>匹配整个网段</td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>port</code></td><td style=text-align:left><code>port 80</code></td><td style=text-align:left></td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>portrange</code></td><td style=text-align:left><code>portrange 8000-8080</code></td><td style=text-align:left></td></tr><tr><td style=text-align:left><strong>Dir</strong></td><td style=text-align:left><code>src</code>, <code>dst</code></td><td style=text-align:left><code>src 192.168.1.1</code></td><td style=text-align:left></td></tr><tr><td style=text-align:left></td><td style=text-align:left><code>src and dst</code></td><td style=text-align:left></td><td style=text-align:left>限制流向</td></tr><tr><td style=text-align:left><strong>Proto</strong></td><td style=text-align:left><code>tcp</code>, <code>udp</code>, <code>icmp</code></td><td style=text-align:left><code>icmp</code></td><td style=text-align:left>还有 <code>ip6</code> (IPv6), <code>arp</code></td></tr></tbody></table></div><h3 id=22-高级位掩码过滤-advanced-bitmasking--专家级技能>2.2 高级位掩码过滤 (Advanced Bitmasking) —— 专家级技能</h3><p>在某些极端场景（如遭受 DDoS 攻击或排查僵尸连接），你需要精准抓取 TCP 标志位。BPF 允许我们直接检查 TCP 报头。</p><p><strong>TCP 报头偏移量 13 是标志位 (Flags)：</strong>
<code>CWR | ECE | URG | ACK | PSH | RST | SYN | FIN</code></p><p><strong>实战公式：</strong> <code>tcp[tcpflags] & tcp-syn != 0</code></p><ol><li><strong>只抓 SYN 包（发起连接）：</strong><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 <span class=s2>&#34;tcp[tcpflags] &amp; (tcp-syn) != 0&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><strong>只抓 RST 包（连接重置/拒绝）：</strong><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 <span class=s2>&#34;tcp[tcpflags] &amp; (tcp-rst) != 0&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><strong>抓取 SYN-ACK 包（服务端响应连接）：</strong><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 <span class=s2>&#34;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) == (tcp-syn|tcp-ack)&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li><li><strong>抓取 HTTP GET 请求 (匹配数据包内容)：</strong><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># &#39;G&#39;, &#39;E&#39;, &#39;T&#39;, &#39; &#39; 的十六进制是 47 45 54 20</span>
</span></span><span class=line><span class=cl>tcpdump -i eth0 <span class=s2>&#34;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420&#34;</span>
</span></span></code></pre></td></tr></table></div></div></li></ol><h3 id=23-基于包大小过滤>2.3 基于包大小过滤</h3><p>排除掉只有 Header 的小包（如 ACK 确认包），只看传输数据的包：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 抓取长度大于 100 字节的包</span>
</span></span><span class=line><span class=cl>tcpdump -i eth0 length &gt; <span class=m>100</span>
</span></span></code></pre></td></tr></table></div></div><hr><h2 id=第三章现场解读与应用层分析-live-decoding>第三章：现场解读与应用层分析 (Live Decoding)</h2><h3 id=31-增强版输出参数>3.1 增强版输出参数</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 -nn -v -s <span class=m>0</span> -A
</span></span></code></pre></td></tr></table></div></div><ul><li><strong><code>-A</code></strong>: 以 ASCII 码打印 payload。这是看 <strong>HTTP Header、JSON、SQL 语句</strong> 的神器。</li><li><strong><code>-X</code></strong>: 十六进制 + ASCII 对照。当数据包含乱码或二进制时使用。</li><li><strong><code>-l</code></strong>: 缓冲行模式。配合 <code>grep</code> 使用时必须加，否则 <code>grep</code> 无法实时收到数据。<ul><li><em>示例</em>：<code>tcpdump -i eth0 -nn -l -A | grep "User-Agent"</code></li></ul></li></ul><h3 id=32-常见应用层协议实战>3.2 常见应用层协议实战</h3><h4 id=1-抓取-mysql-sql-语句>1. 抓取 MySQL SQL 语句</h4><p>MySQL 默认端口 3306，未加密连接下可直接抓取 SQL：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 -nn -s <span class=m>0</span> -A port <span class=m>3306</span> <span class=p>|</span> grep -iE <span class=s1>&#39;select|insert|update|delete&#39;</span>
</span></span></code></pre></td></tr></table></div></div><p><em>注意：如果是 MySQL 8.0 且开启了 SSL，只能看到乱码。</em></p><h4 id=2-抓取-http-真实请求-rest-api>2. 抓取 HTTP 真实请求 (REST API)</h4><p>查看发往本机 8080 端口的 POST 请求内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 -nn -s <span class=m>0</span> -A port <span class=m>8080</span> and tcp<span class=o>[((</span>tcp<span class=o>[</span>12:1<span class=o>]</span> <span class=p>&amp;</span> 0xf0<span class=o>)</span> &gt;&gt; 2<span class=o>)</span>:4<span class=o>]</span> <span class=o>=</span> 0x504F5354
</span></span></code></pre></td></tr></table></div></div><p>或者简单点：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 -nn -s <span class=m>0</span> -A port <span class=m>8080</span> <span class=p>|</span> grep <span class=s2>&#34;POST /&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h4 id=3-抓取-dns-解析耗时>3. 抓取 DNS 解析耗时</h4><p>DNS 慢会导致所有服务都慢。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 -nn port <span class=m>53</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong>关注点</strong>：看 Request 和 Response 之间的时间差。</li></ul><hr><h2 id=第四章容器与云原生环境-docker--kubernetes>第四章：容器与云原生环境 (Docker & Kubernetes)</h2><p><strong>这是现代运维最头疼的地方：容器里的流量怎么抓？</strong></p><h3 id=41-传统-docker-方式>4.1 传统 Docker 方式</h3><p>容器通常有自己的虚拟网卡（veth pair），在宿主机上看到的是 <code>vethXXXX</code>。</p><ol><li><strong>查找容器对应的 veth 网卡</strong>（较麻烦）。</li><li><strong>直接在宿主机抓 docker0 网桥</strong>：<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i docker0 -nn port <span class=m>8080</span>
</span></span></code></pre></td></tr></table></div></div><em>缺点：只能看到进出网桥的流量，看不到容器内部 localhost 通信。</em></li></ol><h3 id=42-终极方案进入容器网络命名空间-namespace>4.2 终极方案：进入容器网络命名空间 (Namespace)</h3><p>这是最专业的方法，无需在容器内安装 tcpdump。</p><ol><li><strong>获取容器 PID</strong>：<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>docker inspect -f <span class=s1>&#39;{{.State.Pid}}&#39;</span> &lt;container_name_or_id&gt;
</span></span><span class=line><span class=cl><span class=c1># 假设 PID 为 12345</span>
</span></span></code></pre></td></tr></table></div></div></li><li><strong>使用 <code>nsenter</code> 进入该 PID 的网络空间抓包</strong>：<div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nsenter -n -t <span class=m>12345</span> tcpdump -i eth0 -nn -v
</span></span></code></pre></td></tr></table></div></div><em>解释</em>：<code>nsenter</code> 让你“借用”宿主机的 <code>tcpdump</code> 二进制文件，直接运行在目标容器的“网络环境”里。<strong>Kubernetes Pod 排查同理。</strong></li></ol><hr><h2 id=第五章故障排查实战剧本-scenarios-expanded>第五章：故障排查实战剧本 (Scenarios Expanded)</h2><h3 id=场景-d排查-tcp-重传-retransmission--网络质量差>场景 D：排查 TCP 重传 (Retransmission) —— 网络质量差</h3><p><strong>现象</strong>：偶尔卡顿，传输速度不稳定。
<strong>命令</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tcpdump -i eth0 -nn tcp
</span></span></code></pre></td></tr></table></div></div><p><strong>Wireshark 分析</strong>：
在 Wireshark 过滤器输入 <code>tcp.analysis.retransmission</code>。</p><ul><li><strong>原理</strong>：如果看到大量红色的 &ldquo;TCP Retransmission&rdquo;，说明数据包丢失了，发送方在重试。</li><li><strong>原因</strong>：物理链路拥塞、网线故障、中间设备丢包。</li></ul><h3 id=场景-e排查-tcp-零窗口-zero-window--接收端处理不过来>场景 E：排查 TCP 零窗口 (Zero Window) —— 接收端处理不过来</h3><p><strong>现象</strong>：上传文件到服务器突然中断或极慢。
<strong>分析</strong>：
在 tcpdump 输出中寻找 <code>win 0</code>。</p><ul><li><strong>日志</strong>：<code>Flags [.], seq 100, ack 200, win 0, length 0</code></li><li><strong>含义</strong>：接收端（服务器）告诉发送端：“我缓存满了，处理不过来了，别发了！”</li><li><strong>原因</strong>：服务端应用（如 Tomcat/Nginx）负载过高或卡死，无法从内核缓冲区取走数据。</li></ul><h3 id=场景-f排查-keepalive-超时>场景 F：排查 Keepalive 超时</h3><p><strong>现象</strong>：连接空闲一段时间后断开。
<strong>策略</strong>：抓取长时间的流量，观察最后的包是 FIN 还是 RST，以及发生的时间间隔。</p><hr><h2 id=第六章高级数据保存与分析流程-workflow>第六章：高级数据保存与分析流程 (Workflow)</h2><h3 id=61-生产环境黑匣子策略-rotating-capture>6.1 生产环境“黑匣子”策略 (Rotating Capture)</h3><p>在排查偶发故障（如每天凌晨 3 点报错）时，不能人工守着。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>nohup tcpdump -i eth0 port <span class=m>80</span> -C <span class=m>100</span> -W <span class=m>20</span> -w /data/pcap/trace.pcap <span class=p>&amp;</span>
</span></span></code></pre></td></tr></table></div></div><ul><li><strong><code>-C 100</code></strong>: 每个文件 100MB。</li><li><strong><code>-W 20</code></strong>: 保留最近 20 个文件（循环覆盖）。</li><li><strong>总容量</strong>：占用 2GB 磁盘空间。</li><li><strong>结果</strong>：你永远拥有“最近 2GB 流量”的快照。</li></ul><h3 id=62-结合-wireshark-的解密-https>6.2 结合 Wireshark 的解密 (HTTPS)</h3><p>Tcpdump 抓到的 HTTPS 流量是加密的（TLS），看到的是乱码。
<strong>破解方法</strong>：</p><ol><li>在服务端设置环境变量 <code>SSLKEYLOGFILE=/tmp/sslkey.log</code>（支持 Nginx, Java, Curl 等）。</li><li>应用会将对称加密密钥写入该文件。</li><li>将 <code>.pcap</code> 和 <code>.log</code> 文件都下载到本地。</li><li><strong>Wireshark 设置</strong>：<code>Preferences</code> -> <code>Protocols</code> -> <code>TLS</code> -> <code>(Pre)-Master-Secret log filename</code> 导入 log 文件。</li><li><strong>见证奇迹</strong>：Wireshark 直接显示解密后的 HTTP 明文。</li></ol><hr><h2 id=第七章运维速查总结卡-the-cheat-sheet>第七章：运维速查总结卡 (The Cheat Sheet)</h2><div class=table-wrapper><table><thead><tr><th style=text-align:left>场景</th><th style=text-align:left>核心命令</th><th style=text-align:left>关键点</th></tr></thead><tbody><tr><td style=text-align:left><strong>基础调试</strong></td><td style=text-align:left><code>tcpdump -i eth0 -nn</code></td><td style=text-align:left>禁用域名解析，快</td></tr><tr><td style=text-align:left><strong>看数据内容</strong></td><td style=text-align:left><code>tcpdump -i eth0 -nn -A -s 0</code></td><td style=text-align:left><code>-A</code>看文本, <code>-s 0</code>防截断</td></tr><tr><td style=text-align:left><strong>抓特定IP交互</strong></td><td style=text-align:left><code>tcpdump host 1.1.1.1 and port 80</code></td><td style=text-align:left>精准定位</td></tr><tr><td style=text-align:left><strong>抓拒绝连接</strong></td><td style=text-align:left><code>tcpdump "tcp[tcpflags] & tcp-rst != 0"</code></td><td style=text-align:left>只看 RST 包</td></tr><tr><td style=text-align:left><strong>容器抓包</strong></td><td style=text-align:left><code>nsenter -n -t &lt;PID> tcpdump</code></td><td style=text-align:left>穿透命名空间</td></tr><tr><td style=text-align:left><strong>长时间监控</strong></td><td style=text-align:left><code>tcpdump -C 50 -W 10 -w /tmp/run.pcap</code></td><td style=text-align:left>轮询保存文件</td></tr><tr><td style=text-align:left><strong>排除 SSH</strong></td><td style=text-align:left><code>tcpdump port not 22</code></td><td style=text-align:left>防止自己刷屏</td></tr><tr><td style=text-align:left><strong>抓 ICMP 报错</strong></td><td style=text-align:left><code>tcpdump 'icmp[icmptype] != icmp-echo and icmp[icmptype] != icmp-echoreply'</code></td><td style=text-align:left>抓取 Destination Unreachable 等错误</td></tr></tbody></table></div></section><footer class=article-footer><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>本文采用 CC BY-NC-SA 4.0 许可协议</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article><a href=/linux/clash%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/><div class=article-details><h2 class=article-title>Linuxclash</h2></div></a></article><article><a href=/utility/wireshar/><div class=article-details><h2 class=article-title>Wireshar</h2></div></a></article><article><a href=/utility/ansible/><div class=article-details><h2 class=article-title>Ansible</h2></div></a></article><article><a href=/utility/jenkins/><div class=article-details><h2 class=article-title>Jenkins</h2></div></a></article><article><a href=/utility/nfs/><div class=article-details><h2 class=article-title>NFS</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo data-repo-id data-category data-category-id data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=en data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"light":"dark_dimmed")}})()</script><footer class=site-footer><section class=copyright>&copy;
2025 © 2025 win. 保留所有权利.</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.31.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>